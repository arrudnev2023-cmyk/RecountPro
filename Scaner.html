<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>VisualDrop ‚Äî PNG ZIP</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body { font-family: sans-serif; background:#0d1117; color:#e6edf3; margin:0; padding:12px; }
    h1 { font-size:18px; margin:12px 0; }
    .card { background:#161b22; padding:16px; border-radius:12px; margin-bottom:16px; }
    button,input[type=file] { width:100%; margin:6px 0; padding:10px; border-radius:8px; border:none; font-weight:600; }
    button { background:#4b8cff; color:white; }
    button:disabled { opacity:.5; }
    .progress { height:10px; background:#30363d; border-radius:999px; overflow:hidden; margin:8px 0; }
    .bar { height:100%; width:0%; background:linear-gradient(90deg,#4b8cff,#7aa6ff); }
    canvas { width:100%; max-width:320px; margin-top:8px; border-radius:8px; background:#000; }
    .muted { color:#8b949e; font-size:13px; margin-top:4px; }
    .debug { color:#58a6ff; font-size:13px; margin-top:6px; white-space:pre-wrap; }
  </style>
</head>
<body>
  <h1>üì¶ VisualDrop ‚Äî PNG ZIP</h1>
  <div class="card">
    <h2>–ö–æ–¥–µ—Ä</h2>
    <input type="file" id="fileInput">
    <button id="btnGenerate" disabled>–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ PNG‚Äë–∫–∞–¥—Ä—ã (ZIP)</button>
    <div class="progress"><div class="bar" id="encBar"></div></div>
    <a id="downloadZip" href="#" download="frames.zip" style="display:none;">
      <button>–°–∫–∞—á–∞—Ç—å ZIP</button>
    </a>
    <div class="muted" id="encStatus">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
  </div>
  <div class="card">
    <h2>–°–∫–∞–Ω–µ—Ä</h2>
    <input type="file" id="zipInput" accept=".zip">
    <button id="btnDecode" disabled>–°–æ–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
    <div class="progress"><div class="bar" id="decBar"></div></div>
    <a id="downloadFile" href="#" style="display:none;">
      <button id="btnDownload">–°–∫–∞—á–∞—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª</button>
    </a>
    <canvas id="canvas" width="128" height="128"></canvas>
    <div class="muted" id="decStatus">ZIP –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
    <div class="debug" id="debugInfo"></div>
  </div>
<script>
const GRID=128, CELLS=GRID*GRID, HEADER_PIXELS=512;
let fileBytes=null, fileName="";
const fileInput=document.getElementById('fileInput');
const btnGenerate=document.getElementById('btnGenerate');
const encBar=document.getElementById('encBar');
const encStatus=document.getElementById('encStatus');
const downloadZip=document.getElementById('downloadZip');
fileInput.addEventListener('change', async ()=>{
  const f=fileInput.files[0];
  if(!f) return;
  fileBytes=new Uint8Array(await f.arrayBuffer());
  fileName=f.name;
  btnGenerate.disabled=false;
  encStatus.textContent=`–§–∞–π–ª: ${f.name} (${(f.size/1024/1024).toFixed(1)} –ú–ë)`;
});
btnGenerate.addEventListener('click', async ()=>{
  const payloadPerFrame=(CELLS-HEADER_PIXELS)*3;
  const totalFrames=Math.ceil(fileBytes.length/payloadPerFrame);
  const zip=new JSZip();
  const canvas=document.createElement('canvas');
  canvas.width=GRID; canvas.height=GRID;
  const ctx=canvas.getContext('2d');
  for(let i=0;i<totalFrames;i++){
    const start=i*payloadPerFrame;
    const end=start+payloadPerFrame;
    const chunk=fileBytes.slice(start,end);
    const img=ctx.createImageData(GRID,GRID);
    if(i===0){
      const meta=JSON.stringify({name:fileName,size:fileBytes.length,total:totalFrames});
      const enc=new TextEncoder().encode(meta);
      for(let j=0;j<HEADER_PIXELS && j<enc.length;j++){
        img.data[j*4]=enc[j]; img.data[j*4+1]=0; img.data[j*4+2]=0; img.data[j*4+3]=255;
      }
      let ci=HEADER_PIXELS;
      for(let k=0;k<chunk.length;k+=3){
        const idx=ci*4;
        img.data[idx]=chunk[k]||0; img.data[idx+1]=chunk[k+1]||0; img.data[idx+2]=chunk[k+2]||0; img.data[idx+3]=255;
        ci++;
      }
    } else {
      let ci=0;
      for(let k=0;k<chunk.length;k+=3){
        const idx=ci*4;
        img.data[idx]=chunk[k]||0; img.data[idx+1]=chunk[k+1]||0; img.data[idx+2]=chunk[k+2]||0; img.data[idx+3]=255;
        ci++;
      }
    }
    ctx.putImageData(img,0,0);
    const blob=await new Promise(r=>canvas.toBlob(r,"image/png"));
    zip.file(`frame_${i}.png`,blob);
    encBar.style.width=`${((i+1)/totalFrames)*100}%`;
  }
  const zipBlob=await zip.generateAsync({type:"blob"});
  const url=URL.createObjectURL(zipBlob);
  downloadZip.href=url;
  downloadZip.style.display="block";
  encStatus.textContent=`ZIP –≥–æ—Ç–æ–≤ (${totalFrames} –∫–∞–¥—Ä–æ–≤)`;
});
const zipInput=document.getElementById('zipInput');
const btnDecode=document.getElementById('btnDecode');
const decBar=document.getElementById('decBar');
const decStatus=document.getElementById('decStatus');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const downloadFile=document.getElementById('downloadFile');
const debugInfo=document.getElementById('debugInfo');
let framesData=[], metaInfo=null;
zipInput.addEventListener('change',()=>{
  if(zipInput.files.length>0){
    btnDecode.disabled=false;
    decStatus.textContent=`–ó–∞–≥—Ä—É–∂–µ–Ω ZIP: ${zipInput.files[0].name}`;
  }
});
btnDecode.addEventListener('click',async ()=>{
  framesData=[]; metaInfo=null;
  const zip=new JSZip();
  const content=await zip.loadAsync(zipInput.files[0]);
  const files=Object.keys(content.files).sort();
  for(let i=0;i<files.length;i++){
    const blob=await content.files[files[i]].async("blob");
    const img=new Image();
    const url=URL.createObjectURL(blob);
    await new Promise(res=>{
      img.onload=()=>{
        ctx.drawImage(img,0,0,GRID,GRID);
        const frame=ctx.getImageData(0,0,GRID,GRID).data;
        if(i===0){
          let headerBytes=[];
          for(let j=0;j<HEADER_PIXELS;j++) headerBytes.push(frame[j*4]);
          const raw=new TextDecoder().decode(new Uint8Array(headerBytes));
          const end=raw.indexOf("}");
          if(end!==-1){
            try{
              const json=raw.slice(0,end+1);
              metaInfo=JSON.parse(json);
              debugInfo.textContent="–ó–∞–≥–æ–ª–æ–≤–æ–∫: "+json;
            }catch(e){ debugInfo.textContent="–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: "+e; }
          }
          let chunk=[];
          for(let j=HEADER_PIXELS;j<CELLS;j++){
            const idx=j*4;
            chunk.push(frame[idx],frame[idx+1],frame[idx+2]);
          }
          framesData.push(new Uint8Array(chunk));
        } else {
          let chunk=[];
          for(let j=0;j<CELLS;j++){
            const idx=j*4;
            chunk.push(frame[idx],frame[idx+1],frame[idx+2]);
          }
          framesData.push(new Uint8Array(chunk));
        }
        res();
      };
      img.src=url;
    });
    decBar.style.width=`${((i+1)/files.length)*100}%`;
    decStatus.textContent=`–ö–∞–¥—Ä–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${i+1}/${files.length}`;
  }
  assembleFile();
});
function assembleFile(){
  const totalLen = framesData.reduce((s,b)=>s+b.length,0);
  const out = new Uint8Array(totalLen);
  let o = 0; 
  for(const c of framesData){ 
    out.set(c,o); 
    o += c.length; 
  }
    let fileName = "output.bin";
  if(metaInfo && metaInfo.name){
    fileName = metaInfo.name;
  }

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é
  let mime = "application/octet-stream";
  const lower = fileName.toLowerCase();
  if(lower.endsWith(".jpg") || lower.endsWith(".jpeg")) mime = "image/jpeg";
  if(lower.endsWith(".png")) mime = "image/png";
  if(lower.endsWith(".gif")) mime = "image/gif";
  if(lower.endsWith(".pdf")) mime = "application/pdf";
  if(lower.endsWith(".mp3")) mime = "audio/mpeg";
  if(lower.endsWith(".mp4")) mime = "video/mp4";
  if(lower.endsWith(".zip")) mime = "application/zip";

  const blob = new Blob([out], {type: mime});
  const url = URL.createObjectURL(blob);

  downloadFile.href = url;
  downloadFile.download = fileName;
  downloadFile.style.display = "block";

  decStatus.textContent = `‚úÖ –§–∞–π–ª —Å–æ–±—Ä–∞–Ω: ${fileName}`;
  debugInfo.textContent += `\n–ò—Ç–æ–≥–æ–≤–æ–µ –∏–º—è —Ñ–∞–π–ª–∞: ${fileName}\n–§–æ—Ä–º–∞—Ç –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –∫–∞–∫ ${mime}`;
}
</script>
</body>
</html>

