<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Table Scanner Pro v2.0</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --text: #f1f5f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 1200px; }
        .upload-zone { border: 3px dashed var(--accent); background: var(--card); border-radius: 15px; padding: 30px; text-align: center; cursor: pointer; margin-bottom: 20px; }
        .preview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: var(--card); padding: 15px; border-radius: 10px; overflow: hidden; }
        canvas { width: 100%; height: auto; border: 1px solid #444; background: #000; }
        .result-container { background: white; color: #333; padding: 10px; border-radius: 8px; overflow-x: auto; min-height: 400px; }
        table { border-collapse: collapse; width: 100%; font-size: 12px; }
        td { border: 1px solid #999; padding: 8px; min-width: 50px; outline: none; }
        td:focus { background: #e0f2fe; border: 2px solid var(--accent); }
        .status-bar { margin: 15px 0; padding: 10px; border-radius: 5px; background: rgba(56, 189, 248, 0.1); border-left: 5px solid var(--accent); }
        .loader { display: none; width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .controls { margin-top: 10px; display: flex; gap: 10px; }
        button { background: var(--accent); color: var(--bg); border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        @media (max-width: 768px) { .preview-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
        <h2>üì∏ –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É</h2>
        <input type="file" id="fileInput" hidden accept="image/*">
        <p>–î–ª—è –ª—É—á—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–µ—Ä–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω —Ä–æ–≤–Ω–æ –Ω–∞–¥ –ª–∏—Å—Ç–æ–º</p>
    </div>

    <div id="status" class="status-bar">–°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞...</div>
    <div id="loader" class="loader"></div>

    <div class="preview-grid">
        <div class="card">
            <h3>–û–±—Ä–∞–±–æ—Ç–∫–∞ (Computer Vision)</h3>
            <canvas id="canvas"></canvas>
        </div>
        <div class="card">
            <h3>–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è (–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–∞—è)</h3>
            <div id="resultContainer" class="result-container"></div>
            <div class="controls">
                <button onclick="exportCSV()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Excel/CSV</button>
            </div>
        </div>
    </div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const status = document.getElementById('status');
    const loader = document.getElementById('loader');

    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const img = new Image();
            img.onload = () => {
                const maxDim = 1500; // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
                let w = img.width, h = img.height;
                if (w > maxDim || h > maxDim) {
                    const ratio = Math.min(maxDim/w, maxDim/h);
                    w *= ratio; h *= ratio;
                }
                canvas.width = w; canvas.height = h;
                ctx.drawImage(img, 0, 0, w, h);
                preprocessImage(); 
                startOCR();
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    };

    // –£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–µ—Ä–µ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ–º
    function preprocessImage() {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            const avg = (data[i] + data[i+1] + data[i+2]) / 3;
            // –ü–æ—Ä–æ–≥ –±–∏–Ω–∞—Ä–∏–∑–∞—Ü–∏–∏ (—É–±–∏—Ä–∞–µ–º —Å–µ—Ä—ã–µ —Ç–µ–Ω–∏ —Å—Ç–æ–ª–∞)
            const threshold = 140; 
            const val = avg > threshold ? 255 : 0;
            data[i] = data[i+1] = data[i+2] = val;
        }
        ctx.putImageData(imageData, 0, 0);
        status.innerText = "–°—Ç–∞—Ç—É—Å: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—á–∏—â–µ–Ω–æ. –ó–∞–ø—É—Å–∫ –ò–ò...";
    }

    async function startOCR() {
        loader.style.display = "block";
        try {
            const worker = await Tesseract.createWorker('rus+eng');
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Tesseract –Ω–∞ –ø–æ–∏—Å–∫ –±–ª–æ–∫–æ–≤ (—Ç–∞–±–ª–∏—Ü)
            await worker.setParameters({
                tessedit_pageseg_mode: Tesseract.PSM.SPARSE_TEXT,
            });
            
            const { data } = await worker.recognize(canvas);
            buildSmartTable(data.words);
            
            await worker.terminate();
            status.innerText = "–°—Ç–∞—Ç—É—Å: –ì–æ—Ç–æ–≤–æ! –í—ã –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –≤ —è—á–µ–π–∫–∞—Ö.";
        } catch (err) {
            status.innerText = "–û—à–∏–±–∫–∞: " + err.message;
        } finally {
            loader.style.display = "none";
        }
    }

    function buildSmartTable(words) {
        const container = document.getElementById('resultContainer');
        container.innerHTML = "";
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å–ª–æ–≤–∞ –≤ —Å—Ç—Ä–æ–∫–∏ –ø–æ Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–µ
        const rowThreshold = 15; 
        let lines = [];
        
        words.forEach(w => {
            let found = false;
            for (let line of lines) {
                if (Math.abs(w.bbox.y0 - line.y) < rowThreshold) {
                    line.words.push(w);
                    found = true;
                    break;
                }
            }
            if (!found) lines.push({ y: w.bbox.y0, words: [w] });
        });

        lines.sort((a, b) => a.y - b.y);

        const table = document.createElement('table');
        lines.forEach(line => {
            const tr = document.createElement('tr');
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–ª–æ–≤–∞ –≤ —Å—Ç—Ä–æ–∫–µ –ø–æ X
            line.words.sort((a, b) => a.bbox.x0 - b.bbox.x0);
            
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–Ω—è—Ç—å, –∫–æ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–æ–≤–∞—è —è—á–µ–π–∫–∞ (–±–æ–ª—å—à–æ–π –ø—Ä–æ–±–µ–ª)
            let currentCellText = [];
            line.words.forEach((w, i) => {
                currentCellText.push(w.text);
                const nextW = line.words[i+1];
                if (!nextW || (nextW.bbox.x0 - w.bbox.x1) > 20) {
                    const td = document.createElement('td');
                    td.contentEditable = true;
                    td.innerText = currentCellText.join(" ");
                    tr.appendChild(td);
                    currentCellText = [];
                }
            });
            table.appendChild(tr);
        });
        container.appendChild(table);
    }

    function exportCSV() {
        let csv = "";
        document.querySelectorAll("table tr").forEach(tr => {
            let row = [];
            tr.querySelectorAll("td").forEach(td => row.push(`"${td.innerText.replace(/"/g, '""')}"`));
            csv += row.join(",") + "\n";
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "table_export.csv";
        link.click();
    }
</script>

</body>
</html>
