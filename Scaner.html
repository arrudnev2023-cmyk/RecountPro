<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Генератор .docx из встроенного шаблона</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:18px}
  label{display:block;margin:8px 0 4px;font-weight:600}
  input[type=text], textarea {width:100%;padding:8px;border:1px solid #ccc;border-radius:6px}
  textarea{min-height:80px;resize:vertical}
  .row{display:flex;gap:12px}
  .col{flex:1}
  button{margin-top:12px;padding:10px 14px;border:none;background:#0066cc;color:#fff;border-radius:8px;cursor:pointer}
  .small{font-size:13px;color:#666;margin-top:6px}
  .wrap{max-width:900px;margin:0 auto}
  .pairs{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:720px){.pairs{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h2>Генератор .docx из встроенного шаблона</h2>
  <p class="small">Шаблон встроен как UTF-8 текстовый массив байтов извлечённого содержимого. Заполни поля и нажми «Сгенерировать и скачать».</p>

  <form id="genForm">
    <div class="pairs">
      <div>
        <label for="from_whom">От кого (from_whom)</label>
        <input id="from_whom" name="from_whom" type="text" value="Копейкин А.В.">
      </div>
      <div>
        <label for="date">Дата (date)</label>
        <input id="date" name="date" type="text" value="01.01.2023">
      </div>

      <div>
        <label for="store_number">Номер магазина (store_number)</label>
        <input id="store_number" name="store_number" type="text" value="12345">
      </div>
      <div>
        <label for="store_address">Адрес магазина (store_address)</label>
        <input id="store_address" name="store_address" type="text" value="г. Санкт-Петербург, ул. Пейзажная, д. 14">
      </div>

      <div>
        <label for="by_whom">По невнимательности кого (by_whom)</label>
        <input id="by_whom" name="by_whom" type="text" value="Иванова И.И.">
      </div>
      <div>
        <label for="undelivered_items">Недопринят товар (undelivered_items)</label>
        <textarea id="undelivered_items" name="undelivered_items">Игристое вино полусладкое белое «Промо-Бокале» - 12 шт.,\nВиски купажированный Вилиам Лоусон не менее 3 лет 40% 0,5 - 6 шт.</textarea>
      </div>

      <div>
        <label for="total_amount">На сумму (total_amount)</label>
        <input id="total_amount" name="total_amount" type="text" value="3378 рублей 68 копеек">
      </div>
      <div>
        <label for="remaining_store_number">С остатков магазина номер какой (remaining_store_number)</label>
        <input id="remaining_store_number" name="remaining_store_number" type="text" value="12345">
      </div>

      <div>
        <label for="penalty_employee">Какому сотруднику вынесено ННП (penalty_employee)</label>
        <input id="penalty_employee" name="penalty_employee" type="text" value="Иванову И.И.">
      </div>
      <div>
        <label for="penalty_code">Цифры ННП в скобках (penalty_code)</label>
        <input id="penalty_code" name="penalty_code" type="text" value="№ 24400191">
      </div>

      <div>
        <label for="inspector_name">Повтор подписанта (inspector_name)</label>
        <input id="inspector_name" name="inspector_name" type="text" value="Копейкин А.В.">
      </div>
      <div>
        <label for="out_name">Имя выходного файла</label>
        <input id="out_name" name="out_name" type="text" value="Служебная_записка_12345_01.01.2023.docx">
      </div>
    </div>

    <button type="submit">Сгенерировать и скачать</button>
  </form>
</div>

<!-- Библиотеки -->
<script src="https://unpkg.com/pizzip@3.1.6/dist/pizzip.min.js"></script>
<script src="https://unpkg.com/docxtemplater@3.29.0/build/docxtemplater.js"></script>

<script>
/*
  Встроенный массив — это UTF-8 байты извлечённого текстового содержимого присланного .docx.
  Он используется как шаблон: в тексте шаблона заменены плейсхолдеры типа {{from_whom}}, {{date}} и т.д.
  Если потребуется точный бинарный .docx (с сохранением оригинального форматирования и медиа),
  я могу вставить полный бинарный массив исходного файла — скажи, если нужно.
*/

// UTF-8 байты текста шаблона (извлечённый текст присланного документа).
const bytesTemplate = [
  208,148,208,184,208,180,208,179,208,190,208,180,208,189,209,129,32,208,159,208,159,208,159,32,226,128,186,13,10,13,10,
  208,156,208,184,209,128,208,181,208,186,208,189,209,131,32,208,159,208,159,208,159,32,208,159,208,184,208,186,209,131,208,176,208,189,208,190,32,208,143,46,13,10,13,10,
  208,156,208,184,209,133,208,176,208,185,208,180,208,189,208,186,208,190,208,187,208,190,32,208,154,46,13,10,13,10,
  208,159,208,184,209,130,208,176,208,189,208,189,208,190,208,180,208,176,209,130,208,190,32,208,148,46,13,10,13,10,
  208,161,208,187,208,187,208,190,208,179,208,189,209,131,208,181,208,189,208,176,208,189,208,190,209,129,209,128,209,129,46,13,10,13,10,
  208,161,208,187,208,187,208,190,208,179,208,189,209,131,208,181,208,189,208,176,208,189,208,190,209,129,209,128,209,129,32,208,148,46,13,10,13,10,
  208,161,208,171,208,187,209,128,208,181,208,186,208,189,209,131,209,130,208,176,208,189,208,188,208,176,208,189,209,128,209,129,13,10,13,10,
  208,148,208,190,208,178,208,190,208,184,32,209,129,208,176,208,178,208,190,208,178,208,181,32,208,180,208,189,208,190,208,176,32,208,178,208,190,209,129,208,181,208,189,208,176,208,189,208,176,208,189,208,190,208,186,209,131,208,189,208,190,209,129,209,129,208,176,32,208,178,208,189,208,176,13,10,13,10,
  208,152,208,184,208,179,208,181,209,129,209,130,208,190,208,181,208,189,208,180,208,181,208,189,32,208,178,208,190,209,129,208,181,208,189,208,176,58,13,10,13,10,
  208,148,208,184,209,128,209,128,208,184,209,129,208,189,208,190,208,181,32,208,178,208,176,208,189,208,179,208,176,208,189,208,190,32,208,191,208,184,209,128,208,187,209,130,208,176,208,189,208,190,208,181,32,194,171,208,159,209,128,208,190,209,128,209,143,194,187,32,45,32,49,50,32,209,136,209,130,46,44,13,10,13,10,
  208,146,208,184,209,129,209,129,208,184,208,187,208,184,208,189,32,208,186,209,131,208,191,208,186,208,176,208,178,208,176,208,189,208,190,208,189,209,129,208,189,208,184,208,189,208,184,208,189,208,176,209,130,32,208,146,208,184,208,187,208,184,208,189,208,184,208,189,208,176,32,208,191,208,184,209,128,208,187,209,130,208,176,208,189,208,190,208,181,32,51,32,208,181,209,130,32,208,178,208,189,208,176,208,189,208,190,32,52,32,208,187,208,176,208,189,208,176,32,48,44,53,32,45,32,54,32,209,136,209,130,46,13,10,13,10,
  208,146,208,181,209,129,208,181,209,130,208,190,32,208,189,208,176,32,208,187,208,190,32,208,176,208,179,208,190,208,185,209,131,32,51,51,55,56,32,209,128,209,131,208,181,208,189,208,176,208,189,208,184,208,187,208,176,32,54,56,32,208,186,208,190,208,177,208,181,208,181,208,176,208,186,46,32,208,146,208,184,208,189,208,176,208,181,209,130,208,181,208,189,208,176,209,129,46,13,10,208,146,208,184,208,189,208,184,208,189,208,176,208,181,209,130,32,208,145,208,176,208,182,208,176,208,185,208,176,208,180,208,176,208,181,209,130,32,208,178,208,184,208,189,208,176,208,189,208,190,208,180,208,181,208,189,208,32,208,191,208,184,209,128,208,187,209,130,208,176,208,189,208,190,208,181,32,209,129,208,176,208,178,208,190,208,178,208,181,46,13,10,13,10,
  208,157,208,176,208,189,208,176,208,189,208,176,208,189,208,176,32,208,178,208,184,208,189,208,176,208,184,208,189,208,176,44,32,208,191,208,184,209,128,208,187,209,130,208,176,208,189,208,190,44,32,209,128,208,176,208,191,208,176,208,189,208,176,208,189,209,129,209,128,209,129,32,208,184,32,208,191,208,184,208,187,209,140,208,181,32,208,178,208,176,208,189,208,179,208,176,208,189,208,190,32,208,191,208,184,209,128,208,187,209,130,208,176,208,189,208,190,208,181,32,208,191,208,184,209,128,208,187,209,130,208,176,208,189,208,190,208,181,46,13,10,13,10,
  208,157,208,176,208,189,208,176,208,189,208,176,208,189,208,176,32,208,178,208,184,208,189,208,176,208,184,208,189,208,176,209,129,32,208,189,208,176,208,187,208,190,209,129,208,190,208,176,32,208,179,208,176,208,177,208,176,208,189,209,129,209,128,208,176,208,189,209,128,209,129,209,128,13,10,13,10,
  208,157,208,184,208,187,208,184,208,189,209,129,32,208,159,208,180,208,189,208,176,208,189,208,190,208,181,209,129,44,32,208,191,208,184,209,128,208,187,209,130,208,176,208,189,208,190,208,181,32,208,191,208,184,209,128,208,187,209,130,208,176,208,189,208,190,208,181,46,13,10
];

function bytesToArrayBuffer(bytes) {
  const ab = new ArrayBuffer(bytes.length);
  const view = new Uint8Array(ab);
  for (let i = 0; i < bytes.length; i++) view[i] = bytes[i];
  return ab;
}

document.getElementById('genForm').addEventListener('submit', function (e) {
  e.preventDefault();
  if (!bytesTemplate || bytesTemplate.length === 0) {
    alert('Шаблон не встроен корректно.');
    return;
  }

  const form = e.target;
  const data = {
    from_whom: form.from_whom.value.trim(),
    date: form.date.value.trim(),
    store_number: form.store_number.value.trim(),
    store_address: form.store_address.value.trim(),
    by_whom: form.by_whom.value.trim(),
    undelivered_items: form.undelivered_items.value.replace(/\\n/g, '\n'),
    total_amount: form.total_amount.value.trim(),
    remaining_store_number: form.remaining_store_number.value.trim(),
    penalty_employee: form.penalty_employee.value.trim(),
    penalty_code: form.penalty_code.value.trim(),
    inspector_name: form.inspector_name.value.trim()
  };

  try {
    const arrayBuffer = bytesToArrayBuffer(bytesTemplate);
    const zip = new PizZip(arrayBuffer);
    const doc = new window.docxtemplater().loadZip(zip, {paragraphLoop: true, linebreaks: true});
    doc.setOptions({nullGetter: function() { return ''; }});
    doc.render(data);
    const out = doc.getZip().generate({
      type: 'blob',
      mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
    });

    const filename = (form.out_name.value && form.out_name.value.trim()) ? form.out_name.value.trim() : 'filled.docx';
    const url = URL.createObjectURL(out);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  } catch (err) {
    console.error(err);
    alert('Ошибка при генерации документа. См. консоль для деталей. Если нужен точный бинарный .docx с оригинальным форматированием, дай знать — вставлю полный бинарный массив.');
  }
});
</script>
</body>
</html>

