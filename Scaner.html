<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Простой сканер — показать название</title>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:20px;background:#f7f7fb;color:#111}
  #video{width:100%;max-width:420px;border-radius:8px;background:#000;display:block}
  .panel{max-width:980px;margin:auto;background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  .status{margin-top:10px;color:#666}
  .name{margin-top:14px;font-size:18px;font-weight:700}
  .notfound{color:#b33;font-weight:700}
  button{margin-top:10px;padding:8px 10px;border-radius:8px;border:0;background:#1976ff;color:#fff;cursor:pointer}
  button.ghost{background:#eee;color:#111}
</style>
</head>
<body>
  <div class="panel">
    <h2>Наведи камеру на штрихкод — покажу название</h2>
    <video id="video" autoplay playsinline></video>
    <div class="status" id="status">Ожидаю сканирования…</div>
    <div id="result"></div>
    <div>
      <button id="toggle">Остановить камеру</button>
      <button id="clear" class="ghost">Очистить</button>
    </div>
  </div>

<script>
const OFF_API = code => `https://world.openfoodfacts.org/api/v0/product/${encodeURIComponent(code)}.json`;
const video = document.getElementById('video');
const status = document.getElementById('status');
const result = document.getElementById('result');
const toggleBtn = document.getElementById('toggle');
const clearBtn = document.getElementById('clear');

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

/* Простая IndexedDB-кешировка по ean */
const DB = 'simple_off_cache';
const STORE = 'products';
function openDB(){ return new Promise((res,rej)=>{ const r = indexedDB.open(DB,1); r.onupgradeneeded = ()=> r.result.createObjectStore(STORE, { keyPath: 'ean' }); r.onsuccess = ()=> res(r.result); r.onerror = ()=> rej(r.error); }); }
async function idbGet(ean){ const db = await openDB(); return new Promise((res,rej)=>{ const tx = db.transaction(STORE,'readonly').objectStore(STORE).get(ean); tx.onsuccess = ()=> res(tx.result?.data || null); tx.onerror = ()=> rej(tx.error); }); }
async function idbPut(ean,data){ const db = await openDB(); return new Promise((res,rej)=>{ const tx = db.transaction(STORE,'readwrite').objectStore(STORE).put({ ean, data }); tx.onsuccess = ()=> res(true); tx.onerror = ()=> rej(tx.error); }); }

/* Запрос к OFF с кешем */
async function lookupEAN(ean){
  // сначала в кеше
  const cached = await idbGet(ean);
  if(cached) return cached;
  // затем в Open Food Facts
  try{
    const res = await fetch(OFF_API(ean));
    if(!res.ok) return null;
    const j = await res.json();
    if(j.status === 1 && j.product){
      const p = {
        ean,
        name: j.product.product_name || j.product.generic_name || j.product.brands || null,
        image: j.product.image_small_url || j.product.image_url || null,
        raw: j.product
      };
      await idbPut(ean, p);
      return p;
    }
    // not found -> cache negative to avoid repeated queries
    await idbPut(ean, { ean, name: null });
    return null;
  } catch(e){ console.debug('OFF error', e); return null; }
}

/* ZXing scanner */
const codeReader = new ZXing.BrowserMultiFormatReader();
let streaming = false;
let last = { code:null, time:0 };

async function handleCode(code){
  const now = Date.now();
  if(code === last.code && now - last.time < 1200) return; // debounce duplicate reads
  last = { code, time: now };
  status.textContent = 'Считан: ' + code;
  result.innerHTML = '<div>Ищу название...</div>';
  const p = await lookupEAN(code);
  if(p && p.name){
    result.innerHTML = `<div class="name">✅ ${escapeHtml(p.name)}</div><div><small>EAN: ${escapeHtml(code)}</small></div>`;
  } else if(p && p.name === null){
    result.innerHTML = `<div class="notfound">❌ Товар не найден: ${escapeHtml(code)}</div>`;
  } else {
    result.innerHTML = `<div class="notfound">❌ Ошибка или товар не найден: ${escapeHtml(code)}</div>`;
  }
}

function startCamera(){
  codeReader.listVideoInputDevices().then(devices=>{
    const prefer = devices.find(d=>/back|rear|environment/i.test(d.label)) || devices[0];
    codeReader.decodeFromVideoDevice(prefer.deviceId, video, (result, err) => {
      if(result) handleCode(result.text);
    });
    streaming = true;
    toggleBtn.textContent = 'Остановить камеру';
    status.textContent = 'Камера включена. Наведи на штрихкод.';
  }).catch(err=>{
    status.textContent = 'Ошибка камеры: ' + (err && err.message || err);
  });
}
function stopCamera(){ try{ codeReader.reset(); }catch(e){} streaming=false; toggleBtn.textContent='Запустить камеру'; status.textContent='Камера остановлена'; }

toggleBtn.addEventListener('click', ()=> streaming ? stopCamera() : startCamera());
clearBtn.addEventListener('click', ()=> { result.innerHTML=''; status.textContent='Очищено'; });

// старт
startCamera();
</script>
</body>
</html>
