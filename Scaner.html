<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Table Extractor</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #preview { max-width: 400px; margin-top: 20px; }
    table { border-collapse: collapse; margin-top: 20px; }
    td, th { border: 1px solid #ccc; padding: 6px 10px; }
  </style>
</head>
<body>

<h2>üìÑ Table Extractor</h2>

<input type="file" id="fileInput" accept="image/*">

<img id="preview">

<div id="result"></div>

<script>
let cvReady = false;
document.addEventListener("opencvready", () => cvReady = true);

document.getElementById("fileInput").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const img = document.getElementById("preview");
  img.src = URL.createObjectURL(file);

  img.onload = async () => {
    if (!cvReady) {
      alert("OpenCV –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –ø–æ–¥–æ–∂–¥–∏ —Å–µ–∫—É–Ω–¥—É");
      return;
    }

    const table = await extractTable(img);
    renderTable(table);
  };
});

async function extractTable(img) {
  // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ OpenCV
  let src = cv.imread(img);
  let gray = new cv.Mat();
  cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

  // 2. –ë–∏–Ω–∞—Ä–∏–∑–∞—Ü–∏—è
  let thresh = new cv.Mat();
  cv.adaptiveThreshold(gray, thresh, 255, cv.ADAPTIVE_THRESH_MEAN_C, cv.THRESH_BINARY_INV, 15, 10);

  // 3. –ù–∞—Ö–æ–¥–∏–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
  let horizontal = thresh.clone();
  let horizontalsize = Math.floor(horizontal.cols / 20);
  let horizontalStructure = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(horizontalsize, 1));
  cv.erode(horizontal, horizontal, horizontalStructure);
  cv.dilate(horizontal, horizontal, horizontalStructure);

  // 4. –ù–∞—Ö–æ–¥–∏–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
  let vertical = thresh.clone();
  let verticalsize = Math.floor(vertical.rows / 20);
  let verticalStructure = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(1, verticalsize));
  cv.erode(vertical, vertical, verticalStructure);
  cv.dilate(vertical, vertical, verticalStructure);

  // 5. –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è ‚Üí —Å–µ—Ç–∫–∞
  let mask = new cv.Mat();
  cv.bitwise_and(horizontal, vertical, mask);

  // 6. –ö–æ–Ω—Ç—É—Ä—ã —è—á–µ–µ–∫
  let contours = new cv.MatVector();
  let hierarchy = new cv.Mat();
  cv.findContours(mask, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

  let cells = [];

  for (let i = 0; i < contours.size(); i++) {
    let rect = cv.boundingRect(contours.get(i));
    if (rect.width < 40 || rect.height < 20) continue;

    let cellMat = src.roi(rect);
    let text = await ocrCell(cellMat);

    cells.push({
      x: rect.x,
      y: rect.y,
      w: rect.width,
      h: rect.height,
      text
    });

    cellMat.delete();
  }

  src.delete(); gray.delete(); thresh.delete();
  horizontal.delete(); vertical.delete(); mask.delete();
  contours.delete(); hierarchy.delete();

  // 7. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —è—á–µ–µ–∫ –ø–æ —Å—Ç—Ä–æ–∫–∞–º/–∫–æ–ª–æ–Ω–∫–∞–º
  cells.sort((a, b) => a.y - b.y || a.x - b.x);

  return buildTableStructure(cells);
}

async function ocrCell(mat) {
  let canvas = document.createElement("canvas");
  cv.imshow(canvas, mat);

  const { data: { text } } = await Tesseract.recognize(canvas, "rus+eng", {
    tessedit_pageseg_mode: 6
  });

  return text.trim();
}

function buildTableStructure(cells) {
  let rows = [];
  let currentRow = [];
  let lastY = cells[0]?.y || 0;

  for (let cell of cells) {
    if (Math.abs(cell.y - lastY) > 20) {
      rows.push(currentRow);
      currentRow = [];
      lastY = cell.y;
    }
    currentRow.push(cell);
  }
  rows.push(currentRow);

  return rows;
}

function renderTable(rows) {
  let html = "<table>";

  for (let row of rows) {
    html += "<tr>";
    for (let cell of row) {
      html += `<td contenteditable="true">${cell.text}</td>`;
    }
    html += "</tr>";
  }

  html += "</table>";

  document.getElementById("result").innerHTML = html;
}
</script>

</body>
</html>
