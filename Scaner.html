<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ë–∞–∑–∞ —à—Ç—Ä–∏—Ö‚Äë–∫–æ–¥–æ–≤</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
    body {
        margin: 0;
        background: #f4f6f8;
        font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
    }

    header {
        background: #1e88e5;
        color: white;
        padding: 15px;
        font-size: 22px;
        text-align: center;
        font-weight: bold;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .container {
        padding: 15px;
        max-width: 900px;
        margin: auto;
    }

    .card {
        background: white;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    h2 {
        margin-top: 0;
        font-size: 20px;
        color: #333;
    }

    input, textarea, button {
        width: 100%;
        padding: 12px;
        margin-top: 8px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 16px;
        box-sizing: border-box;
    }

    button {
        background: #1e88e5;
        color: white;
        border: none;
        font-weight: bold;
        transition: 0.2s;
    }

    button:hover {
        background: #1565c0;
    }

    /* –¢–∞–±–ª–∏—Ü–∞ */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        table-layout: fixed;
    }

    th, td {
        border-bottom: 1px solid #ddd;
        padding: 10px;
        word-break: break-word;
        vertical-align: top;
    }

    th {
        background: #f0f0f0;
        font-weight: bold;
    }

    th:first-child, td:first-child {
        width: 120px;
    }

    .found {
        font-size: 18px;
        margin-top: 10px;
        font-weight: bold;
        color: #1e88e5;
    }

    /* –°–∫–∞–Ω–µ—Ä */
    #preview {
        width: 100%;
        border-radius: 12px;
        margin-top: 10px;
    }

    #frame {
        position: absolute;
        border: 3px solid #ff5252;
        width: 80%;
        height: 80px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
        border-radius: 8px;
    }

    .scanner-wrapper {
        position: relative;
        max-width: 400px;
        margin: auto;
    }
</style>
</head>
<body>

<header>–ë–∞–∑–∞ —à—Ç—Ä–∏—Ö‚Äë–∫–æ–¥–æ–≤</header>

<div class="container">

    <div class="card">
        <h2>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–º–µ—Ä–æ–π</h2>

        <button onclick="startScanner()">üì∑ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
        <button onclick="switchCamera()" style="background:#6a1b9a;margin-top:10px;">üîÑ –°–º–µ–Ω–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
        <button onclick="stopScanner()" style="background:#e53935;margin-top:10px;">‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>

        <div class="scanner-wrapper">
            <video id="preview" playsinline></video>
            <div id="frame"></div>
        </div>

        <div id="scanResult" class="found"></div>
    </div>

    <div class="card">
        <h2>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –≤—Ä—É—á–Ω—É—é</h2>
        <input id="code" placeholder="–®—Ç—Ä–∏—Ö‚Äë–∫–æ–¥">
        <input id="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
        <button onclick="addItem()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>

    <div class="card">
        <h2>–ü–æ–∏—Å–∫ –ø–æ —à—Ç—Ä–∏—Ö‚Äë–∫–æ–¥—É</h2>
        <input id="scanInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥" oninput="scanCodeManual()">
        <div id="manualResult" class="found"></div>
    </div>

    <div class="card">
        <h2>–ú–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç</h2>
        <textarea id="bulk" rows="6" placeholder='"4600605026533": "–ú–æ–ª–æ–∫–æ"
"4810268035258": "–°—ã—Ä —Ä–æ—Å—Å–∏–π—Å–∫–∏–π"'></textarea>
        <button onclick="bulkImport()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>

    <div class="card">
        <h2>–ë–∞–∑–∞ —Ç–æ–≤–∞—Ä–æ–≤</h2>
        <table id="table">
            <thead>
                <tr><th>–®—Ç—Ä–∏—Ö‚Äë–∫–æ–¥</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
let db = JSON.parse(localStorage.getItem("barcodeDB") || "{}");
let currentDeviceId = null;
let devices = [];
let stream = null;
let usingBarcodeDetector = false;

const allowedFormats = ["ean_13", "ean_8", "upc_a", "upc_e", "code_128", "code_39", "itf"];

// ---------- –ë–ê–ó–ê ----------
function saveDB() {
    localStorage.setItem("barcodeDB", JSON.stringify(db));
    renderTable();
}

function renderTable() {
    const tbody = document.querySelector("#table tbody");
    tbody.innerHTML = "";
    Object.keys(db).forEach(code => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${code}</td><td>${db[code]}</td>`;
        tbody.appendChild(tr);
    });
}

function addItem() {
    const code = document.getElementById("code").value.trim();
    const name = document.getElementById("name").value.trim();
    if (!code || !name) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ");
    db[code] = name;
    saveDB();
    document.getElementById("code").value = "";
    document.getElementById("name").value = "";
}

function bulkImport() {
    const text = document.getElementById("bulk").value.trim();
    const lines = text.split("\n");
    lines.forEach(line => {
        const match = line.match(/"(\d+)":\s*"(.+?)"/);
        if (match) db[match[1]] = match[2];
    });
    saveDB();
    alert("–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω");
}

function scanCodeManual() {
    const code = document.getElementById("scanInput").value.trim();
    document.getElementById("manualResult").innerText =
        db[code] ? `${code} ‚Üí ${db[code]}` : (code ? "–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω" : "");
}

// ---------- –°–ö–ê–ù–ï–† ----------

async function startScanner() {
    stopScanner();

    devices = await navigator.mediaDevices.enumerateDevices();
    devices = devices.filter(d => d.kind === "videoinput");

    const back = devices.find(d => /back|environment/gi.test(d.label));
    currentDeviceId = back ? back.deviceId : devices[0].deviceId;

    await startStream();
}

async function switchCamera() {
    if (!devices.length) return;

    const index = devices.findIndex(d => d.deviceId === currentDeviceId);
    const next = (index + 1) % devices.length;

    currentDeviceId = devices[next].deviceId;

    await startStream();
}

async function startStream() {
    stopScanner();

    stream = await navigator.mediaDevices.getUserMedia({
        video: {
            deviceId: currentDeviceId,
            focusMode: "continuous"
        }
    });

    const preview = document.getElementById("preview");
    preview.srcObject = stream;
    preview.play();

    if ("BarcodeDetector" in window) {
        usingBarcodeDetector = true;
        runBarcodeDetector();
    } else {
        usingBarcodeDetector = false;
        runZXing();
    }
}

async function runBarcodeDetector() {
    const detector = new BarcodeDetector({
        formats: ["ean_13", "ean_8", "code_128", "code_39", "upc_a", "upc_e", "itf"]
    });

    const preview = document.getElementById("preview");

    async function scan() {
        if (!usingBarcodeDetector) return;

        try {
            const barcodes = await detector.detect(preview);

            if (barcodes.length > 0) {
                const code = barcodes[0].rawValue;
                const name = db[code] || "–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω";
                document.getElementById("scanResult").innerText = `${code} ‚Üí ${name}`;
            }
        } catch {}

        requestAnimationFrame(scan);
    }

    scan();
}

function runZXing() {
    const preview = document.getElementById("preview");
    const reader = new ZXing.BrowserMultiFormatReader();

    reader.decodeFromVideoDevice(currentDeviceId, preview, (result, err) => {
        if (result) {
            const code = result.text;
            const name = db[code] || "–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω";
            document.getElementById("scanResult").innerText = `${code} ‚Üí ${name}`;
        }
    });
}

function stopScanner() {
    usingBarcodeDetector = false;

    const preview = document.getElementById("preview");

    if (preview.srcObject) {
        preview.srcObject.getTracks().forEach(t => t.stop());
        preview.srcObject = null;
    }
}

renderTable();
</script>

</body>
</html>
