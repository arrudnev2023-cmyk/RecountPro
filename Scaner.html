<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤ ‚Äî 1C style</title>

<!-- ZXing –¥–ª—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è -->
<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
  :root{--bg:#f6f7fb;--card:#fff;--accent:#0b76ff;--muted:#666}
  body{margin:0;font-family:Inter,Roboto,Arial,sans-serif;background:var(--bg);color:#111}
  .wrap{max-width:980px;margin:14px auto;padding:14px}
  header{display:flex;align-items:center;gap:12px}
  h1{font-size:18px;margin:0}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:14px;margin-top:12px}
  @media(max-width:920px){.grid{grid-template-columns:1fr}}
  .panel{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(12,15,30,0.06)}
  #video{width:100%;height:360px;background:#000;border-radius:8px;object-fit:cover}
  .controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  button{border:0;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600;background:var(--accent);color:#fff}
  button.ghost{background:#eef2ff;color:#111}
  .status{margin-top:8px;color:var(--muted);font-size:14px}
  .result{margin-top:12px;min-height:120px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px}
  .card{display:flex;gap:12px;align-items:flex-start;width:100%}
  .thumb{width:120px;height:90px;background:#f0f0f3;border-radius:8px;flex:0 0 120px;display:flex;align-items:center;justify-content:center;color:var(--muted);overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .meta h3{margin:0;font-size:16px}
  .meta p{margin:6px 0;color:var(--muted)}
  .meta .price{font-weight:700;color:#111}
  .sidebar .section{margin-bottom:12px}
  .hint{font-size:13px;color:var(--muted)}
  .notfound{color:#b33;font-weight:700}
  .small{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>üì¶ –ë—ã—Å—Ç—Ä—ã–π —Å–∫–∞–Ω–µ—Ä ‚Äî –∫–∞–∫ –≤ 1C</h1>
  </header>

  <div class="grid">
    <main class="panel">
      <video id="video" autoplay playsinline></video>
      <div class="status" id="status">–û–∂–∏–¥–∞—é —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è‚Ä¶</div>

      <div class="result" id="resultArea">
        <div class="hint">–ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥ ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ</div>
      </div>

      <div class="controls">
        <button id="toggleCam">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
        <button id="clearRes" class="ghost">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <button id="prefetchHot" class="ghost">–ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∏—Ç—å –≥–æ—Ä—è—á–∏–µ –ø—Ä–µ—Ñ–∏–∫—Å—ã</button>
      </div>
      <div class="small" style="margin-top:8px">–õ–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –º–æ–∂–Ω–æ –ø—Ä–∞–≤–∏—Ç—å –≤ PRODUCTS. –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –∏—â–µ–º –≤ —á–∞–Ω–∫–µ –ø—Ä–µ—Ñ–∏–∫—Å–∞, –∑–∞—Ç–µ–º –≤ Open Food Facts (–∫—ç—à–∏—Ä—É–µ—Ç—Å—è).</div>
    </main>

    <aside class="panel sidebar">
      <div class="section">
        <h3 style="margin:0 0 8px 0">–ö–æ—Ä–∑–∏–Ω–∞ (–¥–µ–º–æ)</h3>
        <div id="cart" class="small hint">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="clearCart" class="ghost">–û—á–∏—Å—Ç–∏—Ç—å</button>
          <button id="showCart" class="ghost">–ü–æ–∫–∞–∑–∞—Ç—å JSON</button>
        </div>
      </div>

      <div class="section">
        <h3 style="margin:0 0 8px 0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
        <div class="small">Chunks base: <code id="chunksBase">./chunks/</code></div>
        <div style="margin-top:8px" class="small">–ü—Ä–µ—Ñ–∏–∫—Å –¥–ª–∏–Ω—ã: <strong id="prefLen">3</strong> (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ –∫–æ–¥–µ)</div>
      </div>
    </aside>
  </div>

  <footer style="text-align:center;margin-top:12px;color:var(--muted);font-size:13px">–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ scanner-1c.html –ª–æ–∫–∞–ª—å–Ω–æ –∏ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç–µ —Ä—è–¥–æ–º –ø–∞–ø–∫—É chunks/ —Å —Ñ–∞–π–ª–∞–º–∏ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤</footer>
</div>

<script>
/* ========== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ========== */
const PRODUCTS = [ // –ª–æ–∫–∞–ª—å–Ω—ã–µ –±—ã—Å—Ç—Ä—ã–µ –ø—Ä–∏–º–µ—Ä—ã
  { ean: "5901234123457", name: "Coca-Cola 0.5L", price: "79 ‚ÇΩ", image: "" },
  { ean: "4601234567890", name: "–ú–æ–ª–æ–∫–æ –î–æ–º–∏–∫ –≤ –¥–µ—Ä–µ–≤–Ω–µ 1.5%", price: "95 ‚ÇΩ", image: "" }
];
const PREFIX_LEN = 3;                // –¥–ª–∏–Ω–∞ –ø—Ä–µ—Ñ–∏–∫—Å–∞ —á–∞–Ω–∫–∞ (–¥–æ–ª–∂–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Å–±–æ—Ä–∫–µ)
const CHUNKS_BASE = './chunks/';     // –ø–∞–ø–∫–∞ —Å —Ñ–∞–π–ª–∞–º–∏ {prefix}.json –∏–ª–∏ {prefix}.json.gz
const OFF_PRODUCT_URL = 'https://world.openfoodfacts.org/api/v0/product/'; // fallback API

/* ========== IndexedDB –¥–ª—è –∫–µ—à–∞ —á–∞–Ω–∫–æ–≤ –∏ OFF-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ========== */
const DB_NAME = 'scanner_cache_db';
async function openDB(){
  return new Promise((res, rej)=>{
    const r = indexedDB.open(DB_NAME, 1);
    r.onupgradeneeded = ()=> {
      const db = r.result;
      if(!db.objectStoreNames.contains('chunks')) db.createObjectStore('chunks', { keyPath: 'prefix' });
      if(!db.objectStoreNames.contains('off')) db.createObjectStore('off', { keyPath: 'ean' });
    };
    r.onsuccess = ()=> res(r.result);
    r.onerror = ()=> rej(r.error);
  });
}
async function idbGet(store, key){
  const db = await openDB();
  return new Promise((res, rej)=>{
    const tx = db.transaction(store,'readonly').objectStore(store).get(key);
    tx.onsuccess = ()=> res(tx.result?.data || null);
    tx.onerror = ()=> rej(tx.error);
  });
}
async function idbPut(store, key, data){
  const db = await openDB();
  return new Promise((res, rej)=>{
    const tx = db.transaction(store,'readwrite').objectStore(store).put({ [store==='chunks'?'prefix':'ean']: key, data });
    tx.onsuccess = ()=> res(true);
    tx.onerror = ()=> rej(tx.error);
  });
}

/* ========== UI helpers ========== */
const video = document.getElementById('video');
const status = document.getElementById('status');
const resultArea = document.getElementById('resultArea');
const toggleCamBtn = document.getElementById('toggleCam');
const clearResBtn = document.getElementById('clearRes');
const prefetchBtn = document.getElementById('prefetchHot');
const cartEl = document.getElementById('cart');
const clearCartBtn = document.getElementById('clearCart');
const showCartBtn = document.getElementById('showCart');
document.getElementById('prefLen').textContent = PREFIX_LEN;
document.getElementById('chunksBase').textContent = CHUNKS_BASE;

let cart = JSON.parse(localStorage.getItem('scanner_cart') || '[]');
function saveCart(){ localStorage.setItem('scanner_cart', JSON.stringify(cart)); renderCart(); }
function renderCart(){
  if(!cart.length) cartEl.textContent = '–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞';
  else cartEl.innerHTML = cart.map(i=>`${i.qty}√ó ${i.name}`).join('<br>');
}
function addToCart(ean){
  const p = PRODUCTS.find(x=>x.ean===ean) || { name: ean, price: '‚Äî' };
  const ex = cart.find(i=>i.ean===ean);
  if(ex) ex.qty++;
  else cart.push({ ean, name: p.name || p.product_name || ean, qty: 1 });
  saveCart();
}

/* ========== –±—ã—Å—Ç—Ä—ã–π —Ä–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏ ========== */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }
function renderCard(product){
  const name = product.name || product.product_name || product.product_name || '';
  const img = product.image || product.image_small_url || product.image_url || '';
  const imgHtml = img ? `<img src="${escapeHtml(img)}" alt="" />` : `<div style="width:120px;height:90px;display:flex;align-items:center;justify-content:center;color:var(--muted)">–ù–µ—Ç —Ñ–æ—Ç–æ</div>`;
  const price = product.price || product.price || '‚Äî';
  return `
    <div class="card">
      <div class="thumb">${imgHtml}</div>
      <div class="meta">
        <h3>${escapeHtml(name)}</h3>
        <p class="price">${escapeHtml(price)}</p>
        <p><small>EAN: ${escapeHtml(product.ean || product.code || '')}</small></p>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button onclick="addToCart('${escapeHtml(product.ean || product.code || '')}')">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
          <button class="ghost" onclick="navigator.clipboard?.writeText('${escapeHtml(product.ean || product.code || '')}')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å EAN</button>
        </div>
      </div>
    </div>
  `;
}
function renderNotFound(code){ return `<div class="notfound">‚ùå –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω: ${escapeHtml(code)}</div>`; }

/* ========== chunks loader –∏ –ø–æ–∏—Å–∫ ========== */
const loadedChunks = new Map(); // prefix -> Map(ean->name)
async function loadChunk(prefix){
  if(loadedChunks.has(prefix)) return loadedChunks.get(prefix);
  // try idb
  const cached = await idbGet('chunks', prefix);
  if(cached){
    const m = new Map(Object.entries(cached));
    loadedChunks.set(prefix, m);
    return m;
  }
  // fetch chunk .json.gz or .json
  const gzUrl = `${CHUNKS_BASE}${encodeURIComponent(prefix)}.json.gz`;
  const plainUrl = `${CHUNKS_BASE}${encodeURIComponent(prefix)}.json`;
  try{
    let resp = await fetch(gzUrl);
    if(!resp.ok) resp = await fetch(plainUrl);
    if(!resp.ok) return null;
    const obj = await resp.json();
    await idbPut('chunks', prefix, obj);
    const map = new Map(Object.entries(obj));
    loadedChunks.set(prefix, map);
    return map;
  } catch(e){
    console.debug('chunk load err', e);
    return null;
  }
}

async function fetchOFF(ean){
  // try idb off cache
  const cached = await idbGet('off', ean);
  if(cached) return cached;
  try{
    const res = await fetch(`${OFF_PRODUCT_URL}${encodeURIComponent(ean)}.json`);
    if(!res.ok) return null;
    const j = await res.json();
    if(j.status === 1 && j.product){
      const p = {
        ean,
        name: j.product.product_name || j.product.generic_name || j.product.brands,
        image: j.product.image_small_url || j.product.image_front_small_url || j.product.image_url,
        raw: j.product
      };
      await idbPut('off', ean, p);
      return p;
    }
    return null;
  } catch(e){
    console.debug('OFF fetch err', e);
    return null;
  }
}

async function findProduct(ean){
  // 1. local small PRODUCTS
  const local = PRODUCTS.find(p=>p.ean===ean);
  if(local) return local;
  // 2. chunk by prefix
  const prefix = (ean+'').slice(0, PREFIX_LEN);
  const chunk = await loadChunk(prefix);
  if(chunk){
    const name = chunk.get(ean) || chunk[ean];
    if(name) return { ean, name, price: '‚Äî' };
  }
  // 3. offline cache / Open Food Facts
  const off = await fetchOFF(ean);
  if(off) return off;
  return null;
}

/* ========== ZXing scanner ========== */
const codeReader = new ZXing.BrowserMultiFormatReader();
let streaming = false;
let lastDetected = { code: null, time: 0 };

function startCamera(){
  codeReader.listVideoInputDevices().then(devices=>{
    if(!devices || devices.length===0) { status.textContent = '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'; return; }
    const prefer = devices.find(d=>/back|rear|environment/i.test(d.label)) || devices[0];
    codeReader.decodeFromVideoDevice(prefer.deviceId, video, (result, err) => {
      if(result) handleCode(result.text);
    });
    streaming = true; toggleCamBtn.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–º–µ—Ä—É'; status.textContent = '–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞';
  }).catch(err=> status.textContent = '–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: ' + (err && err.message || err));
}
function stopCamera(){ try{ codeReader.reset(); }catch(e){} streaming=false; toggleCamBtn.textContent='–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É'; status.textContent='–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'; }

async function handleCode(code){
  const now = Date.now();
  if(code === lastDetected.code && now - lastDetected.time < 1200) return;
  lastDetected = { code, time: now };
  status.textContent = '–°—á–∏—Ç–∞–Ω: ' + code;
  resultArea.innerHTML = '<div class="small">–ò—â—É...</div>';
  const found = await findProduct(code);
  if(found) resultArea.innerHTML = renderCard(found);
  else resultArea.innerHTML = renderNotFound(code);
}

/* ========== UI events –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ========== */
toggleCamBtn.addEventListener('click', ()=> streaming ? stopCamera() : startCamera());
clearResBtn.addEventListener('click', ()=> { resultArea.innerHTML = '<div class="hint">–û–∂–∏–¥–∞—é —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è‚Ä¶</div>'; status.textContent = '–û—á–∏—â–µ–Ω–æ'; });
prefetchBtn.addEventListener('click', async ()=>{
  // –ø—Ä–∏–º–µ—Ä –≥–æ—Ä—è—á–∏—Ö –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤ ‚Äî –º–æ–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –ø–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ –∏–ª–∏ –∑–∞–¥–∞—Ç—å –≤—Ä—É—á–Ω—É—é
  const hot = ['460','481','489','590','401','400','761']; // RU/EU/–ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –≤ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
  status.textContent = '–ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ ' + hot.join(', ');
  for(const p of hot){ await loadChunk(p); }
  status.textContent = '–ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
});
clearCartBtn.addEventListener('click', ()=> { if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?')) { cart=[]; saveCart(); } });
showCartBtn.addEventListener('click', ()=> {
  const w = window.open(); if(w){ w.document.write('<pre>'+escapeHtml(JSON.stringify(cart, null, 2))+'</pre>'); w.document.close(); }
});

renderCart();
startCamera();

/* –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è inline –∫–Ω–æ–ø–æ–∫ */
window.addToCart = addToCart;
</script>
</body>
</html>
