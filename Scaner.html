<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Генератор .docx из шаблона</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:18px}
  label{display:block;margin:8px 0 4px;font-weight:600}
  input[type=text], textarea {width:100%;padding:8px;border:1px solid #ccc;border-radius:6px}
  textarea{min-height:80px;resize:vertical}
  .row{display:flex;gap:12px}
  .col{flex:1}
  button{margin-top:12px;padding:10px 14px;border:none;background:#0066cc;color:#fff;border-radius:8px;cursor:pointer}
  .small{font-size:13px;color:#666;margin-top:6px}
  .wrap{max-width:900px;margin:0 auto}
  .pairs{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:720px){.pairs{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h2>Генератор .docx из шаблона</h2>
  <p class="small">Шаблон встроен в код в виде base64. Замените строку TEMPLATE_BASE64 на base64 вашего .docx, сохраните файл и откройте в браузере.</p>

  <form id="genForm">
    <div class="pairs">
      <div>
        <label for="from_whom">От кого (from_whom)</label>
        <input id="from_whom" name="from_whom" type="text" value="Копейкин А.В.">
      </div>
      <div>
        <label for="date">Дата (date)</label>
        <input id="date" name="date" type="text" value="01.01.2023">
      </div>

      <div>
        <label for="store_number">Номер магазина (store_number)</label>
        <input id="store_number" name="store_number" type="text" value="12345">
      </div>
      <div>
        <label for="store_address">Адрес магазина (store_address)</label>
        <input id="store_address" name="store_address" type="text" value="г. Санкт-Петербург, ул. Пейзажная, д. 14">
      </div>

      <div>
        <label for="by_whom">По невнимательности кого (by_whom)</label>
        <input id="by_whom" name="by_whom" type="text" value="Иванова И.И.">
      </div>
      <div>
        <label for="undelivered_items">Недопринят товар (undelivered_items)</label>
        <textarea id="undelivered_items" name="undelivered_items">Игристое вино полусладкое белое «Промо-Бокале» - 12 шт.,
Виски купажированный Вилиам Лоусон не менее 3 лет 40% 0,5 - 6 шт.</textarea>
      </div>

      <div>
        <label for="total_amount">На сумму (total_amount)</label>
        <input id="total_amount" name="total_amount" type="text" value="3378 рублей 68 копеек">
      </div>
      <div>
        <label for="remaining_store_number">С остатков магазина номер какой (remaining_store_number)</label>
        <input id="remaining_store_number" name="remaining_store_number" type="text" value="12345">
      </div>

      <div>
        <label for="penalty_employee">Какому сотруднику вынесено ННП (penalty_employee)</label>
        <input id="penalty_employee" name="penalty_employee" type="text" value="Иванову И.И.">
      </div>
      <div>
        <label for="penalty_code">Цифры ННП в скобках (penalty_code)</label>
        <input id="penalty_code" name="penalty_code" type="text" value="№ 24400191">
      </div>

      <div>
        <label for="inspector_name">Повтор подписанта (inspector_name)</label>
        <input id="inspector_name" name="inspector_name" type="text" value="Копейкин А.В.">
      </div>
      <div>
        <label for="out_name">Имя выходного файла</label>
        <input id="out_name" name="out_name" type="text" value="Служебная_записка_12345_01.01.2023.docx">
      </div>
    </div>

    <button type="submit">Сгенерировать и скачать</button>
  </form>
</div>

<script src="https://unpkg.com/pizzip@3.1.6/dist/pizzip.min.js"></script>
<script src="https://unpkg.com/docxtemplater@3.29.0/build/docxtemplater.js"></script>

<script>
const TEMPLATE_BASE64 = 'REPLACE_WITH_BASE64';

function base64ToArrayBuffer(base64) {
  const binary_string = atob(base64);
  const len = binary_string.length;
  const bytes = new Uint8Array(len);
  for (let i = 0; i < len; i++) bytes[i] = binary_string.charCodeAt(i);
  return bytes.buffer;
}

document.getElementById('genForm').addEventListener('submit', function (e) {
  e.preventDefault();
  if (!TEMPLATE_BASE64 || TEMPLATE_BASE64 === 'REPLACE_WITH_BASE64') {
    alert('Вставьте base64 шаблона в переменную TEMPLATE_BASE64 в коде.');
    return;
  }

  const form = e.target;
  const data = {
    from_whom: form.from_whom.value.trim(),
    date: form.date.value.trim(),
    store_number: form.store_number.value.trim(),
    store_address: form.store_address.value.trim(),
    by_whom: form.by_whom.value.trim(),
    undelivered_items: form.undelivered_items.value.replace(/\r?\n/g, '\n'),
    total_amount: form.total_amount.value.trim(),
    remaining_store_number: form.remaining_store_number.value.trim(),
    penalty_employee: form.penalty_employee.value.trim(),
    penalty_code: form.penalty_code.value.trim(),
    inspector_name: form.inspector_name.value.trim()
  };

  try {
    const arrayBuffer = base64ToArrayBuffer(TEMPLATE_BASE64);
    const zip = new PizZip(arrayBuffer);
    const doc = new window.docxtemplater().loadZip(zip, {paragraphLoop: true, linebreaks: true});
    doc.setOptions({nullGetter: function() { return ''; }});
    doc.render(data);
    const out = doc.getZip().generate({type: 'blob', mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'});
    const filename = form.out_name.value && form.out_name.value.trim() ? form.out_name.value.trim() : 'filled.docx';
    const url = URL.createObjectURL(out);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  } catch (err) {
    console.error(err);
    alert('Ошибка при генерации документа. Проверьте корректность шаблона и плейсхолдеров (см. консоль).');
  }
});
</script>
</body>
</html>
