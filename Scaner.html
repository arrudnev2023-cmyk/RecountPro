<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ë–∞–∑–∞ —à—Ç—Ä–∏—Ö‚Äë–∫–æ–¥–æ–≤</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
    body {
        margin: 0;
        background: #f4f6f8;
        font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
    }

    header {
        background: #1e88e5;
        color: white;
        padding: 15px;
        font-size: 22px;
        text-align: center;
        font-weight: bold;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .container {
        padding: 15px;
        max-width: 900px;
        margin: auto;
    }

    .card {
        background: white;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    h2 {
        margin-top: 0;
        font-size: 20px;
        color: #333;
    }

    input, textarea, button {
        width: 100%;
        padding: 12px;
        margin-top: 8px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 16px;
        box-sizing: border-box;
    }

    button {
        background: #1e88e5;
        color: white;
        border: none;
        font-weight: bold;
        transition: 0.2s;
    }

    button:hover {
        background: #1565c0;
    }

    #preview {
        width: 100%;
        border-radius: 12px;
        margin-top: 10px;
    }

    #frame {
        position: absolute;
        border: 3px solid #ff5252;
        width: 80%;
        height: 80px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
        border-radius: 8px;
    }

    .scanner-wrapper {
        position: relative;
        max-width: 400px;
        margin: auto;
    }

    .found {
        font-size: 18px;
        margin-top: 10px;
        font-weight: bold;
        color: #1e88e5;
    }
</style>
</head>
<body>

<header>–ë–∞–∑–∞ —à—Ç—Ä–∏—Ö‚Äë–∫–æ–¥–æ–≤</header>

<div class="container">

    <div class="card">
        <h2>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–º–µ—Ä–æ–π</h2>

        <button onclick="startCamera()">üì∑ –í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
        <button onclick="switchCamera()" style="background:#6a1b9a;margin-top:10px;">üîÑ –°–º–µ–Ω–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
        <button onclick="takeSnapshot()" style="background:#00897b;margin-top:10px;">üì∏ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
        <button onclick="stopCamera()" style="background:#e53935;margin-top:10px;">‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>

        <div class="scanner-wrapper">
            <video id="preview" playsinline></video>
            <div id="frame"></div>
        </div>

        <div id="scanResult" class="found"></div>
    </div>

    <div class="card">
        <h2>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –≤—Ä—É—á–Ω—É—é</h2>
        <input id="code" placeholder="–®—Ç—Ä–∏—Ö‚Äë–∫–æ–¥">
        <input id="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
        <button onclick="addItem()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>

    <div class="card">
        <h2>–ü–æ–∏—Å–∫ –ø–æ —à—Ç—Ä–∏—Ö‚Äë–∫–æ–¥—É</h2>
        <input id="scanInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥" oninput="scanCodeManual()">
        <div id="manualResult" class="found"></div>
    </div>

    <div class="card">
        <h2>–ú–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç</h2>
        <textarea id="bulk" rows="6" placeholder='"4600605026533": "–ú–æ–ª–æ–∫–æ"
"4810268035258": "–°—ã—Ä —Ä–æ—Å—Å–∏–π—Å–∫–∏–π"'></textarea>
        <button onclick="bulkImport()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>

    <div class="card">
        <h2>–ë–∞–∑–∞ —Ç–æ–≤–∞—Ä–æ–≤</h2>
        <table id="table">
            <thead>
                <tr><th>–®—Ç—Ä–∏—Ö‚Äë–∫–æ–¥</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

</div>

<script src="https://unpkg.com/quagga2@1.2.6/dist/quagga.js"></script>

<script>
let db = JSON.parse(localStorage.getItem("barcodeDB") || "{}");
let currentFacing = "environment";
let stream = null;

function saveDB() {
    localStorage.setItem("barcodeDB", JSON.stringify(db));
    renderTable();
}

function renderTable() {
    const tbody = document.querySelector("#table tbody");
    tbody.innerHTML = "";
    Object.keys(db).forEach(code => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${code}</td><td>${db[code]}</td>`;
        tbody.appendChild(tr);
    });
}

function addItem() {
    const code = document.getElementById("code").value.trim();
    const name = document.getElementById("name").value.trim();
    if (!code || !name) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ");
    db[code] = name;
    saveDB();
    document.getElementById("code").value = "";
    document.getElementById("name").value = "";
}

function bulkImport() {
    const text = document.getElementById("bulk").value.trim();
    const lines = text.split("\n");
    lines.forEach(line => {
        const match = line.match(/"(\d+)":\s*"(.+?)"/);
        if (match) db[match[1]] = match[2];
    });
    saveDB();
    alert("–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω");
}

function scanCodeManual() {
    const code = document.getElementById("scanInput").value.trim();
    document.getElementById("manualResult").innerText =
        db[code] ? `${code} ‚Üí ${db[code]}` : (code ? "–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω" : "");
}

// ------------------ CAMERA ------------------

async function startCamera() {
    stopCamera();

    stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: currentFacing }
    });

    const preview = document.getElementById("preview");
    preview.srcObject = stream;
    preview.play();
}

function switchCamera() {
    currentFacing = currentFacing === "environment" ? "user" : "environment";
    startCamera();
}

function takeSnapshot() {
    const video = document.getElementById("preview");

    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);

    const data = canvas.toDataURL("image/png");

    Quagga.decodeSingle({
        src: data,
        numOfWorkers: 0,
        inputStream: { size: 800 },
        decoder: {
            readers: [
                "ean_reader",
                "ean_8_reader",
                "code_128_reader",
                "code_39_reader",
                "upc_reader",
                "upc_e_reader",
                "i2of5_reader"
            ]
        },
        locate: true,
        locator: {
            patchSize: "medium",
            halfSample: false
        }
    }, function(result) {
        if (result && result.codeResult) {
            const code = result.codeResult.code;
            const name = db[code] || "–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω";
            document.getElementById("scanResult").innerText = `${code} ‚Üí ${name}`;
        } else {
            document.getElementById("scanResult").innerText = "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å";
        }
    });
}

function stopCamera() {
    const preview = document.getElementById("preview");

    if (preview.srcObject) {
        preview.srcObject.getTracks().forEach(t => t.stop());
        preview.srcObject = null;
    }
}

renderTable();
</script>

</body>
</html>
