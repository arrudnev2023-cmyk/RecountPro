<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>–ë–∞–∑–∞ —à—Ç—Ä–∏—Ö –∫–æ–¥–æ–≤ ‚Äî Universal Scan</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#07040a;
  --card:#0f0b16;
  --muted:#9aa0b4;
  --neon1:#8a2be2;
  --neon2:#c86cff;
  --accent:linear-gradient(90deg,var(--neon1),var(--neon2));
  --radius:12px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background: radial-gradient(800px 400px at 10% 10%, rgba(138,43,226,0.08), transparent),
              radial-gradient(600px 300px at 90% 90%, rgba(200,108,255,0.06), transparent),
              var(--bg);
  color:#e9e9f2;
  padding:18px;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* Header */
.header{
  max-width:1100px;
  margin:0 auto 18px;
  padding:14px 18px;
  border-radius:14px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border:1px solid rgba(255,255,255,0.03);
  box-shadow: 0 8px 30px rgba(0,0,0,0.6);
}
.logo{
  width:44px;
  height:44px;
  border-radius:10px;
  background:linear-gradient(90deg,var(--neon1),var(--neon2));
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  color:white;
}
.header h1{margin:0;font-size:18px}
.header .small{font-size:13px;color:var(--muted)}

/* Layout */
.container{
  max-width:1100px;
  margin:0 auto;
  display:grid;
  grid-template-columns: 1fr 380px;
  gap:16px;
}
@media (max-width:980px){ .container{grid-template-columns:1fr} }

/* Card */
.card{
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:var(--radius);
  padding:14px;
  border:1px solid rgba(255,255,255,0.03);
  box-shadow: 0 8px 30px rgba(2,2,8,0.6);
}

/* Controls */
.controls{display:flex;gap:8px;flex-wrap:wrap}
.btn{
  background:transparent;
  border:1px solid rgba(255,255,255,0.06);
  color:var(--neon2);
  padding:10px 12px;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
  display:inline-flex;
  gap:8px;
  align-items:center;
  transition:all .14s ease;
}
.btn.primary{
  background:linear-gradient(90deg,var(--neon1),var(--neon2));
  color:#07040a;
  border:none;
  box-shadow: 0 8px 30px rgba(138,43,226,0.14);
}
.select,input,textarea{background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit;padding:10px;border-radius:10px;outline:none}
.select{min-width:160px}

/* Video area */
.preview-wrap{
  position:relative;
  width:100%;
  border-radius:12px;
  overflow:hidden;
  background:#000;
  min-height:220px;
}
video#preview{
  width:100%;
  height:100%;
  display:block;
  object-fit:cover;
  transform-origin:center;
  -webkit-transform-origin:center;
}

/* Results and table */
.found{font-size:15px;color:var(--neon2);font-weight:700;margin-top:10px}
.table-wrap{overflow:auto;max-height:320px}
table{width:100%;border-collapse:collapse;font-size:14px;color:#dfe6ff}
thead th{text-align:left;padding:10px;font-weight:700;color:var(--muted);border-bottom:1px solid rgba(255,255,255,0.03)}
tbody td{padding:10px;border-bottom:1px dashed rgba(255,255,255,0.02)}

/* small */
.small{font-size:13px;color:var(--muted)}
.footer-note{font-size:12px;color:rgba(255,255,255,0.35);margin-top:8px}
</style>
</head>
<body>

<header class="header">
  <div style="display:flex;gap:12px;align-items:center">
    <div class="logo">US</div>
    <div>
      <h1>–ë–∞–∑–∞ —à—Ç—Ä–∏—Ö –∫–æ–¥–æ–≤</h1>
      <div class="small">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥ –ª—é–±—ã–º —É–≥–ª–æ–º ‚Ä¢ –ë–µ–∑ —Ä–∞–º–∫–∏</div>
    </div>
  </div>
  <div style="display:flex;gap:8px;align-items:center">
    <button class="btn" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
    <button class="btn" id="importBtn">–ò–º–ø–æ—Ä—Ç JSON</button>
  </div>
</header>

<main class="container">

  <section class="card">
    <h2>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–º–µ—Ä–æ–π</h2>

    <div class="controls" style="margin-bottom:10px">
      <button class="btn primary" id="startBtn">üì∑ –í–∫–ª—é—á–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
      <button class="btn" id="stopBtn">‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
      <select id="deviceSelect" class="select"></select>
      <button class="btn" id="switchBtn">üîÑ –°–º–µ–Ω–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
      <button class="btn" id="torchBtn">üî¶ Torch</button>
    </div>

    <div class="preview-wrap" aria-hidden="false">
      <video id="preview" playsinline muted></video>
    </div>

    <div id="scanResult" class="found" aria-live="polite"></div>
    <div class="footer-note">–ü–æ–¥–Ω–µ—Å–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥ –ø–æ–¥ –ª—é–±—ã–º —É–≥–ª–æ–º. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–≤–æ—Ä–æ—Ç—ã –∏ –Ω–∞–∫–ª–æ–Ω—ã.</div>
  </section>

  <aside>
    <div class="card">
      <h2>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –≤—Ä—É—á–Ω—É—é</h2>
      <div style="display:flex;flex-direction:column;gap:8px">
        <input id="code" placeholder="–®—Ç—Ä–∏—Ö –∫–æ–¥">
        <input id="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
        <div style="display:flex;gap:8px">
          <button class="btn primary" id="addBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="btn" id="deleteBtn">–£–¥–∞–ª–∏—Ç—å –∫–æ–¥</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h2>–ü–æ–∏—Å–∫ –ø–æ —à—Ç—Ä–∏—Ö –∫–æ–¥—É</h2>
      <input id="scanInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥" oninput="scanCodeManual()">
      <div id="manualResult" class="found"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h2>–ú–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç</h2>
      <textarea id="bulk" rows="6" placeholder='"4600605026533": "–ú–æ–ª–æ–∫–æ"
"4810268035258": "–°—ã—Ä —Ä–æ—Å—Å–∏–π—Å–∫–∏–π"'></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn primary" id="bulkImportBtn">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="btn" id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É</button>
      </div>
    </div>
  </aside>

  <section class="card" style="grid-column:1 / -1">
    <h2>–ë–∞–∑–∞ —Ç–æ–≤–∞—Ä–æ–≤</h2>
    <div class="table-wrap">
      <table id="table">
        <thead><tr><th>–®—Ç—Ä–∏—Ö –∫–æ–¥</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

</main>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<script>
/* ===== State ===== */
let db = JSON.parse(localStorage.getItem('barcodeDB') || '{}');
let stream = null;
let currentDeviceId = null;
let scanning = false;
let detector = ('BarcodeDetector' in window) ? new BarcodeDetector({formats: ["ean_13","ean_8","code_128","code_39","upc_a","upc_e","itf"]}) : null;
let reader = null;
let lastDetected = {code:null, ts:0};
const DEBOUNCE_MS = 1200;

/* ===== Elements ===== */
const preview = document.getElementById('preview');
const deviceSelect = document.getElementById('deviceSelect');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const switchBtn = document.getElementById('switchBtn');
const torchBtn = document.getElementById('torchBtn');
const scanResult = document.getElementById('scanResult');

/* ===== Utilities ===== */
function saveDB(){ localStorage.setItem('barcodeDB', JSON.stringify(db)); renderTable(); }
function renderTable(){
  const tbody = document.querySelector('#table tbody');
  tbody.innerHTML = '';
  Object.keys(db).forEach(code=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${code}</td><td>${db[code]}</td>`;
    tbody.appendChild(tr);
  });
}
function beep(){
  try{
    navigator.vibrate?.(60);
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine';
    o.frequency.value = 880;
    g.gain.value = 0.02;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
  }catch(e){}
}

/* ===== Camera enumeration ===== */
async function enumerateCameras(){
  try{
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === 'videoinput');
    deviceSelect.innerHTML = '';
    cams.forEach((c, idx)=>{
      const opt = document.createElement('option');
      opt.value = c.deviceId;
      opt.text = c.label || `–ö–∞–º–µ—Ä–∞ ${idx+1}`;
      deviceSelect.appendChild(opt);
    });
    if(cams.length && !currentDeviceId) currentDeviceId = cams[0].deviceId;
    if(currentDeviceId) deviceSelect.value = currentDeviceId;
  }catch(e){}
}

/* ===== Start / Stop camera ===== */
async function startCamera(){
  stopCamera();
  scanning = true;
  await enumerateCameras();

  const constraints = {
    audio:false,
    video:{
      deviceId: deviceSelect.value || currentDeviceId || undefined,
      facingMode: { ideal: "environment" },
      width: { ideal: 1280 },
      height: { ideal: 720 }
    }
  };

  try{
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    preview.srcObject = stream;
    await preview.play();
    currentDeviceId = stream.getVideoTracks()[0].getSettings().deviceId || currentDeviceId;
    deviceSelect.value = currentDeviceId || deviceSelect.value;
    reader = new ZXing.BrowserMultiFormatReader();
    requestAnimationFrame(scanLoop);
  }catch(err){
    console.error('camera error', err);
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.');
    scanning = false;
  }
}

function stopCamera(){
  scanning = false;
  if(preview.srcObject){
    preview.srcObject.getTracks().forEach(t=>t.stop());
    preview.srcObject = null;
  }
  if(reader){
    try{ reader.reset(); }catch(e){}
    reader = null;
  }
}

/* ===== Torch ===== */
let torchOn = false;
async function toggleTorch(){
  if(!stream) return alert('–°–Ω–∞—á–∞–ª–∞ –≤–∫–ª—é—á–∏—Ç–µ –∫–∞–º–µ—Ä—É');
  const track = stream.getVideoTracks()[0];
  try{
    await track.applyConstraints({ advanced: [{ torch: !torchOn }] });
    torchOn = !torchOn;
    torchBtn.textContent = torchOn ? 'üî¶ Torch ON' : 'üî¶ Torch';
  }catch(e){
    alert('Torch –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –∏–ª–∏ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.');
  }
}

/* ===== Image preprocessing helpers ===== */
function createCanvas(w,h){
  const c = document.createElement('canvas');
  c.width = w; c.height = h;
  return c;
}
function toGrayscale(ctx, w, h){
  const img = ctx.getImageData(0,0,w,h);
  const d = img.data;
  for(let i=0;i<d.length;i+=4){
    const r=d[i], g=d[i+1], b=d[i+2];
    const v = (r*0.299 + g*0.587 + b*0.114)|0;
    d[i]=d[i+1]=d[i+2]=v;
  }
  ctx.putImageData(img,0,0);
}
function increaseContrast(ctx,w,h,contrast=1.2){
  const img = ctx.getImageData(0,0,w,h);
  const d = img.data;
  const factor = (259*(contrast+255))/(255*(259-contrast));
  for(let i=0;i<d.length;i+=4){
    for(let c=0;c<3;c++){
      let col = d[i+c];
      col = factor*(col-128)+128;
      d[i+c] = Math.max(0,Math.min(255,col));
    }
  }
  ctx.putImageData(img,0,0);
}

/* ===== Multi-angle decode attempts ===== */
async function tryDecodeFromCanvas(canvas){
  // First try BarcodeDetector if available
  if(detector){
    try{
      const bitmap = canvas.getContext('2d').getImageData(0,0,canvas.width,canvas.height);
      const results = await detector.detect(bitmap);
      if(results && results.length) return results[0].rawValue;
    }catch(e){}
  }
  // ZXing fallback: try decode directly and with rotations
  try{
    const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(canvas);
    const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
    const result = new ZXing.MultiFormatReader().decode(binaryBitmap);
    if(result && result.text) return result.text;
  }catch(e){}
  // try rotated versions
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  const temp = createCanvas(w,h);
  const tctx = temp.getContext('2d');
  for(let angle of [90,180,270]){
    tctx.clearRect(0,0,w,h);
    tctx.save();
    tctx.translate(w/2,h/2);
    tctx.rotate(angle*Math.PI/180);
    tctx.drawImage(canvas, -w/2, -h/2);
    tctx.restore();
    try{
      const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(temp);
      const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
      const result = new ZXing.MultiFormatReader().decode(binaryBitmap);
      if(result && result.text) return result.text;
    }catch(e){}
  }
  return null;
}

/* ===== Main scanning loop ===== */
let canvasPool = [];
function getCanvas(w,h){
  for(let c of canvasPool) if(c.width===w && c.height===h) return c;
  const c = createCanvas(w,h);
  canvasPool.push(c);
  return c;
}

async function scanLoop(){
  if(!scanning) return;
  try{
    const w = preview.videoWidth;
    const h = preview.videoHeight;
    if(w===0 || h===0){ requestAnimationFrame(scanLoop); return; }

    // Use full frame to allow arbitrary angles
    const canvas = getCanvas(w,h);
    const ctx = canvas.getContext('2d');
    ctx.drawImage(preview, 0, 0, w, h);

    // Preprocess: downscale for speed, grayscale and contrast
    const scale = Math.max(1, Math.floor(Math.max(w,h)/800));
    const sw = Math.floor(w/scale);
    const sh = Math.floor(h/scale);
    const small = getCanvas(sw,sh);
    const sctx = small.getContext('2d');
    sctx.drawImage(canvas, 0, 0, w, h, 0, 0, sw, sh);
    toGrayscale(sctx, sw, sh);
    increaseContrast(sctx, sw, sh, 30);

    // Try decode on small canvas
    const code = await tryDecodeFromCanvas(small);
    if(code) handleDetected(code);

  }catch(e){
    // ignore
  } finally {
    requestAnimationFrame(scanLoop);
  }
}

/* ===== Handle detection ===== */
function handleDetected(code){
  const now = Date.now();
  if(code === lastDetected.code && (now - lastDetected.ts) < DEBOUNCE_MS) return;
  lastDetected = {code, ts: now};
  const name = db[code] || '–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω';
  scanResult.innerText = `${code} ‚Üí ${name}`;
  beep();
  if(!db[code]){
    const add = confirm(`–ö–æ–¥ ${code} –Ω–µ –Ω–∞–π–¥–µ–Ω. –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä?`);
    if(add){
      const title = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞', '');
      if(title){ db[code] = title; saveDB(); }
    }
  }
}

/* ===== Manual UI ===== */
function scanCodeManual(){
  const code = document.getElementById('scanInput')?.value.trim();
  document.getElementById('manualResult').innerText = db[code] ? `${code} ‚Üí ${db[code]}` : (code ? '–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω' : '');
}

document.getElementById('addBtn').addEventListener('click', ()=>{
  const code = document.getElementById('code').value.trim();
  const name = document.getElementById('name').value.trim();
  if(!code || !name) return alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ');
  db[code] = name;
  saveDB();
  document.getElementById('code').value = '';
  document.getElementById('name').value = '';
});

document.getElementById('deleteBtn').addEventListener('click', ()=>{
  const code = document.getElementById('code').value.trim();
  if(!code) return alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
  if(db[code]){ delete db[code]; saveDB(); alert('–£–¥–∞–ª–µ–Ω–æ'); } else alert('–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω');
});

document.getElementById('bulkImportBtn').addEventListener('click', ()=>{
  const text = document.getElementById('bulk').value.trim();
  const lines = text.split('\n');
  let count = 0;
  lines.forEach(line=>{
    const match = line.match(/"(\d+)":\s*"(.+?)"/);
    if(match){ db[match[1]] = match[2]; count++; }
  });
  saveDB();
  alert(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${count} –∑–∞–ø–∏—Å–µ–π`);
});

document.getElementById('clearBtn').addEventListener('click', ()=>{
  if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –±–∞–∑—É?')){ db = {}; saveDB(); }
});

document.getElementById('exportBtn').addEventListener('click', ()=>{
  const data = JSON.stringify(db, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'barcodeDB.json'; a.click();
  URL.revokeObjectURL(url);
});

document.getElementById('importBtn').addEventListener('click', ()=>{
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json';
  input.onchange = e=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ev=>{
      try{
        const obj = JSON.parse(ev.target.result);
        db = Object.assign({}, db, obj);
        saveDB();
        alert('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω');
      }catch(err){ alert('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON'); }
    };
    reader.readAsText(file);
  };
  input.click();
});

/* Camera controls */
startBtn.addEventListener('click', ()=>startCamera());
stopBtn.addEventListener('click', ()=>stopCamera());
switchBtn.addEventListener('click', async ()=>{
  const opts = Array.from(deviceSelect.options);
  if(!opts.length) return;
  const idx = opts.findIndex(o=>o.value === deviceSelect.value);
  const next = opts[(idx+1) % opts.length];
  deviceSelect.value = next.value;
  currentDeviceId = next.value;
  await startCamera();
});
deviceSelect.addEventListener('change', async ()=>{
  currentDeviceId = deviceSelect.value;
  await startCamera();
});
torchBtn.addEventListener('click', toggleTorch);

/* Init */
renderTable();
enumerateCameras();
navigator.mediaDevices.getUserMedia({video:true}).then(s=>{
  s.getTracks().forEach(t=>t.stop());
  enumerateCameras();
}).catch(()=>{ /* ignore */ });

</script>
</body>
</html>
