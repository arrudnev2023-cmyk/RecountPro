<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ë–∞–∑–∞ —à—Ç—Ä–∏—Ö‚Äë–∫–æ–¥–æ–≤ + —Å–∫–∞–Ω–µ—Ä</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 900px; }
    h2 { margin-top: 25px; }
    input, textarea, button { padding: 8px; margin: 5px 0; }
    input, textarea { width: 100%; box-sizing: border-box; }
    button { cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; font-size: 14px; }
    th { background: #f2f2f2; }
    .found { font-size: 18px; margin-top: 10px; font-weight: bold; }
    #preview { width: 100%; max-width: 400px; border: 3px solid #00aaff; border-radius: 10px; }
    #frame {
        position: absolute;
        border: 3px solid red;
        width: 200px;
        height: 200px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
    }
    .scanner-wrapper { position: relative; margin-top: 20px; max-width: 400px; }
    .top-bar { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .top-bar button { flex: 1; min-width: 150px; }
</style>
</head>
<body>

<h1>–ë–∞–∑–∞ —à—Ç—Ä–∏—Ö‚Äë–∫–æ–¥–æ–≤</h1>

<div class="top-bar">
    <button onclick="startScanner()">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∫–∞–º–µ—Ä–æ–π</button>
    <button onclick="stopScanner()">‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
</div>

<!-- –ë–ª–æ–∫ —Å–∫–∞–Ω–µ—Ä–∞ -->
<h2>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —à—Ç—Ä–∏—Ö‚Äë–∫–æ–¥–∞</h2>
<div class="scanner-wrapper">
    <video id="preview" playsinline></video>
    <div id="frame"></div>
</div>
<div id="scanResult" class="found"></div>

<hr>

<!-- –†—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ -->
<h2>–î–æ–±–∞–≤–∏—Ç—å —à—Ç—Ä–∏—Ö‚Äë–∫–æ–¥ –≤—Ä—É—á–Ω—É—é</h2>
<input id="code" placeholder="–®—Ç—Ä–∏—Ö‚Äë–∫–æ–¥">
<input id="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
<button onclick="addItem()">–î–æ–±–∞–≤–∏—Ç—å</button>

<!-- –ü–æ–ª–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏/–ø–æ–∏—Å–∫–∞ –±–µ–∑ –∫–∞–º–µ—Ä—ã -->
<h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ / –ø–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É</h2>
<input id="scanInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ —Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —à—Ç—Ä–∏—Ö‚Äë–∫–æ–¥" oninput="scanCodeManual()">
<div id="manualResult" class="found"></div>

<!-- –ú–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç -->
<h2>–ú–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç</h2>
<textarea id="bulk" rows="6" placeholder='"4600605026533": "–ú–æ–ª–æ–∫–æ –ø—Ä–æ—Å—Ç–æ–∫–≤–∞—à–∏–Ω–æ"
"4810268035258": "–°—ã—Ä —Ä–æ—Å—Å–∏–π—Å–∫–∏–π"
"4810268035265": "–°—ã—Ä –ë—Ä–µ—Å—Ç-–õ–∏—Ç–æ–≤—Å–∫ –†–æ—Å—Å–∏–π—Å–∫–∏–π 50% 200–≥—Ä*10 /–ë–µ–ª–∞—Ä—É—Å—å"'></textarea>
<button onclick="bulkImport()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>

<!-- –¢–∞–±–ª–∏—Ü–∞ –±–∞–∑—ã -->
<h2>–ë–∞–∑–∞ —Ç–æ–≤–∞—Ä–æ–≤</h2>
<table id="table">
    <thead>
        <tr><th>–®—Ç—Ä–∏—Ö‚Äë–∫–æ–¥</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th></tr>
    </thead>
    <tbody></tbody>
</table>

<!-- ZXing -->
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
let db = JSON.parse(localStorage.getItem("barcodeDB") || "{}");
let codeReader = null;
let currentStream = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑—ã (–º–æ–∂–µ—à—å —É–±—Ä–∞—Ç—å, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ)
if (Object.keys(db).length === 0) {
    db = {
        "4600605026533": "–ú–æ–ª–æ–∫–æ –ø—Ä–æ—Å—Ç–æ–∫–≤–∞—à–∏–Ω–æ",
        "4810268035258": "–°—ã—Ä —Ä–æ—Å—Å–∏–π—Å–∫–∏–π",
        "4810268035265": "–°—ã—Ä –ë—Ä–µ—Å—Ç-–õ–∏—Ç–æ–≤—Å–∫ –†–æ—Å—Å–∏–π—Å–∫–∏–π 50% 200–≥—Ä*10 /–ë–µ–ª–∞—Ä—É—Å—å",
        "4630111539289": "–°–Ω–µ–≥–æ–∫–∞—Ç –¢–∏–º–∫–∞ —Å–ø–æ—Ä—Ç 6",
        "4600721001445": "–ü–∏–≤–æ –°—Ç–µ–ª–ª–∞ –ê—Ä—Ç—É–∞ —Å—Ç. 05¬∞20 /–ö–õ–ò–ù",
        "4607082170018": "–ú–∏–Ω. –≤–æ–¥–∞ –≥–∞–∑. –ö—É—Ä–≥–∞–∑–∞–∫ –Ø–Ω–≥–∞–Ω—Ç–∞—É 15*6",
        "7400000067424": "–î–∏—Å–∫–æ–Ω—Ç–Ω—ã–µ –∫–∞—Ä—Ç—ã 250 —à—Ç –≤ 1 –±–ª–æ–∫–µ (250—à—Ç20)"
    };
    saveDB();
}

function saveDB() {
    localStorage.setItem("barcodeDB", JSON.stringify(db));
    renderTable();
}

function renderTable() {
    const tbody = document.querySelector("#table tbody");
    tbody.innerHTML = "";
    Object.keys(db).forEach(code => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${code}</td><td>${db[code]}</td>`;
        tbody.appendChild(tr);
    });
}

function addItem() {
    const code = document.getElementById("code").value.trim();
    const name = document.getElementById("name").value.trim();
    if (!code || !name) {
        alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ");
        return;
    }
    db[code] = name;
    saveDB();
    document.getElementById("code").value = "";
    document.getElementById("name").value = "";
}

function bulkImport() {
    const text = document.getElementById("bulk").value.trim();
    if (!text) {
        alert("–í—Å—Ç–∞–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞");
        return;
    }
    const lines = text.split("\n");
    lines.forEach(line => {
        const match = line.match(/"(\d+)":\s*"(.+?)"/);
        if (match) {
            db[match[1]] = match[2];
        }
    });
    saveDB();
    alert("–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω");
}

function scanCodeManual() {
    const code = document.getElementById("scanInput").value.trim();
    const name = db[code];
    document.getElementById("manualResult").innerText = code
        ? (name ? code + " ‚Üí " + name : "–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω")
        : "";
}

// –°–∫–∞–Ω–µ—Ä –∫–∞–º–µ—Ä—ã
function startScanner() {
    if (codeReader) {
        // —É–∂–µ –∑–∞–ø—É—â–µ–Ω
        return;
    }
    codeReader = new ZXing.BrowserMultiFormatReader();
    const preview = document.getElementById('preview');

    codeReader
        .listVideoInputDevices()
        .then(videoInputDevices => {
            // –ø—ã—Ç–∞–µ–º—Å—è –≤—ã–±—Ä–∞—Ç—å –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É, –µ—Å–ª–∏ –µ—Å—Ç—å
            let deviceId = videoInputDevices[0].deviceId;
            const backCam = videoInputDevices.find(d => /back|environment/gi.test(d.label));
            if (backCam) deviceId = backCam.deviceId;

            codeReader.decodeFromVideoDevice(deviceId, preview, (result, err) => {
                if (result) {
                    const code = result.text;
                    const name = db[code] || "–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω";
                    document.getElementById("scanResult").innerText = code + " ‚Üí " + name;
                    // –º–æ–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–µ —Å—á–∏—Ç—ã–≤–∞–Ω–∏–µ:
                    // stopScanner();
                }
            });
        })
        .catch(err => {
            console.error(err);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ");
        });
}

function stopScanner() {
    if (codeReader) {
        codeReader.reset();
        codeReader = null;
    }
    const preview = document.getElementById('preview');
    if (preview && preview.srcObject) {
        preview.srcObject.getTracks().forEach(track => track.stop());
        preview.srcObject = null;
    }
}

renderTable();
</script>

</body>
</html>
