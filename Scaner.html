<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>–ë–∞–∑–∞ —à—Ç—Ä–∏—Ö‚Äë–∫–æ–¥–æ–≤ ‚Äî –¢–µ—Ç—Ä–∞–¥–∫–∞ (–º–æ–±–∏–ª—å–Ω–∞—è)</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --paper:#fffdf6;
  --ink:#1b1b1b;
  --accent:#6b3bd6;
  --muted:#6b6b6b;
  --card-radius:12px;
  --btn-radius:10px;
  --rule-color: rgba(107,59,214,0.06);
  --grid-size:28px;
}

/* Page background: realistic notebook sheet with grid/lines and left margin */
html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;background:var(--paper);color:var(--ink);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
body{
  padding:18px;
  display:flex;
  justify-content:center;
  background-image:
    linear-gradient(to bottom, rgba(107,59,214,0.06) 1px, transparent 1px),
    linear-gradient(to right, rgba(107,59,214,0.02) 1px, transparent 1px);
  background-size: var(--grid-size) var(--grid-size), var(--grid-size) var(--grid-size);
}

/* Notebook container: looks like an open page with margin and subtle shadow */
.container{
  width:100%;
  max-width:540px;
  background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,250,0.98));
  border-radius:14px;
  box-shadow: 0 18px 40px rgba(27,27,27,0.06);
  padding:14px;
  box-sizing:border-box;
  border-left: 6px solid rgba(200,40,40,0.12); /* left margin like notebook */
  position:relative;
  overflow:hidden;
}

/* top spiral / header hint */
.container::before{
  content:"";
  position:absolute;
  left:12px;
  top:-10px;
  width:calc(100% - 24px);
  height:18px;
  background: repeating-linear-gradient(90deg, rgba(0,0,0,0.04) 0 6px, transparent 6px 12px);
  border-radius:6px;
  opacity:0.06;
}

/* Header */
.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:10px;
}
.brand{
  display:flex;
  gap:12px;
  align-items:center;
}
.logo{
  width:46px;height:46px;border-radius:8px;
  background:linear-gradient(180deg,#fff,#f3f0ff);
  border:2px solid rgba(107,59,214,0.12);
  display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--accent);
  box-shadow: inset 0 -6px 12px rgba(107,59,214,0.02);
  font-size:18px;
}
.title{
  font-size:18px;font-weight:700;color:var(--ink);
}
.hint{font-size:13px;color:var(--muted)}

/* Card blocks styled like notebook sections with ruled header */
.card{
  background: transparent;
  border-radius:10px;
  padding:10px 8px 14px 8px;
  margin-bottom:12px;
  border-left:4px solid rgba(107,59,214,0.06);
  position:relative;
}

/* small ruled header line */
.card h3{
  margin:0 0 8px 6px;
  font-weight:700;
  color:var(--ink);
}

/* Camera area: occupies ~1/3 of viewport height */
.preview-wrap{
  position:relative;
  border-radius:8px;
  overflow:hidden;
  background:#000;
  border:1px dashed rgba(27,27,27,0.06);
}
.preview-wrap.camera-1-3{
  height:33vh;
  min-height:140px;
  max-height:300px;
}
video#preview{width:100%;height:100%;object-fit:cover;display:block}

/* Controls: buttons look like paper stickers */
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.btn{
  padding:10px 12px;border-radius:var(--btn-radius);border:none;cursor:pointer;font-weight:700;
  background:linear-gradient(180deg,#fff,#f6f6ff);color:var(--ink);box-shadow:0 6px 18px rgba(27,27,27,0.06);
  border:1px solid rgba(27,27,27,0.06);
}
.btn.primary{
  background:linear-gradient(180deg,#6b3bd6,#8a5bf0);color:#fff;border:none;box-shadow:0 10px 30px rgba(107,59,214,0.12);
}
.btn.ghost{background:transparent;border:1px solid rgba(27,27,27,0.06);color:var(--muted);box-shadow:none}

/* Notebook input style: lined inputs with left margin like ruled paper */
.field{display:flex;flex-direction:column;gap:6px;margin-top:8px}
label{font-size:13px;color:var(--muted);margin-left:6px}
input,textarea{
  width:100%;
  padding:12px 12px;
  border-radius:8px;
  border:1px solid rgba(27,27,27,0.06);
  background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.4));
  font-size:15px;color:var(--ink);
  outline:none;
  box-shadow: inset 0 -6px 12px rgba(0,0,0,0.02);
  position:relative;
}
/* add faint ruled lines inside inputs */
input, textarea {
  background-image:
    linear-gradient(to bottom, rgba(107,59,214,0.03) 1px, transparent 1px);
  background-size: 100% 18px;
}
input::placeholder{color:rgba(27,27,27,0.35)}
textarea{min-height:80px;resize:vertical}

/* Table: simple, like list in notebook */
.table-wrap{overflow:auto;max-height:260px;margin-top:8px;border-radius:8px}
table{width:100%;border-collapse:collapse;font-size:14px;color:var(--ink)}
thead th{text-align:left;padding:10px;font-weight:700;color:var(--muted);border-bottom:1px dashed rgba(27,27,27,0.06)}
tbody td{padding:10px;border-bottom:1px dashed rgba(27,27,27,0.04)}

/* small helpers */
.small{font-size:13px;color:var(--muted)}
.toast{
  position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(27,27,27,0.9);color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:9999;
}

/* responsive tweaks */
@media (max-width:420px){
  .container{padding:10px}
  .h1{font-size:16px}
  .logo{width:40px;height:40px}
}
</style>
</head>
<body>

<div class="container" role="main" aria-label="–ú–æ–±–∏–ª—å–Ω–∞—è –±–∞–∑–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤ –≤ —Å—Ç–∏–ª–µ —Ç–µ—Ç—Ä–∞–¥–∫–∏">
  <header class="header">
    <div class="brand">
      <div class="logo">BC</div>
      <div>
        <div class="title">–ë–∞–∑–∞ —à—Ç—Ä–∏—Ö‚Äë–∫–æ–¥–æ–≤</div>
        <div class="hint">–û—Ç–∫—Ä—ã—Ç–∞—è —Ç–µ—Ç—Ä–∞–¥–∫–∞ ‚Äî –º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è</div>
      </div>
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <button id="exportBtn" class="btn ghost" aria-label="–≠–∫—Å–ø–æ—Ä—Ç –±–∞–∑—ã">–≠–∫—Å–ø–æ—Ä—Ç</button>
      <button id="importBtn" class="btn ghost" aria-label="–ò–º–ø–æ—Ä—Ç –±–∞–∑—ã">–ò–º–ø–æ—Ä—Ç</button>
    </div>
  </header>

  <!-- Camera card -->
  <section class="card" aria-labelledby="cameraTitle">
    <h3 id="cameraTitle">–°–∫–∞–Ω–µ—Ä</h3>

    <div class="preview-wrap camera-1-3" aria-hidden="false">
      <video id="preview" playsinline muted></video>
    </div>

    <div class="controls" style="margin-top:10px">
      <button id="startScannerBtn" class="btn primary" aria-label="–í–∫–ª—é—á–∏—Ç—å —Å–∫–∞–Ω–µ—Ä">‚ñ∂ –í–∫–ª—é—á–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
      <button id="stopScannerBtn" class="btn ghost" aria-label="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–µ—Ä">‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
      <select id="deviceSelect" class="btn ghost" aria-label="–í—ã–±–æ—Ä –∫–∞–º–µ—Ä—ã" style="padding:10px;border-radius:10px;background:transparent;color:var(--muted)"></select>
      <button id="torchBtn" class="btn ghost" aria-label="–§–æ–Ω–∞—Ä–∏–∫">üî¶</button>
    </div>

    <div id="scanResult" class="small" aria-live="polite" style="margin-top:8px;padding-left:6px"></div>
    <div class="small" style="margin-top:8px;padding-left:6px">–ü–æ–¥–Ω–µ—Å–∏—Ç–µ —à—Ç—Ä–∏—Ö‚Äë–∫–æ–¥ ‚Äî —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø–æ –≤—Å–µ–º—É –∫–∞–¥—Ä—É, –ø–æ–¥ –ª—é–±—ã–º —É–≥–ª–æ–º.</div>
  </section>

  <!-- Manual add / quick edit -->
  <section class="card" aria-labelledby="manualTitle">
    <h3 id="manualTitle">–î–æ–±–∞–≤–∏—Ç—å / –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å</h3>

    <div class="field">
      <label for="codeInput">–®—Ç—Ä–∏—Ö‚Äë–∫–æ–¥</label>
      <input id="codeInput" type="text" placeholder="–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –≤—Ä—É—á–Ω—É—é" autocomplete="off" />
    </div>

    <div class="field">
      <label for="nameInput">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input id="nameInput" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" autocomplete="off" />
    </div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="saveBtn" class="btn primary" style="flex:1">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∞–∑—É</button>
      <button id="deleteBtn" class="btn ghost" style="width:120px">–£–¥–∞–ª–∏—Ç—å</button>
    </div>

    <div class="small" style="margin-top:8px;padding-left:6px">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ localStorage –ø–æ–¥ –∫–ª—é—á–æ–º <strong>barcodeDB</strong>.</div>
  </section>

  <!-- Bulk import -->
  <section class="card" aria-labelledby="bulkTitle">
    <h3 id="bulkTitle">–ú–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç</h3>
    <label for="bulk" class="small" style="margin-left:6px">–§–æ—Ä–º–∞—Ç: "4600605026533": "–ú–æ–ª–æ–∫–æ"</label>
    <textarea id="bulk" rows="4" placeholder='"4600605026533": "–ú–æ–ª–æ–∫–æ"
"4810268035258": "–°—ã—Ä —Ä–æ—Å—Å–∏–π—Å–∫–∏–π"'></textarea>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="bulkImportBtn" class="btn primary" style="flex:1">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      <button id="clearAllBtn" class="btn ghost" style="width:120px">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
  </section>

  <!-- Table -->
  <section class="card" aria-labelledby="tableTitle">
    <h3 id="tableTitle">–ë–∞–∑–∞ —Ç–æ–≤–∞—Ä–æ–≤</h3>
    <div class="table-wrap" role="region" aria-label="–°–ø–∏—Å–æ–∫ —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤">
      <table id="table" aria-live="polite">
        <thead><tr><th>–®—Ç—Ä–∏—Ö‚Äë–∫–æ–¥</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- ZXing fallback -->
<script src="https://unpkg.com/@zxing/library@latest"></script>

<script>
/* ===== State ===== */
let db = JSON.parse(localStorage.getItem('barcodeDB') || '{}');
let stream = null;
let currentDeviceId = null;
let scanning = false;
let detector = ('BarcodeDetector' in window) ? new BarcodeDetector({formats: ["ean_13","ean_8","code_128","code_39","upc_a","upc_e","itf"]}) : null;
let reader = null;
let lastDetected = {code:null, ts:0};
const DEBOUNCE_MS = 900;

/* ===== Elements ===== */
const preview = document.getElementById('preview');
const startScannerBtn = document.getElementById('startScannerBtn');
const stopScannerBtn = document.getElementById('stopScannerBtn');
const deviceSelect = document.getElementById('deviceSelect');
const torchBtn = document.getElementById('torchBtn');
const scanResult = document.getElementById('scanResult');

const codeInput = document.getElementById('codeInput');
const nameInput = document.getElementById('nameInput');
const saveBtn = document.getElementById('saveBtn');
const deleteBtn = document.getElementById('deleteBtn');

const bulk = document.getElementById('bulk');
const bulkImportBtn = document.getElementById('bulkImportBtn');
const clearAllBtn = document.getElementById('clearAllBtn');

const tableBody = document.querySelector('#table tbody');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');

const toast = document.getElementById('toast');

/* ===== Utilities ===== */
function showToast(text, ms = 1400){
  toast.textContent = text;
  toast.style.display = 'block';
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>{ toast.style.display = 'none'; }, ms);
}
function saveDB(){ localStorage.setItem('barcodeDB', JSON.stringify(db)); renderTable(); }
function renderTable(){
  tableBody.innerHTML = '';
  const keys = Object.keys(db);
  if(!keys.length){
    tableBody.innerHTML = '<tr><td colspan="2" class="small" style="padding:12px;color:var(--muted)">–ë–∞–∑–∞ –ø—É—Å—Ç–∞</td></tr>';
    return;
  }
  keys.forEach(code=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${code}</td><td>${db[code]}</td>`;
    tableBody.appendChild(tr);
  });
}
function beep(){ try{ navigator.vibrate?.(60); }catch(e){} }

/* ===== Camera & devices ===== */
async function enumerateCameras(){
  try{
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === 'videoinput');
    deviceSelect.innerHTML = '';
    cams.forEach((c, idx)=>{
      const opt = document.createElement('option');
      opt.value = c.deviceId;
      opt.text = c.label || `–ö–∞–º–µ—Ä–∞ ${idx+1}`;
      deviceSelect.appendChild(opt);
    });
    if(cams.length && !currentDeviceId) currentDeviceId = cams[0].deviceId;
    if(currentDeviceId) deviceSelect.value = currentDeviceId;
  }catch(e){}
}

async function startCamera(){
  if(scanning) return;
  stopCamera();
  scanning = true;
  await enumerateCameras();

  const constraints = {
    audio:false,
    video:{
      deviceId: deviceSelect.value || currentDeviceId || undefined,
      facingMode: { ideal: "environment" },
      width: { ideal: 1280 },
      height: { ideal: 720 }
    }
  };

  try{
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    preview.srcObject = stream;
    await preview.play();
    currentDeviceId = stream.getVideoTracks()[0].getSettings().deviceId || currentDeviceId;
    deviceSelect.value = currentDeviceId || deviceSelect.value;

    if(!reader) reader = new ZXing.BrowserMultiFormatReader();

    requestAnimationFrame(scanLoop);
    showToast('–°–∫–∞–Ω–µ—Ä –≤–∫–ª—é—á—ë–Ω');
  }catch(err){
    console.error('camera error', err);
    scanResult.innerText = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ';
    scanning = false;
    showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É');
  }
}

function stopCamera(){
  scanning = false;
  if(preview.srcObject){
    preview.srcObject.getTracks().forEach(t=>t.stop());
    preview.srcObject = null;
  }
  if(reader){
    try{ reader.reset(); }catch(e){}
  }
  showToast('–°–∫–∞–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
}

/* Torch */
let torchOn = false;
async function toggleTorch(){
  if(!stream) return showToast('–°–Ω–∞—á–∞–ª–∞ –≤–∫–ª—é—á–∏—Ç–µ —Å–∫–∞–Ω–µ—Ä');
  const track = stream.getVideoTracks()[0];
  try{
    await track.applyConstraints({ advanced: [{ torch: !torchOn }] });
    torchOn = !torchOn;
    torchBtn.textContent = torchOn ? 'üî¶ ON' : 'üî¶';
  }catch(e){
    showToast('Torch –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
  }
}

/* ===== Decoding helpers ===== */
function createCanvas(w,h){ const c=document.createElement('canvas'); c.width=w; c.height=h; return c; }

async function tryDecodeCanvas(canvas){
  if(detector){
    try{
      const imageData = canvas.getContext('2d').getImageData(0,0,canvas.width,canvas.height);
      const res = await detector.detect(imageData);
      if(res && res.length) return res[0].rawValue;
    }catch(e){}
  }
  try{
    const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(canvas);
    const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
    const result = new ZXing.MultiFormatReader().decode(binaryBitmap);
    if(result && result.text) return result.text;
  }catch(e){}
  const w = canvas.width, h = canvas.height;
  const temp = createCanvas(w,h);
  const tctx = temp.getContext('2d');
  for(let angle of [90,180,270]){
    tctx.clearRect(0,0,w,h);
    tctx.save();
    tctx.translate(w/2,h/2);
    tctx.rotate(angle*Math.PI/180);
    tctx.drawImage(canvas, -w/2, -h/2);
    tctx.restore();
    try{
      const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(temp);
      const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
      const result = new ZXing.MultiFormatReader().decode(binaryBitmap);
      if(result && result.text) return result.text;
    }catch(e){}
  }
  return null;
}

/* Main scanning loop (full frame) */
let canvasPool = [];
function getCanvas(w,h){
  for(let c of canvasPool) if(c.width===w && c.height===h) return c;
  const c = createCanvas(w,h); canvasPool.push(c); return c;
}

let scanLoopRunning = false;
async function scanLoop(){
  if(!scanning) { scanLoopRunning = false; return; }
  if(scanLoopRunning) return;
  scanLoopRunning = true;

  try{
    while(scanning){
      const w = preview.videoWidth;
      const h = preview.videoHeight;
      if(w===0 || h===0){
        await new Promise(r => requestAnimationFrame(r));
        continue;
      }

      const canvas = getCanvas(w,h);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(preview, 0, 0, w, h);

      const scale = Math.max(1, Math.floor(Math.max(w,h)/900));
      const sw = Math.floor(w/scale);
      const sh = Math.floor(h/scale);
      const small = getCanvas(sw,sh);
      const sctx = small.getContext('2d');
      sctx.drawImage(canvas, 0, 0, w, h, 0, 0, sw, sh);

      try{
        const code = await tryDecodeCanvas(small);
        if(code) {
          handleDetected(code);
          await new Promise(r => setTimeout(r, 300));
        }
      }catch(e){}

      await new Promise(r => requestAnimationFrame(r));
    }
  }finally{
    scanLoopRunning = false;
  }
}

/* Handle detection */
function handleDetected(code){
  const now = Date.now();
  if(code === lastDetected.code && (now - lastDetected.ts) < DEBOUNCE_MS) return;
  lastDetected = {code, ts: now};
  beep();
  scanResult.innerText = `${code} ‚Üí ${db[code] || '–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω'}`;
  codeInput.value = code;
  if(db[code]) nameInput.value = db[code];
  else nameInput.value = '';
}

/* ===== UI actions ===== */
startScannerBtn.addEventListener('click', async ()=>{ await startCamera(); });
stopScannerBtn.addEventListener('click', ()=>{ stopCamera(); });
deviceSelect.addEventListener('change', async ()=>{ currentDeviceId = deviceSelect.value; await startCamera(); });
torchBtn.addEventListener('click', toggleTorch);

saveBtn.addEventListener('click', ()=>{
  const code = (codeInput.value || '').trim();
  const name = (nameInput.value || '').trim();
  if(!code) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥');
  if(!name) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞');
  db[code] = name;
  saveDB();
  showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –±–∞–∑–µ');
  lastDetected = {code:null, ts:0};
  codeInput.value = '';
  nameInput.value = '';
});

deleteBtn.addEventListener('click', ()=>{
  const code = (codeInput.value || '').trim();
  if(!code) return alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
  if(db[code]){ delete db[code]; saveDB(); showToast('–£–¥–∞–ª–µ–Ω–æ'); } else alert('–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω');
});

bulkImportBtn.addEventListener('click', ()=>{
  const text = bulk.value.trim();
  const lines = text.split('\n');
  let count = 0;
  lines.forEach(line=>{
    const match = line.match(/"(\d+)":\s*"(.+?)"/);
    if(match){ db[match[1]] = match[2]; count++; }
  });
  saveDB();
  showToast(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${count}`);
});

clearAllBtn.addEventListener('click', ()=>{
  if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –±–∞–∑—É —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤?')){ db = {}; saveDB(); showToast('–ë–∞–∑–∞ –æ—á–∏—â–µ–Ω–∞'); }
});

/* Export / Import JSON */
exportBtn.addEventListener('click', ()=>{
  const data = JSON.stringify(db, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'barcodeDB.json'; a.click();
  URL.revokeObjectURL(url);
});

importBtn.addEventListener('click', ()=>{
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json';
  input.onchange = e=>{
    const file = e.target.files[0];
    if(!file) return;
    const readerFile = new FileReader();
    readerFile.onload = ev=>{
      try{
        const obj = JSON.parse(ev.target.result);
        db = Object.assign({}, db, obj);
        saveDB();
        showToast('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω');
      }catch(err){ alert('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON'); }
    };
    readerFile.readAsText(file);
  };
  input.click();
});

/* Init */
renderTable();
enumerateCameras();
navigator.mediaDevices.getUserMedia({video:true}).then(s=>{
  s.getTracks().forEach(t=>t.stop());
  enumerateCameras();
}).catch(()=>{ /* ignore */ });

window.addEventListener('pagehide', ()=>{ stopCamera(); });
window.addEventListener('beforeunload', ()=>{ stopCamera(); });

</script>
</body>
</html>



