<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <title>Mini FPS — Raycasting</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <style>
    body {
      margin:0; background:#000; overflow:hidden;
      font-family:sans-serif; color:#fff;
    }
    canvas { width:100%; height:100vh; display:block; background:#000; }
    .joysticks {
      position:fixed; bottom:20px; left:0; right:0;
      display:flex; justify-content:space-between; padding:0 20px;
      pointer-events:none;
    }
    .joy {
      width:120px; height:120px; border-radius:50%;
      background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.2);
      position:relative; pointer-events:auto;
    }
    .knob {
      width:44px; height:44px; border-radius:50%;
      background:rgba(255,255,255,0.3);
      position:absolute; left:38px; top:38px;
    }
  </style>
</head>
<body>
  <canvas id="game"></canvas>
  <div class="joysticks">
    <div class="joy" id="joyL"><div class="knob" id="knobL"></div></div>
    <div class="joy" id="joyR"><div class="knob" id="knobR"></div></div>
  </div>

<script>
const canvas=document.getElementById('game'),ctx=canvas.getContext('2d');
canvas.width=window.innerWidth; canvas.height=window.innerHeight;

// Карта (1 = стена, 0 = пусто)
const map=[
 [1,1,1,1,1,1,1,1,1,1],
 [1,0,0,0,0,0,0,0,0,1],
 [1,0,0,0,0,0,0,0,0,1],
 [1,0,0,0,1,1,0,0,0,1],
 [1,0,0,0,0,0,0,0,0,1],
 [1,0,0,0,0,0,0,0,0,1],
 [1,0,0,0,0,0,0,0,0,1],
 [1,0,0,0,0,0,0,0,0,1],
 [1,0,0,0,0,0,0,0,0,1],
 [1,1,1,1,1,1,1,1,1,1],
];
const mapW=map[0].length, mapH=map.length;

let player={x:2.5,y:2.5,dir:0,fov:Math.PI/3};

// Джойстики
let joyL={x:0,y:0,active:false}, joyR={x:0,y:0,active:false};
setupJoy(document.getElementById('joyL'),document.getElementById('knobL'),joyL);
setupJoy(document.getElementById('joyR'),document.getElementById('knobR'),joyR);

function setupJoy(zone,knob,state){
  const home={x:38,y:38};
  function setKnob(x,y){knob.style.left=x+'px';knob.style.top=y+'px';}
  zone.addEventListener('touchstart',e=>{
    const t=e.touches[0],r=zone.getBoundingClientRect();
    const v=normJoy(t.clientX-r.left,t.clientY-r.top);
    state.x=v.x;state.y=v.y;state.active=true;setKnob(v.kx,v.ky);
  },{passive:true});
  zone.addEventListener('touchmove',e=>{
    if(!state.active)return;
    const t=e.touches[0],r=zone.getBoundingClientRect();
    const v=normJoy(t.clientX-r.left,t.clientY-r.top);
    state.x=v.x;state.y=v.y;setKnob(v.kx,v.ky);
  },{passive:true});
  zone.addEventListener('touchend',()=>{state.x=0;state.y=0;state.active=false;setKnob(home.x,home.y);},{passive:true});
}
function normJoy(cx,cy){
  const cx0=60,cy0=60,rad=52;
  const dx=cx-cx0,dy=cy-cy0,len=Math.hypot(dx,dy);
  const k=len>rad?rad/len:1,nx=dx*k,ny=dy*k;
  return {x:nx/rad,y:ny/rad,kx:60+nx-22,ky:60+ny-22};
}

// Raycasting
function castRay(angle){
  let sin=Math.sin(angle),cos=Math.cos(angle);
  for(let d=0;d<20;d+=0.02){
    let x=player.x+cos*d,y=player.y+sin*d;
    if(map[Math.floor(y)]?.[Math.floor(x)]===1) return d;
  }
  return 20;
}

function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
function update(){
  // движение
  if(joyL.active){
    const speed=0.05;
    const dx=joyL.x,dy=joyL.y;
    const moveX=Math.cos(player.dir)*dy - Math.sin(player.dir)*dx;
    const moveY=Math.sin(player.dir)*dy + Math.cos(player.dir)*dx;
    player.x+=moveX*speed; player.y+=moveY*speed;
    if(map[Math.floor(player.y)]?.[Math.floor(player.x)]===1){
      player.x-=moveX*speed; player.y-=moveY*speed;
    }
  }
  // поворот
  if(joyR.active){
    player.dir+=joyR.x*0.05;
  }
}
function draw(){
  ctx.fillStyle='#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
  const w=canvas.width,h=canvas.height;
  for(let i=0;i<w;i++){
    const angle=player.dir-player.fov/2+player.fov*i/w;
    const dist=castRay(angle);
    const wallH=h/(dist*Math.cos(angle-player.dir));
    ctx.fillStyle='rgba(200,200,200,1)';
    ctx.fillRect(i,(h-wallH)/2,1,wallH);
  }
}
loop();
</script>
</body>
</html>
