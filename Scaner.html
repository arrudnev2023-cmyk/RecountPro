<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ü–∞—Ä—Å–µ—Ä –£–ü–î —Å –∫–∞–º–µ—Ä—ã</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <!-- Tesseract.js —Å CDN -->
  <script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #05070a;
      --fg: #f5f5f5;
      --accent: #3b82f6;
      --accent-soft: rgba(59,130,246,0.15);
      --danger: #ef4444;
      --muted: #9ca3af;
      --card: #0b0f16;
      --border: #1f2933;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
      color: var(--fg);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      padding: 12px;
      gap: 10px;
    }

    .header {
      padding: 4px 4px 0;
    }

    .title {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .subtitle {
      font-size: 13px;
      color: var(--muted);
      margin-top: 2px;
    }

    .card {
      background: linear-gradient(145deg, rgba(15,23,42,0.96), rgba(15,23,42,0.85));
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.18);
      box-shadow:
        0 18px 45px rgba(15,23,42,0.9),
        0 0 0 1px rgba(15,23,42,0.9);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .camera-wrapper {
      position: relative;
      border-radius: 14px;
      overflow: hidden;
      background: #020617;
      border: 1px solid rgba(148,163,184,0.25);
      aspect-ratio: 3 / 4;
      max-height: 60vh;
    }

    video, canvas {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .camera-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .frame {
      width: 86%;
      height: 70%;
      border-radius: 12px;
      border: 2px solid rgba(248,250,252,0.85);
      box-shadow:
        0 0 0 9999px rgba(15,23,42,0.55),
        0 0 25px rgba(15,23,42,0.9);
      backdrop-filter: blur(1px);
    }

    .hint {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15,23,42,0.85);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34,197,94,0.9);
    }

    .controls {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .btn {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 10px 14px;
      font-size: 14px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      color: #e5e7eb;
      background: radial-gradient(circle at top, #1d4ed8, #1e40af);
      box-shadow:
        0 10px 25px rgba(37,99,235,0.55),
        0 0 0 1px rgba(59,130,246,0.5);
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.08s ease;
    }

    .btn:active {
      transform: scale(0.97) translateY(1px);
      box-shadow:
        0 4px 14px rgba(37,99,235,0.6),
        0 0 0 1px rgba(59,130,246,0.7);
    }

    .btn.secondary {
      flex: 0 0 auto;
      min-width: 44px;
      padding-inline: 10px;
      background: rgba(15,23,42,0.9);
      border-radius: 999px;
      box-shadow:
        0 8px 18px rgba(15,23,42,0.9),
        0 0 0 1px rgba(75,85,99,0.9);
      color: var(--muted);
    }

    .btn.secondary:active {
      transform: scale(0.96) translateY(1px);
    }

    .btn-icon {
      font-size: 16px;
    }

    .status {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #6b7280;
    }

    .status-dot.active {
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34,197,94,0.9);
    }

    .status-dot.busy {
      background: #f97316;
      box-shadow: 0 0 8px rgba(249,115,22,0.9);
    }

    .status-dot.error {
      background: #ef4444;
      box-shadow: 0 0 8px rgba(239,68,68,0.9);
    }

    .results-card {
      margin-top: 4px;
      padding: 10px;
      border-radius: 14px;
      background: radial-gradient(circle at top left, rgba(30,64,175,0.35), rgba(15,23,42,0.98));
      border: 1px solid rgba(148,163,184,0.25);
      max-height: 40vh;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .results-title {
      font-size: 14px;
      font-weight: 500;
    }

    .results-meta {
      font-size: 11px;
      color: var(--muted);
    }

    .results-body {
      overflow: auto;
      border-radius: 10px;
      border: 1px solid rgba(31,41,55,0.9);
      background: rgba(15,23,42,0.95);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      color: #e5e7eb;
    }

    thead {
      background: rgba(15,23,42,0.98);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th, td {
      padding: 6px 6px;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 500;
      color: #9ca3af;
    }

    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.9);
    }

    .col-name {
      max-width: 180px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(34,197,94,0.12);
      color: #bbf7d0;
      border: 1px solid rgba(34,197,94,0.4);
    }

    .badge-error {
      background: rgba(239,68,68,0.12);
      color: #fecaca;
      border-color: rgba(239,68,68,0.5);
    }

    .raw-text {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 10px;
      line-height: 1.4;
      white-space: pre-wrap;
      padding: 6px;
      color: #9ca3af;
    }

    .hidden {
      display: none !important;
    }

    input[type="file"] {
      display: none;
    }

    .file-label {
      font-size: 11px;
      color: var(--muted);
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    @media (min-width: 768px) {
      .app {
        max-width: 480px;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="title">–¢–µ—Å—Ç –ø–∞—Ä—Å–µ—Ä–∞ –£–ü–î —Å –∫–∞–º–µ—Ä—ã</div>
      <div class="subtitle">–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π –¥–æ–∫—É–º–µ–Ω—Ç ‚Äî –ø–æ–ª—É—á–∏—à—å —Å—ã—Ä—É—é —Ç–∞–±–ª–∏—Ü—É —Å —Ç–æ–≤–∞—Ä–∞–º–∏</div>
    </div>

    <div class="card">
      <div class="camera-wrapper">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" class="hidden"></canvas>
        <div class="camera-overlay">
          <div class="frame"></div>
          <div class="hint">
            <div class="dot"></div>
            <span>–í—ã—Ä–∞–≤–Ω–∏–≤–∞–π –ª–∏—Å—Ç –≤ —Ä–∞–º–∫–µ, –¥–µ—Ä–∂–∏ —Ç–µ–ª–µ—Ñ–æ–Ω —Ä–æ–≤–Ω–æ</span>
          </div>
        </div>
      </div>

      <div class="controls">
        <button id="captureBtn" class="btn">
          <span class="btn-icon">üì∏</span>
          <span>–°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫ –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å</span>
        </button>
        <button id="toggleSourceBtn" class="btn secondary" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É / –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª">
          <span class="btn-icon">üîÅ</span>
        </button>
      </div>

      <div class="status">
        <div id="statusDot" class="status-dot"></div>
        <span id="statusText">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã‚Ä¶</span>
      </div>

      <input type="file" id="fileInput" accept="image/*" />
      <div style="margin-top:4px;font-size:11px;color:var(--muted);">
        –ï—Å–ª–∏ –∫–∞–º–µ—Ä–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî <label for="fileInput" class="file-label">–∑–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
      </div>
    </div>

    <div id="resultsCard" class="results-card hidden">
      <div class="results-header">
        <div>
          <div class="results-title">–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞</div>
          <div id="resultsMeta" class="results-meta"></div>
        </div>
        <div id="resultsBadge" class="badge">OK</div>
      </div>
      <div class="results-body">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
              <th>–ï–¥.</th>
              <th>–ö–æ–ª-–≤–æ</th>
              <th>–¶–µ–Ω–∞</th>
              <th>–°—É–º–º–∞</th>
            </tr>
          </thead>
          <tbody id="resultsTableBody"></tbody>
        </table>
      </div>
      <details style="margin-top:4px;">
        <summary style="font-size:11px;color:var(--muted);cursor:pointer;">–ü–æ–∫–∞–∑–∞—Ç—å —Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç OCR</summary>
        <div id="rawText" class="raw-text"></div>
      </details>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const toggleSourceBtn = document.getElementById('toggleSourceBtn');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const resultsCard = document.getElementById('resultsCard');
    const resultsMeta = document.getElementById('resultsMeta');
    const resultsBadge = document.getElementById('resultsBadge');
    const resultsTableBody = document.getElementById('resultsTableBody');
    const rawTextEl = document.getElementById('rawText');
    const fileInput = document.getElementById('fileInput');

    let usingCamera = true;
    let currentStream = null;

    function setStatus(state, text) {
      statusDot.className = 'status-dot';
      if (state === 'active') statusDot.classList.add('active');
      if (state === 'busy') statusDot.classList.add('busy');
      if (state === 'error') statusDot.classList.add('error');
      statusText.textContent = text;
    }

    async function initCamera() {
      try {
        if (currentStream) {
          currentStream.getTracks().forEach(t => t.stop());
          currentStream = null;
        }

        const constraints = {
          audio: false,
          video: {
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 2560 },
            focusMode: 'continuous'
          }
        };

        setStatus('busy', '–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ‚Ä¶');
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        currentStream = stream;
        video.srcObject = stream;
        usingCamera = true;
        setStatus('active', '–ö–∞–º–µ—Ä–∞ –≥–æ—Ç–æ–≤–∞. –ù–∞–≤–µ–¥–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç –∏ –∂–º–∏ –∫–Ω–æ–ø–∫—É.');
      } catch (err) {
        console.error(err);
        usingCamera = false;
        setStatus('error', '–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞.');
      }
    }

    function captureFrame() {
      const videoEl = video;
      if (!videoEl.videoWidth || !videoEl.videoHeight) {
        throw new Error('–í–∏–¥–µ–æ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤–æ');
      }

      const targetRatio = 3 / 4;
      const vw = videoEl.videoWidth;
      const vh = videoEl.videoHeight;
      const vr = vw / vh;

      let sw, sh, sx, sy;
      if (vr > targetRatio) {
        sh = vh * 0.8;
        sw = sh * targetRatio;
      } else {
        sw = vw * 0.8;
        sh = sw / targetRatio;
      }
      sx = (vw - sw) / 2;
      sy = (vh - sh) / 2;

      canvas.width = sw;
      canvas.height = sh;
      const ctx = canvas.getContext('2d');

      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';

      ctx.drawImage(videoEl, sx, sy, sw, sh, 0, 0, sw, sh);

      return canvas.toDataURL('image/jpeg', 0.9);
    }

    function parseItemsFromText(text) {
      const lines = text
        .split(/\r?\n/)
        .map(l => l.trim())
        .filter(l => l.length > 0);

      const items = [];
      const rowRegex = /^(.+?)\s+([–∞-—è–ê-–Øa-zA-Z0-9%]+)\s+(\d+(?:[.,]\d+)?)\s+(\d+(?:[.,]\d+)?)\s+(\d+(?:[.,]\d+)?)(?:\s+(\d+%)\s+(\d+(?:[.,]\d+)?)\s+(\d+(?:[.,]\d+)?))?$/u;

      for (const line of lines) {
        const m = line.match(rowRegex);
        if (!m) continue;

        const name = m[1].trim();
        const unit = m[2].trim();
        const qty = m[3].replace(',', '.');
        const price = m[4].replace(',', '.');
        const total = m[5].replace(',', '.');

        items.push({
          name,
          unit,
          qty,
          price,
          total
        });
      }

      return items;
    }

    function renderResults(items, text, durationMs) {
      resultsTableBody.innerHTML = '';
      if (!items.length) {
        resultsBadge.textContent = '–ù–µ—Ç —Å—Ç—Ä–æ–∫';
        resultsBadge.className = 'badge badge-error';
      } else {
        resultsBadge.textContent = `–°—Ç—Ä–æ–∫: ${items.length}`;
        resultsBadge.className = 'badge';
      }

      items.forEach((item, idx) => {
        const tr = document.createElement('tr');

        const tdIdx = document.createElement('td');
        tdIdx.textContent = String(idx + 1);

        const tdName = document.createElement('td');
        tdName.textContent = item.name;
        tdName.className = 'col-name';

        const tdUnit = document.createElement('td');
        tdUnit.textContent = item.unit;

        const tdQty = document.createElement('td');
        tdQty.textContent = item.qty;

        const tdPrice = document.createElement('td');
        tdPrice.textContent = item.price;

        const tdTotal = document.createElement('td');
        tdTotal.textContent = item.total;

        tr.appendChild(tdIdx);
        tr.appendChild(tdName);
        tr.appendChild(tdUnit);
        tr.appendChild(tdQty);
        tr.appendChild(tdPrice);
        tr.appendChild(tdTotal);

        resultsTableBody.appendChild(tr);
      });

      resultsMeta.textContent = `OCR: ${(durationMs / 1000).toFixed(1)} c ¬∑ ${items.length ? '–Ω–∞–π–¥–µ–Ω—ã —Å—Ç—Ä–æ–∫–∏, –ø–æ—Ö–æ–∂–∏–µ –Ω–∞ —Ç–æ–≤–∞—Ä—ã' : '–Ω–∏—á–µ–≥–æ –ø–æ—Ö–æ–∂–µ–≥–æ –Ω–∞ —Å—Ç—Ä–æ–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'}`;
      rawTextEl.textContent = text;
      resultsCard.classList.remove('hidden');
    }

    async function runOcrOnDataUrl(dataUrl) {
      setStatus('busy', '–†–∞—Å–ø–æ–∑–Ω–∞—ë–º —Ç–µ–∫—Å—Ç‚Ä¶ —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥');
      const start = performance.now();
      try {
        const { data } = await Tesseract.recognize(dataUrl, 'rus+eng', {
          tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK,
          tessedit_char_whitelist: '0123456789.,-%/abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ–∞–±–≤–≥–¥–µ—ë–∂–∑–∏–π–∫–ª–º–Ω–æ–ø—Ä—Å—Ç—É—Ñ—Ö—Ü—á—à—â—ä—ã—å—ç—é—è–ê–ë–í–ì–î–ï–Å–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–´–¨–≠–Æ–Ø ',
        });

        const duration = performance.now() - start;
        const text = data.text || '';
        const items = parseItemsFromText(text);
        renderResults(items, text, duration);
        setStatus('active', '–ì–æ—Ç–æ–≤–æ. –ú–æ–∂–µ—à—å —Å–¥–µ–ª–∞—Ç—å –µ—â—ë –æ–¥–∏–Ω —Å–Ω–∏–º–æ–∫.');
      } catch (err) {
        console.error(err);
        setStatus('error', '–û—à–∏–±–∫–∞ OCR. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ –∏–ª–∏ —Å–¥–µ–ª–∞–π —Ñ–æ—Ç–æ —á—ë—Ç—á–µ.');
      }
    }

    captureBtn.addEventListener('click', async () => {
      if (!usingCamera) {
        setStatus('error', '–ö–∞–º–µ—Ä–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª.');
        return;
      }
      try {
        const dataUrl = captureFrame();
        await runOcrOnDataUrl(dataUrl);
      } catch (err) {
        console.error(err);
        setStatus('error', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫. –ü–æ–¥–æ–∂–¥–∏ —Å–µ–∫—É–Ω–¥—É –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞.');
      }
    });

    toggleSourceBtn.addEventListener('click', () => {
      if (usingCamera) {
        usingCamera = false;
        if (currentStream) {
          currentStream.getTracks().forEach(t => t.stop());
          currentStream = null;
        }
        setStatus('active', '–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞.');
      } else {
        initCamera();
      }
    });

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async (ev) => {
        const dataUrl = ev.target.result;
        await runOcrOnDataUrl(dataUrl);
      };
      reader.readAsDataURL(file);
    });

    window.addEventListener('load', () => {
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        initCamera();
      } else {
        setStatus('error', '–ö–∞–º–µ—Ä–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑—É–π –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞.');
      }
    });
  </script>
</body>
</html>
