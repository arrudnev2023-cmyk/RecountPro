<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>–ë–∞–∑–∞ —à—Ç—Ä–∏—Ö‚Äë–∫–æ–¥–æ–≤ ‚Äî –ú–æ–±–∏–ª—å–Ω–∞—è</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg-1:#07040a;
  --bg-2:#0f0b16;
  --muted:#9aa0b4;
  --neon1:#8a2be2;
  --neon2:#c86cff;
  --accent:linear-gradient(90deg,var(--neon1),var(--neon2));
  --card-radius:14px;
  --btn-radius:12px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;padding:0;background:
  radial-gradient(800px 400px at 10% 10%, rgba(138,43,226,0.06), transparent),
  radial-gradient(600px 300px at 90% 90%, rgba(200,108,255,0.04), transparent),
  linear-gradient(180deg,var(--bg-1),var(--bg-2));
  font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;
  color:#eef0ff;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  padding:12px;
}

/* Layout */
.container{
  max-width:480px;
  margin:0 auto;
  display:flex;
  flex-direction:column;
  gap:12px;
}

/* Header */
.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
.brand{
  display:flex;
  gap:12px;
  align-items:center;
}
.logo{
  width:44px;height:44px;border-radius:10px;
  background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;
  box-shadow:0 10px 30px rgba(138,43,226,0.12);
}
.title{
  font-size:18px;font-weight:700;
}
.subtitle{font-size:13px;color:var(--muted)}

/* Card */
.card{
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:var(--card-radius);
  padding:12px;
  border:1px solid rgba(255,255,255,0.03);
  box-shadow:0 10px 30px rgba(0,0,0,0.6);
}

/* Camera area: max 1/3 viewport height */
.preview-wrap{
  position:relative;
  border-radius:12px;
  overflow:hidden;
  background:#000;
}
.preview-wrap.camera-1-3{
  height:33vh;
  min-height:140px;
  max-height:300px;
}
video#preview{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}

/* Controls */
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.btn{
  padding:10px 12px;border-radius:var(--btn-radius);border:none;cursor:pointer;font-weight:700;
  background:var(--accent);color:#07040a;box-shadow:0 10px 30px rgba(138,43,226,0.12);
}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);box-shadow:none}
.select{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}

/* Inputs */
.field{display:flex;flex-direction:column;gap:6px;margin-top:8px}
label{font-size:13px;color:var(--muted)}
input,textarea{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:15px}
textarea{resize:vertical}

/* Results */
.found{font-size:15px;color:var(--neon2);font-weight:700;margin-top:8px}

/* Table */
.table-wrap{overflow:auto;max-height:260px;margin-top:8px;border-radius:10px}
table{width:100%;border-collapse:collapse;font-size:14px;color:#dfe6ff}
thead th{text-align:left;padding:10px;font-weight:700;color:var(--muted);border-bottom:1px solid rgba(255,255,255,0.03)}
tbody td{padding:10px;border-bottom:1px dashed rgba(255,255,255,0.02)}

/* Footer small */
.small{font-size:13px;color:var(--muted)}

/* Responsive tweaks */
@media (min-width:520px){
  .container{max-width:520px}
}
</style>
</head>
<body>

<div class="container" role="main" aria-label="–ë–∞–∑–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤ –º–æ–±–∏–ª—å–Ω–∞—è">
  <header class="header">
    <div class="brand">
      <div class="logo">BC</div>
      <div>
        <div class="title">–ë–∞–∑–∞ —à—Ç—Ä–∏—Ö‚Äë–∫–æ–¥–æ–≤</div>
        <div class="subtitle">–°–∫–∞–Ω–µ—Ä –∑–∞–Ω–∏–º–∞–µ—Ç —Ç—Ä–µ—Ç—å —ç–∫—Ä–∞–Ω–∞ ‚Äî –º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è</div>
      </div>
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <button id="exportBtn" class="btn ghost" aria-label="–≠–∫—Å–ø–æ—Ä—Ç –±–∞–∑—ã">–≠–∫—Å–ø–æ—Ä—Ç</button>
      <button id="importBtn" class="btn ghost" aria-label="–ò–º–ø–æ—Ä—Ç –±–∞–∑—ã">–ò–º–ø–æ—Ä—Ç</button>
    </div>
  </header>

  <!-- Camera card -->
  <section class="card" aria-labelledby="cameraTitle">
    <h3 id="cameraTitle" style="margin:0 0 8px 0">–°–∫–∞–Ω–µ—Ä</h3>

    <div class="preview-wrap camera-1-3" aria-hidden="false">
      <video id="preview" playsinline muted></video>
    </div>

    <div class="controls" style="margin-top:10px">
      <select id="deviceSelect" class="select" aria-label="–í—ã–±–æ—Ä –∫–∞–º–µ—Ä—ã"></select>
      <button id="switchBtn" class="btn ghost" aria-label="–°–º–µ–Ω–∏—Ç—å –∫–∞–º–µ—Ä—É">üîÑ</button>
      <button id="torchBtn" class="btn ghost" aria-label="–§–æ–Ω–∞—Ä–∏–∫">üî¶</button>
      <button id="stopBtn" class="btn ghost" aria-label="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å">‚õî</button>
    </div>

    <div id="scanResult" class="found" aria-live="polite"></div>
    <div class="small" style="margin-top:8px">–ü–æ–¥–Ω–µ—Å–∏—Ç–µ —à—Ç—Ä–∏—Ö‚Äë–∫–æ–¥ ‚Äî —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø–æ –≤—Å–µ–º—É –∫–∞–¥—Ä—É, –ø–æ–¥ –ª—é–±—ã–º —É–≥–ª–æ–º.</div>
  </section>

  <!-- Manual add / quick edit -->
  <section class="card" aria-labelledby="manualTitle">
    <h3 id="manualTitle" style="margin:0 0 8px 0">–î–æ–±–∞–≤–∏—Ç—å / –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å</h3>

    <div class="field">
      <label for="codeInput">–®—Ç—Ä–∏—Ö‚Äë–∫–æ–¥</label>
      <input id="codeInput" type="text" placeholder="–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –≤—Ä—É—á–Ω—É—é" autocomplete="off" />
    </div>

    <div class="field">
      <label for="nameInput">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input id="nameInput" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" autocomplete="off" />
    </div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="saveBtn" class="btn" style="flex:1">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∞–∑—É</button>
      <button id="deleteBtn" class="btn ghost" style="width:120px">–£–¥–∞–ª–∏—Ç—å</button>
    </div>

    <div class="small" style="margin-top:8px">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ localStorage –ø–æ–¥ –∫–ª—é—á–æ–º <strong>barcodeDB</strong>.</div>
  </section>

  <!-- Bulk import -->
  <section class="card" aria-labelledby="bulkTitle">
    <h3 id="bulkTitle" style="margin:0 0 8px 0">–ú–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç</h3>
    <label for="bulk">–§–æ—Ä–º–∞—Ç: "4600605026533": "–ú–æ–ª–æ–∫–æ"</label>
    <textarea id="bulk" rows="4" placeholder='"4600605026533": "–ú–æ–ª–æ–∫–æ"
"4810268035258": "–°—ã—Ä —Ä–æ—Å—Å–∏–π—Å–∫–∏–π"'></textarea>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="bulkImportBtn" class="btn" style="flex:1">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      <button id="clearAllBtn" class="btn ghost" style="width:120px">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
  </section>

  <!-- Table -->
  <section class="card" aria-labelledby="tableTitle">
    <h3 id="tableTitle" style="margin:0 0 8px 0">–ë–∞–∑–∞ —Ç–æ–≤–∞—Ä–æ–≤</h3>
    <div class="table-wrap" role="region" aria-label="–°–ø–∏—Å–æ–∫ —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤">
      <table id="table" aria-live="polite">
        <thead><tr><th>–®—Ç—Ä–∏—Ö‚Äë–∫–æ–¥</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<!-- ZXing fallback -->
<script src="https://unpkg.com/@zxing/library@latest"></script>

<script>
/* ===== State ===== */
let db = JSON.parse(localStorage.getItem('barcodeDB') || '{}');
let stream = null;
let currentDeviceId = null;
let scanning = false;
let detector = ('BarcodeDetector' in window) ? new BarcodeDetector({formats: ["ean_13","ean_8","code_128","code_39","upc_a","upc_e","itf"]}) : null;
let reader = null;
let lastDetected = {code:null, ts:0};
const DEBOUNCE_MS = 900;

/* ===== Elements ===== */
const preview = document.getElementById('preview');
const deviceSelect = document.getElementById('deviceSelect');
const switchBtn = document.getElementById('switchBtn');
const torchBtn = document.getElementById('torchBtn');
const stopBtn = document.getElementById('stopBtn');
const scanResult = document.getElementById('scanResult');

const codeInput = document.getElementById('codeInput');
const nameInput = document.getElementById('nameInput');
const saveBtn = document.getElementById('saveBtn');
const deleteBtn = document.getElementById('deleteBtn');

const bulk = document.getElementById('bulk');
const bulkImportBtn = document.getElementById('bulkImportBtn');
const clearAllBtn = document.getElementById('clearAllBtn');

const tableBody = document.querySelector('#table tbody');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');

/* ===== Utilities ===== */
function saveDB(){ localStorage.setItem('barcodeDB', JSON.stringify(db)); renderTable(); }
function renderTable(){
  tableBody.innerHTML = '';
  const keys = Object.keys(db);
  if(!keys.length){
    tableBody.innerHTML = '<tr><td colspan="2" class="small" style="padding:12px;color:var(--muted)">–ë–∞–∑–∞ –ø—É—Å—Ç–∞</td></tr>';
    return;
  }
  keys.forEach(code=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${code}</td><td>${db[code]}</td>`;
    tableBody.appendChild(tr);
  });
}
function beep(){ try{ navigator.vibrate?.(60); }catch(e){} }

/* ===== Camera & devices ===== */
async function enumerateCameras(){
  try{
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === 'videoinput');
    deviceSelect.innerHTML = '';
    cams.forEach((c, idx)=>{
      const opt = document.createElement('option');
      opt.value = c.deviceId;
      opt.text = c.label || `–ö–∞–º–µ—Ä–∞ ${idx+1}`;
      deviceSelect.appendChild(opt);
    });
    if(cams.length && !currentDeviceId) currentDeviceId = cams[0].deviceId;
    if(currentDeviceId) deviceSelect.value = currentDeviceId;
  }catch(e){}
}

async function startCamera(){
  stopCamera();
  scanning = true;
  await enumerateCameras();

  const constraints = {
    audio:false,
    video:{
      deviceId: deviceSelect.value || currentDeviceId || undefined,
      facingMode: { ideal: "environment" },
      width: { ideal: 1280 },
      height: { ideal: 720 }
    }
  };

  try{
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    preview.srcObject = stream;
    await preview.play();
    currentDeviceId = stream.getVideoTracks()[0].getSettings().deviceId || currentDeviceId;
    deviceSelect.value = currentDeviceId || deviceSelect.value;

    reader = new ZXing.BrowserMultiFormatReader();
    requestAnimationFrame(scanLoop);
  }catch(err){
    console.error('camera error', err);
    scanResult.innerText = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ';
    scanning = false;
  }
}

function stopCamera(){
  scanning = false;
  if(preview.srcObject){
    preview.srcObject.getTracks().forEach(t=>t.stop());
    preview.srcObject = null;
  }
  if(reader){
    try{ reader.reset(); }catch(e){}
    reader = null;
  }
}

/* Torch */
let torchOn = false;
async function toggleTorch(){
  if(!stream) return alert('–°–Ω–∞—á–∞–ª–∞ –≤–∫–ª—é—á–∏—Ç–µ –∫–∞–º–µ—Ä—É');
  const track = stream.getVideoTracks()[0];
  try{
    await track.applyConstraints({ advanced: [{ torch: !torchOn }] });
    torchOn = !torchOn;
    torchBtn.textContent = torchOn ? 'üî¶ ON' : 'üî¶';
  }catch(e){
    alert('Torch –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ/–±—Ä–∞—É–∑–µ—Ä–µ.');
  }
}

/* ===== Decoding helpers ===== */
function createCanvas(w,h){ const c=document.createElement('canvas'); c.width=w; c.height=h; return c; }

async function tryDecodeCanvas(canvas){
  // BarcodeDetector
  if(detector){
    try{
      const imageData = canvas.getContext('2d').getImageData(0,0,canvas.width,canvas.height);
      const res = await detector.detect(imageData);
      if(res && res.length) return res[0].rawValue;
    }catch(e){}
  }
  // ZXing direct
  try{
    const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(canvas);
    const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
    const result = new ZXing.MultiFormatReader().decode(binaryBitmap);
    if(result && result.text) return result.text;
  }catch(e){}
  // rotated attempts
  const w = canvas.width, h = canvas.height;
  const temp = createCanvas(w,h);
  const tctx = temp.getContext('2d');
  for(let angle of [90,180,270]){
    tctx.clearRect(0,0,w,h);
    tctx.save();
    tctx.translate(w/2,h/2);
    tctx.rotate(angle*Math.PI/180);
    tctx.drawImage(canvas, -w/2, -h/2);
    tctx.restore();
    try{
      const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(temp);
      const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
      const result = new ZXing.MultiFormatReader().decode(binaryBitmap);
      if(result && result.text) return result.text;
    }catch(e){}
  }
  return null;
}

/* Main scanning loop (full frame) */
let canvasPool = [];
function getCanvas(w,h){
  for(let c of canvasPool) if(c.width===w && c.height===h) return c;
  const c = createCanvas(w,h); canvasPool.push(c); return c;
}

async function scanLoop(){
  if(!scanning) return;
  try{
    const w = preview.videoWidth;
    const h = preview.videoHeight;
    if(w===0 || h===0){ requestAnimationFrame(scanLoop); return; }

    const canvas = getCanvas(w,h);
    const ctx = canvas.getContext('2d');
    ctx.drawImage(preview, 0, 0, w, h);

    // downscale for speed
    const scale = Math.max(1, Math.floor(Math.max(w,h)/900));
    const sw = Math.floor(w/scale);
    const sh = Math.floor(h/scale);
    const small = getCanvas(sw,sh);
    const sctx = small.getContext('2d');
    sctx.drawImage(canvas, 0, 0, w, h, 0, 0, sw, sh);

    const code = await tryDecodeCanvas(small);
    if(code) handleDetected(code);
  }catch(e){
    // ignore
  } finally {
    requestAnimationFrame(scanLoop);
  }
}

/* Handle detection */
function handleDetected(code){
  const now = Date.now();
  if(code === lastDetected.code && (now - lastDetected.ts) < DEBOUNCE_MS) return;
  lastDetected = {code, ts: now};
  beep();
  scanResult.innerText = `${code} ‚Üí ${db[code] || '–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω'}`;
  // populate inputs for quick save/edit
  codeInput.value = code;
  if(db[code]) nameInput.value = db[code];
  else nameInput.value = '';
}

/* ===== UI actions ===== */
deviceSelect.addEventListener('change', async ()=>{
  currentDeviceId = deviceSelect.value;
  await startCamera();
});
switchBtn.addEventListener('click', async ()=>{
  // cycle devices
  const opts = Array.from(deviceSelect.options);
  if(!opts.length) return;
  const idx = opts.findIndex(o=>o.value === deviceSelect.value);
  const next = opts[(idx+1) % opts.length];
  deviceSelect.value = next.value;
  currentDeviceId = next.value;
  await startCamera();
});
torchBtn.addEventListener('click', toggleTorch);
stopBtn.addEventListener('click', stopCamera);

saveBtn.addEventListener('click', ()=>{
  const code = (codeInput.value || '').trim();
  const name = (nameInput.value || '').trim();
  if(!code) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥');
  if(!name) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞');
  db[code] = name;
  saveDB();
  scanResult.innerText = `–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${code} ‚Üí ${name}`;
});

deleteBtn.addEventListener('click', ()=>{
  const code = (codeInput.value || '').trim();
  if(!code) return alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
  if(db[code]){ delete db[code]; saveDB(); alert('–£–¥–∞–ª–µ–Ω–æ'); } else alert('–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω');
});

bulkImportBtn.addEventListener('click', ()=>{
  const text = bulk.value.trim();
  const lines = text.split('\n');
  let count = 0;
  lines.forEach(line=>{
    const match = line.match(/"(\d+)":\s*"(.+?)"/);
    if(match){ db[match[1]] = match[2]; count++; }
  });
  saveDB();
  alert(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${count} –∑–∞–ø–∏—Å–µ–π`);
});

clearAllBtn.addEventListener('click', ()=>{
  if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –±–∞–∑—É —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤?')){ db = {}; saveDB(); }
});

/* Export / Import JSON */
exportBtn.addEventListener('click', ()=>{
  const data = JSON.stringify(db, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'barcodeDB.json'; a.click();
  URL.revokeObjectURL(url);
});

importBtn.addEventListener('click', ()=>{
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json';
  input.onchange = e=>{
    const file = e.target.files[0];
    if(!file) return;
    const readerFile = new FileReader();
    readerFile.onload = ev=>{
      try{
        const obj = JSON.parse(ev.target.result);
        db = Object.assign({}, db, obj);
        saveDB();
        alert('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω');
      }catch(err){ alert('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON'); }
    };
    readerFile.readAsText(file);
  };
  input.click();
});

/* Init */
renderTable();
enumerateCameras();
navigator.mediaDevices.getUserMedia({video:true}).then(s=>{
  s.getTracks().forEach(t=>t.stop());
  enumerateCameras();
}).catch(()=>{ /* ignore */ });

/* Stop camera when leaving page */
window.addEventListener('pagehide', ()=>{ stopCamera(); });
window.addEventListener('beforeunload', ()=>{ stopCamera(); });

</script>
</body>
</html>

