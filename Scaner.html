<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>VisualDrop ‚Äî –ö–æ–¥–µ—Ä –∏ –°–∫–∞–Ω–µ—Ä</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <style>
    body { font-family: sans-serif; background:#0d1117; color:#e6edf3; margin:0; padding:12px; }
    h1 { font-size:18px; margin:12px 0; }
    .card { background:#161b22; padding:16px; border-radius:12px; margin-bottom:16px; }
    button,input[type=file] { width:100%; margin:6px 0; padding:10px; border-radius:8px; border:none; font-weight:600; }
    button { background:#4b8cff; color:white; }
    button:disabled { opacity:.5; }
    .progress { height:10px; background:#30363d; border-radius:999px; overflow:hidden; margin:8px 0; }
    .bar { height:100%; width:0%; background:linear-gradient(90deg,#4b8cff,#7aa6ff); }
    video,canvas { width:100%; max-width:320px; margin-top:8px; border-radius:8px; }
    .muted { color:#8b949e; font-size:13px; margin-top:4px; }
    .debug { color:#58a6ff; font-size:13px; margin-top:6px; }
  </style>
</head>
<body>
  <h1>üì≤ VisualDrop ‚Äî –ö–æ–¥–µ—Ä –∏ –°–∫–∞–Ω–µ—Ä</h1>

  <!-- –ö–û–î–ï–† -->
  <div class="card">
    <h2>–ö–æ–¥–µ—Ä</h2>
    <input type="file" id="fileInput">
    <button id="btnGenerate" disabled>–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ –≤–∏–¥–µ–æ</button>
    <div class="progress"><div class="bar" id="encBar"></div></div>
    <video id="genVideo" controls></video>
    <a id="downloadVideo" href="#" download="visualdrop.webm" style="display:none;">
      <button>–°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ</button>
    </a>
    <div class="muted" id="encStatus">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
  </div>

  <!-- –°–ö–ê–ù–ï–† -->
  <div class="card">
    <h2>–°–∫–∞–Ω–µ—Ä</h2>
    <input type="file" id="videoInput" accept="video/mp4,video/webm">
    <button id="btnDecode" disabled>–°–æ–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
    <div class="progress"><div class="bar" id="decBar"></div></div>
    <a id="downloadLink" href="#" style="display:none;">
      <button id="btnDownload">–°–∫–∞—á–∞—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª</button>
    </a>
    <video id="video" controls></video>
    <canvas id="canvas" width="128" height="128" style="display:none;"></canvas>
    <div class="muted" id="decStatus">–í–∏–¥–µ–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ</div>
    <div class="debug" id="debugInfo"></div>
  </div>

<script>
const GRID=128, BYTES_PER_CELL=3, CELLS=GRID*GRID, PAYLOAD_PER_FRAME=CELLS*BYTES_PER_CELL;
const HEADER_SIZE=512; // –±–∞–π—Ç –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–æ–∫

// ===== –ö–û–î–ï–† =====
const fileInput=document.getElementById('fileInput');
const btnGenerate=document.getElementById('btnGenerate');
const encBar=document.getElementById('encBar');
const encStatus=document.getElementById('encStatus');
const genVideo=document.getElementById('genVideo');
const downloadVideo=document.getElementById('downloadVideo');

let fileBytes=null, fileName="";

fileInput.addEventListener('change', async ()=>{
  const f=fileInput.files[0];
  if(!f) return;
  if(f.size>100*1024*1024){ alert("–ú–∞–∫—Å–∏–º—É–º 100 –ú–ë"); return; }
  fileBytes=new Uint8Array(await f.arrayBuffer());
  fileName=f.name;
  btnGenerate.disabled=false;
  encStatus.textContent=`–§–∞–π–ª: ${f.name} (${(f.size/1024/1024).toFixed(1)} –ú–ë)`;
});

btnGenerate.addEventListener('click', async ()=>{
  if(!fileBytes) return;
  encStatus.textContent="–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞–¥—Ä–æ–≤...";
  const totalFrames=Math.ceil(fileBytes.length/PAYLOAD_PER_FRAME);
  const frames=[];
  for(let i=0;i<totalFrames;i++){
    const chunk=fileBytes.slice(i*PAYLOAD_PER_FRAME,(i+1)*PAYLOAD_PER_FRAME);
    const frame=buildFrame(chunk,i,totalFrames);
    frames.push(frame);
    encBar.style.width=`${((i+1)/totalFrames)*100}%`;
  }
  const stream=canvasStream(frames,10);
  const rec=new MediaRecorder(stream,{mimeType:"video/webm"});
  const chunks=[];
  rec.ondataavailable=e=>chunks.push(e.data);
  rec.onstop=()=>{
    const blob=new Blob(chunks,{type:"video/webm"});
    const url=URL.createObjectURL(blob);
    genVideo.src=url;
    downloadVideo.href=url;
    downloadVideo.style.display="block";
    encStatus.textContent=`–í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ (${totalFrames} –∫–∞–¥—Ä–æ–≤)`;
  };
  rec.start();
  setTimeout(()=>rec.stop(),frames.length*100);
});

function buildFrame(chunk, index, total){
  const canvas=document.createElement('canvas');
  canvas.width=GRID; canvas.height=GRID;
  const ctx=canvas.getContext('2d');
  const img=ctx.createImageData(GRID,GRID);
  let ci=0;
  if(index===0){
    const meta=JSON.stringify({name:fileName,size:fileBytes.length,total});
    const enc=new TextEncoder().encode(meta);
    for(let i=0;i<enc.length && i<HEADER_SIZE;i++){
      chunk[i]=enc[i];
    }
  }
  for(let i=0;i<chunk.length;i+=3){
    const r=chunk[i]||0,g=chunk[i+1]||0,b=chunk[i+2]||0;
    const idx=ci*4;
    img.data[idx]=r; img.data[idx+1]=g; img.data[idx+2]=b; img.data[idx+3]=255;
    ci++;
  }
  ctx.putImageData(img,0,0);
  return canvas;
}

function canvasStream(frames,fps){
  const canvas=document.createElement('canvas');
  canvas.width=GRID; canvas.height=GRID;
  const ctx=canvas.getContext('2d');
  let i=0;
  setInterval(()=>{
    ctx.drawImage(frames[i],0,0);
    i=(i+1)%frames.length;
  },1000/fps);
  return canvas.captureStream(fps);
}

// ===== –°–ö–ê–ù–ï–† =====
const videoInput=document.getElementById('videoInput');
const btnDecode=document.getElementById('btnDecode');
const decBar=document.getElementById('decBar');
const decStatus=document.getElementById('decStatus');
const video=document.getElementById('video');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const downloadLink=document.getElementById('downloadLink');
const debugInfo=document.getElementById('debugInfo');

let framesData=[], metaInfo=null;

videoInput.addEventListener('change',()=>{
  const f=videoInput.files[0];
  if(!f) return;
  const url=URL.createObjectURL(f);
  video.src=url;
  btnDecode.disabled=false;
  decStatus.textContent=`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –≤–∏–¥–µ–æ: ${f.name}`;
});

btnDecode.addEventListener('click',async ()=>{
  framesData=[];
  metaInfo=null;
  decStatus.textContent="–î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ...";
  await decodeVideo();
});

async function decodeVideo(){
  const duration=video.duration;
  const fps=10;
  const totalFrames=Math.floor(duration*fps);
  for(let i=0;i<totalFrames;i++){
    video.currentTime=i/fps;
    await new Promise(r=>video.onseeked=r);
    ctx.drawImage(video,0,0,GRID,GRID);
    const frame=ctx.getImageData(0,0,GRID,GRID).data;
    const chunk=[];
    for(let j=0;j<CELLS;j++){
      const idx=j*4;
      chunk.push(frame[idx],frame[idx+1],frame[idx+2]);
    }
    const arr=new Uint8Array(chunk);
    if(i===0){
      const raw=new TextDecoder().decode(arr.slice(0,HEADER_SIZE));
      const end=raw.indexOf("}");
      if(end!==-1){
        try{
          const json=raw.slice(0,end+1);
          metaInfo=JSON.parse(json);
        }catch(e){ console.warn("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞",e); }
      }
            // —É–±–∏—Ä–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏–∑ –ø–æ–ª–µ–∑–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
      framesData.push(arr.slice(HEADER_SIZE));
    } else {
      framesData.push(arr);
    }
    decBar.style.width=`${((i+1)/totalFrames)*100}%`;
    decStatus.textContent=`–ö–∞–¥—Ä–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${i+1}/${totalFrames}`;
  }
  assembleFile();
}

function assembleFile(){
  const totalLen = framesData.reduce((s,b)=>s+b.length,0);
  const out = new Uint8Array(totalLen);
  let o = 0; 
  for(const c of framesData){ 
    out.set(c,o); 
    o += c.length; 
  }

  // –ò–º—è —Ñ–∞–π–ª–∞ –∏–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
  let fileName = "output.bin";
  if(metaInfo && metaInfo.name){
    fileName = metaInfo.name;
  }

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é
  let mime = "application/octet-stream";
  if(fileName.toLowerCase().endsWith(".jpg") || fileName.toLowerCase().endsWith(".jpeg")) mime = "image/jpeg";
  if(fileName.toLowerCase().endsWith(".png")) mime = "image/png";
  if(fileName.toLowerCase().endsWith(".gif")) mime = "image/gif";
  if(fileName.toLowerCase().endsWith(".pdf")) mime = "application/pdf";
  if(fileName.toLowerCase().endsWith(".mp3")) mime = "audio/mpeg";
  if(fileName.toLowerCase().endsWith(".mp4")) mime = "video/mp4";
  if(fileName.toLowerCase().endsWith(".zip")) mime = "application/zip";

  const blob = new Blob([out], {type: mime});
  const url = URL.createObjectURL(blob);

  downloadLink.href = url;
  downloadLink.download = fileName;
  downloadLink.style.display = "block";

  decStatus.textContent = `‚úÖ –§–∞–π–ª —Å–æ–±—Ä–∞–Ω: ${fileName}`;
  debugInfo.textContent = `–§–æ—Ä–º–∞—Ç –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –∫–∞–∫ ${mime} (–ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é ${fileName.split('.').pop()})`;
}
</script>
</body>
</html>

