<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ë–∞–∑–∞ —à—Ç—Ä–∏—Ö‚Äë–∫–æ–¥–æ–≤</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
    body {
        margin: 0;
        background: #f4f6f8;
        font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
    }

    header {
        background: #1e88e5;
        color: white;
        padding: 15px;
        font-size: 22px;
        text-align: center;
        font-weight: bold;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .container {
        padding: 15px;
        max-width: 900px;
        margin: auto;
    }

    .card {
        background: white;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    h2 {
        margin-top: 0;
        font-size: 20px;
        color: #333;
    }

    input, textarea, button {
        width: 100%;
        padding: 12px;
        margin-top: 8px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 16px;
        box-sizing: border-box;
    }

    button {
        background: #1e88e5;
        color: white;
        border: none;
        font-weight: bold;
        transition: 0.2s;
    }

    button:hover {
        background: #1565c0;
    }

    /* –¢–∞–±–ª–∏—Ü–∞ */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        table-layout: fixed;
    }

    th, td {
        border-bottom: 1px solid #ddd;
        padding: 10px;
        word-break: break-word;
        vertical-align: top;
    }

    th {
        background: #f0f0f0;
        font-weight: bold;
    }

    th:first-child, td:first-child {
        width: 120px;
    }

    .found {
        font-size: 18px;
        margin-top: 10px;
        font-weight: bold;
        color: #1e88e5;
    }

    /* –°–∫–∞–Ω–µ—Ä */
    #preview {
        width: 100%;
        border-radius: 12px;
        margin-top: 10px;
    }

    /* –†–∞–º–∫–∞ –ø–æ–¥ –ª–∏–Ω–µ–π–Ω—ã–π —à—Ç—Ä–∏—Ö-–∫–æ–¥ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è) */
    #frame {
        position: absolute;
        border: 3px solid #ff5252;
        width: 80%;
        height: 80px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
        border-radius: 8px;
    }

    .scanner-wrapper {
        position: relative;
        max-width: 400px;
        margin: auto;
    }
</style>
</head>
<body>

<header>–ë–∞–∑–∞ —à—Ç—Ä–∏—Ö‚Äë–∫–æ–¥–æ–≤</header>

<div class="container">

    <!-- –°–∫–∞–Ω–µ—Ä -->
    <div class="card">
        <h2>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–º–µ—Ä–æ–π</h2>
        <button onclick="startScanner()">üì∑ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
        <button onclick="stopScanner()" style="background:#e53935;margin-top:10px;">‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>

        <div class="scanner-wrapper">
            <video id="preview" playsinline></video>
            <div id="frame"></div>
        </div>

        <div id="scanResult" class="found"></div>
    </div>

    <!-- –†—É—á–Ω–æ–π –≤–≤–æ–¥ -->
    <div class="card">
        <h2>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –≤—Ä—É—á–Ω—É—é</h2>
        <input id="code" placeholder="–®—Ç—Ä–∏—Ö‚Äë–∫–æ–¥">
        <input id="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
        <button onclick="addItem()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>

    <!-- –ü–æ–∏—Å–∫ -->
    <div class="card">
        <h2>–ü–æ–∏—Å–∫ –ø–æ —à—Ç—Ä–∏—Ö‚Äë–∫–æ–¥—É</h2>
        <input id="scanInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥" oninput="scanCodeManual()">
        <div id="manualResult" class="found"></div>
    </div>

    <!-- –ú–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç -->
    <div class="card">
        <h2>–ú–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç</h2>
        <textarea id="bulk" rows="6" placeholder='"4600605026533": "–ú–æ–ª–æ–∫–æ"
"4810268035258": "–°—ã—Ä —Ä–æ—Å—Å–∏–π—Å–∫–∏–π"'></textarea>
        <button onclick="bulkImport()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ -->
    <div class="card">
        <h2>–ë–∞–∑–∞ —Ç–æ–≤–∞—Ä–æ–≤</h2>
        <table id="table">
            <thead>
                <tr><th>–®—Ç—Ä–∏—Ö‚Äë–∫–æ–¥</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
let db = JSON.parse(localStorage.getItem("barcodeDB") || "{}");
let codeReader = null;
let currentStream = null;

function saveDB() {
    localStorage.setItem("barcodeDB", JSON.stringify(db));
    renderTable();
}

function renderTable() {
    const tbody = document.querySelector("#table tbody");
    tbody.innerHTML = "";
    Object.keys(db).forEach(code => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${code}</td><td>${db[code]}</td>`;
        tbody.appendChild(tr);
    });
}

function addItem() {
    const code = document.getElementById("code").value.trim();
    const name = document.getElementById("name").value.trim();
    if (!code || !name) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ");
    db[code] = name;
    saveDB();
    document.getElementById("code").value = "";
    document.getElementById("name").value = "";
}

function bulkImport() {
    const text = document.getElementById("bulk").value.trim();
    const lines = text.split("\n");
    lines.forEach(line => {
        const match = line.match(/"(\d+)":\s*"(.+?)"/);
        if (match) db[match[1]] = match[2];
    });
    saveDB();
    alert("–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω");
}

function scanCodeManual() {
    const code = document.getElementById("scanInput").value.trim();
    document.getElementById("manualResult").innerText =
        db[code] ? `${code} ‚Üí ${db[code]}` : (code ? "–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω" : "");
}

// –°–ø–∏—Å–æ–∫ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ (—Ç–æ–ª—å–∫–æ –ª–∏–Ω–µ–π–Ω—ã–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥—ã)
const allowedFormats = [
    ZXing.BarcodeFormat.EAN_13,
    ZXing.BarcodeFormat.EAN_8,
    ZXing.BarcodeFormat.UPC_A,
    ZXing.BarcodeFormat.UPC_E,
    ZXing.BarcodeFormat.CODE_128,
    ZXing.BarcodeFormat.CODE_39,
    ZXing.BarcodeFormat.ITF
];

function startScanner() {
    if (codeReader) return;

    codeReader = new ZXing.BrowserMultiFormatReader();
    const preview = document.getElementById('preview');

    codeReader.listVideoInputDevices().then(devices => {
        // –≤—Å–µ–≥–¥–∞ –ø—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É
        let deviceId = null;
        const back = devices.find(d => /back|environment/gi.test(d.label));
        if (back) {
            deviceId = back.deviceId;
        } else if (devices.length > 0) {
            deviceId = devices[devices.length - 1].deviceId; // —á–∞—Å—Ç–æ –∑–∞–¥–Ω—è—è –ø–æ—Å–ª–µ–¥–Ω—è—è
        }

        if (!deviceId) {
            alert("–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
            return;
        }

        codeReader.decodeFromVideoDevice(deviceId, preview, (result, err) => {
            if (result) {
                // —Ñ–∏–ª—å—Ç—Ä—É–µ–º: —Ç–æ–ª—å–∫–æ —à—Ç—Ä–∏—Ö-–∫–æ–¥—ã, –Ω–µ QR
                if (!allowedFormats.includes(result.barcodeFormat)) {
                    return;
                }
                const code = result.text;
                const name = db[code] || "–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω";
                document.getElementById("scanResult").innerText = `${code} ‚Üí ${name}`;
            }
        });

        // –ø—Ä–æ–±—É–µ–º –≤–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ—Ñ–æ–∫—É—Å
        setTimeout(() => {
            try {
                const track = preview.srcObject && preview.srcObject.getVideoTracks()[0];
                if (track && track.applyConstraints) {
                    track.applyConstraints({
                        advanced: [
                            { focusMode: "continuous" }
                        ]
                    }).catch(() => {});
                }
            } catch(e) {}
        }, 1000);
    }).catch(err => {
        console.error(err);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ");
    });
}

function stopScanner() {
    if (codeReader) {
        codeReader.reset();
        codeReader = null;
    }
    const preview = document.getElementById('preview');
    if (preview && preview.srcObject) {
        preview.srcObject.getTracks().forEach(t => t.stop());
        preview.srcObject = null;
    }
}

renderTable();
</script>

</body>
</html>
