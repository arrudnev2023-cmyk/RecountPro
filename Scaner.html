<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–°–∫–∞–Ω–µ—Ä + Open Food Facts</title>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<style>
  :root{--bg:#f7f8fa;--card:#fff;--accent:#0b76ff;--muted:#666}
  html,body{height:100%;margin:0;font-family:Inter,Roboto,Arial,sans-serif;background:var(--bg);color:#111}
  .wrap{max-width:980px;margin:18px auto;padding:18px}
  .panel{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 2px 8px rgba(20,20,30,0.05)}
  #video{width:100%;height:360px;background:#000;border-radius:8px;object-fit:cover}
  .status{margin-top:10px;font-size:14px;color:var(--muted)}
  .result-area{margin-top:14px;min-height:120px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px}
  .card{display:flex;gap:12px;align-items:flex-start;width:100%}
  .thumb{width:120px;height:90px;background:#eee;border-radius:6px;flex:0 0 120px;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:13px;overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .meta{flex:1}
  .meta h3{margin:0;font-size:16px}
  .meta p{margin:6px 0;color:var(--muted);font-size:14px}
  button{background:var(--accent);border:none;color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600}
  button.ghost{background:#eee;color:#111}
</style>
</head>
<body>
<div class="wrap">
  <h1 class="panel">üì¶ –°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤ + Open Food Facts</h1>

  <div class="panel">
    <video id="video" autoplay playsinline></video>
    <div class="status" id="status">–û–∂–∏–¥–∞—é —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è‚Ä¶</div>
    <div class="result-area" id="resultArea">
      <div class="hint">–ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥</div>
    </div>
    <div style="margin-top:12px">
      <button id="toggleCamera">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
      <button id="clearResult" class="ghost">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
  </div>

  <p style="font-size:13px;color:#666;margin-top:8px">
    –õ–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –º–∞—Å—Å–∏–≤–µ PRODUCTS. –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Open Food Facts API –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫—ç—à–∏—Ä—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.
  </p>
</div>

<script>
/* ----------------- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ª–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ ----------------- */
const PRODUCTS = [
  { ean: "5901234123457", name: "Coca-Cola 0.5L", price: "79 ‚ÇΩ", image: "" },
  { ean: "4601234567890", name: "–ú–æ–ª–æ–∫–æ –î–æ–º–∏–∫ –≤ –¥–µ—Ä–µ–≤–Ω–µ 1.5%", price: "95 ‚ÇΩ", image: "" },
  { ean: "4006381333931", name: "–ú–∞—Ä–∫–µ—Ä Staedtler", price: "49 ‚ÇΩ", image: "" }
];
// Open Food Facts base URL (API v0 product endpoint)
const OFF_PRODUCT_URL = 'https://world.openfoodfacts.org/api/v0/product/'; // {code}.json

/* ----------------- –ù–µ–±–æ–ª—å—à–∏–π IndexedDB-Cache (–ø—Ä–æ—Å—Ç–æ–π) ----------------- */
const DB_NAME = 'off_cache_db';
const STORE = 'products';
function openDB(){ return new Promise((res, rej)=>{
  const r = indexedDB.open(DB_NAME,1);
  r.onupgradeneeded = ()=> r.result.createObjectStore(STORE, { keyPath: 'ean' });
  r.onsuccess = ()=> res(r.result);
  r.onerror = ()=> rej(r.error);
});}
async function dbGet(ean){
  const db = await openDB();
  return new Promise((res, rej)=>{
    const tx = db.transaction(STORE,'readonly').objectStore(STORE).get(ean);
    tx.onsuccess = ()=> res(tx.result?.data || null);
    tx.onerror = ()=> rej(tx.error);
  });
}
async function dbPut(ean, data){
  const db = await openDB();
  return new Promise((res, rej)=>{
    const tx = db.transaction(STORE,'readwrite').objectStore(STORE).put({ ean, data });
    tx.onsuccess = ()=> res(true);
    tx.onerror = ()=> rej(tx.error);
  });
}

/* ----------------- UI ----------------- */
const video = document.getElementById('video');
const status = document.getElementById('status');
const resultArea = document.getElementById('resultArea');
const toggleCameraBtn = document.getElementById('toggleCamera');
const clearResultBtn = document.getElementById('clearResult');

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function renderCard(product){
  const img = product.image || (product.image_small_url || product.image_url) || '';
  const imgHtml = img ? `<img src="${escapeHtml(img)}" alt="" />` : `<div style="width:120px;height:90px;display:flex;align-items:center;justify-content:center;color:#666">–ù–µ—Ç —Ñ–æ—Ç–æ</div>`;
  const price = product.price || product['price'] || '‚Äî';
  return `
    <div class="card">
      <div class="thumb">${imgHtml}</div>
      <div class="meta">
        <h3>${escapeHtml(product.name || product.product_name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</h3>
        <p class="price">${escapeHtml(price)}</p>
        <p><small>EAN: ${escapeHtml(product.ean || product.code)}</small></p>
      </div>
    </div>
  `;
}
function renderNotFound(code){ return `<div style="color:#b33;font-weight:600">‚ùå –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω: ${escapeHtml(code)}</div>`; }

/* ----------------- Open Food Facts –∑–∞–ø—Ä–æ—Å –∏ –ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ ----------------- */
async function fetchFromOFF(ean){
  try{
    const res = await fetch(`${OFF_PRODUCT_URL}${encodeURIComponent(ean)}.json`);
    if(!res.ok) return null;
    const j = await res.json();
    if(j.status === 1 && j.product){
      // –≤—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º –ø–æ–ª–µ–∑–Ω—ã–µ –ø–æ–ª—è: product_name, image_small_url, image_url
      const p = {
        ean,
        name: j.product.product_name || j.product.generic_name || j.product.brands,
        image_small_url: j.product.image_small_url || j.product.image_front_small_url || j.product.image_url,
        image_url: j.product.image_url || j.product.image_front_url,
        ingredients_text: j.product.ingredients_text,
        nutriments: j.product.nutriments,
        raw: j.product
      };
      return p;
    } else return null;
  } catch(e){ console.debug('OFF fetch err', e); return null; }
}

/* main search: –ª–æ–∫–∞–ª—å–Ω–æ -> indexedDB cache -> Open Food Facts API */
async function findProduct(ean){
  // 1) –ª–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ PRODUCTS
  const local = PRODUCTS.find(p => p.ean === ean);
  if(local) return local;
  // 2) –∫–µ—à
  const cached = await dbGet(ean);
  if(cached) return cached;
  // 3) –∑–∞–ø—Ä–æ—Å –∫ Open Food Facts
  const off = await fetchFromOFF(ean);
  if(off){ await dbPut(ean, off); return off; }
  return null;
}

/* ----------------- ZXing scanner ----------------- */
const codeReader = new ZXing.BrowserMultiFormatReader();
let streaming = false;
let lastDetected = { code: null, time: 0 };

function startCamera(){
  codeReader.listVideoInputDevices()
    .then(devices=>{
      if(!devices || devices.length === 0) throw new Error('–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
      const prefer = devices.find(d => /back|rear|environment/i.test(d.label)) || devices[0];
      codeReader.decodeFromVideoDevice(prefer.deviceId, video, (result, err)=>{
        if(result) handleCode(result.text);
      });
      streaming = true; toggleCameraBtn.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–º–µ—Ä—É';
      status.textContent = '–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞. –ù–∞–≤–µ–¥–∏ –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥.';
    })
    .catch(err=> status.textContent = '–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: ' + (err && err.message ? err.message : err));
}

function stopCamera(){ try{ codeReader.reset(); }catch(e){} streaming=false; toggleCameraBtn.textContent='–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É'; status.textContent='–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'; }

async function handleCode(code){
  const now = Date.now();
  if(code === lastDetected.code && (now - lastDetected.time) < 1200) return;
  lastDetected = { code, time: now };
  status.textContent = '–°—á–∏—Ç–∞–Ω: ' + code;
  resultArea.innerHTML = `<div style="color:#666">–ò—â—É...</div>`;
  const found = await findProduct(code);
  if(found) resultArea.innerHTML = renderCard(found);
  else resultArea.innerHTML = renderNotFound(code);
}

/* –∫–Ω–æ–ø–∫–∏ */
toggleCameraBtn.addEventListener('click', ()=> streaming ? stopCamera() : startCamera());
clearResultBtn.addEventListener('click', ()=> { resultArea.innerHTML = '<div class="hint">–û–∂–∏–¥–∞—é —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è‚Ä¶</div>'; status.textContent='–û—á–∏—â–µ–Ω–æ'; });

/* —Å—Ç–∞—Ä—Ç */
startCamera();
</script>
</body>
</html>
