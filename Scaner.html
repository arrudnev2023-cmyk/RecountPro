<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>–ë–∞–∑–∞ —à—Ç—Ä–∏—Ö‚Äë–∫–æ–¥–æ–≤ ‚Äî Dark Neon</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#07060b;
  --panel:#0f0c16;
  --muted:#9aa0b4;
  --neon1:#8a2be2;
  --neon2:#c86cff;
  --accent:linear-gradient(90deg,var(--neon1),var(--neon2));
  --radius:12px;
  --glass: rgba(255,255,255,0.03);
}

*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#05030a,#0b0710);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#eae9f8;-webkit-font-smoothing:antialiased}
.container{
  max-width:520px;margin:18px auto;padding:16px;display:flex;flex-direction:column;gap:12px;
}

/* Header */
.header{
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,0.03);
  box-shadow:0 10px 30px rgba(0,0,0,0.6);
}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:44px;height:44px;border-radius:10px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:800;color:#0b0710}
.title{font-size:18px;font-weight:700}
.subtitle{font-size:13px;color:var(--muted)}

/* Card */
.card{
  background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
  border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03);
  box-shadow:0 8px 24px rgba(0,0,0,0.6);
}

/* Camera area: 1/3 viewport height */
.preview-wrap{position:relative;border-radius:10px;overflow:hidden;background:#000;border:1px solid rgba(255,255,255,0.02)}
.preview-wrap.camera-1-3{height:33vh;min-height:140px;max-height:300px}
video#preview{width:100%;height:100%;object-fit:cover;display:block}

/* Controls */
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.btn{
  padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700;
  background:linear-gradient(90deg,#22202a,#1a1620);color:#eae9f8;
  box-shadow:0 6px 18px rgba(0,0,0,0.6);
}
.btn.primary{
  background:var(--accent);color:#0b0710;box-shadow:0 12px 36px rgba(138,43,226,0.12);
}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}

/* Inputs */
.field{display:flex;flex-direction:column;gap:6px;margin-top:10px}
label{font-size:13px;color:var(--muted)}
input[type="text"], textarea{
  width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);
  background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
  color:#eae9f8;font-size:15px;outline:none;
}

/* Table */
.table-wrap{overflow:auto;max-height:220px;margin-top:8px;border-radius:8px}
table{width:100%;border-collapse:collapse;font-size:14px;color:#eae9f8}
thead th{text-align:left;padding:10px;font-weight:700;color:var(--muted);border-bottom:1px solid rgba(255,255,255,0.03)}
tbody td{padding:10px;border-bottom:1px dashed rgba(255,255,255,0.02)}

/* small */
.small{font-size:13px;color:var(--muted)}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(10,8,14,0.9);color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:9999}

/* responsive */
@media (max-width:420px){ .container{padding:12px} .logo{width:40px;height:40px} }
</style>
</head>
<body>

<div class="container" role="main" aria-label="–ë–∞–∑–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤ ‚Äî —Ç—ë–º–Ω–∞—è –Ω–µ–æ–Ω–æ–≤–∞—è —Ç–µ–º–∞">
  <header class="header">
    <div class="brand">
      <div class="logo">BC</div>
      <div>
        <div class="title">–ë–∞–∑–∞ —à—Ç—Ä–∏—Ö‚Äë–∫–æ–¥–æ–≤</div>
        <div class="subtitle">–¢—ë–º–Ω–∞—è –º–∏–Ω–∏–º–∞–ª–∫–∞ ‚Ä¢ –ù–µ–æ–Ω–æ–≤—ã–π –∞–∫—Ü–µ–Ω—Ç</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="exportBtn" class="btn ghost" aria-label="–≠–∫—Å–ø–æ—Ä—Ç">–≠–∫—Å–ø–æ—Ä—Ç</button>
      <button id="importBtn" class="btn ghost" aria-label="–ò–º–ø–æ—Ä—Ç">–ò–º–ø–æ—Ä—Ç</button>
    </div>
  </header>

  <section class="card" aria-labelledby="scannerTitle">
    <h3 id="scannerTitle" style="margin:0 0 8px 0">–°–∫–∞–Ω–µ—Ä</h3>

    <div class="preview-wrap camera-1-3" aria-hidden="false">
      <video id="preview" playsinline muted></video>
    </div>

    <div class="controls">
      <button id="startScannerBtn" class="btn primary" aria-label="–í–∫–ª—é—á–∏—Ç—å —Å–∫–∞–Ω–µ—Ä">‚ñ∂ –í–∫–ª—é—á–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
      <button id="stopScannerBtn" class="btn ghost" aria-label="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–µ—Ä">‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
      <select id="deviceSelect" class="btn ghost" aria-label="–í—ã–±–æ—Ä –∫–∞–º–µ—Ä—ã" style="min-width:140px"></select>
      <button id="torchBtn" class="btn ghost" aria-label="–§–æ–Ω–∞—Ä–∏–∫">üî¶</button>
    </div>

    <div id="scanResult" class="small" style="margin-top:10px" aria-live="polite"></div>
  </section>

  <section class="card" aria-labelledby="editTitle">
    <h3 id="editTitle" style="margin:0 0 8px 0">–î–æ–±–∞–≤–∏—Ç—å / –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</h3>

    <div class="field">
      <label for="codeInput">–®—Ç—Ä–∏—Ö‚Äë–∫–æ–¥</label>
      <input id="codeInput" type="text" placeholder="–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥" autocomplete="off" />
    </div>

    <div class="field">
      <label for="nameInput">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input id="nameInput" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" autocomplete="off" />
    </div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="saveBtn" class="btn primary" style="flex:1">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button id="clearBtn" class="btn ghost" style="width:120px">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <div class="small" style="margin-top:8px">–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ <code>localStorage</code> –ø–æ–¥ –∫–ª—é—á–æ–º <strong>barcodeDB</strong>.</div>
  </section>

  <section class="card" aria-labelledby="tableTitle">
    <h3 id="tableTitle" style="margin:0 0 8px 0">–ë–∞–∑–∞ —Ç–æ–≤–∞—Ä–æ–≤</h3>
    <div class="table-wrap">
      <table id="table" aria-live="polite">
        <thead><tr><th>–®—Ç—Ä–∏—Ö‚Äë–∫–æ–¥</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- ZXing fallback -->
<script src="https://unpkg.com/@zxing/library@latest"></script>

<script>
/* ===== State ===== */
let db = JSON.parse(localStorage.getItem('barcodeDB') || '{}');
let stream = null;
let currentDeviceId = null;
let scanning = false;
let detector = ('BarcodeDetector' in window) ? new BarcodeDetector({formats: ["ean_13","ean_8","code_128","code_39","upc_a","upc_e","itf"]}) : null;
let reader = null;
let lastDetected = {code:null, ts:0};
const DEBOUNCE_MS = 900;

/* ===== Elements ===== */
const preview = document.getElementById('preview');
const startScannerBtn = document.getElementById('startScannerBtn');
const stopScannerBtn = document.getElementById('stopScannerBtn');
const deviceSelect = document.getElementById('deviceSelect');
const torchBtn = document.getElementById('torchBtn');
const scanResult = document.getElementById('scanResult');

const codeInput = document.getElementById('codeInput');
const nameInput = document.getElementById('nameInput');
const saveBtn = document.getElementById('saveBtn');
const clearBtn = document.getElementById('clearBtn');

const tableBody = document.querySelector('#table tbody');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const toast = document.getElementById('toast');

/* ===== Utilities ===== */
function showToast(text, ms = 1400){
  toast.textContent = text;
  toast.style.display = 'block';
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>{ toast.style.display = 'none'; }, ms);
}
function saveDB(){ localStorage.setItem('barcodeDB', JSON.stringify(db)); renderTable(); }
function renderTable(){
  tableBody.innerHTML = '';
  const keys = Object.keys(db);
  if(!keys.length){
    tableBody.innerHTML = '<tr><td colspan="2" class="small" style="padding:12px;color:var(--muted)">–ë–∞–∑–∞ –ø—É—Å—Ç–∞</td></tr>';
    return;
  }
  keys.forEach(code=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${code}</td><td>${db[code]}</td>`;
    tableBody.appendChild(tr);
  });
}
function beep(){ try{ navigator.vibrate?.(60); }catch(e){} }

/* ===== Camera & devices ===== */
async function enumerateCameras(){
  try{
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === 'videoinput');
    deviceSelect.innerHTML = '';
    cams.forEach((c, idx)=>{
      const opt = document.createElement('option');
      opt.value = c.deviceId;
      opt.text = c.label || `–ö–∞–º–µ—Ä–∞ ${idx+1}`;
      deviceSelect.appendChild(opt);
    });
    if(cams.length && !currentDeviceId) currentDeviceId = cams[0].deviceId;
    if(currentDeviceId) deviceSelect.value = currentDeviceId;
  }catch(e){}
}

async function startCamera(){
  if(scanning) return;
  stopCamera();
  scanning = true;
  await enumerateCameras();

  const constraints = {
    audio:false,
    video:{
      deviceId: deviceSelect.value || currentDeviceId || undefined,
      facingMode: { ideal: "environment" },
      width: { ideal: 1280 },
      height: { ideal: 720 }
    }
  };

  try{
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    preview.srcObject = stream;
    await preview.play();
    currentDeviceId = stream.getVideoTracks()[0].getSettings().deviceId || currentDeviceId;
    deviceSelect.value = currentDeviceId || deviceSelect.value;

    if(!reader) reader = new ZXing.BrowserMultiFormatReader();

    requestAnimationFrame(scanLoop);
    showToast('–°–∫–∞–Ω–µ—Ä –≤–∫–ª—é—á—ë–Ω');
  }catch(err){
    console.error('camera error', err);
    scanResult.innerText = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ';
    scanning = false;
    showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É');
  }
}

function stopCamera(){
  scanning = false;
  if(preview.srcObject){
    preview.srcObject.getTracks().forEach(t=>t.stop());
    preview.srcObject = null;
  }
  if(reader){
    try{ reader.reset(); }catch(e){}
  }
  showToast('–°–∫–∞–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
}

/* Torch */
let torchOn = false;
async function toggleTorch(){
  if(!stream) return showToast('–°–Ω–∞—á–∞–ª–∞ –≤–∫–ª—é—á–∏—Ç–µ —Å–∫–∞–Ω–µ—Ä');
  const track = stream.getVideoTracks()[0];
  try{
    await track.applyConstraints({ advanced: [{ torch: !torchOn }] });
    torchOn = !torchOn;
    torchBtn.textContent = torchOn ? 'üî¶ ON' : 'üî¶';
  }catch(e){
    showToast('Torch –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
  }
}

/* ===== Decoding helpers ===== */
function createCanvas(w,h){ const c=document.createElement('canvas'); c.width=w; c.height=h; return c; }

async function tryDecodeCanvas(canvas){
  if(detector){
    try{
      const imageData = canvas.getContext('2d').getImageData(0,0,canvas.width,canvas.height);
      const res = await detector.detect(imageData);
      if(res && res.length) return res[0].rawValue;
    }catch(e){}
  }
  try{
    const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(canvas);
    const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
    const result = new ZXing.MultiFormatReader().decode(binaryBitmap);
    if(result && result.text) return result.text;
  }catch(e){}
  const w = canvas.width, h = canvas.height;
  const temp = createCanvas(w,h);
  const tctx = temp.getContext('2d');
  for(let angle of [90,180,270]){
    tctx.clearRect(0,0,w,h);
    tctx.save();
    tctx.translate(w/2,h/2);
    tctx.rotate(angle*Math.PI/180);
    tctx.drawImage(canvas, -w/2, -h/2);
    tctx.restore();
    try{
      const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(temp);
      const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
      const result = new ZXing.MultiFormatReader().decode(binaryBitmap);
      if(result && result.text) return result.text;
    }catch(e){}
  }
  return null;
}

/* Main scanning loop */
let canvasPool = [];
function getCanvas(w,h){
  for(let c of canvasPool) if(c.width===w && c.height===h) return c;
  const c = createCanvas(w,h); canvasPool.push(c); return c;
}

let scanLoopRunning = false;
async function scanLoop(){
  if(!scanning) { scanLoopRunning = false; return; }
  if(scanLoopRunning) return;
  scanLoopRunning = true;

  try{
    while(scanning){
      const w = preview.videoWidth;
      const h = preview.videoHeight;
      if(w===0 || h===0){
        await new Promise(r => requestAnimationFrame(r));
        continue;
      }

      const canvas = getCanvas(w,h);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(preview, 0, 0, w, h);

      const scale = Math.max(1, Math.floor(Math.max(w,h)/900));
      const sw = Math.floor(w/scale);
      const sh = Math.floor(h/scale);
      const small = getCanvas(sw,sh);
      const sctx = small.getContext('2d');
      sctx.drawImage(canvas, 0, 0, w, h, 0, 0, sw, sh);

      try{
        const code = await tryDecodeCanvas(small);
        if(code) {
          handleDetected(code);
          await new Promise(r => setTimeout(r, 300));
        }
      }catch(e){}

      await new Promise(r => requestAnimationFrame(r));
    }
  }finally{
    scanLoopRunning = false;
  }
}

/* Handle detection */
function handleDetected(code){
  const now = Date.now();
  if(code === lastDetected.code && (now - lastDetected.ts) < DEBOUNCE_MS) return;
  lastDetected = {code, ts: now};
  beep();
  scanResult.innerText = `${code} ‚Üí ${db[code] || '–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω'}`;
  codeInput.value = code;
  if(db[code]) nameInput.value = db[code];
  else nameInput.value = '';
}

/* ===== UI actions ===== */
startScannerBtn.addEventListener('click', async ()=>{ await startCamera(); });
stopScannerBtn.addEventListener('click', ()=>{ stopCamera(); });
deviceSelect.addEventListener('change', async ()=>{ currentDeviceId = deviceSelect.value; await startCamera(); });
torchBtn.addEventListener('click', toggleTorch);

saveBtn.addEventListener('click', ()=>{
  const code = (codeInput.value || '').trim();
  const name = (nameInput.value || '').trim();
  if(!code) return showToast('–®—Ç—Ä–∏—Ö‚Äë–∫–æ–¥ –ø—É—Å—Ç–æ–π');
  if(!name) return showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
  db[code] = name;
  saveDB();
  showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
  lastDetected = {code:null, ts:0};
  codeInput.value = '';
  nameInput.value = '';
});

clearBtn.addEventListener('click', ()=>{
  codeInput.value = '';
  nameInput.value = '';
  showToast('–ü–æ–ª—è –æ—á–∏—â–µ–Ω—ã');
});

/* Export / Import JSON */
exportBtn.addEventListener('click', ()=>{
  const data = JSON.stringify(db, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'barcodeDB.json'; a.click();
  URL.revokeObjectURL(url);
});

importBtn.addEventListener('click', ()=>{
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json';
  input.onchange = e=>{
    const file = e.target.files[0];
    if(!file) return;
    const readerFile = new FileReader();
    readerFile.onload = ev=>{
      try{
        const obj = JSON.parse(ev.target.result);
        db = Object.assign({}, db, obj);
        saveDB();
        showToast('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω');
      }catch(err){ showToast('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON'); }
    };
    readerFile.readAsText(file);
  };
  input.click();
});

/* Init */
renderTable();
enumerateCameras();
navigator.mediaDevices.getUserMedia({video:true}).then(s=>{
  s.getTracks().forEach(t=>t.stop());
  enumerateCameras();
}).catch(()=>{ /* ignore */ });

window.addEventListener('pagehide', ()=>{ stopCamera(); });
window.addEventListener('beforeunload', ()=>{ stopCamera(); });

</script>
</body>
</html>


