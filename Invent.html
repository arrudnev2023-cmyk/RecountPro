<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<!-- Отключаем масштабирование и двойной тап -->
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
<title>Инвентаризация — мобильное</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f4f6fb;
  --panel:#ffffff;
  --muted:#6b7280;
  --accent-1:#7b3be6;
  --accent-2:#c86cff;
  --accent:linear-gradient(90deg,var(--accent-1),var(--accent-2));
  --header-h:110px;
  --footer-h:88px;
  --gap:10px;
  --card-radius:10px;
  --shadow: 0 8px 20px rgba(16,24,40,0.06);
  --max-width:420px;
  --safe-margin:12px;
}

/* Reset & base */
*{box-sizing:border-box}
html,body{
  height:100%;
  margin:0;
  background:var(--bg);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:#0b1020;
  -webkit-font-smoothing:antialiased;
  overscroll-behavior-y: none; /* prevent pull-to-refresh */
  touch-action: pan-y; /* allow vertical scroll only */
  -ms-touch-action: pan-y;
  -webkit-user-select:none; user-select:none;
  -webkit-tap-highlight-color: transparent;
  font-size:15px;
  -webkit-text-size-adjust:100%;
}

/* App layout */
.app{height:100vh;display:flex;flex-direction:column;align-items:center;}

/* Header fixed (two rows) */
.header{
  position:fixed; left:0; right:0; top:0;
  height:var(--header-h);
  display:flex;align-items:flex-start;justify-content:center;
  background:linear-gradient(180deg, rgba(255,255,255,0.995), rgba(255,255,255,0.98));
  border-bottom:1px solid rgba(11,16,32,0.04);
  z-index:2000;
  padding:10px var(--safe-margin);
  box-shadow: 0 6px 18px rgba(16,24,40,0.04);
  overscroll-behavior: contain;
  touch-action: none; /* prevent dragging on header */
}
.header-inner{ width:100%; max-width:var(--max-width); display:flex; flex-direction:column; gap:8px; margin:0 auto; }

/* Title row */
.title-row{ display:flex; align-items:center; gap:10px; }
.logo{ width:44px; height:44px; border-radius:10px; background:var(--accent); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:800; flex:0 0 44px; font-size:14px; }
.title{ font-size:16px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

/* Search row */
.search-row{ display:flex; gap:8px; align-items:center; }
.input-wrap{ position:relative; flex:1; min-width:0; }
.input{
  width:100%;
  padding:10px 40px 10px 12px;
  border-radius:10px;
  border:1px solid rgba(11,16,32,0.06);
  background:#fff;
  outline:none;
  font-size:15px;
}
.clear-x{ position:absolute; right:8px; top:50%; transform:translateY(-50%); background:transparent; border:none; color:var(--muted); font-weight:700; padding:6px; border-radius:6px; cursor:pointer; }
.scan-btn{ padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:700; background:var(--accent); color:#fff; min-width:84px; flex:0 0 auto; }

/* Content (single scrollable area) */
.content{
  width:100%;
  max-width:var(--max-width);
  margin-top: calc(var(--header-h) + 6px);
  margin-bottom: calc(var(--footer-h) + 6px);
  height: calc(100vh - var(--header-h) - var(--footer-h) - 12px);
  overflow:auto;
  -webkit-overflow-scrolling: touch;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:var(--gap);
  align-items:stretch;
  margin-left:auto;
  margin-right:auto;
  touch-action: pan-y; /* allow vertical pan inside content */
}

/* Card / scanner */
.card{ background:var(--panel); border-radius:var(--card-radius); padding:12px; border:1px solid rgba(11,16,32,0.06); box-shadow:var(--shadow); }
.preview-wrap{ border-radius:10px; overflow:hidden; background:#000; border:1px solid rgba(11,16,32,0.06); display:none; }
.preview-wrap.visible{ display:block; }
.preview-wrap.camera-1-3{ height:32vh; min-height:140px; max-height:300px; }
video#preview{ width:100%; height:100%; object-fit:cover; display:block; }

/* Results list */
.results{ display:flex; flex-direction:column; gap:10px; }
.card-item{ display:flex; flex-direction:column; padding:12px; border-radius:10px; border:1px solid rgba(11,16,32,0.04); background:linear-gradient(180deg,#fff,#fbfbff); }
.item-top{ display:flex; align-items:center; gap:12px; }
.avatar{ width:56px; height:56px; border-radius:8px; background:linear-gradient(90deg,var(--accent-1),var(--accent-2)); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; flex:0 0 56px; }
.item-meta{ display:flex; flex-direction:column; min-width:0; flex:1; }
.item-name{ font-weight:700; color:#0b1020; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.item-code{ color:var(--muted); font-size:13px; margin-top:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.qty-row{ margin-top:10px; display:flex; gap:8px; align-items:center; }
.qty-input{ flex:1; padding:10px; border-radius:8px; border:1px solid rgba(11,16,32,0.06); font-weight:700; font-size:15px; background:#fbfbff; cursor:pointer; }
.plus-btn{ padding:10px 12px; border-radius:8px; background:linear-gradient(90deg,var(--accent-1),var(--accent-2)); color:#fff; border:none; cursor:pointer; font-weight:700; }

/* Footer (fixed) - strictly at bottom, full width on phone */
.footer{
  position:fixed; left:0; right:0; bottom:0;
  height:var(--footer-h);
  display:flex;align-items:center;justify-content:center;
  background:linear-gradient(180deg, rgba(255,255,255,0.995), rgba(255,255,255,0.98));
  border-top:1px solid rgba(11,16,32,0.04);
  z-index:2000;
  padding:10px var(--safe-margin);
  box-shadow:0 -6px 18px rgba(16,24,40,0.04);
  touch-action:none;
}
.footer-inner{ width:100%; max-width:var(--max-width); display:flex; gap:8px; align-items:center; margin:0 auto; }
.manual-input{ flex:1; display:flex; gap:8px; align-items:center; }
.manual-input input{ flex:1; padding:10px; border-radius:10px; border:1px solid rgba(11,16,32,0.06); background:#fff; outline:none; min-width:0; cursor:pointer; }
.manual-input button{ padding:10px 12px; border-radius:10px; border:none; background:var(--accent-1); color:#fff; font-weight:700; cursor:pointer; }

/* Numeric pad (custom) - positioned dynamically under active card */
.numeric-pad{
  position:fixed;
  display:none;
  z-index:2100;
  background:linear-gradient(180deg,#fff,#f3f4f8);
  border-top:1px solid rgba(11,16,32,0.06);
  box-shadow:0 -8px 30px rgba(11,16,32,0.08);
  padding:10px;
  border-radius:10px 10px 0 0;
}
.numeric-pad.visible{ display:block; }
.numeric-pad .row{ display:flex; gap:8px; margin-bottom:8px; }
.numeric-pad button.key{ flex:1; padding:12px 8px; border-radius:8px; border:1px solid rgba(11,16,32,0.06); background:#fff; font-size:18px; font-weight:700; }
.numeric-pad .key.action{ background:linear-gradient(90deg,var(--accent-1),var(--accent-2)); color:#fff; border:none; }
.numeric-pad .key.wide{ flex:2; }

/* small */
.small{ font-size:13px; color:var(--muted); }

/* modal (hidden by default) */
.modal-backdrop{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:2200; background:rgba(11,16,32,0.45); }
.modal{ width:92%; max-width:420px; background:#fff; border-radius:12px; padding:12px; box-shadow:0 20px 60px rgba(11,16,32,0.25); }
.modal .row{ display:flex; gap:8px; margin-top:8px; }
.modal input{ flex:1; padding:8px; border-radius:8px; border:1px solid rgba(11,16,32,0.06); }

/* mobile-only: keep layout phone-like */
@media (min-width:600px){
  .app{ align-items:center; }
  .content{ margin-left:auto; margin-right:auto; }
}
</style>
</head>
<body>
<div class="app" id="app" role="application" aria-label="Инвентаризация">

  <!-- Header -->
  <header class="header" role="banner" aria-label="Шапка">
    <div class="header-inner">
      <div class="title-row">
        <div class="logo" aria-hidden="true">INV</div>
        <div class="title">Инвентаризация</div>
      </div>

      <div class="search-row" role="search" aria-label="Поиск и сканер">
        <div class="input-wrap">
          <input id="searchInput" class="input" type="text" placeholder="Поиск по названию или коду" aria-label="Поиск по товарам" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
          <button id="clearSearch" class="clear-x" title="Очистить поле" aria-label="Очистить поле">✕</button>
        </div>
        <button id="openScannerBtn" class="scan-btn" aria-label="Открыть сканер">Сканер</button>
      </div>
    </div>
  </header>

  <!-- Content -->
  <main class="content" id="content" role="main" aria-label="Список товаров">
    <!-- Scanner card (hidden by default) -->
    <section id="scannerCard" class="card" style="display:none" aria-hidden="true">
      <div class="preview-wrap camera-1-3" id="previewWrap">
        <video id="preview" playsinline muted></video>
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <select id="deviceSelect" class="btn ghost" aria-label="Выбор камеры" style="min-width:80px"></select>
        <button id="closeScannerBtn" class="btn ghost" aria-label="Закрыть сканер">✕ Закрыть</button>
      </div>
      <div id="scanResult" class="small" style="margin-top:8px"></div>
    </section>

    <!-- Results list -->
    <section id="resultsWrap" class="card" aria-labelledby="resultsTitle">
      <h3 id="resultsTitle" style="margin:0 0 8px 0">Найденные товары</h3>
      <div id="results" class="results" aria-live="polite">
        <div id="emptyHint" class="small">Пока нет позиций. Сканируйте штрихкод или добавьте вручную.</div>
      </div>
    </section>
  </main>

  <!-- Footer (strict bottom) -->
  <footer class="footer" id="footer" role="contentinfo" aria-label="Добавление вручную">
    <div class="footer-inner">
      <div class="manual-input">
        <input id="manualCode" placeholder="Штрихкод (опционально)" aria-label="Штрихкод вручную" readonly>
        <input id="manualName" placeholder="Название товара" aria-label="Название вручную" readonly>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="addManualBtn" class="btn ghost" aria-label="Добавить вручную">Добавить</button>
      </div>
    </div>
  </footer>

  <!-- Numeric pad -->
  <div id="numericPad" class="numeric-pad" aria-hidden="true">
    <div class="row">
      <button class="key" data-key="1">1</button>
      <button class="key" data-key="2">2</button>
      <button class="key" data-key="3">3</button>
    </div>
    <div class="row">
      <button class="key" data-key="4">4</button>
      <button class="key" data-key="5">5</button>
      <button class="key" data-key="6">6</button>
    </div>
    <div class="row">
      <button class="key" data-key="7">7</button>
      <button class="key" data-key="8">8</button>
      <button class="key" data-key="9">9</button>
    </div>
    <div class="row">
      <button class="key" data-key="+">+</button>
      <button class="key" data-key="0">0</button>
      <button class="key action" id="padBack">←</button>
    </div>
    <div class="row">
      <button class="key wide action" id="padDone">Готово</button>
    </div>
  </div>

  <!-- Modal for manual text entry (optional) -->
  <div id="modalBackdrop" class="modal-backdrop" style="display:none;align-items:center;justify-content:center;">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Ввод вручную">
      <div style="font-weight:700">Добавить товар вручную</div>
      <div class="row" style="margin-top:10px">
        <input id="modalCode" placeholder="Штрихкод (цифры и +)" readonly>
      </div>
      <div class="row">
        <input id="modalName" placeholder="Название товара (буквы и цифры)" readonly>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="modalCancel" class="btn ghost">Отмена</button>
        <button id="modalSave" class="btn" style="background:var(--accent);color:#fff">Сохранить</button>
      </div>
    </div>
  </div>
</div>

<!-- ZXing library -->
<script src="https://unpkg.com/@zxing/library@latest"></script>

<script>
/* ===== Storage keys and state ===== */
const STORAGE_DB = 'barcodeDB';
const STORAGE_INV = 'inventoryItems';
let barcodeDB = JSON.parse(localStorage.getItem(STORAGE_DB) || '{}');
let inventoryItems = JSON.parse(localStorage.getItem(STORAGE_INV) || '[]');
let renderedCards = new Map();
let padTarget = null; // {type:'qty'|'manual'|'modal', code/field}

/* ===== Elements ===== */
const content = document.getElementById('content');
const header = document.querySelector('.header');
const footer = document.getElementById('footer');
const searchInput = document.getElementById('searchInput');
const clearSearch = document.getElementById('clearSearch');
const openScannerBtn = document.getElementById('openScannerBtn');
const scannerCard = document.getElementById('scannerCard');
const previewWrap = document.getElementById('previewWrap');
const preview = document.getElementById('preview');
const deviceSelect = document.getElementById('deviceSelect');
const closeScannerBtn = document.getElementById('closeScannerBtn');
const scanResult = document.getElementById('scanResult');

const resultsEl = document.getElementById('results');
const emptyHint = document.getElementById('emptyHint');

const manualCode = document.getElementById('manualCode');
const manualName = document.getElementById('manualName');
const addManualBtn = document.getElementById('addManualBtn');

const numericPad = document.getElementById('numericPad');
const padBack = document.getElementById('padBack');
const padDone = document.getElementById('padDone');

const modalBackdrop = document.getElementById('modalBackdrop');
const modalCode = document.getElementById('modalCode');
const modalName = document.getElementById('modalName');
const modalCancel = document.getElementById('modalCancel');
const modalSave = document.getElementById('modalSave');

/* ===== Utilities ===== */
function saveDB(){ localStorage.setItem(STORAGE_DB, JSON.stringify(barcodeDB)); }
function saveInventory(){ localStorage.setItem(STORAGE_INV, JSON.stringify(inventoryItems)); }
function showToast(text, ms=1200){ scanResult.textContent = text; setTimeout(()=>{ if(scanResult.textContent===text) scanResult.textContent=''; }, ms); }
function beep(){ try{ const ctx = new (window.AudioContext||window.webkitAudioContext)(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.type='sine'; o.frequency.value=880; g.gain.value=0.02; o.connect(g); g.connect(ctx.destination); o.start(); setTimeout(()=>{ o.stop(); ctx.close(); },120); }catch(e){} }
function normalize(s){ return (s||'').toString().toLowerCase().trim(); }

/* ===== Search & display helpers ===== */
function searchItems(q){
  q = normalize(q);
  if(!q) return [];
  const tokens = q.split(/\s+/).filter(Boolean);
  const out = [];
  for(const code of Object.keys(barcodeDB)){
    const name = normalize(barcodeDB[code]);
    const hay = (code + ' ' + name);
    if(tokens.every(t => hay.indexOf(t) !== -1)) out.push({code, name: barcodeDB[code]});
  }
  return out;
}
function getDisplayList(){
  const q = searchInput.value.trim();
  const list = [];
  for(const it of inventoryItems) list.push({code: it.code, name: it.name, expr: it.expr || String(it.qty || 0), qty: it.qty || 0});
  if(q){
    const found = searchItems(q);
    const inv = new Set(inventoryItems.map(i=>i.code));
    for(const f of found) if(!inv.has(f.code)) list.push({code: f.code, name: f.name, expr:'0', qty:0});
  }
  return list;
}

/* ===== Render results (incremental) ===== */
function renderResults(){
  const list = getDisplayList();
  if(list.length === 0){
    resultsEl.innerHTML = '';
    emptyHint.style.display = 'block';
    renderedCards.clear();
    return;
  }
  emptyHint.style.display = 'none';

  const keep = new Set(list.map(i=>i.code));
  for(const [code, el] of renderedCards){
    if(!keep.has(code)){ el.remove(); renderedCards.delete(code); }
  }

  const frag = document.createDocumentFragment();
  for(const item of list){
    if(renderedCards.has(item.code)){
      const el = renderedCards.get(item.code);
      const nameEl = el.querySelector('.item-name');
      const codeEl = el.querySelector('.item-code');
      const inputEl = el.querySelector('.qty-input');
      if(nameEl && nameEl.textContent !== item.name) nameEl.textContent = item.name;
      if(codeEl && codeEl.textContent !== item.code) codeEl.textContent = item.code;
      if(document.activeElement !== inputEl) inputEl.value = item.expr || String(item.qty || 0);
      frag.appendChild(el);
      continue;
    }

    const card = document.createElement('div');
    card.className = 'card-item';
    card.dataset.code = item.code;
    card.innerHTML = `
      <div class="item-top">
        <div class="item-left" style="display:flex;gap:12px;align-items:center;min-width:0">
          <div class="avatar">${escapeHtml(item.name.slice(0,2).toUpperCase())}</div>
          <div class="item-meta">
            <div class="item-name">${escapeHtml(item.name)}</div>
            <div class="item-code">${escapeHtml(item.code)}</div>
          </div>
        </div>
      </div>
      <div class="qty-row">
        <input class="qty-input" type="text" value="${escapeHtml(item.expr || String(item.qty || 0))}" readonly inputmode="none" aria-label="Выражение для ${escapeHtml(item.name)}">
        <button class="plus-btn" title="Плюс">+</button>
      </div>
    `;
    const qtyInput = card.querySelector('.qty-input');
    const plusBtn = card.querySelector('.plus-btn');

    qtyInput.addEventListener('click', ()=>{ openPadForQty(item.code); });
    qtyInput.addEventListener('touchstart', (e)=>{ e.preventDefault(); openPadForQty(item.code); });

    plusBtn.addEventListener('click', (ev)=>{
      ev.preventDefault();
      openPadForQty(item.code, ()=>{ padInsert('+'); });
    });

    renderedCards.set(item.code, card);
    frag.appendChild(card);
  }

  resultsEl.appendChild(frag);
}
function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function normalizeExpression(expr){ if(!expr) return ''; const trailingPlus = /\+\s*$/.test(expr); const parts = (expr.match(/\d+/g) || []); const joined = parts.join(' + '); return trailingPlus ? (joined ? joined + ' + ' : ' + ') : joined; }
function evaluateExpression(expr){ if(!expr) return 0; const nums = (expr.match(/\d+/g) || []).map(n=>parseInt(n,10) || 0); return nums.reduce((s,v)=>s+v, 0); }

/* Upsert inventory */
function upsertInventoryExpr(code, name, expr, total, dontRerender = false){
  const idx = inventoryItems.findIndex(it => it.code === code);
  if(idx >= 0){
    inventoryItems[idx].qty = total;
    inventoryItems[idx].expr = expr;
    inventoryItems[idx].name = name || inventoryItems[idx].name;
  } else {
    inventoryItems.unshift({ code, name, qty: total, expr });
  }
  saveInventory();
  const card = renderedCards.get(code);
  if(card){
    const inputEl = card.querySelector('.qty-input');
    if(document.activeElement !== inputEl){
      inputEl.value = expr;
    }
  }
  if(!dontRerender) renderResults();
}

/* ===== Custom numeric pad behavior and precise positioning ===== */
function openPadForQty(code, callbackAfterOpen){
  padTarget = { type:'qty', code };
  const card = document.querySelector(`[data-code="${code}"]`);
  if(!card) return;
  // compute desired scroll so card is visible above pad and header
  const desiredTop = Math.max(0, card.offsetTop - 12);
  content.scrollTo({ top: desiredTop, behavior: 'smooth' });
  // after scroll, position pad under card
  setTimeout(()=>{
    const cardRect = card.getBoundingClientRect();
    const viewportWidth = Math.min(window.innerWidth, document.documentElement.clientWidth);
    const pad = numericPad;
    const padWidth = Math.min(cardRect.width, viewportWidth - 24);
    const padLeft = Math.max(12, cardRect.left + (cardRect.width - padWidth)/2);
    pad.style.width = padWidth + 'px';
    pad.style.left = padLeft + 'px';
    pad.style.bottom = footer.getBoundingClientRect().height + 'px';
    pad.classList.add('visible');
    pad.setAttribute('aria-hidden','false');
    if(typeof callbackAfterOpen === 'function') setTimeout(callbackAfterOpen, 120);
  }, 260);
}

function openPadForManualField(field){
  padTarget = { type:'manual', field };
  const footerInner = document.querySelector('.footer-inner');
  const rect = footerInner.getBoundingClientRect();
  const pad = numericPad;
  const padWidth = Math.min(rect.width - 16, window.innerWidth - 24);
  const padLeft = rect.left + 8;
  pad.style.width = padWidth + 'px';
  pad.style.left = padLeft + 'px';
  pad.style.bottom = footer.getBoundingClientRect().height + 'px';
  pad.classList.add('visible');
  pad.setAttribute('aria-hidden','false');
}

function openPadForModalField(field){
  padTarget = { type:'modal', field };
  const modal = document.querySelector('.modal');
  const pad = numericPad;
  if(modal){
    const rect = modal.getBoundingClientRect();
    const padWidth = Math.min(rect.width - 16, window.innerWidth - 24);
    const padLeft = rect.left + 8;
    pad.style.width = padWidth + 'px';
    pad.style.left = padLeft + 'px';
    pad.style.bottom = footer.getBoundingClientRect().height + 'px';
  } else {
    pad.style.width = Math.min(window.innerWidth - 24, 360) + 'px';
    pad.style.left = ((window.innerWidth - parseFloat(pad.style.width)) / 2) + 'px';
    pad.style.bottom = footer.getBoundingClientRect().height + 'px';
  }
  pad.classList.add('visible');
  pad.setAttribute('aria-hidden','false');
}

function closePad(){
  padTarget = null;
  numericPad.classList.remove('visible');
  numericPad.setAttribute('aria-hidden','true');
}

/* Insert key into current pad target */
function padInsert(ch){
  if(!padTarget) return;
  if(padTarget.type === 'qty'){
    const card = document.querySelector(`[data-code="${padTarget.code}"]`);
    if(!card) return;
    const input = card.querySelector('.qty-input');
    if(!input) return;
    if(ch === '←') input.value = input.value.slice(0,-1);
    else input.value = (input.value || '') + ch;
    const expr = input.value;
    const total = evaluateExpression(expr);
    upsertInventoryExpr(padTarget.code, (barcodeDB[padTarget.code] || ''), expr, total, true);
  } else if(padTarget.type === 'manual'){
    if(padTarget.field === 'manualCode') manualCode.value = manualCode.value + ch;
    if(padTarget.field === 'manualName') manualName.value = manualName.value + ch;
  } else if(padTarget.type === 'modal'){
    if(padTarget.field === 'code') modalCode.value = modalCode.value + ch;
    if(padTarget.field === 'name') modalName.value = modalName.value + ch;
  }
}

/* pad buttons wiring */
numericPad.addEventListener('click', (e)=>{
  const btn = e.target.closest('button.key');
  if(!btn) return;
  const key = btn.getAttribute('data-key');
  if(key) padInsert(key);
});
document.getElementById('padBack').addEventListener('click', ()=>{ padInsert('←'); });
document.getElementById('padDone').addEventListener('click', ()=>{ closePad(); });

/* clicking outside pad closes it (but not when interacting with card or footer) */
document.addEventListener('click', (e)=>{
  if(numericPad.contains(e.target)) return;
  if(e.target.closest('.qty-input')) return;
  if(e.target.closest('#manualCode') || e.target.closest('#manualName')) return;
  if(e.target.closest('.modal')) return;
  closePad();
});

/* ===== Manual footer interactions (readonly fields open pad) ===== */
manualCode.addEventListener('click', ()=>{ openPadForManualField('manualCode'); padTarget = {type:'manual', field:'manualCode'}; });
manualName.addEventListener('click', ()=>{ openPadForManualField('manualName'); padTarget = {type:'manual', field:'manualName'}; });

addManualBtn.addEventListener('click', ()=>{
  const code = (manualCode.value||'').trim();
  const name = (manualName.value||'').trim() || (code || 'Новый товар');
  const finalCode = code || ('manual-' + Date.now());
  barcodeDB[finalCode] = name;
  saveDB();
  upsertInventoryExpr(finalCode, name, '0', 0, true);
  renderResults();
  manualCode.value = '';
  manualName.value = '';
  showToast('Добавлено вручную');
});

/* ===== Modal manual add (optional) ===== */
function openManualModal(){
  modalCode.value = '';
  modalName.value = '';
  modalBackdrop.style.display = 'flex';
  openPadForModalField('code');
}
modalCancel.addEventListener('click', ()=>{ modalBackdrop.style.display='none'; closePad(); });
modalSave.addEventListener('click', ()=>{
  const code = (modalCode.value||'').trim();
  const name = (modalName.value||'').trim() || (code || 'Новый товар');
  const finalCode = code || ('manual-' + Date.now());
  barcodeDB[finalCode] = name;
  saveDB();
  upsertInventoryExpr(finalCode, name, '0', 0, true);
  renderResults();
  modalBackdrop.style.display='none';
  closePad();
  showToast('Добавлено вручную');
});
modalCode.addEventListener('click', ()=>{ openPadForModalField('code'); padTarget = {type:'modal', field:'code'}; });
modalName.addEventListener('click', ()=>{ openPadForModalField('name'); padTarget = {type:'modal', field:'name'}; });

/* ===== Search wiring (no autofocus on load) ===== */
searchInput.addEventListener('input', ()=>{ renderResults(); });
clearSearch.addEventListener('click', ()=>{ searchInput.value=''; renderResults(); });

/* ===== Scanner (ZXing.BrowserMultiFormatReader.decodeFromVideoDevice) ===== */
let codeReader = null;
let scanning = false;
let lastDetected = {code:null, ts:0};
const DEBOUNCE_MS = 900;

async function enumerateCameras(){
  try{
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === 'videoinput');
    deviceSelect.innerHTML = '';
    cams.forEach((c, idx)=>{
      const opt = document.createElement('option');
      opt.value = c.deviceId;
      opt.text = c.label || `Камера ${idx+1}`;
      deviceSelect.appendChild(opt);
    });
  }catch(e){}
}

async function startScanner(){
  if(scanning) return;
  try{
    codeReader = codeReader || new ZXing.BrowserMultiFormatReader();
  }catch(e){
    showToast('Сканер недоступен');
    return;
  }
  await enumerateCameras();
  const deviceId = deviceSelect.value || undefined;
  try{
    scanning = true;
    codeReader.decodeFromVideoDevice(deviceId, preview, (result, err) => {
      if(result && result.text){
        const now = Date.now();
        if(result.text === lastDetected.code && (now - lastDetected.ts) < DEBOUNCE_MS) return;
        lastDetected = {code: result.text, ts: now};
        beep();
        // handle detection and immediately stop scanner and hide UI
        handleDetected(result.text);
        try{ codeReader.reset(); }catch(e){}
        scanning = false;
        previewWrap.classList.remove('visible');
        scannerCard.style.display = 'none';
      }
    });
    previewWrap.classList.add('visible');
    scannerCard.style.display = 'block';
    showToast('Сканер запущен');
  }catch(e){
    scanning = false;
    showToast('Ошибка доступа к камере');
  }
}
function stopScanner(){
  try{ if(codeReader) codeReader.reset(); }catch(e){}
  scanning = false;
  previewWrap.classList.remove('visible');
  scannerCard.style.display = 'none';
  showToast('Сканер остановлен');
}
openScannerBtn.addEventListener('click', async ()=>{ await startScanner(); });
closeScannerBtn.addEventListener('click', ()=>{ stopScanner(); });

deviceSelect.addEventListener('change', async ()=>{
  if(scanning){ try{ codeReader.reset(); }catch(e){} scanning=false; }
  await startScanner();
});

/* handle detection */
function handleDetected(code){
  searchInput.value = code;
  const found = barcodeDB[code];
  if(found){
    showToast('Найден товар в базе');
    const idx = inventoryItems.findIndex(it=>it.code===code);
    if(idx === -1) upsertInventoryExpr(code, found, '0', 0, true);
    renderResults();
    // open pad for that card and scroll to it
    openPadForQty(code);
  } else {
    const create = confirm(`Код ${code} не найден. Создать товар с этим кодом и добавить 1 шт.?`);
    if(create){
      const name = prompt('Введите название товара', '') || '';
      if(name.trim()){
        barcodeDB[code] = name.trim();
        saveDB();
        upsertInventoryExpr(code, barcodeDB[code], '1', 1, true);
        renderResults();
        openPadForQty(code);
        showToast('Товар добавлен');
      } else showToast('Название не введено');
    } else showToast('Код не найден');
  }
}

/* enumerate cameras on load (non-blocking) */
if(navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) navigator.mediaDevices.enumerateDevices().then(enumerateCameras).catch(()=>{});

/* Prevent pull-to-refresh on some browsers (extra JS) */
(function preventPullToRefresh(){
  let startY = 0;
  let id = null;
  document.addEventListener('touchstart', (e)=>{ if(e.touches && e.touches.length===1){ startY = e.touches[0].clientY; id = e.touches[0].identifier; } }, {passive:true});
  document.addEventListener('touchmove', (e)=>{
    try{
      const t = Array.from(e.touches).find(tt=>tt.identifier===id) || e.touches[0];
      const currentY = t.clientY;
      const sc = document.querySelector('.content');
      if(sc){
        const atTop = sc.scrollTop <= 0;
        if(atTop && currentY > startY) e.preventDefault();
      } else {
        if(window.scrollY <= 0 && currentY > startY) e.preventDefault();
      }
    }catch(err){}
  }, {passive:false});
})();

/* Make header and footer non-draggable on touch (extra safety) */
['touchstart','touchmove','touchend','touchcancel'].forEach(ev=>{
  header.addEventListener(ev, (e)=>{ e.stopPropagation(); }, {passive:true});
  footer.addEventListener(ev, (e)=>{ e.stopPropagation(); }, {passive:true});
});

/* Disable double-tap zoom (prevent quick successive taps) */
(function preventDoubleTapZoom(){
  let lastTouch = 0;
  document.addEventListener('touchend', function(e){
    const now = Date.now();
    if (now - lastTouch <= 300) {
      e.preventDefault();
    }
    lastTouch = now;
  }, {passive:false});
  // iOS gesturestart (pinch) prevention
  document.addEventListener('gesturestart', function(e){ e.preventDefault(); }, {passive:false});
})();

/* Initial render */
renderResults();

/* Expose for debugging if needed */
window._inv = { renderResults, upsertInventoryExpr, inventoryItems, barcodeDB };
</script>
</body>
</html>

