<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Инвентаризация — Invent</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f6f7fb;
  --panel:#ffffff;
  --muted:#6b7280;
  --neon1:#7b3be6;
  --neon2:#c86cff;
  --accent:linear-gradient(90deg,var(--neon1),var(--neon2));
  --radius:12px;
  --header-h:84px;
  --footer-h:84px;
  --gap:12px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#0b1020;background:var(--bg);-webkit-font-smoothing:antialiased}
.app{height:100vh;display:flex;flex-direction:column;}

/* 1. Фиксированная шапка (первый блок) */
.header-fixed{
  position:fixed; left:0; right:0; top:0;
  height:var(--header-h);
  display:flex; align-items:center; justify-content:center;
  background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.96));
  border-bottom:1px solid rgba(11,16,32,0.04);
  z-index:1200;
  padding:12px;
  box-shadow:0 6px 20px rgba(16,24,40,0.04);
}
.header-inner{width:100%;max-width:420px;display:flex;gap:10px;align-items:center}
.brand{display:flex;gap:10px;align-items:center;min-width:0}
.logo{width:44px;height:44px;border-radius:10px;background:var(--neon1);background:var(--accent);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;flex:0 0 44px}
.title{font-size:16px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.search-row{display:flex;gap:8px;align-items:center;flex:1}
.input-wrap{position:relative;flex:1}
.input{width:100%;padding:10px 40px 10px 12px;border-radius:10px;border:1px solid rgba(11,16,32,0.06);background:#fff;outline:none;font-size:15px}
.clear-x{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:transparent;border:none;color:var(--muted);font-weight:700;padding:6px;border-radius:6px;cursor:pointer}
.scan-btn{padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700;background:var(--accent);color:#fff;min-width:84px;flex:0 0 auto}

/* 2. Средняя область — карточки (второй блок) */
.main{
  margin-top:var(--header-h);
  margin-bottom:var(--footer-h);
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  padding:16px;
  display:flex;
  justify-content:center;
}
.main-inner{width:100%;max-width:420px;display:flex;flex-direction:column;gap:var(--gap)}

/* Сканер-карта (скрыта по умолчанию) */
.card{background:var(--panel);border-radius:12px;padding:12px;border:1px solid rgba(11,16,32,0.06);box-shadow:0 8px 24px rgba(16,24,40,0.04)}
.preview-wrap{border-radius:10px;overflow:hidden;background:#000;border:1px solid rgba(11,16,32,0.06);display:none}
.preview-wrap.visible{display:block}
.preview-wrap.camera-1-3{height:33vh;min-height:140px;max-height:300px}
video#preview{width:100%;height:100%;object-fit:cover;display:block}

/* Список карточек */
.results{display:flex;flex-direction:column;gap:10px;margin-top:6px}
.card-item{display:flex;flex-direction:column;padding:12px;border-radius:10px;border:1px solid rgba(11,16,32,0.04);background:linear-gradient(180deg,#fff,#fbfbff)}
.item-top{display:flex;align-items:center;gap:12px}
.item-left{display:flex;gap:12px;align-items:center;min-width:0}
.item-meta{display:flex;flex-direction:column;min-width:0;flex:1}
.item-name{font-weight:700;color:#0b1020;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.item-code{color:var(--muted);font-size:13px;margin-top:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.qty-row{margin-top:10px;display:flex;gap:8px;align-items:center}
.qty-input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(11,16,32,0.06);font-weight:700;font-size:15px}
.plus-btn{padding:10px 12px;border-radius:8px;background:linear-gradient(90deg,var(--neon1),var(--neon2));color:#fff;border:none;cursor:pointer}

/* 3. Нижняя панель — ручное добавление (третий блок) */
.footer-fixed{
  position:fixed; left:0; right:0; bottom:0;
  height:var(--footer-h);
  display:flex; align-items:center; justify-content:center;
  background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.96));
  border-top:1px solid rgba(11,16,32,0.04);
  z-index:1200;
  padding:12px;
  box-shadow:0 -6px 20px rgba(16,24,40,0.04);
}
.footer-inner{width:100%;max-width:420px;display:flex;gap:8px;align-items:center}
.manual-input{flex:1;display:flex;gap:8px;align-items:center}
.manual-input input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(11,16,32,0.06);background:#fff;outline:none}
.manual-input button{padding:10px 12px;border-radius:10px;border:none;background:var(--neon1);color:#fff;font-weight:700;cursor:pointer}

/* Numeric pad (встроенная цифровая панель) */
.numeric-pad {
  position: fixed;
  left: 0;
  right: 0;
  bottom: var(--footer-h);
  background: linear-gradient(180deg,#fff,#f3f4f8);
  border-top: 1px solid rgba(11,16,32,0.06);
  box-shadow: 0 -8px 30px rgba(11,16,32,0.08);
  padding: 10px;
  display: none;
  z-index: 1250;
}
.numeric-pad.visible { display: block; }
.numeric-pad .row { display:flex; gap:8px; margin-bottom:8px; }
.numeric-pad button.key {
  flex:1;
  padding:12px 8px;
  border-radius:8px;
  border:1px solid rgba(11,16,32,0.06);
  background:#fff;
  font-size:18px;
  font-weight:700;
}
.numeric-pad .key.action { background: linear-gradient(90deg,#7b3be6,#c86cff); color:#fff; border:none; }
.numeric-pad .key.wide { flex:2; }

/* Helpers */
.small{font-size:13px;color:var(--muted)}
@media (max-width:420px){
  :root{--header-h:96px;--footer-h:96px}
  .logo{width:40px;height:40px}
  .input{font-size:15px}
}
</style>
</head>
<body>
<div class="app" id="app" role="application" aria-label="Инвентаризация приложение">

  <!-- 1. Фиксированная шапка -->
  <header class="header-fixed" role="banner" aria-label="Шапка и поиск">
    <div class="header-inner">
      <div class="brand" aria-hidden="false">
        <div class="logo">INV</div>
        <div style="min-width:0">
          <div class="title">Инвентаризация</div>
        </div>
      </div>

      <div class="search-row" role="search" aria-label="Поиск и сканер">
        <div class="input-wrap">
          <input id="searchInput" class="input" type="text" placeholder="Поиск по названию или коду" aria-label="Поиск по товарам">
          <button id="clearSearch" class="clear-x" title="Очистить поле" aria-label="Очистить поле">✕</button>
        </div>
        <button id="openScannerBtn" class="scan-btn" aria-label="Открыть сканер">Сканер</button>
      </div>
    </div>
  </header>

  <!-- 2. Средняя область — карточки -->
  <main class="main" id="main" role="main" aria-label="Список товаров">
    <div class="main-inner">
      <!-- Сканер-карта -->
      <section id="scannerCard" class="card" style="display:none" aria-hidden="true">
        <div class="preview-wrap camera-1-3" id="previewWrap">
          <video id="preview" playsinline muted></video>
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <select id="deviceSelect" class="btn ghost" aria-label="Выбор камеры" style="min-width:80px"></select>
          <button id="closeScannerBtn" class="btn ghost" aria-label="Закрыть сканер">✕ Закрыть</button>
        </div>
        <div id="scanResult" class="small" style="margin-top:8px"></div>
      </section>

      <!-- Список найденных карточек -->
      <section class="card" aria-labelledby="resultsTitle">
        <h3 id="resultsTitle" style="margin:0 0 8px 0">Найденные товары</h3>
        <div id="results" class="results" aria-live="polite">
          <div id="emptyHint" class="small">Пока нет позиций. Сканируйте штрихкод или добавьте вручную.</div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
          <div class="small">Если код не в базе — сканер предложит создать товар.</div>
        </div>
      </section>
    </div>
  </main>

  <!-- 3. Нижняя фиксированная панель — ручное добавление -->
  <footer class="footer-fixed" role="contentinfo" aria-label="Добавление товара вручную">
    <div class="footer-inner">
      <div class="manual-input" style="flex:1">
        <input id="manualCode" placeholder="Штрихкод (или оставьте пустым)" aria-label="Штрихкод вручную">
        <input id="manualName" placeholder="Название товара" aria-label="Название товара вручную" style="margin-left:8px">
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="addManualBtn" class="btn ghost" aria-label="Добавить вручную">Добавить</button>
      </div>
    </div>
  </footer>

  <!-- Встроенная цифровая панель -->
  <div id="numericPad" class="numeric-pad" aria-hidden="true">
    <div class="row">
      <button class="key" data-key="1">1</button>
      <button class="key" data-key="2">2</button>
      <button class="key" data-key="3">3</button>
    </div>
    <div class="row">
      <button class="key" data-key="4">4</button>
      <button class="key" data-key="5">5</button>
      <button class="key" data-key="6">6</button>
    </div>
    <div class="row">
      <button class="key" data-key="7">7</button>
      <button class="key" data-key="8">8</button>
      <button class="key" data-key="9">9</button>
    </div>
    <div class="row">
      <button class="key" data-key="+">+</button>
      <button class="key" data-key="0">0</button>
      <button class="key action" id="padBack">←</button>
    </div>
    <div class="row">
      <button class="key wide action" id="padDone">Готово</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
/* ===== Storage keys ===== */
const STORAGE_DB = 'barcodeDB';
const STORAGE_INV = 'inventoryItems';

/* ===== State ===== */
let barcodeDB = JSON.parse(localStorage.getItem(STORAGE_DB) || '{}');
let inventoryItems = JSON.parse(localStorage.getItem(STORAGE_INV) || '[]');
let stream = null;
let currentDeviceId = null;
let scanning = false;
let detector = ('BarcodeDetector' in window) ? new BarcodeDetector({formats:["ean_13","ean_8","code_128","code_39","upc_a","upc_e","itf"]}) : null;
let reader = null;
let lastDetected = {code:null, ts:0};
const DEBOUNCE_MS = 900;

/* ===== Elements ===== */
const searchInput = document.getElementById('searchInput');
const clearSearch = document.getElementById('clearSearch');
const openScannerBtn = document.getElementById('openScannerBtn');
const scannerCard = document.getElementById('scannerCard');
const previewWrap = document.getElementById('previewWrap');
const preview = document.getElementById('preview');
const deviceSelect = document.getElementById('deviceSelect');
const closeScannerBtn = document.getElementById('closeScannerBtn');
const scanResult = document.getElementById('scanResult');

const resultsEl = document.getElementById('results');
const emptyHint = document.getElementById('emptyHint');

const manualCode = document.getElementById('manualCode');
const manualName = document.getElementById('manualName');
const addManualBtn = document.getElementById('addManualBtn');

const numericPad = document.getElementById('numericPad');

const renderedCards = new Map();
let focusedInputCode = null;
let padTargetCode = null;

/* ===== Utilities ===== */
function saveDB(){ localStorage.setItem(STORAGE_DB, JSON.stringify(barcodeDB)); }
function saveInventory(){ localStorage.setItem(STORAGE_INV, JSON.stringify(inventoryItems)); }
function showToast(text, ms=1200){ scanResult.textContent = text; setTimeout(()=>{ if(scanResult.textContent===text) scanResult.textContent=''; }, ms); }
function beepSound(){ try{ const ctx = new (window.AudioContext || window.webkitAudioContext)(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.type='sine'; o.frequency.value=880; g.gain.value=0.02; o.connect(g); g.connect(ctx.destination); o.start(); setTimeout(()=>{ o.stop(); ctx.close(); },120); }catch(e){} }
function normalize(s){ return (s||'').toString().toLowerCase().trim(); }

/* ===== Search helpers ===== */
function searchItems(query){
  const q = normalize(query);
  if(!q) return [];
  const tokens = q.split(/\s+/).filter(Boolean);
  const results = [];
  for(const code of Object.keys(barcodeDB)){
    const name = normalize(barcodeDB[code]);
    const hay = (code + ' ' + name);
    const ok = tokens.every(t => hay.indexOf(t) !== -1);
    if(ok) results.push({ code, name: barcodeDB[code] });
  }
  results.sort((a,b)=> a.name.length - b.name.length);
  return results;
}

/* Build display list: inventory items always shown; if search present, append search results not already in inventory */
function getDisplayList(){
  const q = searchInput.value.trim();
  const display = [];
  for(const it of inventoryItems){
    display.push({ code: it.code, name: it.name, expr: it.expr || String(it.qty || 0), qty: it.qty || 0, fromInventory: true });
  }
  if(q){
    const search = searchItems(q);
    const invCodes = new Set(inventoryItems.map(i=>i.code));
    for(const s of search){
      if(!invCodes.has(s.code)){
        display.push({ code: s.code, name: s.name, expr: '0', qty: 0, fromInventory: false });
      }
    }
  }
  return display;
}

/* ===== Render results (incremental, preserve inputs & focus) ===== */
function renderResults(){
  const list = getDisplayList();
  if(!list.length){
    resultsEl.innerHTML = '';
    emptyHint.style.display = 'block';
    renderedCards.clear();
    return;
  }
  emptyHint.style.display = 'none';

  for(const item of list){
    if(renderedCards.has(item.code)){
      const el = renderedCards.get(item.code);
      const nameEl = el.querySelector('.item-name');
      const codeEl = el.querySelector('.item-code');
      const inputEl = el.querySelector('.qty-input');
      if(nameEl && nameEl.textContent !== item.name) nameEl.textContent = item.name;
      if(codeEl && codeEl.textContent !== item.code) codeEl.textContent = item.code;
      if(focusedInputCode !== item.code){
        inputEl.value = item.expr || String(item.qty || 0);
      }
      continue;
    }

    const card = document.createElement('div');
    card.className = 'card-item';
    card.dataset.code = item.code;
    card.innerHTML = `
      <div class="item-top">
        <div class="item-left">
          <div class="avatar" style="width:56px;height:56px;border-radius:8px;background:linear-gradient(90deg,var(--neon1),var(--neon2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">${item.name.slice(0,2).toUpperCase()}</div>
          <div class="item-meta">
            <div class="item-name">${item.name}</div>
            <div class="item-code">${item.code}</div>
          </div>
        </div>
      </div>

      <div class="qty-row">
        <input inputmode="numeric" pattern="[0-9+ ]*" class="qty-input" type="text" value="${escapeHtml(item.expr || String(item.qty || 0))}" aria-label="Выражение для ${item.name}">
        <button class="plus-btn" title="Плюс">+</button>
      </div>
    `;
    const qtyInput = card.querySelector('.qty-input');
    const plusBtn = card.querySelector('.plus-btn');

    qtyInput.addEventListener('focus', ()=>{
      focusedInputCode = item.code;
      padTargetCode = item.code;
      openNumericPad(item.code);
    });
    qtyInput.addEventListener('blur', ()=>{
      focusedInputCode = null;
      const expr = qtyInput.value;
      const total = evaluateExpression(expr);
      upsertInventoryExpr(item.code, item.name, expr, total, true);
      qtyInput.value = normalizeExpression(expr);
    });

    qtyInput.addEventListener('input', ()=>{
      const expr = qtyInput.value;
      const total = evaluateExpression(expr);
      upsertInventoryExpr(item.code, item.name, expr, total, true);
    });

    plusBtn.addEventListener('click', (ev)=>{
      ev.preventDefault();
      let expr = qtyInput.value || '';
      expr = expr.trim();
      if(/\+\s*$/.test(expr)){
        qtyInput.focus();
        return;
      }
      expr = expr === '' ? '0 + ' : expr + ' + ';
      const total = evaluateExpression(expr);
      upsertInventoryExpr(item.code, item.name, expr, total, true);
      qtyInput.value = normalizeExpression(expr);
      qtyInput.focus();
      setTimeout(()=>{ try{ qtyInput.setSelectionRange(qtyInput.value.length, qtyInput.value.length); }catch(e){} }, 0);
    });

    resultsEl.appendChild(card);
    renderedCards.set(item.code, card);
  }
}

/* Escape HTML for safe insertion into value attribute */
function escapeHtml(s){
  return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* Normalize expression: keep digits and pluses, format with spaces; preserve trailing plus */
function normalizeExpression(expr){
  if(!expr) return '';
  const trailingPlus = /\+\s*$/.test(expr);
  const parts = (expr.match(/\d+/g) || []);
  const joined = parts.join(' + ');
  return trailingPlus ? (joined ? joined + ' + ' : ' + ') : joined;
}

/* Evaluate expression like "5 + 3 + 7" -> 15. Non-numeric tokens ignored. */
function evaluateExpression(expr){
  if(!expr) return 0;
  const nums = (expr.match(/\d+/g) || []).map(n=>parseInt(n,10) || 0);
  return nums.reduce((s,v)=>s+v, 0);
}

/* Upsert inventory with expression and computed total */
function upsertInventoryExpr(code, name, expr, total, dontRerender = false){
  const idx = inventoryItems.findIndex(it => it.code === code);
  if(idx >= 0){
    inventoryItems[idx].qty = total;
    inventoryItems[idx].expr = expr;
    inventoryItems[idx].name = name || inventoryItems[idx].name;
  } else {
    inventoryItems.unshift({ code, name, qty: total, expr });
  }
  saveInventory();
  const card = renderedCards.get(code);
  if(card){
    const inputEl = card.querySelector('.qty-input');
    if(document.activeElement !== inputEl){
      inputEl.value = expr;
    }
  }
  if(!dontRerender){
    renderResults();
  }
}

/* Focus input of a card by code and open numeric pad */
function focusCardInput(code){
  setTimeout(()=>{
    const card = renderedCards.get(code) || document.querySelector(`[data-code="${code}"]`);
    if(!card) return;
    const input = card.querySelector('.qty-input');
    if(!input) return;
    try{
      input.type = 'tel';
      input.setAttribute('inputmode','numeric');
      input.focus();
      const len = input.value.length;
      try{ input.setSelectionRange(len, len); }catch(e){}
      setTimeout(()=>{ try{ input.type = 'text'; }catch(e){} try{ input.setSelectionRange(len, len); }catch(e){} }, 120);
    }catch(e){
      try{ input.focus(); }catch(e){}
    }
    openNumericPad(code);
    padTargetCode = code;
    focusedInputCode = code;
  }, 160);
}

/* ===== Numeric pad integration ===== */
function openNumericPad(code){
  padTargetCode = code;
  numericPad.classList.add('visible');
  numericPad.setAttribute('aria-hidden','false');
  // try to keep native keyboard open if it opened
  setTimeout(()=>{
    const card = document.querySelector(`[data-code="${code}"]`);
    if(card){
      const input = card.querySelector('.qty-input');
      if(input){
        try{ input.focus(); }catch(e){}
      }
    }
  }, 80);
}
function closeNumericPad(){
  padTargetCode = null;
  numericPad.classList.remove('visible');
  numericPad.setAttribute('aria-hidden','true');
  try{ document.activeElement && document.activeElement.blur(); }catch(e){}
}
function padInsert(ch){
  if(!padTargetCode) return;
  const card = document.querySelector(`[data-code="${padTargetCode}"]`);
  if(!card) return;
  const input = card.querySelector('.qty-input');
  if(!input) return;
  if(ch === '←'){
    input.value = input.value.slice(0, -1);
  } else {
    input.value = (input.value || '') + ch;
  }
  input.dispatchEvent(new Event('input', { bubbles: true }));
  try{ input.focus(); }catch(e){}
}

/* pad button handlers */
numericPad.addEventListener('click', (e)=>{
  const btn = e.target.closest('button.key');
  if(!btn) return;
  const key = btn.getAttribute('data-key');
  if(key){ padInsert(key); return; }
  if(btn.id === 'padBack'){ padInsert('←'); return; }
  if(btn.id === 'padDone'){ closeNumericPad(); return; }
});

/* Close pad when tapping outside (but not when tapping inputs) */
document.addEventListener('click', (e)=>{
  if(!numericPad.classList.contains('visible')) return;
  if(numericPad.contains(e.target)) return;
  if(e.target.closest('.qty-input')) return;
  closeNumericPad();
});

/* ===== Scanner implementation ===== */
async function enumerateCameras(){
  try{
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === 'videoinput');
    deviceSelect.innerHTML = '';
    cams.forEach((c, idx)=>{
      const opt = document.createElement('option');
      opt.value = c.deviceId;
      opt.text = c.label || `Камера ${idx+1}`;
      deviceSelect.appendChild(opt);
    });
    if(cams.length && !currentDeviceId) currentDeviceId = cams[0].deviceId;
    if(currentDeviceId) deviceSelect.value = currentDeviceId;
  }catch(e){}
}

async function startCamera(){
  if(scanning) return;
  stopCamera();
  scanning = true;
  await enumerateCameras();
  const constraints = {
    audio:false,
    video:{
      deviceId: deviceSelect.value || currentDeviceId || undefined,
      facingMode: { ideal: "environment" },
      width: { ideal: 1280 },
      height: { ideal: 720 }
    }
  };
  try{
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    preview.srcObject = stream;
    await preview.play();
    currentDeviceId = stream.getVideoTracks()[0].getSettings().deviceId || currentDeviceId;
    deviceSelect.value = currentDeviceId || deviceSelect.value;
    if(!reader) reader = new ZXing.BrowserMultiFormatReader();
    requestAnimationFrame(scanLoop);
    showToast('Сканер запущен');
  }catch(err){
    console.error(err);
    showToast('Ошибка доступа к камере');
    scanning = false;
  }
}

function stopCamera(){
  scanning = false;
  if(preview.srcObject){
    preview.srcObject.getTracks().forEach(t=>t.stop());
    preview.srcObject = null;
  }
  if(reader){
    try{ reader.reset(); }catch(e){}
  }
  showToast('Сканер остановлен');
}

function createCanvas(w,h){ const c=document.createElement('canvas'); c.width=w; c.height=h; return c; }

async function tryDecodeCanvas(canvas){
  if(detector){
    try{
      const imageData = canvas.getContext('2d').getImageData(0,0,canvas.width,canvas.height);
      const res = await detector.detect(imageData);
      if(res && res.length) return res[0].rawValue;
    }catch(e){}
  }
  try{
    const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(canvas);
    const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
    const result = new ZXing.MultiFormatReader().decode(binaryBitmap);
    if(result && result.text) return result.text;
  }catch(e){}
  const w = canvas.width, h = canvas.height;
  const temp = createCanvas(w,h);
  const tctx = temp.getContext('2d');
  for(const angle of [90,180,270]){
    tctx.clearRect(0,0,w,h);
    tctx.save();
    tctx.translate(w/2,h/2);
    tctx.rotate(angle*Math.PI/180);
    tctx.drawImage(canvas, -w/2, -h/2);
    tctx.restore();
    try{
      const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(temp);
      const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
      const result = new ZXing.MultiFormatReader().decode(binaryBitmap);
      if(result && result.text) return result.text;
    }catch(e){}
  }
  return null;
}

let canvasPool = [];
function getCanvas(w,h){
  for(const c of canvasPool) if(c.width===w && c.height===h) return c;
  const c = createCanvas(w,h); canvasPool.push(c); return c;
}

let scanLoopRunning = false;
async function scanLoop(){
  if(!scanning) { scanLoopRunning = false; return; }
  if(scanLoopRunning) return;
  scanLoopRunning = true;
  try{
    while(scanning){
      const w = preview.videoWidth;
      const h = preview.videoHeight;
      if(w===0 || h===0){ await new Promise(r=>requestAnimationFrame(r)); continue; }
      const canvas = getCanvas(w,h);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(preview, 0, 0, w, h);
      const scale = Math.max(1, Math.floor(Math.max(w,h)/900));
      const sw = Math.floor(w/scale);
      const sh = Math.floor(h/scale);
      const small = getCanvas(sw,sh);
      const sctx = small.getContext('2d');
      sctx.drawImage(canvas, 0, 0, w, h, 0, 0, sw, sh);
      try{
        const code = await tryDecodeCanvas(small);
        if(code) {
          beepSound();
          hideScannerUI();
          handleDetected(code);
          await new Promise(r=>setTimeout(r, 300));
        }
      }catch(e){}
      await new Promise(r=>requestAnimationFrame(r));
    }
  }finally{ scanLoopRunning = false; }
}

/* When code detected: populate search, create if missing, keep item on screen and focus its input */
function handleDetected(code){
  const now = Date.now();
  if(code === lastDetected.code && (now - lastDetected.ts) < DEBOUNCE_MS) return;
  lastDetected = {code, ts: now};
  searchInput.value = code;
  const found = barcodeDB[code];
  if(found){
    showToast('Найден товар в базе');
    const idx = inventoryItems.findIndex(it=>it.code===code);
    if(idx === -1){
      upsertInventoryExpr(code, found, '0', 0, true);
    }
    renderResults();
    focusCardInput(code);
  } else {
    const create = confirm(`Код ${code} не найден. Создать товар с этим кодом и добавить 1 шт.?`);
    if(create){
      const name = prompt('Введите название товара для нового кода', '') || '';
      if(name.trim()){
        barcodeDB[code] = name.trim();
        saveDB();
        upsertInventoryExpr(code, barcodeDB[code], '1', 1, true);
        renderResults();
        focusCardInput(code);
        showToast('Товар добавлен и учтён');
      } else {
        showToast('Название не введено');
      }
    } else {
      showToast('Код не найден');
    }
  }
}

/* ===== UI wiring ===== */
openScannerBtn.addEventListener('click', ()=>{
  scannerCard.style.display = 'block';
  scannerCard.setAttribute('aria-hidden','false');
  previewWrap.classList.add('visible');
  startCamera();
});
closeScannerBtn.addEventListener('click', ()=>{ hideScannerUI(); });
function hideScannerUI(){
  stopCamera();
  scannerCard.style.display = 'none';
  scannerCard.setAttribute('aria-hidden','true');
  previewWrap.classList.remove('visible');
}

deviceSelect.addEventListener('change', async ()=>{ currentDeviceId = deviceSelect.value; await startCamera(); });

searchInput.addEventListener('input', ()=>{ renderResults(); });
clearSearch.addEventListener('click', ()=>{ searchInput.value = ''; renderResults(); searchInput.focus(); });

addManualBtn.addEventListener('click', ()=>{
  const code = (manualCode.value || '').trim();
  const name = (manualName.value || '').trim() || (code || 'Новый товар');
  const finalCode = code || ('manual-' + Date.now());
  barcodeDB[finalCode] = name;
  saveDB();
  upsertInventoryExpr(finalCode, name, '0', 0, true);
  renderResults();
  focusCardInput(finalCode);
  manualCode.value = '';
  manualName.value = '';
  showToast('Добавлено вручную');
});

/* Close pad when tapping outside handled earlier */

/* Init */
renderResults();
enumerateCameras();
navigator.mediaDevices.getUserMedia({video:true}).then(s=>{ s.getTracks().forEach(t=>t.stop()); enumerateCameras(); }).catch(()=>{});
</script>
</body>
</html>




