<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>RecountPro ‚Äî –ü–µ—Ä–µ—Å—á—ë—Ç</title>

  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://unpkg.com/@zxing/library@latest"></script>

  <style>
    :root {
      --accent: #6d28d9;
      --accent-light: #a78bfa;
      --text: #e6eef8;
      --muted: #9aa3b2;
      --card-bg: linear-gradient(135deg,#1e1e2f,#2a2a40);
      --max-width: 980px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#000;color:var(--text);font-family:"Segoe UI",system-ui,Arial,Helvetica,sans-serif; -webkit-font-smoothing:antialiased;overflow:hidden}
    #bg{position:fixed;inset:0;z-index:-1;background:#000}
    /* Header */
    #header{position:fixed;left:0;right:0;top:0;z-index:1000;background:rgba(12,12,16,0.72);backdrop-filter:blur(10px);padding:12px;border-radius:0 0 18px 18px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    #header h1{margin:0;text-align:center;font-size:1.15rem;color:#fff}
    #search-container{margin-top:8px;max-width:var(--max-width);margin-left:auto;margin-right:auto;position:relative}
    #search{width:100%;padding:10px 56px 10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(20,20,24,0.6);color:#fff;font-size:15px}
    #clear-search{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer;z-index:3}
    #voice-or-scan{position:absolute;right:48px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);cursor:pointer;z-index:3}
    /* Content */
    #content{position:fixed;left:0;right:0;top:96px;bottom:0;overflow:auto;padding:12px;box-sizing:border-box}
    #content.with-keyboard{padding-bottom:34vh}
    .item{max-width:var(--max-width);margin:10px auto;padding:12px;border-radius:12px;background:var(--card-bg);box-shadow:0 8px 30px rgba(0,0,0,0.6);border-left:6px solid transparent}
    .item.match{border-left-color:#22c55e}
    .item.missing{border-left-color:#ef4444}
    .item.excess{border-left-color:#3b82f6}
    .item.found{box-shadow:0 18px 50px rgba(106,17,203,0.18);transform:translateY(-6px)}
    .field{margin-bottom:8px}
    .label{font-weight:700;color:#dbeafe;margin-right:6px}
    input[data-code]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#fff;color:#000;font-size:15px}
    /* Keyboard */
    #custom-keyboard{position:fixed;left:0;right:0;bottom:-40vh;height:34vh;background:#0b0b0d;padding:10px;box-sizing:border-box;display:grid;grid-template-columns:repeat(3,1fr);grid-auto-rows:1fr;gap:8px;z-index:3000;transition:bottom .28s}
    #custom-keyboard.show{bottom:0}
    #custom-keyboard button{border:none;border-radius:8px;background:#222;color:#fff;font-size:20px;cursor:pointer}
    #custom-keyboard .done{grid-column:1 / -1;background:linear-gradient(90deg,var(--accent),var(--accent-light));font-weight:800;font-size:18px}
    /* Scanner preview */
    #scannerCard{display:none;max-width:var(--max-width);margin:10px auto;color:#ddd}
    .preview-wrap{border-radius:10px;overflow:hidden;background:#000;border:1px solid rgba(255,255,255,0.04)}
    .preview-wrap.camera-1-3{height:34vh;min-height:140px}
    video#preview{width:100%;height:100%;object-fit:cover;display:block}
    #deviceSelect{background:#111;color:#fff;border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.04)}
    #scanResult{margin-top:8px;color:var(--muted)}
    .hidden{display:none!important}
    /* Modal / small */
    #modal, #session-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:2000;align-items:center;justify-content:center}
    .modal-inner{background:#fff;border-radius:12px;max-width:95%;width:95%;max-height:85%;overflow:auto;padding:12px}
    /* export area hidden */
    #export-area{display:none}
    @media(min-width:900px){#content{padding-left:24px;padding-right:24px}}
  </style>
</head>
<body>
  <canvas id="bg"></canvas>

  <div id="header">
    <h1>RecountPro ‚Äî –ü–µ—Ä–µ—Å—á—ë—Ç</h1>
    <div id="search-container">
      <div style="position:relative;">
        <input id="search" type="text" placeholder="–ü–æ–∏—Å–∫..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" aria-label="–ü–æ–∏—Å–∫" />
        <button id="clear-search" aria-label="–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫">√ó</button>
        <!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞ (–∑–∞–º–µ–Ω—è–µ—Ç –≥–æ–ª–æ—Å–æ–≤—É—é) -->
        <button id="voice-or-scan" aria-label="–°–∫–∞–Ω–µ—Ä" title="–û—Ç–∫—Ä—ã—Ç—å —Å–∫–∞–Ω–µ—Ä">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 7v4a1 1 0 0 0 1 1h4" stroke="#cbd5e1" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M21 17v-4a1 1 0 0 0-1-1h-4" stroke="#cbd5e1" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            <rect x="7" y="7" width="10" height="10" rx="2" stroke="#cbd5e1" stroke-width="1.6" fill="none"/>
            <circle cx="12" cy="12" r="2.2" stroke="#cbd5e1" stroke-width="1.6" fill="none"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <div id="content">
    <!-- Scanner preview -->
    <div id="scannerCard">
      <div class="preview-wrap camera-1-3" id="previewWrap"><video id="preview" playsinline muted></video></div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <select id="deviceSelect" aria-label="–ö–∞–º–µ—Ä–∞"></select>
        <button id="closeScannerBtn" style="background:none;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:8px;border-radius:8px;cursor:pointer">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div id="scanResult"></div>
    </div>

    <div id="list"></div>
  </div>

  <!-- –ö–∞—Å—Ç–æ–º–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ -->
  <div id="custom-keyboard" aria-hidden="true">
    <button>1</button><button>2</button><button>3</button>
    <button>4</button><button>5</button><button>6</button>
    <button>7</button><button>8</button><button>9</button>
    <button>+</button><button>0</button><button id="back">‚Üê</button>
    <button class="done" id="done">–ì–æ—Ç–æ–≤–æ</button>
  </div>

  <!-- –ú–æ–¥–∞–ª–∏ -->
  <div id="modal">
    <div class="modal-inner" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:center;align-items:center;position:relative;padding-bottom:8px;border-bottom:1px solid #eee">
        <h2 style="margin:0;color:var(--accent)">–ò—Ç–æ–≥ –ø–µ—Ä–µ—Å—á—ë—Ç–∞</h2>
        <button onclick="document.getElementById('modal').style.display='none'" style="position:absolute;right:8px;top:8px;background:none;border:none;font-size:18px;cursor:pointer">‚úï</button>
      </div>
      <div id="modal-content" style="padding-top:8px"></div>
      <div style="margin-top:12px"><button onclick="document.getElementById('modal').style.display='none'" style="width:100%;padding:10px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-weight:700">–ó–∞–∫—Ä—ã—Ç—å</button></div>
    </div>
  </div>

  <!-- –°–∫—Ä—ã—Ç–∞—è –æ–±–ª–∞—Å—Ç—å —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
  <div id="export-area"></div>

<script>
/* =========================
   –í—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–æ—Å—Ç–∞–≤–ª–µ–Ω–æ)
   ========================= */
const LAST_ACTIVITY_KEY = "lastActivity";
const MAX_IDLE_TIME = 6 * 60 * 60 * 1000;
function updateActivity(){ localStorage.setItem(LAST_ACTIVITY_KEY, Date.now().toString()); }
function checkIdleTime(){ const last = parseInt(localStorage.getItem(LAST_ACTIVITY_KEY) || "0",10); if(last && Date.now()-last > MAX_IDLE_TIME){ localStorage.removeItem("isAuth"); window.location.href="/demo.html"; } }
["click","keydown","mousemove","scroll","touchstart"].forEach(evt=>document.addEventListener(evt, updateActivity, {passive:true}));
setInterval(checkIdleTime, 30*60*1000);
updateActivity();

/* =========================
   –ë–∞–∑–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤ (–ø—Ä–∏–º–µ—Ä)
   ========================= */
const barcodeDB = {
  "4601234000011": { code: "4601234000011", name: "–ú–æ–ª–æ–∫–æ 1–ª", unit: "—à—Ç", price: 59.90 },
  "4601234000028": { code: "4601234000028", name: "–•–ª–µ–± —Ä–∂–∞–Ω–æ–π", unit: "—à—Ç", price: 35.00 },
  "4601234000035": { code: "4601234000035", name: "–Ø–±–ª–æ–∫–∏ –∫–≥", unit: "–∫–≥", price: 120.00 },
  "4601234000042": { code: "4601234000042", name: "–°—ã—Ä 200–≥", unit: "—à—Ç", price: 250.00 },
  "4601234000059": { code: "4601234000059", name: "–ö–æ—Ñ–µ 250–≥", unit: "—à—Ç", price: 499.00 }
};

/* =========================
   –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   ========================= */
const listEl = document.getElementById("list");
const searchInput = document.getElementById("search");
const clearSearchBtn = document.getElementById("clear-search");
const scanBtn = document.getElementById("voice-or-scan");
const keyboard = document.getElementById("custom-keyboard");
let allItems = [];
let sessionValues = {};
let activeInput = null;

/* –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ—Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ */
window.addEventListener("DOMContentLoaded", () => {
  const currentLocalkaId = (window.localkaData && window.localkaData.docId) ? window.localkaData.docId : "loc_" + new Date().toISOString().slice(0,10);
  const sessionKey = "autosave_session_" + currentLocalkaId;
  const savedSession = localStorage.getItem(sessionKey);
  if (savedSession) {
    try {
      const session = JSON.parse(savedSession);
      allItems = session.items || [];
      sessionValues = session.values || {};
    } catch { allItems = []; sessionValues = {}; }
  } else {
    allItems = Object.values(barcodeDB).map(b => ({ code: b.code, name: b.name, unit: b.unit || '', price: b.price || 0, docQty: 0 }));
    sessionValues = {};
  }
  render(allItems);
});

/* –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ */
function autosave(){
  const currentLocalkaId = (window.localkaData && window.localkaData.docId) ? window.localkaData.docId : "loc_" + new Date().toISOString().slice(0,10);
  const sessionKey = "autosave_session_" + currentLocalkaId;
  const session = { items: allItems, values: sessionValues };
  localStorage.setItem(sessionKey, JSON.stringify(session));
}
window.addEventListener("beforeunload", autosave);

/* =========================
   –ü–æ–∏—Å–∫: –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞
   ========================= */
function normalize(str){ return String(str||"").toLowerCase().replace(/—ë/g,"–µ").replace(/‚Ññ/g,"").replace(/\s+/g," ").trim(); }
function matchesQuery(text, query){ const words = query.split(" ").filter(Boolean); return words.every(w => text.includes(w)); }

/* =========================
   –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ (–∫–∞—Ä—Ç–æ—á–∫–∏)
   ========================= */
function render(items){
  listEl.innerHTML = '';
  items.forEach(item => {
    const value = sessionValues[item.code] || localStorage.getItem("qty_" + item.code) || "";
    const div = document.createElement("div");
    div.className = "item";
    div.dataset.code = item.code;
    div.innerHTML = `
      <div class="field"><span class="label">–ê—Ä—Ç–∏–∫—É–ª:</span> ${item.code}</div>
      <div class="field"><span class="label">–ù–∞–∑–≤–∞–Ω–∏–µ:</span> ${escapeHtml(item.name)}</div>
      <div class="field"><span class="label">–ü–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º:</span> ${item.docQty} —à—Ç</div>
      <div class="field">
        <span class="label">–§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:</span>
        <input type="text" data-code="${item.code}" value="${escapeHtml(value)}" inputmode="none" readonly />
      </div>
    `;
    let actual = 0;
    try { actual = Function("return " + (value || "0").replace(',', '.'))() || 0; } catch {}
    if (actual === item.docQty) div.classList.add("match");
    else if (actual < item.docQty) div.classList.add("missing");
    else if (actual > item.docQty) div.classList.add("excess");
    listEl.appendChild(div);
  });
  attachInputHandlers();
  updateSummary(allItems);
}

/* escapeHtml */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

/* =========================
   –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–Ω–ø—É—Ç–æ–≤ –∏ –∫–∞—Å—Ç–æ–º–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
   ========================= */
function attachInputHandlers(){
  document.querySelectorAll('input[data-code]').forEach(input => {
    input.addEventListener('focus', () => { activeInput = input; openKeyboardFor(input); });
    input.addEventListener('click', () => { activeInput = input; openKeyboardFor(input); });
  });

  keyboard.querySelectorAll('button').forEach(btn => {
    btn.onclick = () => {
      if (!activeInput) return;
      const val = btn.textContent;
      if (val === "‚Üê") activeInput.value = activeInput.value.slice(0, -1);
      else if (val === "–ì–æ—Ç–æ–≤–æ" || val === "–ì–æ—Ç–æ–≤–æ") { closeKeyboard(); return; }
      else activeInput.value += val;
      activeInput.dispatchEvent(new Event("input", { bubbles: true }));
    };
  });

  document.getElementById('done').addEventListener('click', closeKeyboard);
  document.getElementById('back').addEventListener('click', () => { if (!activeInput) return; activeInput.value = activeInput.value.slice(0, -1); activeInput.dispatchEvent(new Event("input", { bubbles: true })); });

  document.addEventListener('click', e => {
    if (!e.target.closest('#custom-keyboard') && !e.target.matches('input[data-code]')) {
      closeKeyboard();
    }
  });
}

function openKeyboardFor(input){
  activeInput = input;
  keyboard.classList.add('show');
  document.getElementById('content').classList.add('with-keyboard');
  setTimeout(() => {
    const rect = input.getBoundingClientRect();
    const viewportH = window.innerHeight;
    const padHeight = Math.max(260, Math.round(viewportH * 0.34));
    const desiredBottom = padHeight + 12;
    if (rect.bottom > viewportH - desiredBottom) {
      const content = document.getElementById('content');
      const offset = rect.bottom - (viewportH - desiredBottom);
      content.scrollBy({ top: offset + 12, behavior: 'smooth' });
    } else {
      input.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }, 150);
}

function closeKeyboard(){
  activeInput = null;
  keyboard.classList.remove('show');
  document.getElementById('content').classList.remove('with-keyboard');
}

/* –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –∏ –ø–µ—Ä–µ–∫—Ä–∞—Å–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ */
listEl.addEventListener('input', e => {
  if (e.target.tagName !== 'INPUT') return;
  const code = e.target.dataset.code;
  const value = e.target.value;
  sessionValues[code] = value;
  localStorage.setItem("qty_" + code, value);

  const raw = value.replace(',', '.').trim();
  let actual = NaN;
  try {
    let safeRaw = raw;
    if (/[\+\-\*\/]$/.test(safeRaw)) safeRaw = safeRaw.slice(0, -1);
    if (safeRaw) actual = Function("return " + safeRaw)();
  } catch { actual = NaN; }

  const item = allItems.find(i => i.code === code);
  const card = e.target.closest('.item');
  card.classList.remove('match', 'missing', 'excess');

  if (!value) {
  } else if (!isNaN(actual)) {
    if (actual === item.docQty) card.classList.add('match');
    else if (actual < item.docQty) card.classList.add('missing');
    else if (actual > item.docQty) card.classList.add('excess');
  }
  updateSummary(allItems);
  autosave();
});

/* =========================
   –ü–æ–∏—Å–∫: —Å–∫—Ä—ã–≤–∞–µ–º –Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
   ========================= */
searchInput.addEventListener('input', () => {
  const q = normalize(searchInput.value);
  document.querySelectorAll('#list .item').forEach(div => {
    const code = normalize(div.dataset.code);
    const item = allItems.find(i => i.code === div.dataset.code);
    if (!item) { div.classList.add('hidden'); return; }
    const name = normalize(item.name);
    const match = (q === "") || matchesQuery(name, q) || matchesQuery(code, q);
    div.classList.toggle('hidden', !match);
  });
});
clearSearchBtn.addEventListener('click', () => {
  searchInput.value = '';
  document.querySelectorAll('#list .item').forEach(div => div.classList.remove('hidden'));
});

/* =========================
   –°–∫–∞–Ω–µ—Ä (ZXing) ‚Äî –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –∑–∞–¥–Ω–µ–π –∫–∞–º–µ—Ä—ã
   ========================= */
let codeReader = null;
let scanning = false;
let lastDetected = { code: null, ts: 0 };
const DEBOUNCE_MS = 900;

const preview = document.getElementById('preview');
const previewWrap = document.getElementById('previewWrap');
const scannerCard = document.getElementById('scannerCard');
const deviceSelect = document.getElementById('deviceSelect');
const closeScannerBtn = document.getElementById('closeScannerBtn');
const scanResult = document.getElementById('scanResult');

/**
 * –í—ã–±–∏—Ä–∞–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ, –∫–æ—Ç–æ—Ä–æ–µ, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, —è–≤–ª—è–µ—Ç—Å—è –∑–∞–¥–Ω–µ–π –∫–∞–º–µ—Ä–æ–π.
 * –õ–æ–≥–∏–∫–∞:
 *  - –µ—Å–ª–∏ –≤ label –µ—Å—Ç—å 'back', 'rear', 'environment', '–∑–∞–¥–Ω', '—Ç—ã–ª' ‚Äî –≤—ã–±–∏—Ä–∞–µ–º –µ–≥–æ
 *  - –∏–Ω–∞—á–µ, –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞–º–µ—Ä, –≤—ã–±–∏—Ä–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é (—á–∞—Å—Ç–æ rear)
 *  - –∏–Ω–∞—á–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–≤—ã–π deviceId
 */
function chooseRearCamera(devices) {
  if (!devices || devices.length === 0) return null;
  const labels = devices.map(d => (d.label || '').toLowerCase());
  for (let i = 0; i < devices.length; i++) {
    const l = labels[i];
    if (!l) continue;
    if (l.includes('back') || l.includes('rear') || l.includes('environment') || l.includes('–∑–∞–¥–Ω') || l.includes('—Ç—ã–ª')) {
      return devices[i].deviceId;
    }
  }
  // –µ—Å–ª–∏ –Ω–µ—Ç —è–≤–Ω–æ–π –º–µ—Ç–∫–∏, —á–∞—Å—Ç–æ rear ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤ —Å–ø–∏—Å–∫–µ
  return devices[devices.length - 1].deviceId;
}

async function enumerateCamerasAndSelectRear() {
  try {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === 'videoinput');
    deviceSelect.innerHTML = '';
    cams.forEach((c, idx) => {
      const opt = document.createElement('option');
      opt.value = c.deviceId;
      opt.text = c.label || `–ö–∞–º–µ—Ä–∞ ${idx+1}`;
      deviceSelect.appendChild(opt);
    });
    if (cams.length === 0) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.text = '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞';
      deviceSelect.appendChild(opt);
      return null;
    }
    const rearId = chooseRearCamera(cams);
    if (rearId) deviceSelect.value = rearId;
    else deviceSelect.selectedIndex = 0;
    return deviceSelect.value || cams[0].deviceId;
  } catch (e) {
    console.warn('enumerateCameras error', e);
    return null;
  }
}

async function startScanner(){
  if (scanning) return;
  try {
    codeReader = codeReader || new ZXing.BrowserMultiFormatReader();
  } catch (e) {
    scanResult.textContent = '–°–∫–∞–Ω–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
    return;
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä –∏ –≤—ã–±–∏—Ä–∞–µ–º –∑–∞–¥–Ω—é—é
  const selectedRear = await enumerateCamerasAndSelectRear();

  const deviceId = selectedRear || undefined;
  const constraints = deviceId ? { video: { deviceId: { exact: deviceId } } } : { video: { facingMode: { exact: "environment" } } };

  try {
    scanResult.textContent = '–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ...';
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    preview.srcObject = stream;
    try { await preview.play(); } catch (e) {}
    previewWrap.classList.add('visible');
    scannerCard.style.display = 'block';
    scanResult.textContent = '–°–∫–∞–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω';
    scanning = true;

    // decodeFromVideoDevice ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π deviceId
    codeReader.decodeFromVideoDevice(deviceId, preview, (result, err) => {
      if (result && result.text) {
        const now = Date.now();
        if (result.text === lastDetected.code && (now - lastDetected.ts) < DEBOUNCE_MS) return;
        lastDetected = { code: result.text, ts: now };
        beep();
        handleDetected(result.text);
      }
    });
  } catch (err) {
    scanning = false;
    scanResult.textContent = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ –∏–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∞–º–µ—Ä—É';
    console.error('startScanner error', err);
  }
}

function stopScanner(){
  try { if (codeReader) codeReader.reset(); } catch (e) {}
  scanning = false;
  try {
    const stream = preview.srcObject;
    if (stream && stream.getTracks) stream.getTracks().forEach(t => t.stop());
  } catch (e) {}
  preview.srcObject = null;
  previewWrap.classList.remove('visible');
  scannerCard.style.display = 'none';
  scanResult.textContent = '';
}

scanBtn.addEventListener('click', async () => {
  if (!scanning) await startScanner();
  else stopScanner();
});
closeScannerBtn.addEventListener('click', stopScanner);
deviceSelect.addEventListener('change', async () => {
  if (scanning) {
    try { codeReader.reset(); } catch (e) {}
    scanning = false;
  }
  await startScanner();
});

function beep(){
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine';
    o.frequency.value = 880;
    g.gain.value = 0.02;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
  } catch (e) {}
}

function handleDetected(code){
  try { if (codeReader) codeReader.reset(); } catch (e) {}
  scanning = false;
  try { const stream = preview.srcObject; if (stream && stream.getTracks) stream.getTracks().forEach(t => t.stop()); } catch (e) {}
  preview.srcObject = null;
  previewWrap.classList.remove('visible');
  scannerCard.style.display = 'none';
  scanResult.textContent = `–ù–∞–π–¥–µ–Ω –∫–æ–¥: ${code}`;

  const found = barcodeDB[code];
  if (found) {
    const card = document.querySelector(`.item[data-code="${found.code}"]`);
    if (card) {
      card.classList.add('found');
      card.classList.remove('hidden');
      setTimeout(()=>card.classList.remove('found'), 2200);
      setTimeout(()=> card.scrollIntoView({ behavior:'smooth', block:'center' }), 160);
      const input = card.querySelector('input[data-code]');
      if (input) setTimeout(()=>{ input.focus(); openKeyboardFor(input); }, 320);
    } else {
      allItems.unshift({ code: found.code, name: found.name, unit: found.unit || '', price: found.price || 0, docQty: 0 });
      render(allItems);
      const newCard = document.querySelector(`.item[data-code="${found.code}"]`);
      if (newCard) {
        newCard.classList.add('found');
        setTimeout(()=>newCard.classList.remove('found'), 2200);
        setTimeout(()=> newCard.scrollIntoView({ behavior:'smooth', block:'center' }), 160);
        const input = newCard.querySelector('input[data-code]');
        if (input) setTimeout(()=>{ input.focus(); openKeyboardFor(input); }, 320);
      }
    }
  } else {
    const create = confirm(`–ö–æ–¥ ${code} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ. –î–æ–±–∞–≤–∏—Ç—å –∫–∞–∫ –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä?`);
    if (create) {
      const name = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞', '') || `–¢–æ–≤–∞—Ä ${code}`;
      barcodeDB[code] = { code, name, unit: '', price: 0 };
      allItems.unshift({ code, name, unit: '', price: 0, docQty: 0 });
      render(allItems);
      const newCard = document.querySelector(`.item[data-code="${code}"]`);
      if (newCard) {
        newCard.classList.add('found');
        setTimeout(()=>newCard.classList.remove('found'), 2200);
        setTimeout(()=> newCard.scrollIntoView({ behavior:'smooth', block:'center' }), 160);
        const input = newCard.querySelector('input[data-code]');
        if (input) setTimeout(()=>{ input.focus(); openKeyboardFor(input); }, 320);
      }
    }
  }
}

/* –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ—á–∏—Å–ª–∏—Ç—å –∫–∞–º–µ—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–Ω–µ –±–ª–æ–∫–∏—Ä—É—é—â–∞—è) */
if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
  navigator.mediaDevices.enumerateDevices().then(enumerateCamerasAndSelectRear).catch(()=>{});
}

/* =========================
   –ü–∞—Ä—Å–∏–Ω–≥ PDF (–∫–∞–∫ –≤ –≤–∞—à–µ–º –∫–æ–¥–µ)
   ========================= */
function groupByY(items) {
  const lines = {};
  items.forEach(item => {
    const y = Math.round(item.transform[5]);
    if (!lines[y]) lines[y] = [];
    lines[y].push({ str: item.str, x: item.transform[4] });
  });
  return Object.values(lines).map(words => words.sort((a,b)=>a.x-b.x).map(w=>w.str).join(' '));
}

function parseLines(lines) {
  const items = [];
  for (let line of lines) {
    line = line.trim();
    if (!/^\d+\s+\d{4,6}/.test(line)) continue;
    const match = line.match(/^(\d+)\s+(\d{4,6})\s+(.+?)\s+(\d+\*\d+)?\s+([\d.,]+)\s+(.*)$/i);
    if (match) {
      const rawTail = match[6];
      const qtyMatches = [...rawTail.matchAll(/(\d+)\s*—à—Ç/gi)];
      const docQty = qtyMatches.length > 0 ? parseInt(qtyMatches[qtyMatches.length - 1][1]) : null;
      items.push({
        code: match[2],
        name: match[3].trim(),
        unit: match[4] || '',
        price: parseFloat(match[5].replace(',', '.')),
        docQty
      });
    }
  }
  return items;
}

/* =========================
   –ò—Ç–æ–≥–∏ –∏ —ç–∫—Å–ø–æ—Ä—Ç (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
   ========================= */
function updateSummary(items) {
  let match = 0, missing = 0, excess = 0, delta = 0;
  items.forEach(item => {
    const input = document.querySelector(`input[data-code="${item.code}"]`);
    if (!input) return;
    const raw = input.value.trim();
    const actual = parseFloat(raw.replace(',', '.')) || 0;
    if (actual === item.docQty) match++;
    else if (actual < item.docQty) { missing++; delta += item.docQty - actual; }
    else { excess++; delta += actual - item.docQty; }
  });
}

/* –≠–∫—Å–ø–æ—Ä—Ç PDF ‚Äî –∑–∞–≥–ª—É—à–∫–∞ (–≤—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à—É —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏) */
let startTime = new Date();
function exportPDF() {
  autosave();
  alert("–≠–∫—Å–ø–æ—Ä—Ç –≤—ã–∑–≤–∞–Ω. –í—Å—Ç–∞–≤—å—Ç–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é exportPDF –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.");
}

/* =========================
   –ó–∞–≥—Ä—É–∑–∫–∞ PDF (–∫–∞–∫ –≤ –≤–∞—à–µ–º –∫–æ–¥–µ)
   ========================= */
document.addEventListener('DOMContentLoaded', () => {
  const upload = document.getElementById('upload');
  if (upload) {
    upload.addEventListener('change', async e => {
      const file = e.target.files[0];
      if (!file) return;
      const arrayBuffer = await file.arrayBuffer();
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js";
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let allLines = [];
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const grouped = groupByY(content.items);
        allLines.push(...grouped);
      }
      allItems = parseLines(allLines);
      const overwrite = confirm("–ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ—Å—á—ë—Ç–∞?");
      if (overwrite) sessionValues = {};
      else {
        allItems.forEach(item => {
          const saved = localStorage.getItem("qty_" + item.code);
          if (saved) sessionValues[item.code] = saved;
        });
      }
      render(allItems);
      autosave();
    });
  }
});

/* =========================
   Canvas background (–∑–≤—ë–∑–¥—ã/–∫–æ–º–µ—Ç—ã)
   ========================= */
const canvas = document.getElementById("bg");
const ctx = canvas.getContext("2d");
function resizeCanvas(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener("resize", resizeCanvas);
resizeCanvas();
let stars = [];
for (let i = 0; i < 200; i++) stars.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, r: Math.random() * 1.5 + 0.5, alpha: Math.random(), speed: Math.random() * 0.2 + 0.05 });
let comets = [];
function spawnComet(){ comets.push({ x: -100, y: Math.random() * canvas.height * 0.5, vx: 6 + Math.random() * 2, vy: 2 + Math.random(), life: 0, maxLife: 300 }); }
let clickParticles = [];
canvas.addEventListener("click", e => {
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left, y = e.clientY - rect.top;
  for (let i = 0; i < 20; i++) clickParticles.push({ x, y, vx: (Math.random() - 0.5) * 4, vy: (Math.random() - 0.5) * 4, life: 0, maxLife: 60, r: Math.random() * 2 + 1 });
});
function drawClickParticles(){ clickParticles.forEach((p,i)=>{ ctx.fillStyle = `rgba(255,255,200,${1 - p.life / p.maxLife})`; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); p.x += p.vx; p.y += p.vy; p.life++; if (p.life > p.maxLife) clickParticles.splice(i,1); }); }
function animate(){ ctx.clearRect(0,0,canvas.width,canvas.height); stars.forEach(s=>{ s.alpha += (Math.random()-0.5)*0.05; if(s.alpha<0) s.alpha=0; if(s.alpha>1) s.alpha=1; s.y += s.speed; if(s.y>canvas.height){ s.y=0; s.x=Math.random()*canvas.width } ctx.fillStyle = `rgba(255,255,255,${s.alpha})`; ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill(); }); if(Math.random()<0.005) spawnComet(); comets.forEach((c,i)=>{ let grad = ctx.createLinearGradient(c.x,c.y,c.x-120,c.y-60); grad.addColorStop(0,"rgba(255,255,255,0.8)"); grad.addColorStop(1,"rgba(255,255,255,0)"); ctx.strokeStyle = grad; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(c.x,c.y); ctx.lineTo(c.x-120,c.y-60); ctx.stroke(); ctx.fillStyle="#fff"; ctx.beginPath(); ctx.arc(c.x,c.y,3.5,0,Math.PI*2); ctx.fill(); c.x += c.vx; c.y += c.vy; c.life++; if(c.x>canvas.width+150||c.y>canvas.height+150||c.life>c.maxLife) comets.splice(i,1); }); drawClickParticles(); requestAnimationFrame(animate); }
animate();

/* =========================
   –£—Ç–∏–ª–∏—Ç—ã: –æ—á–∏—Å—Ç–∫–∞, —Å–µ—Å—Å–∏–∏, —ç–∫—Å–ø–æ—Ä—Ç –∏ —Ç.–¥.
   ========================= */
function clearRecount() {
  if (!confirm("–û—á–∏—Å—Ç–∏—Ç—å –ø–µ—Ä–µ—Å—á—ë—Ç?")) return;
  const currentLocalkaId = (window.localkaData && window.localkaData.docId) ? window.localkaData.docId : "loc_" + new Date().toISOString().slice(0,10);
  const sessionKey = "autosave_session_" + currentLocalkaId;
  localStorage.removeItem(sessionKey);
  if (Array.isArray(allItems) && allItems.length > 0) allItems.forEach(item => localStorage.removeItem("qty_" + item.code));
  allItems = [];
  sessionValues = {};
  listEl.innerHTML = '';
  updateSummary([]);
}

function saveSession() {
  const name = prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Å–µ—Å—Å–∏–∏");
  if (!name) return;
  document.querySelectorAll('input[data-code]').forEach(input => sessionValues[input.dataset.code] = input.value);
  const session = { items: allItems, values: sessionValues };
  localStorage.setItem("session_" + name, JSON.stringify(session));
  localStorage.setItem("active_session", name);
  alert("–°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: " + name);
}

function openSessionModal() {
  const container = document.getElementById("session-list");
  if (!container) return;
  container.innerHTML = '';
  const keys = Object.keys(localStorage).filter(k => k.startsWith("session_"));
  if (keys.length === 0) container.innerHTML = "<div>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π</div>";
  else keys.forEach(key => {
    const name = key.replace("session_", "");
    const div = document.createElement("div");
    div.style = "margin-bottom:0.5rem; padding:0.5rem; border:1px solid #ddd; border-radius:6px;";
    div.innerHTML = `<strong>${name}</strong><div style="margin-top:0.3rem;"><button onclick="loadSession('${name}')">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button> <button onclick="switchSession('${name}')">üîÅ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button> <button onclick="deleteSession('${name}')">üóë –£–¥–∞–ª–∏—Ç—å</button></div>`;
    container.appendChild(div);
  });
  document.getElementById("session-modal").style.display = "flex";
}

function loadSession(name) {
  const raw = localStorage.getItem("session_" + name);
  if (!raw) return alert("–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
  try {
    const session = JSON.parse(raw);
    allItems = session.items;
    sessionValues = session.values || {};
    render(allItems);
    alert("–°–µ—Å—Å–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞: " + name);
  } catch {
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–µ—Å—Å–∏–∏");
  }
}
function switchSession(name) { localStorage.setItem("active_session", name); loadSession(name); }
function deleteSession(name) { if (!confirm("–£–¥–∞–ª–∏—Ç—å —Å–µ—Å—Å–∏—é: " + name + "?")) return; localStorage.removeItem("session_" + name); if (localStorage.getItem("active_session") === name) localStorage.removeItem("active_session"); openSessionModal(); }

/* =========================
   –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
   ========================= */
window._recount = { render, allItems, barcodeDB, startScanner, stopScanner, autosave };

</script>
</body>
</html>
