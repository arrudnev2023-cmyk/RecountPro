<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Инвентаризация — Invent</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f6f7fb;
  --panel:#ffffff;
  --muted:#6b7280;
  --neon1:#7b3be6;
  --neon2:#c86cff;
  --accent:linear-gradient(90deg,var(--neon1),var(--neon2));
  --header-h:112px; /* two-row header */
  --footer-h:92px;
  --max-w:420px;
  --gap:10px;
  --card-radius:12px;
  --shadow: 0 8px 24px rgba(16,24,40,0.04);
}

/* Reset & base */
*{box-sizing:border-box}
html,body{
  height:100%;
  margin:0;
  background:var(--bg);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  -webkit-font-smoothing:antialiased;
  overscroll-behavior-y: none; /* prevent pull-to-refresh on supporting browsers */
  touch-action: manipulation;
  -webkit-user-select:none; user-select:none;
}

/* App layout: three strict zones */
.app{height:100vh;display:flex;flex-direction:column;align-items:center;}

/* Header (fixed) */
.header{
  position:fixed; left:0; right:0; top:0;
  height:var(--header-h);
  display:flex;align-items:flex-start;justify-content:center;
  background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.96));
  border-bottom:1px solid rgba(11,16,32,0.04);
  z-index:1400;
  padding:12px 12px 10px 12px;
  box-shadow: 0 6px 18px rgba(16,24,40,0.04);
  overscroll-behavior: contain;
}
.header-inner{ width:100%; max-width:var(--max-w); display:flex; flex-direction:column; gap:8px; }

/* Title row */
.title-row{ display:flex; align-items:center; gap:10px; }
.logo{ width:44px; height:44px; border-radius:10px; background:var(--accent); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:800; flex:0 0 44px; }
.title{ font-size:18px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

/* Search row */
.search-row{ display:flex; gap:8px; align-items:center; }
.input-wrap{ position:relative; flex:1; min-width:0; }
.input{
  width:100%;
  padding:10px 40px 10px 12px;
  border-radius:10px;
  border:1px solid rgba(11,16,32,0.06);
  background:#fff;
  outline:none;
  font-size:15px;
}
.clear-x{ position:absolute; right:8px; top:50%; transform:translateY(-50%); background:transparent; border:none; color:var(--muted); font-weight:700; padding:6px; border-radius:6px; cursor:pointer; }
.scan-btn{ padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:700; background:var(--accent); color:#fff; min-width:84px; flex:0 0 auto; }

/* Content (single scrollable area) */
.content{
  width:100%;
  max-width:var(--max-w);
  margin-top: calc(var(--header-h) + 6px);
  margin-bottom: calc(var(--footer-h) + 6px);
  height: calc(100vh - var(--header-h) - var(--footer-h) - 12px);
  overflow:auto;
  -webkit-overflow-scrolling: touch;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:var(--gap);
  align-items:stretch;
  background:transparent;
}

/* Card / scanner */
.card{ background:var(--panel); border-radius:var(--card-radius); padding:12px; border:1px solid rgba(11,16,32,0.06); box-shadow:var(--shadow); }
.preview-wrap{ border-radius:10px; overflow:hidden; background:#000; border:1px solid rgba(11,16,32,0.06); display:none; }
.preview-wrap.visible{ display:block; }
.preview-wrap.camera-1-3{ height:33vh; min-height:140px; max-height:300px; }
video#preview{ width:100%; height:100%; object-fit:cover; display:block; }

/* Results list */
.results{ display:flex; flex-direction:column; gap:10px; }
.card-item{ display:flex; flex-direction:column; padding:12px; border-radius:10px; border:1px solid rgba(11,16,32,0.04); background:linear-gradient(180deg,#fff,#fbfbff); will-change:transform; }
.item-top{ display:flex; align-items:center; gap:12px; }
.avatar{ width:56px; height:56px; border-radius:8px; background:linear-gradient(90deg,var(--neon1),var(--neon2)); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; flex:0 0 56px; }
.item-meta{ display:flex; flex-direction:column; min-width:0; flex:1; }
.item-name{ font-weight:700; color:#0b1020; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.item-code{ color:var(--muted); font-size:13px; margin-top:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.qty-row{ margin-top:10px; display:flex; gap:8px; align-items:center; }
.qty-input{ flex:1; padding:10px; border-radius:8px; border:1px solid rgba(11,16,32,0.06); font-weight:700; font-size:15px; }
.plus-btn{ padding:10px 12px; border-radius:8px; background:linear-gradient(90deg,var(--neon1),var(--neon2)); color:#fff; border:none; cursor:pointer; }

/* Footer (fixed) */
.footer{ position:fixed; left:0; right:0; bottom:0; height:var(--footer-h); display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.96)); border-top:1px solid rgba(11,16,32,0.04); z-index:1400; padding:12px; box-shadow:0 -6px 18px rgba(16,24,40,0.04); }
.footer-inner{ width:100%; max-width:var(--max-w); display:flex; gap:8px; align-items:center; }
.manual-input{ flex:1; display:flex; gap:8px; align-items:center; }
.manual-input input{ flex:1; padding:10px; border-radius:10px; border:1px solid rgba(11,16,32,0.06); background:#fff; outline:none; min-width:0; }
.manual-input button{ padding:10px 12px; border-radius:10px; border:none; background:var(--neon1); color:#fff; font-weight:700; cursor:pointer; }

/* Numeric pad (optional) */
.numeric-pad { position: fixed; left: 0; right: 0; bottom: var(--footer-h); background: linear-gradient(180deg,#fff,#f3f4f8); border-top: 1px solid rgba(11,16,32,0.06); box-shadow: 0 -8px 30px rgba(11,16,32,0.08); padding: 10px; display: none; z-index: 1450; }
.numeric-pad.visible { display: block; }
.numeric-pad .row { display:flex; gap:8px; margin-bottom:8px; }
.numeric-pad button.key { flex:1; padding:12px 8px; border-radius:8px; border:1px solid rgba(11,16,32,0.06); background:#fff; font-size:18px; font-weight:700; }
.numeric-pad .key.action { background: linear-gradient(90deg,#7b3be6,#c86cff); color:#fff; border:none; }
.numeric-pad .key.wide { flex:2; }

.small{ font-size:13px; color:var(--muted); }
@media (max-width:420px){ :root{ --header-h:120px; --footer_h:100px } .logo{ width:40px; height:40px } .input{ font-size:15px } }
</style>
</head>
<body>
<div class="app" id="app" role="application" aria-label="Инвентаризация">

  <!-- Header -->
  <header class="header" role="banner" aria-label="Шапка">
    <div class="header-inner">
      <div class="title-row">
        <div class="logo" aria-hidden="true">INV</div>
        <div class="title">Инвентаризация</div>
      </div>

      <div class="search-row" role="search" aria-label="Поиск и сканер">
        <div class="input-wrap">
          <input id="searchInput" class="input" type="text" placeholder="Поиск по названию или коду" aria-label="Поиск по товарам">
          <button id="clearSearch" class="clear-x" title="Очистить поле" aria-label="Очистить поле">✕</button>
        </div>
        <button id="openScannerBtn" class="scan-btn" aria-label="Открыть сканер">Сканер</button>
      </div>
    </div>
  </header>

  <!-- Content -->
  <main class="content" id="content" role="main" aria-label="Список товаров">
    <!-- Scanner card (hidden by default) -->
    <section id="scannerCard" class="card" style="display:none" aria-hidden="true">
      <div class="preview-wrap camera-1-3" id="previewWrap">
        <video id="preview" playsinline muted></video>
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <select id="deviceSelect" class="btn ghost" aria-label="Выбор камеры" style="min-width:80px"></select>
        <button id="closeScannerBtn" class="btn ghost" aria-label="Закрыть сканер">✕ Закрыть</button>
      </div>
      <div id="scanResult" class="small" style="margin-top:8px"></div>
    </section>

    <!-- Results list -->
    <section id="resultsWrap" class="card" aria-labelledby="resultsTitle">
      <h3 id="resultsTitle" style="margin:0 0 8px 0">Найденные товары</h3>
      <div id="results" class="results" aria-live="polite">
        <div id="emptyHint" class="small">Пока нет позиций. Сканируйте штрихкод или добавьте вручную.</div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="footer" role="contentinfo" aria-label="Добавление вручную">
    <div class="footer-inner">
      <div class="manual-input">
        <input id="manualCode" placeholder="Штрихкод (опционально)" aria-label="Штрихкод вручную">
        <input id="manualName" placeholder="Название товара" aria-label="Название вручную">
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="addManualBtn" class="btn ghost" aria-label="Добавить вручную">Добавить</button>
      </div>
    </div>
  </footer>

  <!-- Numeric pad -->
  <div id="numericPad" class="numeric-pad" aria-hidden="true">
    <div class="row">
      <button class="key" data-key="1">1</button>
      <button class="key" data-key="2">2</button>
      <button class="key" data-key="3">3</button>
    </div>
    <div class="row">
      <button class="key" data-key="4">4</button>
      <button class="key" data-key="5">5</button>
      <button class="key" data-key="6">6</button>
    </div>
    <div class="row">
      <button class="key" data-key="7">7</button>
      <button class="key" data-key="8">8</button>
      <button class="key" data-key="9">9</button>
    </div>
    <div class="row">
      <button class="key" data-key="+">+</button>
      <button class="key" data-key="0">0</button>
      <button class="key action" id="padBack">←</button>
    </div>
    <div class="row">
      <button class="key wide action" id="padDone">Готово</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
/* ===== Storage keys ===== */
const STORAGE_DB = 'barcodeDB';
const STORAGE_INV = 'inventoryItems';

/* ===== State ===== */
let barcodeDB = JSON.parse(localStorage.getItem(STORAGE_DB) || '{}');
let inventoryItems = JSON.parse(localStorage.getItem(STORAGE_INV) || '[]');
let renderedCards = new Map();
let padTargetCode = null;

/* ===== Elements ===== */
const searchInput = document.getElementById('searchInput');
const clearSearch = document.getElementById('clearSearch');
const openScannerBtn = document.getElementById('openScannerBtn');
const scannerCard = document.getElementById('scannerCard');
const previewWrap = document.getElementById('previewWrap');
const preview = document.getElementById('preview');
const deviceSelect = document.getElementById('deviceSelect');
const closeScannerBtn = document.getElementById('closeScannerBtn');
const scanResult = document.getElementById('scanResult');

const resultsEl = document.getElementById('results');
const emptyHint = document.getElementById('emptyHint');

const manualCode = document.getElementById('manualCode');
const manualName = document.getElementById('manualName');
const addManualBtn = document.getElementById('addManualBtn');

const numericPad = document.getElementById('numericPad');

/* ===== Utilities ===== */
function saveDB(){ localStorage.setItem(STORAGE_DB, JSON.stringify(barcodeDB)); }
function saveInventory(){ localStorage.setItem(STORAGE_INV, JSON.stringify(inventoryItems)); }
function showToast(text, ms=1200){ scanResult.textContent = text; setTimeout(()=>{ if(scanResult.textContent===text) scanResult.textContent=''; }, ms); }
function beepSound(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine';
    o.frequency.value = 880;
    g.gain.value = 0.02;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
  }catch(e){}
}
function normalize(s){ return (s||'').toString().toLowerCase().trim(); }

/* ===== Search & display helpers ===== */
function searchItems(q){
  q = normalize(q);
  if(!q) return [];
  const tokens = q.split(/\s+/).filter(Boolean);
  const out = [];
  for(const code of Object.keys(barcodeDB)){
    const name = normalize(barcodeDB[code]);
    const hay = (code + ' ' + name);
    if(tokens.every(t => hay.indexOf(t) !== -1)) out.push({code, name: barcodeDB[code]});
  }
  return out;
}

function getDisplayList(){
  const q = searchInput.value.trim();
  const list = [];
  for(const it of inventoryItems) list.push({code: it.code, name: it.name, expr: it.expr || String(it.qty || 0), qty: it.qty || 0});
  if(q){
    const found = searchItems(q);
    const inv = new Set(inventoryItems.map(i=>i.code));
    for(const f of found) if(!inv.has(f.code)) list.push({code: f.code, name: f.name, expr:'0', qty:0});
  }
  return list;
}

/* ===== Render results (incremental, preserve inputs & focus) ===== */
function renderResults(){
  const list = getDisplayList();
  if(list.length === 0){
    resultsEl.innerHTML = '';
    emptyHint.style.display = 'block';
    renderedCards.clear();
    return;
  }
  emptyHint.style.display = 'none';

  const keep = new Set(list.map(i=>i.code));
  for(const [code, el] of renderedCards){
    if(!keep.has(code)){ el.remove(); renderedCards.delete(code); }
  }

  const frag = document.createDocumentFragment();
  for(const item of list){
    if(renderedCards.has(item.code)){
      const el = renderedCards.get(item.code);
      const nameEl = el.querySelector('.item-name');
      const codeEl = el.querySelector('.item-code');
      const inputEl = el.querySelector('.qty-input');
      if(nameEl && nameEl.textContent !== item.name) nameEl.textContent = item.name;
      if(codeEl && codeEl.textContent !== item.code) codeEl.textContent = item.code;
      if(document.activeElement !== inputEl) inputEl.value = item.expr || String(item.qty || 0);
      frag.appendChild(el);
      continue;
    }

    const card = document.createElement('div');
    card.className = 'card-item';
    card.dataset.code = item.code;
    card.innerHTML = `
      <div class="item-top">
        <div class="item-left">
          <div class="avatar">${escapeHtml(item.name.slice(0,2).toUpperCase())}</div>
          <div class="item-meta">
            <div class="item-name">${escapeHtml(item.name)}</div>
            <div class="item-code">${escapeHtml(item.code)}</div>
          </div>
        </div>
      </div>

      <div class="qty-row">
        <input inputmode="numeric" pattern="[0-9+ ]*" class="qty-input" type="text" value="${escapeHtml(item.expr || String(item.qty || 0))}" aria-label="Выражение для ${escapeHtml(item.name)}">
        <button class="plus-btn" title="Плюс">+</button>
      </div>
    `;
    const qtyInput = card.querySelector('.qty-input');
    const plusBtn = card.querySelector('.plus-btn');

    qtyInput.addEventListener('focus', ()=>{
      padTargetCode = item.code;
      openNumericPad(item.code);
    });
    qtyInput.addEventListener('blur', ()=>{
      const expr = qtyInput.value;
      const total = evaluateExpression(expr);
      upsertInventoryExpr(item.code, item.name, expr, total, true);
      qtyInput.value = normalizeExpression(expr);
    });

    qtyInput.addEventListener('input', ()=>{
      const expr = qtyInput.value;
      const total = evaluateExpression(expr);
      upsertInventoryExpr(item.code, item.name, expr, total, true);
    });

    plusBtn.addEventListener('click', (ev)=>{
      ev.preventDefault();
      let expr = qtyInput.value || '';
      expr = expr.trim();
      if(/\+\s*$/.test(expr)){
        qtyInput.focus();
        return;
      }
      expr = expr === '' ? '0 + ' : expr + ' + ';
      const total = evaluateExpression(expr);
      upsertInventoryExpr(item.code, item.name, expr, total, true);
      qtyInput.value = normalizeExpression(expr);
      qtyInput.focus();
      setTimeout(()=>{ try{ qtyInput.setSelectionRange(qtyInput.value.length, qtyInput.value.length); }catch(e){} }, 0);
    });

    renderedCards.set(item.code, card);
    frag.appendChild(card);
  }

  resultsEl.appendChild(frag);
}

/* helpers */
function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function normalizeExpression(expr){ if(!expr) return ''; const trailingPlus = /\+\s*$/.test(expr); const parts = (expr.match(/\d+/g) || []); const joined = parts.join(' + '); return trailingPlus ? (joined ? joined + ' + ' : ' + ') : joined; }
function evaluateExpression(expr){ if(!expr) return 0; const nums = (expr.match(/\d+/g) || []).map(n=>parseInt(n,10) || 0); return nums.reduce((s,v)=>s+v, 0); }

/* Upsert inventory */
function upsertInventoryExpr(code, name, expr, total, dontRerender = false){
  const idx = inventoryItems.findIndex(it => it.code === code);
  if(idx >= 0){
    inventoryItems[idx].qty = total;
    inventoryItems[idx].expr = expr;
    inventoryItems[idx].name = name || inventoryItems[idx].name;
  } else {
    inventoryItems.unshift({ code, name, qty: total, expr });
  }
  saveInventory();
  const card = renderedCards.get(code);
  if(card){
    const inputEl = card.querySelector('.qty-input');
    if(document.activeElement !== inputEl){
      inputEl.value = expr;
    }
  }
  if(!dontRerender) renderResults();
}

/* Numeric pad integration */
function openNumericPad(code){
  padTargetCode = code;
  numericPad.classList.add('visible');
  numericPad.setAttribute('aria-hidden','false');
  setTimeout(()=>{
    const card = document.querySelector(`[data-code="${code}"]`);
    if(card){
      const input = card.querySelector('.qty-input');
      if(input) try{ input.focus(); }catch(e){}
    }
  }, 80);
}
function closeNumericPad(){
  padTargetCode = null;
  numericPad.classList.remove('visible');
  numericPad.setAttribute('aria-hidden','true');
  try{ document.activeElement && document.activeElement.blur(); }catch(e){}
}
function padInsert(ch){
  if(!padTargetCode) return;
  const card = document.querySelector(`[data-code="${padTargetCode}"]`);
  if(!card) return;
  const input = card.querySelector('.qty-input');
  if(!input) return;
  if(ch === '←'){
    input.value = input.value.slice(0, -1);
  } else {
    input.value = (input.value || '') + ch;
  }
  input.dispatchEvent(new Event('input', { bubbles: true }));
  try{ input.focus(); }catch(e){}
}
numericPad.addEventListener('click', (e)=>{
  const btn = e.target.closest('button.key');
  if(!btn) return;
  const key = btn.getAttribute('data-key');
  if(key){ padInsert(key); return; }
  if(btn.id === 'padBack'){ padInsert('←'); return; }
  if(btn.id === 'padDone'){ closeNumericPad(); return; }
});
document.addEventListener('click', (e)=>{
  if(!numericPad.classList.contains('visible')) return;
  if(numericPad.contains(e.target)) return;
  if(e.target.closest('.qty-input')) return;
  closeNumericPad();
});

/* Search wiring (no autofocus on load) */
searchInput.addEventListener('input', ()=>{ renderResults(); });
clearSearch.addEventListener('click', ()=>{ searchInput.value = ''; renderResults(); });

/* Manual add */
addManualBtn.addEventListener('click', ()=>{
  const code = (manualCode.value || '').trim();
  const name = (manualName.value || '').trim() || (code || 'Новый товар');
  const finalCode = code || ('manual-' + Date.now());
  barcodeDB[finalCode] = name;
  saveDB();
  upsertInventoryExpr(finalCode, name, '0', 0, true);
  renderResults();
  focusCardInput(finalCode);
  manualCode.value = '';
  manualName.value = '';
  showToast('Добавлено вручную');
});

/* Focus card input and try to nudge native keyboard (best-effort) */
function focusCardInput(code){
  setTimeout(()=>{
    const card = renderedCards.get(code) || document.querySelector(`[data-code="${code}"]`);
    if(!card) return;
    const input = card.querySelector('.qty-input');
    if(!input) return;
    try{
      input.type = 'tel';
      input.setAttribute('inputmode','numeric');
      input.focus();
      const len = input.value.length;
      try{ input.setSelectionRange(len, len); }catch(e){}
      setTimeout(()=>{
        try{ input.type = 'text'; }catch(e){}
        try{ input.setSelectionRange(len, len); }catch(e){}
      }, 120);
    }catch(e){
      try{ input.focus(); }catch(e){}
    }
    openNumericPad(code);
    padTargetCode = code;
  }, 160);
}

/* ===== Scanner using ZXing.BrowserMultiFormatReader.decodeFromVideoDevice ===== */
let codeReader = null;
let scanning = false;
let lastDetected = {code:null, ts:0};
const DEBOUNCE_MS = 900;

async function enumerateCameras(){
  try{
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === 'videoinput');
    deviceSelect.innerHTML = '';
    cams.forEach((c, idx)=>{
      const opt = document.createElement('option');
      opt.value = c.deviceId;
      opt.text = c.label || `Камера ${idx+1}`;
      deviceSelect.appendChild(opt);
    });
  }catch(e){}
}

async function startScanner(){
  if(scanning) return;
  if(!window.ZXing || !ZXing.BrowserMultiFormatReader){
    // ZXing script is included via <script> tag; ensure it's ready
    if(!window.ZXing) {
      showToast('Загрузка сканера...');
      // script tag already present; wait briefly
      await new Promise(r=>setTimeout(r, 300));
    }
  }
  try{
    codeReader = codeReader || new ZXing.BrowserMultiFormatReader();
  }catch(e){
    showToast('Сканер недоступен');
    return;
  }
  await enumerateCameras();
  const deviceId = deviceSelect.value || undefined;
  try{
    scanning = true;
    codeReader.decodeFromVideoDevice(deviceId, preview, (result, err) => {
      if(result && result.text){
        const now = Date.now();
        if(result.text === lastDetected.code && (now - lastDetected.ts) < DEBOUNCE_MS) return;
        lastDetected = {code: result.text, ts: now};
        beepSound();
        handleDetected(result.text);
      }
      // ignore frequent NotFoundException errors
    });
    previewWrap.classList.add('visible');
    scannerCard.style.display = 'block';
    showToast('Сканер запущен');
  }catch(e){
    scanning = false;
    showToast('Ошибка доступа к камере');
  }
}

function stopScanner(){
  try{ if(codeReader) codeReader.reset(); }catch(e){}
  scanning = false;
  previewWrap.classList.remove('visible');
  scannerCard.style.display = 'none';
  showToast('Сканер остановлен');
}

/* handle detection */
function handleDetected(code){
  searchInput.value = code;
  const found = barcodeDB[code];
  if(found){
    showToast('Найден товар в базе');
    const idx = inventoryItems.findIndex(it=>it.code===code);
    if(idx === -1) upsertInventoryExpr(code, found, '0', 0, true);
    renderResults();
    focusCardInput(code);
  } else {
    const create = confirm(`Код ${code} не найден. Создать товар с этим кодом и добавить 1 шт.?`);
    if(create){
      const name = prompt('Введите название товара', '') || '';
      if(name.trim()){
        barcodeDB[code] = name.trim();
        saveDB();
        upsertInventoryExpr(code, barcodeDB[code], '1', 1, true);
        renderResults();
        focusCardInput(code);
        showToast('Товар добавлен');
      } else showToast('Название не введено');
    } else showToast('Код не найден');
  }
}

/* UI wiring for scanner */
openScannerBtn.addEventListener('click', async ()=>{
  await startScanner();
});
closeScannerBtn.addEventListener('click', ()=>{ stopScanner(); });

deviceSelect.addEventListener('change', async ()=>{
  if(scanning){ try{ codeReader.reset(); }catch(e){} scanning=false; }
  await startScanner();
});

/* enumerate cameras on load (non-blocking) */
if(navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) navigator.mediaDevices.enumerateDevices().then(enumerateCameras).catch(()=>{});

/* Prevent pull-to-refresh on some browsers (extra JS) */
(function preventPullToRefresh(){
  let startY = 0;
  let id = null;
  document.addEventListener('touchstart', (e)=>{ if(e.touches && e.touches.length===1){ startY = e.touches[0].clientY; id = e.touches[0].identifier; } }, {passive:true});
  document.addEventListener('touchmove', (e)=>{
    try{
      const t = Array.from(e.touches).find(tt=>tt.identifier===id) || e.touches[0];
      const currentY = t.clientY;
      const sc = document.querySelector('.content');
      if(sc){
        const atTop = sc.scrollTop <= 0;
        if(atTop && currentY > startY) e.preventDefault();
      } else {
        if(window.scrollY <= 0 && currentY > startY) e.preventDefault();
      }
    }catch(err){}
  }, {passive:false});
})();

/* Initial render (no autofocus) */
renderResults();

/* Expose for debugging (optional) */
window._inv = { renderResults, upsertInventoryExpr, inventoryItems, barcodeDB };
</script>
</body>
</html>








