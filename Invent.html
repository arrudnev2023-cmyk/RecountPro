<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Инвентаризация — Mobile</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#fbfbfd;
  --panel:#ffffff;
  --muted:#6b7280;
  --neon1:#7b3be6;
  --neon2:#c86cff;
  --accent:linear-gradient(90deg,var(--neon1),var(--neon2));
  --radius:12px;
  --card-border: rgba(124,58,237,0.10);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#f6f7fb,#f0f2f8);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#0b1020}
.container{max-width:420px;margin:12px auto;padding:12px;display:flex;flex-direction:column;gap:12px}
.header{display:flex;flex-direction:column;gap:10px}
.header-top{display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;gap:10px;align-items:center}
.logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(90deg,var(--neon1),var(--neon2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
.title{font-size:18px;font-weight:700}
.subtitle{font-size:13px;color:var(--muted)}
.search-row{display:flex;gap:8px;align-items:center}
.input-wrap{position:relative;flex:1}
.input{width:100%;padding:10px 40px 10px 12px;border-radius:10px;border:1px solid rgba(11,16,32,0.06);background:#fff;outline:none;font-size:15px}
.clear-x{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:transparent;border:none;color:var(--muted);font-weight:700;padding:6px;border-radius:6px;cursor:pointer}
.scan-btn{padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700;background:var(--accent);color:#fff;min-width:84px}
.card{background:var(--panel);border-radius:12px;padding:12px;border:1px solid var(--card-border);box-shadow:0 8px 24px rgba(16,24,40,0.04)}
.preview-wrap{border-radius:10px;overflow:hidden;background:#000;border:1px solid rgba(11,16,32,0.06);display:none}
.preview-wrap.visible{display:block}
.preview-wrap.camera-1-3{height:33vh;min-height:140px;max-height:300px}
video#preview{width:100%;height:100%;object-fit:cover;display:block}
.controls{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
.btn{padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700;background:#111827;color:#fff}
.btn.ghost{background:transparent;border:1px solid rgba(11,16,32,0.06);color:var(--muted)}
.btn.neon{background:var(--accent);color:#fff;box-shadow:0 10px 30px rgba(124,58,237,0.12)}
.results{display:flex;flex-direction:column;gap:10px;margin-top:10px}
.card-item{display:flex;flex-direction:column;padding:10px;border-radius:10px;border:1px solid rgba(11,16,32,0.04);background:linear-gradient(180deg,#fff,#fbfbff)}
.item-top{display:flex;align-items:center;gap:12px}
.item-left{display:flex;gap:12px;align-items:center;min-width:0}
.item-meta{display:flex;flex-direction:column;min-width:0;flex:1}
.item-code{font-weight:700;color:#0b1020;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.item-name{color:var(--muted);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.qty-row{margin-top:10px;display:flex;gap:8px;align-items:center}
.qty-input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(11,16,32,0.06);font-weight:700;font-size:15px}
.plus-btn{padding:10px 12px;border-radius:8px;background:linear-gradient(90deg,var(--neon1),var(--neon2));color:#fff;border:none;cursor:pointer}
.footer{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
.clear-btn{background:transparent;border:1px dashed rgba(11,16,32,0.08);padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
.small{font-size:13px;color:var(--muted)}
.overlay{position:fixed;inset:0;background:rgba(11,16,32,0.35);z-index:9998;display:none}
.summary-modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;border-radius:12px;padding:14px;box-shadow:0 20px 60px rgba(11,16,32,0.2);max-width:92%;max-height:80%;overflow:auto;z-index:9999;display:none}
@media (max-width:420px){ .container{padding:10px} .qty-input{font-size:14px} }
</style>
</head>
<body>
<div class="container" role="main" aria-label="Инвентаризация">
  <header class="header">
    <div class="header-top">
      <div class="brand">
        <div class="logo">INV</div>
        <div>
          <div class="title">Инвентаризация</div>
          <div class="subtitle">Сканируй, считай, сохраняй</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="summaryBtn" class="btn ghost" title="Итог">Итог</button>
        <button id="clearRecountBtn" class="clear-btn" title="Очистить пересчёт">Очистить пересчёт</button>
      </div>
    </div>

    <!-- Поиск и кнопка сканера -->
    <div class="search-row">
      <div class="input-wrap">
        <input id="searchInput" class="input" type="text" placeholder="Поиск по названию или коду (часть слова)" aria-label="Поиск">
        <button id="clearSearch" class="clear-x" title="Очистить" aria-label="Очистить поле">✕</button>
      </div>
      <button id="openScannerBtn" class="scan-btn" aria-label="Открыть сканер">Сканер</button>
    </div>
  </header>

  <!-- Скрытое окно сканера: показывается по кнопке; при показе запускается сразу -->
  <section id="scannerCard" class="card" style="display:none">
    <div class="preview-wrap camera-1-3" id="previewWrap">
      <video id="preview" playsinline muted></video>
    </div>

    <div class="controls" style="margin-top:8px">
      <select id="deviceSelect" class="btn ghost" aria-label="Камера" style="min-width:80px"></select>
      <button id="closeScannerBtn" class="btn ghost">✕ Закрыть</button>
    </div>

    <div id="scanResult" class="small" style="margin-top:8px"></div>
  </section>

  <!-- Результаты (изначально пусто) -->
  <section class="card" aria-labelledby="resultsTitle">
    <h3 id="resultsTitle" style="margin:0 0 8px 0">Найденные товары</h3>
    <div id="results" class="results" aria-live="polite">
      <div id="emptyHint" class="small">Пока нет позиций. Сканируйте штрихкод или добавьте вручную.</div>
    </div>

    <div class="footer">
      <div class="small">Если код не в базе — сканер предложит создать товар.</div>
      <div style="display:flex;gap:8px">
        <button id="addManualBtn" class="btn ghost">Добавить вручную</button>
      </div>
    </div>
  </section>
</div>

<div id="overlay" class="overlay"></div>
<div id="summaryModal" class="summary-modal" role="dialog" aria-modal="true">
  <h3 style="margin-top:0">Итог инвентаризации</h3>
  <div id="summaryList" style="display:flex;flex-direction:column;gap:8px;margin-top:8px"></div>
  <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
    <button id="closeSummary" class="btn ghost">Закрыть</button>
  </div>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
/* ===== Storage keys ===== */
const STORAGE_DB = 'barcodeDB';
const STORAGE_INV = 'inventoryItems';

/* ===== State ===== */
let barcodeDB = JSON.parse(localStorage.getItem(STORAGE_DB) || '{}');
let inventoryItems = JSON.parse(localStorage.getItem(STORAGE_INV) || '[]');
let stream = null;
let currentDeviceId = null;
let scanning = false;
let detector = ('BarcodeDetector' in window) ? new BarcodeDetector({formats:["ean_13","ean_8","code_128","code_39","upc_a","upc_e","itf"]}) : null;
let reader = null;
let lastDetected = {code:null, ts:0};
const DEBOUNCE_MS = 900;

/* ===== Elements ===== */
const searchInput = document.getElementById('searchInput');
const clearSearch = document.getElementById('clearSearch');
const openScannerBtn = document.getElementById('openScannerBtn');
const scannerCard = document.getElementById('scannerCard');
const previewWrap = document.getElementById('previewWrap');
const preview = document.getElementById('preview');
const deviceSelect = document.getElementById('deviceSelect');
const closeScannerBtn = document.getElementById('closeScannerBtn');
const scanResult = document.getElementById('scanResult');

const resultsEl = document.getElementById('results');
const emptyHint = document.getElementById('emptyHint');
const addManualBtn = document.getElementById('addManualBtn');
const summaryBtn = document.getElementById('summaryBtn');
const clearRecountBtn = document.getElementById('clearRecountBtn');

const overlay = document.getElementById('overlay');
const summaryModal = document.getElementById('summaryModal');
const summaryList = document.getElementById('summaryList');
const closeSummary = document.getElementById('closeSummary');

/* ===== Utilities ===== */
function saveDB(){ localStorage.setItem(STORAGE_DB, JSON.stringify(barcodeDB)); }
function saveInventory(){ localStorage.setItem(STORAGE_INV, JSON.stringify(inventoryItems)); }
function showToast(text, ms=1400){ scanResult.textContent = text; setTimeout(()=>{ if(scanResult.textContent===text) scanResult.textContent=''; }, ms); }
function beepSound(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine';
    o.frequency.value = 880;
    g.gain.value = 0.02;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
  }catch(e){}
}
function normalize(s){ return (s||'').toString().toLowerCase().trim(); }

/* ===== Search (partial, any order) ===== */
function searchItems(query){
  const q = normalize(query);
  if(!q) return []; // empty by default
  const tokens = q.split(/\s+/).filter(Boolean);
  const results = [];
  for(const code of Object.keys(barcodeDB)){
    const name = normalize(barcodeDB[code]);
    const hay = (code + ' ' + name);
    const ok = tokens.every(t => hay.indexOf(t) !== -1);
    if(ok) results.push({ code, name: barcodeDB[code] });
  }
  results.sort((a,b)=> a.name.length - b.name.length);
  return results;
}

/* ===== Render results (cards) ===== */
function renderResults(list){
  resultsEl.innerHTML = '';
  if(!list || !list.length){
    emptyHint.style.display = 'block';
    return;
  }
  emptyHint.style.display = 'none';
  list.forEach(item=>{
    const existingInv = inventoryItems.find(it => it.code === item.code);
    const qtyVal = existingInv ? existingInv.qty : 0;
    const exprVal = existingInv ? (existingInv.expr || String(qtyVal)) : String(qtyVal);

    const card = document.createElement('div');
    card.className = 'card-item';
    card.innerHTML = `
      <div class="item-top">
        <div class="item-left">
          <div style="width:56px;height:56px;border-radius:8px;background:linear-gradient(90deg,var(--neon1),var(--neon2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">${item.code.slice(-4)}</div>
          <div class="item-meta">
            <div class="item-code">${item.code}</div>
            <div class="item-name">${item.name}</div>
          </div>
        </div>
      </div>

      <div class="qty-row">
        <input inputmode="numeric" pattern="[0-9+ ]*" class="qty-input" type="text" value="${escapeHtml(exprVal)}" aria-label="Выражение для ${item.name}">
        <button class="plus-btn" title="Добавить">+</button>
      </div>
    `;
    const qtyInput = card.querySelector('.qty-input');
    const plusBtn = card.querySelector('.plus-btn');

    // When user types expression manually, compute total and persist
    qtyInput.addEventListener('input', ()=>{
      // keep expression as-is, but compute total and save
      const expr = qtyInput.value.trim();
      const total = evaluateExpression(expr);
      upsertInventoryExpr(item.code, item.name, expr, total);
    });

    qtyInput.addEventListener('blur', ()=>{
      const expr = qtyInput.value.trim();
      const total = evaluateExpression(expr);
      upsertInventoryExpr(item.code, item.name, expr, total);
      // normalize expression to show spaced pluses
      qtyInput.value = normalizeExpression(expr);
    });

    // Plus button: append "+ <current number in input or 1>" to expression and sum
    plusBtn.addEventListener('click', ()=>{
      // determine number to add: if input contains a trailing number, use it; else use 1
      const currentExpr = qtyInput.value.trim();
      const lastNumber = extractLastNumber(currentExpr);
      const add = Math.max(1, lastNumber || 1);
      // append to expression
      const newExpr = (currentExpr ? currentExpr + ' + ' + add : String(add));
      const total = evaluateExpression(newExpr);
      upsertInventoryExpr(item.code, item.name, newExpr, total);
      qtyInput.value = normalizeExpression(newExpr);
      showToast('Добавлено');
    });

    resultsEl.appendChild(card);
  });
}

/* Escape HTML for safe insertion into value attribute */
function escapeHtml(s){
  return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* Normalize expression: remove extra spaces, ensure "a + b + c" format */
function normalizeExpression(expr){
  if(!expr) return '';
  // keep only digits and plus signs and spaces
  const cleaned = expr.replace(/[^\d+]/g, ' ');
  const parts = cleaned.split('+').map(p=>p.trim()).filter(Boolean);
  return parts.join(' + ');
}

/* Extract last number from expression (if any) */
function extractLastNumber(expr){
  if(!expr) return null;
  const m = expr.match(/(\d+)\s*$/);
  return m ? parseInt(m[1],10) : null;
}

/* Evaluate expression like "5 + 3 + 7" -> 15. Non-numeric tokens ignored. */
function evaluateExpression(expr){
  if(!expr) return 0;
  // extract numbers
  const nums = (expr.match(/\d+/g) || []).map(n=>parseInt(n,10) || 0);
  return nums.reduce((s,v)=>s+v, 0);
}

/* Upsert inventory with expression and computed total */
function upsertInventoryExpr(code, name, expr, total){
  const idx = inventoryItems.findIndex(it => it.code === code);
  if(idx >= 0){
    inventoryItems[idx].qty = total;
    inventoryItems[idx].expr = expr;
    inventoryItems[idx].name = name || inventoryItems[idx].name;
  } else {
    inventoryItems.unshift({ code, name, qty: total, expr });
  }
  saveInventory();
}

/* ===== Scanner logic (hidden by default) ===== */
async function enumerateCameras(){
  try{
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === 'videoinput');
    deviceSelect.innerHTML = '';
    cams.forEach((c, idx)=>{
      const opt = document.createElement('option');
      opt.value = c.deviceId;
      opt.text = c.label || `Камера ${idx+1}`;
      deviceSelect.appendChild(opt);
    });
    if(cams.length && !currentDeviceId) currentDeviceId = cams[0].deviceId;
    if(currentDeviceId) deviceSelect.value = currentDeviceId;
  }catch(e){}
}

async function startCamera(){
  if(scanning) return;
  stopCamera();
  scanning = true;
  await enumerateCameras();
  const constraints = {
    audio:false,
    video:{
      deviceId: deviceSelect.value || currentDeviceId || undefined,
      facingMode: { ideal: "environment" },
      width: { ideal: 1280 },
      height: { ideal: 720 }
    }
  };
  try{
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    preview.srcObject = stream;
    await preview.play();
    currentDeviceId = stream.getVideoTracks()[0].getSettings().deviceId || currentDeviceId;
    deviceSelect.value = currentDeviceId || deviceSelect.value;
    if(!reader) reader = new ZXing.BrowserMultiFormatReader();
    requestAnimationFrame(scanLoop);
    showToast('Сканер запущен');
  }catch(err){
    console.error(err);
    showToast('Ошибка доступа к камере');
    scanning = false;
  }
}

function stopCamera(){
  scanning = false;
  if(preview.srcObject){
    preview.srcObject.getTracks().forEach(t=>t.stop());
    preview.srcObject = null;
  }
  if(reader){
    try{ reader.reset(); }catch(e){}
  }
  showToast('Сканер остановлен');
}

function createCanvas(w,h){ const c=document.createElement('canvas'); c.width=w; c.height=h; return c; }

async function tryDecodeCanvas(canvas){
  if(detector){
    try{
      const imageData = canvas.getContext('2d').getImageData(0,0,canvas.width,canvas.height);
      const res = await detector.detect(imageData);
      if(res && res.length) return res[0].rawValue;
    }catch(e){}
  }
  try{
    const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(canvas);
    const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
    const result = new ZXing.MultiFormatReader().decode(binaryBitmap);
    if(result && result.text) return result.text;
  }catch(e){}
  const w = canvas.width, h = canvas.height;
  const temp = createCanvas(w,h);
  const tctx = temp.getContext('2d');
  for(const angle of [90,180,270]){
    tctx.clearRect(0,0,w,h);
    tctx.save();
    tctx.translate(w/2,h/2);
    tctx.rotate(angle*Math.PI/180);
    tctx.drawImage(canvas, -w/2, -h/2);
    tctx.restore();
    try{
      const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(temp);
      const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
      const result = new ZXing.MultiFormatReader().decode(binaryBitmap);
      if(result && result.text) return result.text;
    }catch(e){}
  }
  return null;
}

let canvasPool = [];
function getCanvas(w,h){
  for(const c of canvasPool) if(c.width===w && c.height===h) return c;
  const c = createCanvas(w,h); canvasPool.push(c); return c;
}

let scanLoopRunning = false;
async function scanLoop(){
  if(!scanning) { scanLoopRunning = false; return; }
  if(scanLoopRunning) return;
  scanLoopRunning = true;
  try{
    while(scanning){
      const w = preview.videoWidth;
      const h = preview.videoHeight;
      if(w===0 || h===0){ await new Promise(r=>requestAnimationFrame(r)); continue; }
      const canvas = getCanvas(w,h);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(preview, 0, 0, w, h);
      const scale = Math.max(1, Math.floor(Math.max(w,h)/900));
      const sw = Math.floor(w/scale);
      const sh = Math.floor(h/scale);
      const small = getCanvas(sw,sh);
      const sctx = small.getContext('2d');
      sctx.drawImage(canvas, 0, 0, w, h, 0, 0, sw, sh);
      try{
        const code = await tryDecodeCanvas(small);
        if(code) {
          // sound
          beepSound();
          // hide scanner UI immediately
          hideScannerUI();
          // handle detection
          handleDetected(code);
          await new Promise(r=>setTimeout(r, 300));
        }
      }catch(e){}
      await new Promise(r=>requestAnimationFrame(r));
    }
  }finally{ scanLoopRunning = false; }
}

/* When code detected: populate search, create if missing, keep item on screen */
function handleDetected(code){
  const now = Date.now();
  if(code === lastDetected.code && (now - lastDetected.ts) < DEBOUNCE_MS) return;
  lastDetected = {code, ts: now};
  searchInput.value = code;
  const found = barcodeDB[code];
  if(found){
    showToast('Найден товар в базе');
    // ensure item is present in results and not removed after counting
    performSearch();
    // keep item visible (do not remove)
  } else {
    const create = confirm(`Код ${code} не найден. Создать товар с этим кодом и добавить 1 шт.?`);
    if(create){
      const name = prompt('Введите название товара для нового кода', '') || '';
      if(name.trim()){
        barcodeDB[code] = name.trim();
        saveDB();
        upsertInventoryExpr(code, barcodeDB[code], '1', 1); // add 1
        performSearch();
        showToast('Товар добавлен и учтён');
      } else {
        showToast('Название не введено');
      }
    } else {
      showToast('Код не найден');
    }
  }
}

/* ===== Search and UI wiring ===== */
function performSearch(){
  const q = searchInput.value.trim();
  const results = searchItems(q);
  renderResults(results);
}
searchInput.addEventListener('input', performSearch);
clearSearch.addEventListener('click', ()=>{
  searchInput.value = '';
  performSearch();
  searchInput.focus();
});

/* Manual add */
addManualBtn.addEventListener('click', ()=>{
  const code = prompt('Введите штрихкод', '')?.trim();
  if(!code) return;
  const name = prompt('Название товара', '')?.trim() || code;
  barcodeDB[code] = name;
  saveDB();
  upsertInventoryExpr(code, name, '0', 0);
  performSearch();
  showToast('Добавлено вручную');
});

/* Summary modal */
function openSummary(){
  overlay.style.display = 'block';
  summaryModal.style.display = 'block';
  summaryList.innerHTML = '';
  if(!inventoryItems.length){
    summaryList.innerHTML = '<div class="small">Нет добавленных позиций</div>';
    return;
  }
  const agg = {};
  for(const it of inventoryItems){
    if(!agg[it.code]) agg[it.code] = { name: it.name, qty: 0 };
    agg[it.code].qty += Number(it.qty || 0);
  }
  for(const code of Object.keys(agg)){
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.justifyContent = 'space-between';
    row.style.padding = '8px 0';
    row.innerHTML = `<div><strong>${agg[code].name || '—'}</strong><div class="small">${code}</div></div><div style="font-weight:700">${agg[code].qty}</div>`;
    summaryList.appendChild(row);
  }
}
function closeSummaryModal(){ overlay.style.display = 'none'; summaryModal.style.display = 'none'; }

/* Clear recount */
function clearRecount(){
  if(!confirm('Очистить все текущие пересчёты на этом экране? Это не удалит базу штрих-кодов.')) return;
  inventoryItems = [];
  saveInventory();
  performSearch();
  showToast('Пересчёт очищен');
}

/* Show/hide scanner UI and auto-start when shown */
function showScannerUI(){
  scannerCard.style.display = 'block';
  previewWrap.classList.add('visible');
  // start camera immediately
  startCamera();
}
function hideScannerUI(){
  stopCamera();
  scannerCard.style.display = 'none';
  previewWrap.classList.remove('visible');
}

/* Events wiring */
openScannerBtn.addEventListener('click', ()=>{ showScannerUI(); });
closeScannerBtn.addEventListener('click', ()=>{ hideScannerUI(); });
deviceSelect.addEventListener('change', async ()=>{ currentDeviceId = deviceSelect.value; await startCamera(); });
summaryBtn.addEventListener('click', openSummary);
closeSummary.addEventListener('click', closeSummaryModal);
overlay.addEventListener('click', closeSummaryModal);
clearRecountBtn.addEventListener('click', clearRecount);

/* Init: screen empty by default */
performSearch();
enumerateCameras();
navigator.mediaDevices.getUserMedia({video:true}).then(s=>{ s.getTracks().forEach(t=>t.stop()); enumerateCameras(); }).catch(()=>{});
</script>
</body>
</html>


