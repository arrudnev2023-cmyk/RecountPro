<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä ‚Äî –°–∫–∞–Ω–µ—Ä (–º–æ–±–∏–ª—å–Ω—ã–π)</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#07040a;
    --card:#0f0b16;
    --muted:#9aa0b4;
    --accent1:#8a2be2;
    --accent2:#c86cff;
    --radius:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#05030a,#0b0710);color:#eef0ff}
  .app{max-width:480px;margin:0 auto;padding:14px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  .title{font-weight:700;font-size:18px}
  .small{font-size:13px;color:var(--muted)}
  .btn{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#07040a;padding:10px 12px;border-radius:10px;border:none;font-weight:700}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  .controls{display:flex;gap:8px;align-items:center;margin-bottom:10px}
  .preview-wrap{position:relative;border-radius:12px;overflow:hidden;background:#000;min-height:320px}
  video#preview{width:100%;height:100%;object-fit:cover;display:block}
  .overlay-ui{position:absolute;left:0;right:0;bottom:0;padding:12px;display:flex;flex-direction:column;gap:8px;background:linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.45));}
  .result-card{background:rgba(255,255,255,0.03);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);display:flex;flex-direction:column;gap:8px}
  label{font-size:13px;color:var(--muted)}
  input[type="number"], input[type="text"]{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  .row{display:flex;gap:8px;align-items:center}
  .row .btn{flex:1}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent2);padding:10px;border-radius:10px;font-weight:700}
  .list{margin-top:12px;max-height:220px;overflow:auto}
  .item{padding:10px;border-bottom:1px dashed rgba(255,255,255,0.03);display:flex;justify-content:space-between;align-items:center}
  .item .meta{display:flex;flex-direction:column}
  .save-note{font-size:12px;color:var(--muted);margin-top:8px}
  /* full-screen modal for scanner on mobile */
  .scanner-modal{position:fixed;inset:0;background:#000;z-index:9999;display:flex;flex-direction:column}
  .scanner-top{display:flex;align-items:center;justify-content:space-between;padding:12px}
  .close-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent2);padding:8px;border-radius:8px}
  @media (min-width:481px){
    .app{margin-top:18px}
    .preview-wrap{min-height:420px}
  }
</style>
</head>
<body>

<div class="app">
  <header>
    <div>
      <div class="title">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</div>
      <div class="small">–û—Ç–∫—Ä–æ–π —Å–∫–∞–Ω–µ—Ä –∏ –¥–æ–±–∞–≤—å —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É</div>
    </div>
    <button id="openScannerBtn" class="btn">–û—Ç–∫—Ä—ã—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
  </header>

  <section class="card">
    <h3 style="margin:0 0 8px 0">–ö–æ—Ä–∑–∏–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤</h3>
    <div id="addedList" class="list"></div>
    <div class="save-note">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (addedItems).</div>
  </section>
</div>

<!-- Scanner modal (hidden until opened) -->
<div id="scannerModal" class="scanner-modal" style="display:none">
  <div class="scanner-top">
    <button id="closeScannerBtn" class="close-btn">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
    <div class="small">–°–∫–∞–Ω–µ—Ä ‚Äî –ø–æ–¥–Ω–µ—Å–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥ –ø–æ–¥ –ª—é–±—ã–º —É–≥–ª–æ–º</div>
    <button id="torchBtn" class="close-btn">üî¶</button>
  </div>

  <div style="flex:1;display:flex;flex-direction:column">
    <div class="preview-wrap" style="flex:1">
      <video id="preview" playsinline muted></video>
      <div class="overlay-ui" aria-live="polite">
        <div id="scanStatus" class="small">–û–∂–∏–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è‚Ä¶</div>
        <div id="detectedArea"></div>
      </div>
    </div>

    <div style="padding:12px;background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.06))">
      <div class="row">
        <button id="manualAddBtn" class="ghost">–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</button>
        <button id="closeAndSaveBtn" class="btn">–ì–æ—Ç–æ–≤–æ</button>
      </div>
    </div>
  </div>
</div>

<!-- ZXing fallback -->
<script src="https://unpkg.com/@zxing/library@latest"></script>

<script>
/* ===== State ===== */
let barcodeDB = JSON.parse(localStorage.getItem('barcodeDB') || '{}'); // –≤–∞—à–∞ –±–∞–∑–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤
let addedItems = JSON.parse(localStorage.getItem('addedItems') || '[]'); // –∫–æ—Ä–∑–∏–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
let stream = null;
let scanning = false;
let detector = ('BarcodeDetector' in window) ? new BarcodeDetector({formats: ["ean_13","ean_8","code_128","code_39","upc_a","upc_e","itf"]}) : null;
let reader = null;
let lastDetected = {code:null, ts:0};
const DEBOUNCE_MS = 900;

/* ===== Elements ===== */
const openScannerBtn = document.getElementById('openScannerBtn');
const scannerModal = document.getElementById('scannerModal');
const closeScannerBtn = document.getElementById('closeScannerBtn');
const preview = document.getElementById('preview');
const scanStatus = document.getElementById('scanStatus');
const detectedArea = document.getElementById('detectedArea');
const torchBtn = document.getElementById('torchBtn');
const manualAddBtn = document.getElementById('manualAddBtn');
const closeAndSaveBtn = document.getElementById('closeAndSaveBtn');
const addedList = document.getElementById('addedList');

/* ===== Utilities ===== */
function saveAdded(){ localStorage.setItem('addedItems', JSON.stringify(addedItems)); renderAddedList(); }
function renderAddedList(){
  addedList.innerHTML = '';
  if(!addedItems.length){ addedList.innerHTML = '<div class="small" style="padding:12px;color:var(--muted)">–ü—É—Å—Ç–æ</div>'; return; }
  addedItems.forEach((it, idx)=>{
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `<div class="meta"><strong>${it.name || '‚Äî'}</strong><span class="small">–ö–æ–¥: ${it.code}</span></div>
                     <div style="display:flex;gap:8px;align-items:center">
                       <div class="small">x${it.qty}</div>
                       <button class="ghost" data-idx="${idx}">–£–¥–∞–ª–∏—Ç—å</button>
                     </div>`;
    addedList.appendChild(div);
  });
  // attach delete handlers
  addedList.querySelectorAll('button.ghost').forEach(b=>{
    b.addEventListener('click', e=>{
      const idx = +b.getAttribute('data-idx');
      addedItems.splice(idx,1);
      saveAdded();
    });
  });
}
function beep(){
  try{ navigator.vibrate?.(60); }catch(e){}
}

/* ===== Camera & scanning ===== */
async function openScanner(){
  scannerModal.style.display = 'flex';
  await startCamera();
}
async function closeScanner(){
  scannerModal.style.display = 'none';
  stopCamera();
  scanStatus.innerText = '–û–∂–∏–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è‚Ä¶';
  detectedArea.innerHTML = '';
}

async function startCamera(){
  stopCamera();
  scanning = true;
  const constraints = {
    audio:false,
    video:{
      facingMode: { ideal: "environment" },
      width: { ideal: 1280 },
      height: { ideal: 720 }
    }
  };
  try{
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    preview.srcObject = stream;
    await preview.play();
    reader = new ZXing.BrowserMultiFormatReader();
    requestAnimationFrame(scanLoop);
  }catch(err){
    console.error('camera error', err);
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.');
    scanning = false;
    closeScanner();
  }
}

function stopCamera(){
  scanning = false;
  if(preview.srcObject){
    preview.srcObject.getTracks().forEach(t=>t.stop());
    preview.srcObject = null;
  }
  if(reader){
    try{ reader.reset(); }catch(e){}
    reader = null;
  }
}

/* Torch toggle */
let torchOn = false;
async function toggleTorch(){
  if(!stream) return;
  const track = stream.getVideoTracks()[0];
  try{
    await track.applyConstraints({ advanced: [{ torch: !torchOn }] });
    torchOn = !torchOn;
    torchBtn.textContent = torchOn ? 'üî¶ ON' : 'üî¶';
  }catch(e){
    alert('Torch –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ/–±—Ä–∞—É–∑–µ—Ä–µ.');
  }
}

/* Preprocessing helpers */
function createCanvas(w,h){ const c=document.createElement('canvas'); c.width=w; c.height=h; return c; }
function toGrayscale(ctx,w,h){ const img=ctx.getImageData(0,0,w,h); const d=img.data; for(let i=0;i<d.length;i+=4){ const v=(d[i]*0.299 + d[i+1]*0.587 + d[i+2]*0.114)|0; d[i]=d[i+1]=d[i+2]=v; } ctx.putImageData(img,0,0); }
function increaseContrast(ctx,w,h,contrast=30){ const img=ctx.getImageData(0,0,w,h); const d=img.data; const factor=(259*(contrast+255))/(255*(259-contrast)); for(let i=0;i<d.length;i+=4){ for(let c=0;c<3;c++){ let col=d[i+c]; col=factor*(col-128)+128; d[i+c]=Math.max(0,Math.min(255,col)); } } ctx.putImageData(img,0,0); }

/* Try decode with detector or ZXing, including rotated attempts */
async function tryDecodeCanvas(canvas){
  // BarcodeDetector
  if(detector){
    try{
      const imageData = canvas.getContext('2d').getImageData(0,0,canvas.width,canvas.height);
      const res = await detector.detect(imageData);
      if(res && res.length) return res[0].rawValue;
    }catch(e){}
  }
  // ZXing direct
  try{
    const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(canvas);
    const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
    const result = new ZXing.MultiFormatReader().decode(binaryBitmap);
    if(result && result.text) return result.text;
  }catch(e){}
  // rotated attempts
  const w = canvas.width, h = canvas.height;
  const temp = createCanvas(w,h);
  const tctx = temp.getContext('2d');
  for(let angle of [90,180,270]){
    tctx.clearRect(0,0,w,h);
    tctx.save();
    tctx.translate(w/2,h/2);
    tctx.rotate(angle*Math.PI/180);
    tctx.drawImage(canvas, -w/2, -h/2);
    tctx.restore();
    try{
      const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(temp);
      const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
      const result = new ZXing.MultiFormatReader().decode(binaryBitmap);
      if(result && result.text) return result.text;
    }catch(e){}
  }
  return null;
}

/* Main scanning loop (full frame, multi-angle friendly) */
let canvasPool = [];
function getCanvas(w,h){
  for(let c of canvasPool) if(c.width===w && c.height===h) return c;
  const c = createCanvas(w,h); canvasPool.push(c); return c;
}

async function scanLoop(){
  if(!scanning) return;
  try{
    const w = preview.videoWidth;
    const h = preview.videoHeight;
    if(w===0 || h===0){ requestAnimationFrame(scanLoop); return; }

    const canvas = getCanvas(w,h);
    const ctx = canvas.getContext('2d');
    ctx.drawImage(preview, 0, 0, w, h);

    // downscale for speed
    const scale = Math.max(1, Math.floor(Math.max(w,h)/900));
    const sw = Math.floor(w/scale);
    const sh = Math.floor(h/scale);
    const small = getCanvas(sw,sh);
    const sctx = small.getContext('2d');
    sctx.drawImage(canvas, 0, 0, w, h, 0, 0, sw, sh);
    toGrayscale(sctx, sw, sh);
    increaseContrast(sctx, sw, sh, 30);

    const code = await tryDecodeCanvas(small);
    if(code) handleDetected(code);
  }catch(e){
    // ignore
  } finally {
    requestAnimationFrame(scanLoop);
  }
}

/* Handle detection: create card UI for adding quantity */
function handleDetected(code){
  const now = Date.now();
  if(code === lastDetected.code && (now - lastDetected.ts) < DEBOUNCE_MS) return;
  lastDetected = {code, ts: now};
  beep();
  const name = barcodeDB[code] || '';
  scanStatus.innerText = `–ù–∞–π–¥–µ–Ω –∫–æ–¥: ${code} ${name ? '‚Äî ' + name : '‚Äî —Ç–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ'}`;

  // create quick-add card in overlay
  detectedArea.innerHTML = '';
  const card = document.createElement('div');
  card.className = 'result-card';
  card.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-weight:700">${name || '‚Äî'}</div>
        <div class="small">–ö–æ–¥: ${code}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;min-width:120px">
        <label class="small">–ö–æ–ª-–≤–æ</label>
        <input id="qtyInput" type="number" min="1" value="1" />
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="saveDetectedBtn" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
      <button id="cancelDetectedBtn" class="ghost">–û—Ç–º–µ–Ω–∞</button>
    </div>
  `;
  detectedArea.appendChild(card);

  // handlers
  document.getElementById('cancelDetectedBtn').addEventListener('click', ()=>{
    detectedArea.innerHTML = '';
    scanStatus.innerText = '–û–∂–∏–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è‚Ä¶';
  });

  document.getElementById('saveDetectedBtn').addEventListener('click', ()=>{
    const qty = Math.max(1, parseInt(document.getElementById('qtyInput').value || '1', 10));
    const item = { code, name: name || '', qty, ts: Date.now() };
    addedItems.unshift(item); // newest first
    saveAdded();
    detectedArea.innerHTML = '';
    scanStatus.innerText = `–î–æ–±–∞–≤–ª–µ–Ω–æ: ${code} √ó${qty}`;
  });

  // If product not in DB, offer quick manual name input
  if(!name){
    const addNameBtn = document.createElement('button');
    addNameBtn.className = 'ghost';
    addNameBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ –±–∞–∑—É';
    addNameBtn.style.marginTop = '8px';
    card.appendChild(addNameBtn);
    addNameBtn.addEventListener('click', ()=>{
      const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–¥–∞', '');
      if(newName){
        barcodeDB[code] = newName;
        localStorage.setItem('barcodeDB', JSON.stringify(barcodeDB));
        // update UI
        card.querySelector('div > div').firstChild.textContent = newName;
      }
    });
  }
}

/* Manual add fallback */
manualAddBtn.addEventListener('click', ()=>{
  const code = prompt('–í–≤–µ–¥–∏—Ç–µ —à—Ç—Ä–∏—Ö–∫–æ–¥', '')?.trim();
  if(!code) return;
  const name = barcodeDB[code] || prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (–Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑–µ)', '') || '';
  const qty = parseInt(prompt('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', '1') || '1', 10) || 1;
  const item = { code, name, qty, ts: Date.now() };
  addedItems.unshift(item);
  saveAdded();
  scanStatus.innerText = `–î–æ–±–∞–≤–ª–µ–Ω–æ –≤—Ä—É—á–Ω—É—é: ${code} √ó${qty}`;
});

/* Buttons */
openScannerBtn.addEventListener('click', openScanner);
closeScannerBtn.addEventListener('click', closeScanner);
closeAndSaveBtn.addEventListener('click', closeScanner);
torchBtn.addEventListener('click', toggleTorch);

/* Init list and warm-up camera permissions for labels */
renderAddedList();
navigator.mediaDevices.getUserMedia({video:true}).then(s=>{
  s.getTracks().forEach(t=>t.stop());
}).catch(()=>{ /* ignore */ });

/* Optional: expose a function to open scanner programmatically (for binding to other UI) */
window.openAddScanner = openScanner;

</script>
</body>
</html>
