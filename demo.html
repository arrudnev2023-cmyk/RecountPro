<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>RecountPro ‚Äî –ü–µ—Ä–µ—Å—á—ë—Ç</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    :root {
      --accent: #6d28d9;
      --accent-light: #a78bfa;
      --text: #1f2937;
      --border: #d1d5db;
    }
    body {
      font-family: "Segoe UI", system-ui, sans-serif;
      margin: 0;
      color: var(--text);
      overflow: hidden;
      background: #000;
    }

    /* –§–æ–Ω canvas */
    #bg {
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      z-index:-1;
      background: #000;
    }

    /* –ú–∞–∫–µ—Ç: 3 –∑–æ–Ω—ã */
   /* –®–∞–ø–∫–∞ */
#header {
  position: fixed;
  top: 0; left: 0; right: 0;
  z-index: 1000;
  background: rgba(20, 20, 20, 0.7); /* –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ç—ë–º–Ω—ã–π —Ñ–æ–Ω */
  color: #f5f5f5;
  padding: 0.8rem 1rem;
  border-radius: 0 0 20px 20px; /* —Å–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–µ –Ω–∏–∂–Ω–∏–µ —É–≥–ª—ã */
  box-shadow: 0 8px 24px rgba(0,0,0,0.5);
  backdrop-filter: blur(12px) saturate(180%); /* —ç—Ñ—Ñ–µ–∫—Ç —Å—Ç–µ–∫–ª–∞ */
  -webkit-backdrop-filter: blur(12px) saturate(180%);
  animation: fadeInDown 0.4s ease;
}

/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
#header h1 {
  margin: 0;
  font-size: 1.3rem;
  text-align: center;
  font-weight: 600;
  letter-spacing: 0.5px;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–∏—Å–∫–∞ */
#search-container {
  margin-top: 0.6rem;
  background: rgba(40, 40, 40, 0.6);
  border-radius: 12px;
  padding: 0.4rem;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}

/* –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ */
#search {
  width: 100%;
  padding: 0.6rem 2.5rem 0.6rem 0.8rem;
  font-size: 1rem;
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 10px;
  box-sizing: border-box;
  background: rgba(30,30,30,0.8);
  color: #f5f5f5;
  transition: border 0.2s ease, background 0.2s ease;
}

#search:focus {
  border: 1px solid #6a11cb; /* –∞–∫—Ü–µ–Ω—Ç –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ */
  background: rgba(40,40,40,0.9);
  outline: none;
}

/* –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ */
/* –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω—É) */
#clear-search {
  position: absolute;
  right: 0.6rem;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  font-size: 1.2rem;
  color: #aaa;
  cursor: pointer;
  transition: color 0.2s ease;
  z-index: 2;
}
#clear-search:hover { color: #fff; }

}
    /* –ì–æ–ª–æ—Å–æ–≤–æ–π –ø–æ–∏—Å–∫: –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏ */
#voice-search-btn {
  position: absolute;
  right: 2.6rem; /* —Å–æ–≥–ª–∞—Å—É–µ—Ç—Å—è —Å –ø—Ä–∞–≤–∫–æ–π #clear-search */
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px;
  z-index: 2;
}
#voice-search-btn[aria-pressed="true"] #voice-icon path {
  stroke: var(--accent);
  transition: stroke 0.15s ease;
}
#voice-search-btn.recording #voice-icon {
  animation: pulse 1s infinite;
}
@keyframes pulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.08); opacity: 0.85; }
  100% { transform: scale(1); opacity: 1; }
}


#clear-search:hover {
  color: #fff;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
@keyframes fadeInDown {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}


    /* –ö–æ–Ω—Ç–µ–Ω—Ç (–∫–∞—Ä—Ç–æ—á–∫–∏) */
 
#content {
  position: fixed;
  top: 6.5rem; /* –≤—ã—Å–æ—Ç–∞ —à–∞–ø–∫–∏ */
  bottom: 0;
  left: 0; right: 0;
  overflow-y: auto;
  padding: 0.5rem;
  box-sizing: border-box;
  z-index: 1;
  transition: padding-bottom 0.3s ease;
}
/* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã */
#content.with-keyboard {
  padding-bottom: 35vh;
}

.item {
  margin: 0.5rem auto;
  padding: 1rem;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  max-width: 600px;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  background: linear-gradient(135deg, #1e1e2f, #2a2a40);
  color: #fff;
  border-left: 6px solid transparent;
}
.item.match { border-left-color: #22c55e; }
.item.missing { border-left-color: #ef4444; }
.item.excess { border-left-color: #3b82f6; }
.field { margin-bottom: 0.4rem; font-size: 0.9rem; }
.label { font-weight: 600; }

input[data-code] {
  width: 100%;
  padding: 0.6rem;
  font-size: 1rem;
  box-sizing: border-box;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: #fefefe;
  color: #000;

  /* ‚ú® –¥–æ–±–∞–≤–ª–µ–Ω–æ: —Ü–≤–µ—Ç –∫—É—Ä—Å–æ—Ä–∞ */
  caret-color: var(--accent, #6a11cb);
}

    /* –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ */
    #custom-keyboard {
  position: fixed;
  bottom: -40vh;
  left: 0; right: 0;
  height: 33vh;
  background: #111;
  padding: 0.5rem;
  box-sizing: border-box;
  z-index: 3000;
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows: repeat(4, 1fr);
  gap: 0.5rem;
  transition: bottom 0.3s ease;

  /* üîí –æ—Ç–∫–ª—é—á–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∏ –≤—ã–∑–æ–≤—ã –ø–æ –¥–æ–ª–≥–æ–º—É —Ç–∞–ø—É */
  -webkit-user-select: none;
  -ms-user-select: none;
  user-select: none;
  -webkit-touch-callout: none;
}

#custom-keyboard.show { bottom: 0; }

#custom-keyboard button {
  width: 100%;
  height: 100%;
  font-size: 1.6rem;           /* ‚â•16px, —á—Ç–æ–±—ã iOS –Ω–µ –∑—É–º–∏–ª */
  background: #333;
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;

  /* üî• —É–±–∏—Ä–∞–µ–º –¥–≤–æ–π–Ω–æ–π —Ç–∞–ø‚Äë–∑—É–º */
  touch-action: manipulation;

  /* –æ—Ç–∫–ª—é—á–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö */
  -webkit-user-select: none;
  user-select: none;

  /* –ø–ª–∞–≤–Ω—ã–π –æ—Ç–∫–ª–∏–∫ */
  transition: background 0.15s ease, transform 0.1s ease;
}

/* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è */
#custom-keyboard button:active {
  background: #555;
  transform: scale(0.95);
}


   /* –û–±—ë—Ä—Ç–∫–∞ –º–µ–Ω—é */
#menu-wrapper {
  position: fixed;
  bottom: 1rem;
  right: 1rem;
  z-index: 1001;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  font-family: "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
}

#menu-toggle, #flashlight-btn, #ocr-btn {
  background: linear-gradient(135deg, #6a11cb, #2575fc);
  color: #fff;
  border: none;
  padding: 0.8rem 1.2rem;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 6px 20px rgba(0,0,0,0.35), 0 0 12px rgba(106,17,203,0.6);
  transition: all 0.3s ease;
  backdrop-filter: blur(6px);
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
   
/* SVG –≤–Ω—É—Ç—Ä–∏ –∫–Ω–æ–ø–æ–∫ */
#menu-toggle svg, #flashlight-btn svg {
  display: block;
  width: 22px;
  height: 22px;
  fill: #fff;
}

/* Hover‚Äë—ç—Ñ—Ñ–µ–∫—Ç */
#menu-toggle:hover, #flashlight-btn:hover {
  transform: translateY(-3px) scale(1.03);
  box-shadow: 0 10px 28px rgba(0,0,0,0.5), 0 0 18px rgba(37,117,252,0.8);
}

/* Active‚Äë—Å–æ—Å—Ç–æ—è–Ω–∏–µ */
#menu-toggle:active, #flashlight-btn:active {
  transform: translateY(0) scale(0.98);
  box-shadow: inset 0 3px 8px rgba(0,0,0,0.6);
}

/* –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é (glassmorphism) */
#menu-actions {
  display: none;
  flex-direction: column;
  gap: 0.6rem;
  margin-top: 0.7rem;
  background: rgba(20, 20, 20, 0.7);
  padding: 1rem;
  border-radius: 16px;
  box-shadow: 0 12px 32px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.1);
  backdrop-filter: blur(12px) saturate(180%);
  animation: fadeIn 0.35s ease;
}

/* –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é */
#menu-actions button {
  background: linear-gradient(145deg, #1f1f1f, #2c2c2c);
  color: #f9f9f9;
  border: none;
  padding: 0.7rem 1rem;
  border-radius: 10px;
  font-size: 0.95rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.25s ease;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.08), 0 6px 14px rgba(0,0,0,0.4);
  letter-spacing: 0.3px;
}

#menu-actions button:hover {
  background: linear-gradient(145deg, #2c2c2c, #3a3a3a);
  transform: translateX(-3px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.6), 0 0 10px rgba(255,255,255,0.15);
}

#menu-actions button:active {
  transform: translateX(0) scale(0.97);
  box-shadow: inset 0 3px 8px rgba(0,0,0,0.6);
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(12px) scale(0.95); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}




    /* –°–∫—Ä—ã—Ç–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ */
    .hidden { display: none !important; }

    /* –≠–∫—Å–ø–æ—Ä—Ç PDF ‚Äî —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —à—Ä–∏—Ñ—Ç */
    #export-area {
  font-size: 8px;   /* –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —à—Ä–∏—Ñ—Ç */
  line-height: 1.2; /* –ø–ª–æ—Ç–Ω–µ–µ —Å—Ç—Ä–æ–∫–∏ */
}

#export-area th,
#export-area td {
  padding: 2px 3px; /* –º–µ–Ω—å—à–µ –æ—Ç—Å—Ç—É–ø—ã */
}

  </style>
</head>
<body>
  <!-- –§–æ–Ω canvas -->
  <canvas id="bg"></canvas>

  <!-- –®–∞–ø–∫–∞ -->
  <div id="header">
    <h1>RecountPro ‚Äî –ü–µ—Ä–µ—Å—á—ë—Ç</h1>
    <div id="search-container">
      <div id="search-wrapper" style="position:relative;">
  <input type="text" id="search" placeholder="–ü–æ–∏—Å–∫..."
         autocomplete="off" autocorrect="off"
         autocapitalize="off" spellcheck="false" aria-label="–ü–æ–∏—Å–∫" />
  <button id="clear-search" type="button" aria-label="–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫">√ó</button>

  <!-- –ö–Ω–æ–ø–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ -->
  <button id="voice-search-btn" type="button" aria-label="–ì–æ–ª–æ—Å–æ–≤–æ–π –ø–æ–∏—Å–∫" aria-pressed="false"
          style="position:absolute; right:2.6rem; top:50%; transform:translateY(-50%); background:none; border:none; cursor:pointer; padding:4px;">
    <svg id="voice-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3z" stroke="#aaa" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M19 11v1a7 7 0 0 1-14 0v-1" stroke="#aaa" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M12 19v3" stroke="#aaa" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>
</div>

    </div>
  </div>
  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
  <div id="content">
    <div id="list"></div>
  </div>

  <!-- –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ -->
  <div id="custom-keyboard">
    <button>1</button><button>2</button><button>3</button>
    <button>4</button><button>5</button><button>6</button>
    <button>7</button><button>8</button><button>9</button>
    <button>+</button><button>0</button><button>‚Üê</button>
  </div>

  <!-- –ú–µ–Ω—é -->
  <div id="menu-wrapper">
    <div style="display:flex; gap:0.5rem;">
     <!-- –ö–Ω–æ–ø–∫–∏ -->
<div style="display:flex; gap:0.5rem;">
 <button id="flashlight-btn" aria-label="Flashlight">
  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <!-- –¢–í–û–ô –§–û–ù–ê–†–ò–ö -->
    <g stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="8" y="2.5" width="8" height="4" rx="1.2" fill="none"/>
      <rect x="9.5" y="6.5" width="5" height="9" rx="1.2" fill="none"/>
      <rect x="8.5" y="16.5" width="7" height="4.5" rx="1.4" fill="none"/>
      <line x1="12" y1="2" x2="12" y2="0.5" />
      <line x1="9"  y1="3" x2="7.5" y2="1.8" />
      <line x1="15" y1="3" x2="16.5" y2="1.8" />
    </g>
    <circle cx="12" cy="11" r="0.9" fill="#111"/>
  </svg>
 </button>
  
  <button id="menu-toggle" aria-label="Menu">
    <!-- SVG –º–µ–Ω—é (—Ç—Ä–∏ –ø–æ–ª–æ—Å–∫–∏) -->
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
      <rect x="4" y="6" width="16" height="2.2" rx="1.1" fill="white"/>
      <rect x="4" y="11" width="16" height="2.2" rx="1.1" fill="white"/>
      <rect x="4" y="16" width="16" height="2.2" rx="1.1" fill="white"/>
    </svg>
  </button>
</div>

    </div>



    <div id="ocr-debug" style="
  position: fixed;
  bottom: 10px;
  left: 10px;
  background: rgba(0,0,0,0.7);
  color: #0f0;
  padding: 10px;
  font-size: 16px;
  z-index: 99999;
  max-width: 90vw;
  white-space: pre-wrap;
"></div>




    
    <div id="menu-actions">
      <button onclick="document.getElementById('upload').click()"> –ó–∞–≥—Ä—É–∑–∏—Ç—å –õ–†</button>
      <button onclick="exportPDF()"> –°–∫–∞—á–∞—Ç—å –õ–†</button>
      <button onclick="saveSession()"> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å </button>
      <button onclick="openSessionModal()"> –£–ø—Ä–∞–≤–ª—è—Ç—å </button>
      <button onclick="showSummaryModal()"> –ò—Ç–æ–≥</button>
      <button onclick="clearRecount()"> –û—á–∏—Å—Ç–∏—Ç—å –ø–µ—Ä–µ—Å—á—ë—Ç</button>
    </div>
  </div>

  <!-- –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ PDF -->
  <input type="file" id="upload" accept=".pdf" style="display:none;">

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏—Ç–æ–≥–æ–≤ -->
 <div id="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
       background:rgba(0,0,0,0.6); z-index:2000; justify-content:center; align-items:center;">
  <div style="background:#fff; max-width:95%; width:95%; max-height:85%; 
              border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,0.4); 
              position:relative; display:flex; flex-direction:column;">

    <!-- –•–µ–¥–µ—Ä —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –∏ –∫—Ä–µ—Å—Ç–∏–∫–æ–º -->
    <div style="position:sticky; top:0; background:#fff; 
                display:flex; justify-content:center; align-items:center;
                padding:0.5rem 2rem; border-bottom:1px solid #ddd; z-index:10;">
      <h2 style="margin:0; font-size:1rem; color:var(--accent); flex:1; text-align:center;">
        –ò—Ç–æ–≥ –ø–µ—Ä–µ—Å—á—ë—Ç–∞
      </h2>
      <button onclick="document.getElementById('modal').style.display='none'"
              style="position:absolute; top:8px; right:8px; background:none; border:none; 
                     font-size:1.4rem; cursor:pointer; color:#666;">‚úñ</button>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Å —Ç–∞–±–ª–∏—Ü–µ–π -->
    <div style="flex:1; overflow:auto; padding:0.5rem;">
      <div id="modal-content" style="font-size:0.75rem;"></div>
    </div>

    <!-- –§—É—Ç–µ—Ä —Å –∫–Ω–æ–ø–∫–æ–π -->
    <div style="padding:0.5rem; border-top:1px solid #ddd;">
      <button onclick="document.getElementById('modal').style.display='none'" 
              style="background:var(--accent); color:#fff; border:none; padding:0.5rem 1rem;
                     border-radius:6px; cursor:pointer; width:100%; font-size:0.9rem;">
        –ó–∞–∫—Ä—ã—Ç—å
      </button>
    </div>
  </div>
</div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–µ—Å—Å–∏–π -->
  <div id="session-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
       background:rgba(0,0,0,0.6); z-index:2000; justify-content:center; align-items:center;">
    <div style="background:#fff; max-width:600px; width:90%; max-height:80%; overflow-y:auto;
                border-radius:12px; padding:1rem; box-shadow:0 4px 16px rgba(0,0,0,0.4);">
      <h2 style="margin-top:0; font-size:1.2rem; color:var(--accent);">–°–µ—Å—Å–∏–∏</h2>
      <div id="session-list"></div>
      <button onclick="document.getElementById('session-modal').style.display='none'" 
              style="margin-top:1rem; background:var(--accent); color:#fff; border:none; padding:0.6rem 1rem;
                     border-radius:8px; cursor:pointer; width:100%;">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <!-- –û–±–ª–∞—Å—Ç—å —ç–∫—Å–ø–æ—Ä—Ç–∞ PDF -->
  <div id="export-area" style="display:none; padding:0.5rem; background:#fff; color:#000;">
    <h2 style="margin:0; font-size:1rem; color:var(--accent);">–ò—Ç–æ–≥ –ø–µ—Ä–µ—Å—á—ë—Ç–∞</h2>
    <div id="export-summary" style="margin-bottom:0.5rem;"></div>
    <table style="width:100%; border-collapse:collapse; table-layout:fixed; font-size:0.8rem;">
      <thead>
        <tr style="background:#f3f4f6;">
          <th style="width:60px; border:1px solid #ccc; padding:4px;">–ê—Ä—Ç–∏–∫—É–ª</th>
          <th style="width:140px; border:1px solid #ccc; padding:4px;">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
          <th style="width:60px; border:1px solid #ccc; padding:4px;">–†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å</th>
          <th style="width:50px; border:1px solid #ccc; padding:4px;">–¶–µ–Ω–∞</th>
          <th style="width:60px; border:1px solid #ccc; padding:4px;">–ü–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º</th>
          <th style="width:140px; border:1px solid #ccc; padding:4px;">–§–∞–∫—Ç</th>
          <th style="width:50px; border:1px solid #ccc; padding:4px;">–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ</th>
        </tr>
      </thead>
      <tbody id="export-table-body"></tbody>
    </table>
  </div>
<script>

  // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
  const LAST_ACTIVITY_KEY = "lastActivity";
  const MAX_IDLE_TIME = 6 * 60 * 60 * 1000; // 6 —á–∞—Å–æ–≤

  function updateActivity() {
    localStorage.setItem(LAST_ACTIVITY_KEY, Date.now().toString());
  }

  function checkIdleTime() {
    const last = parseInt(localStorage.getItem(LAST_ACTIVITY_KEY) || "0", 10);
    const now = Date.now();
    if (last && now - last > MAX_IDLE_TIME) {
      localStorage.removeItem("isAuth");
      window.location.href = "/demo.html";
    }
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–∏ –¥–µ–π—Å—Ç–≤–∏—è—Ö
  ["click", "keydown", "mousemove", "scroll", "touchstart"].forEach(evt => {
    document.addEventListener(evt, updateActivity, { passive: true });
  });

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
  setInterval(checkIdleTime, 30 * 60 * 1000);
  updateActivity();

  // –ë–∞–∑–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
  const list = document.getElementById("list");
  const searchInput = document.getElementById("search");
  const keyboard = document.getElementById("custom-keyboard");
  let allItems = [], activeInput = null;
  let sessionValues = {};

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener("DOMContentLoaded", () => {
  // üîë –æ–ø—Ä–µ–¥–µ–ª—è–µ–º ID –ª–æ–∫–∞–ª–∫–∏: –±–µ—Ä—ë–º docId –∏–∑ JSON, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî fallback –ø–æ –¥–∞—Ç–µ
  const currentLocalkaId = (window.localkaData && window.localkaData.docId)
    ? window.localkaData.docId
    : "loc_" + new Date().toISOString().slice(0,10);

  const sessionKey = "autosave_session_" + currentLocalkaId;

  // –ø—Ä–æ–±—É–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —Å–µ—Å—Å–∏—é –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–π –ª–æ–∫–∞–ª–∫–∏
  const savedSession = localStorage.getItem(sessionKey);
  if (savedSession) {
    try {
      const session = JSON.parse(savedSession);
      allItems = session.items || [];
      sessionValues = session.values || {};
    } catch {
      allItems = [];
      sessionValues = {};
    }
  } else {
    allItems = [];
    sessionValues = {};
  }

  if (allItems.length > 0) {
    render(allItems);
  }
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–π –ª–æ–∫–∞–ª–∫–∏
function loadLocalka(data) {
  // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º ID –ª–æ–∫–∞–ª–∫–∏
  const currentLocalkaId = data.docId || "loc_" + new Date().toISOString().slice(0,10);
  const sessionKey = "autosave_session_" + currentLocalkaId;

  // ‚ùå –æ—á–∏—â–∞–µ–º –∞–≤—Ç–æ—Å–µ–π–≤ –¥–ª—è —ç—Ç–æ–π –ª–æ–∫–∞–ª–∫–∏ (—á–∏—Å—Ç—ã–π —Å—Ç–∞—Ä—Ç)
  localStorage.removeItem(sessionKey);

  allItems = data;
  sessionValues = {};

  // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–µ–∫—É—â—É—é –ª–æ–∫–∞–ª–∫—É –≥–ª–æ–±–∞–ª—å–Ω–æ, —á—Ç–æ–±—ã autosave –∑–Ω–∞–ª –µ—ë ID
  window.localkaData = data;

  render(allItems);
}

// –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
function autosave() {
  const currentLocalkaId = (window.localkaData && window.localkaData.docId)
    ? window.localkaData.docId
    : "loc_" + new Date().toISOString().slice(0,10);

  const sessionKey = "autosave_session_" + currentLocalkaId;

  const session = {
    items: allItems,
    values: sessionValues
  };

  localStorage.setItem(sessionKey, JSON.stringify(session));
}

  // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
  window.addEventListener("beforeunload", autosave);

  // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –ø–æ —Å—Ç—Ä–æ–∫–∞–º PDF
  function groupByY(items) {
    const lines = {};
    items.forEach(item => {
      const y = Math.round(item.transform[5]);
      if (!lines[y]) lines[y] = [];
      lines[y].push({ str: item.str, x: item.transform[4] });
    });
    return Object.values(lines).map(words =>
      words.sort((a, b) => a.x - b.x).map(w => w.str).join(' ')
    );
  }

  // –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–∫ –≤ –æ–±—ä–µ–∫—Ç—ã —Ç–æ–≤–∞—Ä–æ–≤
  function parseLines(lines) {
    const items = [];
    for (let line of lines) {
      line = line.trim();
      if (!/^\d+\s+\d{4,6}/.test(line)) continue;

      const match = line.match(/^(\d+)\s+(\d{4,6})\s+(.+?)\s+(\d+\*\d+)?\s+([\d.,]+)\s+(.*)$/i);
      if (match) {
        const rawTail = match[6];
        const qtyMatches = [...rawTail.matchAll(/(\d+)\s*—à—Ç/gi)];
        const docQty = qtyMatches.length > 0 ? parseInt(qtyMatches[qtyMatches.length - 1][1]) : null;

        items.push({
          code: match[2],
          name: match[3].trim(),
          unit: match[4] || '',
          price: parseFloat(match[5].replace(',', '.')),
          docQty
        });
      }
    }
    return items;
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤
  function updateSummary(items) {
    let match = 0, missing = 0, excess = 0, delta = 0;
    items.forEach(item => {
      const input = document.querySelector(`input[data-code="${item.code}"]`);
      if (!input) return;
      const raw = input.value.trim();
      const actual = parseFloat(raw.replace(',', '.')) || 0;
      if (actual === item.docQty) match++;
      else if (actual < item.docQty) { missing++; delta += item.docQty - actual; }
      else { excess++; delta += actual - item.docQty; }
    });
  }
  // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤

function render(items) {
  list.innerHTML = '';
  items.forEach(item => {
    const value = sessionValues[item.code] || localStorage.getItem("qty_" + item.code) || "";
    const div = document.createElement("div");
    div.className = "item";
    div.dataset.code = item.code;
    div.innerHTML = `
      <div class="field"><span class="label">–ê—Ä—Ç–∏–∫—É–ª:</span> ${item.code}</div>
      <div class="field"><span class="label">–ù–∞–∑–≤–∞–Ω–∏–µ:</span> ${item.name}</div>
      <div class="field"><span class="label">–†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å:</span> ${item.unit}</div>
      <div class="field"><span class="label">–¶–µ–Ω–∞:</span> ${item.price.toFixed(2)} ‚ÇΩ</div>
      <div class="field"><span class="label">–ü–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º:</span> ${item.docQty} —à—Ç</div>
      <div class="field">
        <span class="label">–§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:</span>
        <input type="text" data-code="${item.code}" value="${value}" inputmode="none" readonly />
      </div>
    `;

    // –Ω–∞—á–∞–ª—å–Ω–∞—è –æ–∫—Ä–∞—Å–∫–∞ –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–µ
    let actual = 0;
    try { actual = Function("return " + value.replace(',', '.'))() || 0; } catch {}
    if (actual === item.docQty) div.classList.add("match");
    else if (actual < item.docQty) div.classList.add("missing");
    else if (actual > item.docQty) div.classList.add("excess");

    list.appendChild(div);
  });
  updateSummary(allItems);
  attachInputHandlers(); // –ø–æ–¥–∫–ª—é—á–∞–µ–º —Ç–≤–æ—é –∫–∞—Å—Ç–æ–º–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –≤–≤–æ–¥–∞
}

// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –∏–Ω–ø—É—Ç–æ–≤ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
function attachInputHandlers() {
  document.querySelectorAll('input[data-code]').forEach(input => {
    input.addEventListener('focus', () => {
      activeInput = input;
      keyboard.classList.add("show");
      document.getElementById("content").classList.add("with-keyboard");
      setTimeout(() => input.scrollIntoView({ behavior: 'smooth', block: 'center' }), 150);
    });
    input.addEventListener('click', () => {
      activeInput = input;
      keyboard.classList.add("show");
      document.getElementById("content").classList.add("with-keyboard");
      setTimeout(() => input.scrollIntoView({ behavior: 'smooth', block: 'center' }), 150);
    });
  });

  // –ö–ª–∏–∫–∏ –ø–æ –∫–Ω–æ–ø–∫–∞–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
  keyboard.querySelectorAll('button').forEach(btn => {
    btn.onclick = () => {
      if (!activeInput) return;
      const val = btn.textContent;
      if (val === "‚Üê") {
        activeInput.value = activeInput.value.slice(0, -1);
      } else {
        activeInput.value += val;
      }
      // üî• —Ç–µ–ø–µ—Ä—å —Å–æ–±—ã—Ç–∏–µ –≤—Å–ø–ª—ã–≤–∞–µ—Ç –∏ –ª–æ–≤–∏—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω—ã–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º
      activeInput.dispatchEvent(new Event("input", { bubbles: true }));
    };
  });

  // –°–∫—Ä—ã—Ç–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
  document.addEventListener("click", e => {
    if (!e.target.closest("#custom-keyboard") && !e.target.matches("input[data-code]")) {
      keyboard.classList.remove("show");
      document.getElementById("content").classList.remove("with-keyboard");
      activeInput = null;
    }
  });
}


// –ü–æ–∏—Å–∫

// –§—É–Ω–∫—Ü–∏—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
function normalize(str) {
  return String(str || "")
    .toLowerCase()
    .replace(/—ë/g, "–µ")   // —ë ‚Üí –µ
    .replace(/‚Ññ/g, "")    // —É–±–∏—Ä–∞–µ–º —Å–∏–º–≤–æ–ª ‚Ññ
    .replace(/\s+/g, " ") // —Å—Ö–ª–æ–ø—ã–≤–∞–µ–º –ø—Ä–æ–±–µ–ª—ã
    .trim();
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞: –≤—Å–µ –ª–∏ —Å–ª–æ–≤–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –≤ —Å—Ç—Ä–æ–∫–µ
function matchesQuery(text, query) {
  const words = query.split(" ");
  return words.every(w => text.includes(w));
}

// –ü–æ–∏—Å–∫
searchInput.addEventListener("input", () => {
  const q = normalize(searchInput.value);

  document.querySelectorAll("#list .item").forEach(div => {
    const code = normalize(div.dataset.code);
    const item = allItems.find(i => i.code === div.dataset.code);
    if (!item) { 
      div.classList.add("hidden"); 
      return; 
    }

    const name = normalize(item.name);

    // —Ç–µ–ø–µ—Ä—å –∏—â–µ–º –ø–æ —á–∞—Å—Ç—è–º: –∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –¥–æ–ª–∂–Ω–æ –≤—Å—Ç—Ä–µ—Ç–∏—Ç—å—Å—è
    const match = matchesQuery(name, q) || matchesQuery(code, q);

    div.classList.toggle("hidden", !match);
  });
});


// –û—á–∏—Å—Ç–∫–∞ –ø–æ–∏—Å–∫–∞
document.getElementById("clear-search").addEventListener("click", () => {
  searchInput.value = '';
  document.querySelectorAll("#list .item").forEach(div => div.classList.remove("hidden"));
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –∑–Ω–∞—á–µ–Ω–∏–π –∏ –ø–µ—Ä–µ–∫—Ä–∞—Å–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫
list.addEventListener("input", e => {
  if (e.target.tagName === "INPUT") {
    const code = e.target.dataset.code;
    const value = e.target.value;
    sessionValues[code] = value;
    localStorage.setItem("qty_" + code, value);

    const raw = value.replace(',', '.').trim();
    let actual = NaN;

    try {
      let safeRaw = raw;

      // –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –æ–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä (+ - * /), —É–±–∏—Ä–∞–µ–º –µ–≥–æ
      if (/[\+\-\*\/]$/.test(safeRaw)) {
        safeRaw = safeRaw.slice(0, -1);
      }

      if (safeRaw) {
        actual = Function("return " + safeRaw)();
      }
    } catch {
      actual = NaN;
    }

    const item = allItems.find(i => i.code === code);
    const card = e.target.closest(".item");
    card.classList.remove("match", "missing", "excess");

    if (!value) {
      // –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –≤–∏–¥
    } else if (!isNaN(actual)) {
      if (actual === item.docQty) {
        card.classList.add("match");
      } else if (actual < item.docQty) {
        card.classList.add("missing");
      } else if (actual > item.docQty) {
        card.classList.add("excess");
      }
    }

    updateSummary(allItems);
    autosave();
  }
});




  // –≠–∫—Å–ø–æ—Ä—Ç PDF
 // –≥–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–∫–∞–ª–∫–∏

let startTime = new Date();

function exportPDF() {
  autosave();
  const exportArea = document.getElementById("export-area");
  exportArea.innerHTML = ""; 
  exportArea.style.display = "block";
  exportArea.style.fontFamily = "Arial, sans-serif";
  window.scrollTo(0, 0);

  let totalPlus = 0, totalMinus = 0;

  // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
  const sortedItems = [...allItems].sort((a, b) => a.name.localeCompare(b.name, 'ru'));

  // –≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö
  const filename = prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞", "RecountPro.pdf");
  if (!filename) {
    exportArea.style.display = "none";
    return;
  }
  const groupName = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã", "");
  const countedBy = prompt("–ö—Ç–æ —Å—á–∏—Ç–∞–ª?", "");

  // —Ñ–∏–∫—Å–∏—Ä—É–µ–º –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
  const endTime = new Date();

  // —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
  const formattedDate = endTime.toLocaleDateString("ru-RU", {
    day: "numeric",
    month: "long",
    year: "numeric"
  });
  const formatTime = d => d.toLocaleTimeString("ru-RU", {hour: "2-digit", minute: "2-digit"});
  const startStr = formatTime(startTime);
  const endStr = formatTime(endTime);

  // –∑–∞–≥–æ–ª–æ–≤–æ–∫
  const title = document.createElement("div");
  title.style.textAlign = "center";
  title.style.fontSize = "10px";
  title.style.marginBottom = "4px";
  title.innerText = "–ê–∫—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ-—Ä–µ–≤–∏–∑–∏–æ–Ω–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∏ –∫–∞—á–µ—Å—Ç–≤—É";
  exportArea.appendChild(title);

  const dateLine = document.createElement("div");
  dateLine.style.textAlign = "center";
  dateLine.style.fontSize = "12px";
  dateLine.style.marginBottom = "10px";
  dateLine.innerText = formattedDate;
  exportArea.appendChild(dateLine);

  // –≤–µ—Ä—Ö–Ω—è—è —Å—Ç—Ä–æ–∫–∞
  const topRow = document.createElement("div");
  topRow.style.display = "flex";
  topRow.style.justifyContent = "space-between";
  topRow.style.alignItems = "flex-start";
  topRow.style.marginBottom = "10px";

  const leftBlock = document.createElement("div");
  leftBlock.style.textAlign = "left";
  leftBlock.style.fontSize = "12px";
  leftBlock.innerHTML = `–ò—Ç–æ–≥:<br>‚Äì0 ‚ÇΩ<br>+0 ‚ÇΩ`;

  const rightBlock = document.createElement("div");
  rightBlock.style.textAlign = "right";
  rightBlock.style.fontSize = "12px";
  rightBlock.innerHTML = `
    –°—á–∏—Ç–∞–ª: ${countedBy || ""}<br>
    <span style="display:inline-block; border-bottom:1px solid #000; width:300px;"></span><br>
    <span style="display:inline-block; border-bottom:1px solid #000; width:300px;"></span>
  `;

  topRow.appendChild(leftBlock);
  topRow.appendChild(rightBlock);
  exportArea.appendChild(topRow);

  // —Ç–∞–±–ª–∏—Ü–∞
  const table = document.createElement("table");
  table.style.borderCollapse = "collapse";
  table.style.width = "100%";
  table.style.fontSize = "10px";
  table.style.pageBreakInside = "avoid";

  const thead = document.createElement("thead");
  thead.style.pageBreakInside = "avoid";
  thead.innerHTML = `
    <tr>
      <th colspan="8" style="border:1px solid #444; padding:4px; text-align:center; font-size:12px; font-weight:bold;">
        ${groupName || ""}
      </th>
    </tr>
    <tr>
      <th style="border:1px solid #444; padding:2px; width:28px; text-align:center;">‚Ññ</th>
      <th style="border:1px solid #444; padding:2px; width:60px;">–ê—Ä—Ç–∏–∫—É–ª</th>
      <th style="border:1px solid #444; padding:2px;">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
      <th style="border:1px solid #444; padding:2px; width:40px;">–ï–¥.</th>
      <th style="border:1px solid #444; padding:2px; width:45px; text-align:right;">–¶–µ–Ω–∞</th>
      <th style="border:1px solid #444; padding:2px; width:45px; text-align:right;">–û—Å—Ç–∞—Ç–æ–∫</th>
      <th style="border:1px solid #444; padding:2px; width:120px; text-align:right;">–§–∞–∫—Ç</th>
      <th style="border:1px solid #444; padding:2px; width:55px; text-align:right;">–†–∞–∑–Ω.</th>
    </tr>
  `;
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  tbody.style.pageBreakInside = "avoid";
  let index = 1;

  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–Ω–∏—Ü—ã: –ø—É—Å—Ç–∞—è —è—á–µ–π–∫–∞ –¥–ª—è –Ω—É–ª—è, +/‚àí –¥–ª—è –Ω–µ–Ω—É–ª–µ–≤—ã—Ö
  function formatDiffCell(diff) {
    const n = Number(diff);
    const EPS = 1e-9;
    if (!isFinite(n) || Math.abs(n) <= EPS) return ''; // –ø—É—Å—Ç–∞—è —è—á–µ–π–∫–∞ –≤–º–µ—Å—Ç–æ "0"
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω—ã–π –≤–∏–¥, –∏–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å –¥–≤—É–º—è –∑–Ω–∞–∫–∞–º–∏
    const s = (Math.abs(n % 1) < EPS) ? String(n) : String(Number(n.toFixed(2)));
    return (n > 0 ? '+' : '') + s;
  }

  sortedItems.forEach(item => {
    const input = document.querySelector(`input[data-code="${item.code}"]`);
    const raw = input ? input.value.trim() : "";
    let actual = 0;

    try {
      let safe = raw.replace(',', '.').replace(/[^0-9+\-*/().]/g, '').trim();
      if (/[\+\-\*\/]$/.test(safe)) {
        safe = safe.slice(0, -1);
      }
      if (safe) {
        actual = Function(`"use strict"; return (${safe})`)() || 0;
      }
    } catch {
      actual = 0;
    }

    const delta = actual - item.docQty;
    const deltaStr = formatDiffCell(delta);

    if (delta > 0) totalPlus += delta * item.price;
    else if (delta < 0) totalMinus += Math.abs(delta) * item.price;

    const row = document.createElement("tr");
    row.style.pageBreakInside = "avoid";
    row.innerHTML = `
      <td style="border:1px solid #444; padding:2px; text-align:center;">${index}</td>
      <td style="border:1px solid #444; padding:2px;">${item.code}</td>
      <td style="border:1px solid #444; padding:2px; font-size:9px;">${item.name}</td>
      <td style="border:1px solid #444; padding:2px;">${item.unit}</td>
      <td style="border:1px solid #444; padding:2px; text-align:right;">${item.price.toFixed(2)}</td>
      <td style="border:1px solid #444; padding:2px; text-align:right;">${item.docQty}</td>
      <td style="border:1px solid #444; padding:2px; text-align:right;">${raw}</td>
      <td style="border:1px solid #444; padding:2px; text-align:right;">${deltaStr}</td>
    `;
    tbody.appendChild(row);
    index++;
  });

  table.appendChild(tbody);
  exportArea.appendChild(table);

  // –∏—Ç–æ–≥–∏
  leftBlock.innerHTML = `
    –ò—Ç–æ–≥:<br>
    ‚Äì${totalMinus.toFixed(2)} ‚ÇΩ<br>
    +${totalPlus.toFixed(2)} ‚ÇΩ
  `;


  // –ø–æ–¥–ø–∏—Å—å —Å–Ω–∏–∑—É
  const footer = document.createElement("div");
  footer.style.textAlign = "right";
  footer.style.fontSize = "8px";
  footer.style.marginTop = "5px";
  footer.innerText = `–í—Ä–µ–º—è –ø–µ—Ä–µ—Å—á—ë—Ç–∞: —Å ${startStr} –ø–æ ${endStr}`;
  exportArea.appendChild(footer);


  
    // –±–ª–æ–∫ –ø–æ–¥–ø–∏—Å–µ–π (3 —Å—Ç—Ä–æ–∫–∏, –ø–æ–¥–ø–∏—Å–∏ –ø–æ–¥ –ª–∏–Ω–∏—è–º–∏, —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã)
  const signBlock = document.createElement("table");
  signBlock.style.width = "100%";
  signBlock.style.borderCollapse = "collapse";
  signBlock.style.fontSize = "10px";
  signBlock.style.marginTop = "10px"; // –º–µ–Ω—å—à–µ –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É

  signBlock.innerHTML = `
    <tr>
      <td style="border-bottom:1px solid #000; height:20px; width:33%; text-align:center;"></td>
      <td style="border-bottom:1px solid #000; width:33%; text-align:center;"></td>
      <td style="border-bottom:1px solid #000; width:33%; text-align:center;"></td>
    </tr>
    <tr>
      <td style="font-size:8px; text-align:center;">–î–æ–ª–∂–Ω–æ—Å—Ç—å</td>
      <td style="font-size:8px; text-align:center;">–ü–æ–¥–ø–∏—Å—å</td>
      <td style="font-size:8px; text-align:center;">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –ø–æ–¥–ø–∏—Å–∏</td>
    </tr>
    <tr>
      <td style="border-bottom:1px solid #000; height:20px; text-align:center;"></td>
      <td style="border-bottom:1px solid #000; text-align:center;"></td>
      <td style="border-bottom:1px solid #000; text-align:center;"></td>
    </tr>
    <tr>
      <td style="font-size:8px; text-align:center;">–î–æ–ª–∂–Ω–æ—Å—Ç—å</td>
      <td style="font-size:8px; text-align:center;">–ü–æ–¥–ø–∏—Å—å</td>
      <td style="font-size:8px; text-align:center;">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –ø–æ–¥–ø–∏—Å–∏</td>
    </tr>
    <tr>
      <td style="border-bottom:1px solid #000; height:20px; text-align:center;"></td>
      <td style="border-bottom:1px solid #000; text-align:center;"></td>
      <td style="border-bottom:1px solid #000; text-align:center;"></td>
    </tr>
    <tr>
      <td style="font-size:8px; text-align:center;">–î–æ–ª–∂–Ω–æ—Å—Ç—å</td>
      <td style="font-size:8px; text-align:center;">–ü–æ–¥–ø–∏—Å—å</td>
      <td style="font-size:8px; text-align:center;">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –ø–æ–¥–ø–∏—Å–∏</td>
    </tr>
  `;
  exportArea.appendChild(signBlock);
 

  // —ç–∫—Å–ø–æ—Ä—Ç
  const opt = {
    margin: 0.2,
    filename,
    image: { type: 'jpeg', quality: 0.95 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: 'pt', format: 'a4', orientation: 'portrait' },
    pagebreak: { mode: ['avoid-all'] }
  };

  html2pdf().set(opt).from(exportArea).save().then(() => {
    exportArea.style.display = "none";
  });
}
  // –ò—Ç–æ–≥–æ–≤–æ–µ –æ–∫–Ω–æ (–≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ + —Ü–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è)
function showSummaryModal() {
  const rows = allItems.map(item => {
    const input = document.querySelector(`input[data-code="${item.code}"]`);
    const raw = (input ? input.value.trim() : (sessionValues[item.code] || "")).trim();

    // actual –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 0 –ø—Ä–∏ –ø—É—Å—Ç–æ–º/–Ω–µ–≤–∞–ª–∏–¥–Ω–æ–º —Ñ–∞–∫—Ç–µ ‚Äî —á—Ç–æ–±—ã —Ä–∞–∑–Ω–∏—Ü–∞ —Å—á–∏—Ç–∞–ª–∞—Å—å (0 - docQty)
    let actual = 0;

    try {
      let safeRaw = raw.replace(',', '.').replace(/[^0-9+\-*/().]/g, '').trim();

      // –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –æ–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä (+ - * /), —É–±–∏—Ä–∞–µ–º –µ–≥–æ
      if (/[\+\-\*\/]$/.test(safeRaw)) {
        safeRaw = safeRaw.slice(0, -1);
      }

      if (safeRaw) {
        actual = Function(`"use strict"; return (${safeRaw})`)() || 0;
      }
    } catch {
      actual = 0;
    }

    // —Ä–∞–∑–Ω–∏—Ü—É —Å—á–∏—Ç–∞–µ–º –≤—Å–µ–≥–¥–∞: –¥–∞–∂–µ –µ—Å–ª–∏ —Ñ–∞–∫—Ç –ø—É—Å—Ç–æ–π ‚Üí 0 - docQty
    const delta = actual - item.docQty;

    // —Ü–≤–µ—Ç –∏ –∑–Ω–∞–∫ –¥–ª—è —Ä–∞–∑–Ω–∏—Ü—ã
    const color = delta > 0 ? "green" : (delta < 0 ? "red" : "gray");
    const deltaStr = delta > 0 ? `+${delta}` : `${delta}`;

    // –≤ –∫–æ–ª–æ–Ω–∫–µ ¬´–§–∞–∫—Ç¬ª –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ, –µ—Å–ª–∏ –ø–æ–ª–µ —Ñ–∞–∫—Ç–∞ –ø—É—Å—Ç–æ–µ; –∏–Ω–∞—á–µ ‚Äî –ø–æ—Å—á–∏—Ç–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    const factCell = raw !== "" ? actual : "";

    return `
      <tr>
        <td style="border:1px solid #ccc; padding:4px;">${item.code}</td>
        <td style="border:1px solid #ccc; padding:4px;">${item.name}</td>
        <td style="border:1px solid #ccc; padding:4px;">${item.docQty}</td>
        <td style="border:1px solid #ccc; padding:4px;">${factCell}</td>
        <td style="border:1px solid #ccc; padding:4px; color:${color};">${deltaStr}</td>
      </tr>
    `;
  });

  const html = `
    <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
      <thead style="position:sticky; top:0; background:#fff; z-index:1;">
        <tr style="background:#f3f4f6;">
          <th style="border:1px solid #ccc; padding:4px;">–ê—Ä—Ç–∏–∫—É–ª</th>
          <th style="border:1px solid #ccc; padding:4px;">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
          <th style="border:1px solid #ccc; padding:4px;">–î–æ–∫—É–º–µ–Ω—Ç—ã</th>
          <th style="border:1px solid #ccc; padding:4px;">–§–∞–∫—Ç</th>
          <th style="border:1px solid #ccc; padding:4px;">Œî</th>
        </tr>
      </thead>
      <tbody>${rows.join("")}</tbody>
    </table>
  `;

  document.getElementById("modal-content").innerHTML = html;
  document.getElementById("modal").style.display = "flex";
}


  // –ú–µ–Ω—é
  document.getElementById("menu-toggle").addEventListener("click", () => {
    const menu = document.getElementById("menu-actions");
    menu.style.display = menu.style.display === "flex" ? "none" : "flex";
  });

  // –ó–∞–≥—Ä—É–∑–∫–∞ PDF
  document.getElementById("upload").addEventListener("change", async e => {
    const file = e.target.files[0];
    if (!file) return;
    const arrayBuffer = await file.arrayBuffer();

    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js";

    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    let allLines = [];
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      const grouped = groupByY(content.items);
      allLines.push(...grouped);
    }
    allItems = parseLines(allLines);

    const overwrite = confirm("–ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ—Å—á—ë—Ç–∞?");
    if (overwrite) {
      sessionValues = {};
    } else {
      allItems.forEach(item => {
        const saved = localStorage.getItem("qty_" + item.code);
        if (saved) sessionValues[item.code] = saved;
      });
    }

    render(allItems);
    autosave();
  });

  // –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ—Å—á—ë—Ç–∞
 function clearRecount() {
  if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –ø–µ—Ä–µ—Å—á—ë—Ç?")) {
    // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º ID —Ç–µ–∫—É—â–µ–π –ª–æ–∫–∞–ª–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    const currentLocalkaId = (window.localkaData && window.localkaData.docId)
      ? window.localkaData.docId
      : "loc_" + new Date().toISOString().slice(0,10);

    const sessionKey = "autosave_session_" + currentLocalkaId;

    // 1) —É–¥–∞–ª—è–µ–º –∞–≤—Ç–æ—Å–µ—Å—Å–∏—é
    localStorage.removeItem(sessionKey);

    // 2) —É–¥–∞–ª—è–µ–º –≤—Å–µ qty_* –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Ç–µ–∫—É—â–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤
    if (Array.isArray(allItems) && allItems.length > 0) {
      allItems.forEach(item => {
        if (item && item.code) {
          localStorage.removeItem("qty_" + item.code);
        }
      });
    }

    // 3) —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏
    allItems = [];
    sessionValues = {};

    // 4) —á–∏—Å—Ç–∏–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    list.innerHTML = '';
    updateSummary([]);
  }
}


  // –°–µ—Å—Å–∏–∏
  function saveSession() {
    const name = prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Å–µ—Å—Å–∏–∏");
    if (!name) return;

    // –°–æ–±–∏—Ä–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –≤—Å–µ—Ö –∏–Ω–ø—É—Ç–æ–≤
    document.querySelectorAll('input[data-code]').forEach(input => {
      sessionValues[input.dataset.code] = input.value;
    });

    const session = { items: allItems, values: sessionValues };
    localStorage.setItem("session_" + name, JSON.stringify(session));
    localStorage.setItem("active_session", name);
    alert("–°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: " + name);
  }

  function openSessionModal() {
    const container = document.getElementById("session-list");
    container.innerHTML = '';
    const keys = Object.keys(localStorage).filter(k => k.startsWith("session_"));
    if (keys.length === 0) {
      container.innerHTML = "<div>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π</div>";
    } else {
      keys.forEach(key => {
        const name = key.replace("session_", "");
        const div = document.createElement("div");
        div.style = "margin-bottom:0.5rem; padding:0.5rem; border:1px solid var(--border); border-radius:6px;";
        div.innerHTML = `
          <strong>${name}</strong>
          <div style="margin-top:0.3rem;">
            <button onclick="loadSession('${name}')">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            <button onclick="switchSession('${name}')">üîÅ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
            <button onclick="deleteSession('${name}')">üóë –£–¥–∞–ª–∏—Ç—å</button>
          </div>
        `;
        container.appendChild(div);
      });
    }
    document.getElementById("session-modal").style.display = "flex";
  }

  function loadSession(name) {
    const raw = localStorage.getItem("session_" + name);
    if (!raw) return alert("–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
    try {
      const session = JSON.parse(raw);
      allItems = session.items;
      sessionValues = session.values || {};
      render(allItems);
      alert("–°–µ—Å—Å–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞: " + name);
    } catch {
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–µ—Å—Å–∏–∏");
    }
  }

  function switchSession(name) {
    localStorage.setItem("active_session", name);
    loadSession(name);
  }

  function deleteSession(name) {
    if (!confirm("–£–¥–∞–ª–∏—Ç—å —Å–µ—Å—Å–∏—é: " + name + "?")) return;
    localStorage.removeItem("session_" + name);
    if (localStorage.getItem("active_session") === name) {
      localStorage.removeItem("active_session");
    }
    openSessionModal();
  }
  // üî¶ –§–æ–Ω–∞—Ä–∏–∫
  let flashlightStream = null;
  let flashlightTrack = null;
  let flashlightOn = false;

  async function toggleFlashlight() {
    try {
      if (!flashlightOn) {
        flashlightStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { exact: "environment" } }
        });
        flashlightTrack = flashlightStream.getVideoTracks()[0];
        await flashlightTrack.applyConstraints({ advanced: [{ torch: true }] });
        flashlightOn = true;
      } else {
        if (flashlightTrack) {
          await flashlightTrack.applyConstraints({ advanced: [{ torch: false }] });
          flashlightTrack.stop();
        }
        if (flashlightStream) {
          flashlightStream.getTracks().forEach(t => t.stop());
        }
        flashlightOn = false;
      }
    } catch (err) {
      alert("–§–æ–Ω–∞—Ä–∏–∫ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –∏–ª–∏ –±—Ä–∞—É–∑–µ—Ä–µ");
      console.error(err);
    }
  }

  document.getElementById("flashlight-btn").addEventListener("click", toggleFlashlight);

// üåå –ê–Ω–∏–º–∞—Ü–∏—è —Ñ–æ–Ω–∞ (–∑–≤—ë–∑–¥—ã + –∫–æ–º–µ—Ç—ã + –∫–ª–∏–∫–∏)
const canvas = document.getElementById("bg");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

// --- –ó–≤—ë–∑–¥—ã —Å –ø–∞—Ä–∞–ª–ª–∞–∫—Å–æ–º ---
let stars = [];
for (let i = 0; i < 200; i++) {
  stars.push({
    x: Math.random() * canvas.width,
    y: Math.random() * canvas.height,
    r: Math.random() * 1.5 + 0.5,
    alpha: Math.random(),
    speed: Math.random() * 0.2 + 0.05
  });
}

// --- –ù–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–º–µ—Ç ---
let comets = [];
function spawnComet() {
  comets.push({
    x: -100,
    y: Math.random() * canvas.height * 0.5,
    vx: 6 + Math.random() * 2,
    vy: 2 + Math.random(),
    life: 0,
    maxLife: 300
  });
}

// --- –ß–∞—Å—Ç–∏—Ü—ã –æ—Ç –∫–ª–∏–∫–æ–≤ ---
let clickParticles = [];
canvas.addEventListener("click", e => {
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  for (let i = 0; i < 20; i++) {
    clickParticles.push({
      x,
      y,
      vx: (Math.random() - 0.5) * 4,
      vy: (Math.random() - 0.5) * 4,
      life: 0,
      maxLife: 60,
      r: Math.random() * 2 + 1
    });
  }
});

function drawClickParticles() {
  clickParticles.forEach((p, i) => {
    ctx.fillStyle = `rgba(255,255,200,${1 - p.life / p.maxLife})`;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
    ctx.fill();

    p.x += p.vx;
    p.y += p.vy;
    p.life++;

    if (p.life > p.maxLife) {
      clickParticles.splice(i, 1);
    }
  });
}

// --- –ê–Ω–∏–º–∞—Ü–∏—è ---
function animate() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // –ó–≤—ë–∑–¥—ã
  stars.forEach(s => {
    s.alpha += (Math.random() - 0.5) * 0.05;
    if (s.alpha < 0) s.alpha = 0;
    if (s.alpha > 1) s.alpha = 1;

    s.y += s.speed;
    if (s.y > canvas.height) {
      s.y = 0;
      s.x = Math.random() * canvas.width;
    }

    ctx.fillStyle = `rgba(255,255,255,${s.alpha})`;
    ctx.beginPath();
    ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
    ctx.fill();
  });

  // –°–ª—É—á–∞–π–Ω—ã–π –∑–∞–ø—É—Å–∫ –∫–æ–º–µ—Ç—ã
  if (Math.random() < 0.005) {
    spawnComet();
  }

  // –ö–æ–º–µ—Ç—ã
  comets.forEach((c, i) => {
    let grad = ctx.createLinearGradient(c.x, c.y, c.x - 120, c.y - 60);
    grad.addColorStop(0, "rgba(255,255,255,0.8)");
    grad.addColorStop(1, "rgba(255,255,255,0)");

    ctx.strokeStyle = grad;
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(c.x, c.y);
    ctx.lineTo(c.x - 120, c.y - 60);
    ctx.stroke();

    ctx.fillStyle = "#fff";
    ctx.beginPath();
    ctx.arc(c.x, c.y, 3.5, 0, Math.PI * 2);
    ctx.fill();

    c.x += c.vx;
    c.y += c.vy;
    c.life++;

    if (c.x > canvas.width + 150 || c.y > canvas.height + 150 || c.life > c.maxLife) {
      comets.splice(i, 1);
    }
  });

  // –ß–∞—Å—Ç–∏—Ü—ã –æ—Ç –∫–ª–∏–∫–æ–≤
  drawClickParticles();

  requestAnimationFrame(animate);
}
animate();
  // –ì–æ–ª–æ—Å–æ–≤–æ–π –ø–æ–∏—Å–∫ –¥–ª—è –ø–æ–ª—è #search —Å –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–æ–π, —Ñ—É–∑–∑–∏-–ø–æ–∏—Å–∫–æ–º –∏ –∞–≤—Ç–æ-–∑–∞–º–µ–Ω–æ–π
(function() {
  const searchInput = document.getElementById('search');
  const voiceBtn = document.getElementById('voice-search-btn');

  // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –ø–æ–∏—Å–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
  if (!searchInput) return;

  // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ SpeechRecognition (–≤–∫–ª—é—á–∞—è –ø—Ä–µ—Ñ–∏–∫—Å webkit)
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition || !voiceBtn) {
    if (voiceBtn) voiceBtn.style.display = 'none';
    return;
  }

  // ------------------ –£—Ç–∏–ª–∏—Ç—ã –∏ –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ ------------------
  const NUMBER_WORDS = {
    "–Ω–æ–ª—å":"0","–æ–¥–∏–Ω":"1","–¥–≤–∞":"2","—Ç—Ä–∏":"3","—á–µ—Ç—ã—Ä–µ":"4","–ø—è—Ç—å":"5",
    "—à–µ—Å—Ç—å":"6","—Å–µ–º—å":"7","–≤–æ—Å–µ–º—å":"8","–¥–µ–≤—è—Ç—å":"9","–¥–µ—Å—è—Ç—å":"10",
    "–æ–¥–Ω–∞":"1","–¥–≤–µ":"2","—Ç—Ä–µ—Ç–∏–π":"3","–ø–µ—Ä–≤—ã–π":"1","–≤—Ç–æ—Ä–æ–π":"2"
  };

  function preprocessFinalText(s) {
    if (!s) return "";
    let t = String(s).toLowerCase().trim();

    // –∑–∞–º–µ–Ω—è–µ–º —Å–ª–æ–≤–∞‚Äë—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞ —Ü–∏—Ñ—Ä—ã
    t = t.replace(/\b([–∞-—è—ë]+)\b/gi, (m) => {
      const w = m.toLowerCase();
      return NUMBER_WORDS[w] !== undefined ? NUMBER_WORDS[w] : m;
    });

    // —É–¥–∞–ª—è–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–ª–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ –º–µ—à–∞—é—Ç –ø–æ–∏—Å–∫—É
    t = t.replace(/\b(—à—Ç|—à—Ç—É–∫|–±—É—Ç|–±—É—Ç—ã–ª–∫–∞|–±—É—Ç—ã–ª–∫–∏|–±—É—Ç—ã–ª–æ–∫|—É–ø–∞–∫|—É–ø–∞–∫–æ–≤–∫–∞|–ª–∏—Ç—Ä|–ª)\b/gi, ' ');

    // —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã, —Å—Ö–ª–æ–ø—ã–≤–∞–µ–º –ø—Ä–æ–±–µ–ª—ã
    t = t.replace(/[^0-9a-z–∞-—è—ë\s\-]/gi, ' ').replace(/\s+/g, ' ').trim();

    return t;
  }

  function normForCompare(s) {
    return String(s || '')
      .toLowerCase()
      .replace(/—ë/g, '–µ')
      .replace(/[^a-z0-9–∞-—è—ë]/gi, '')
      .trim();
  }

  // –õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω
  function levenshtein(a, b) {
    a = String(a); b = String(b);
    if (a === b) return 0;
    const al = a.length, bl = b.length;
    if (al === 0) return bl;
    if (bl === 0) return al;
    const v0 = new Array(bl + 1), v1 = new Array(bl + 1);
    for (let j = 0; j <= bl; j++) v0[j] = j;
    for (let i = 0; i < al; i++) {
      v1[0] = i + 1;
      for (let j = 0; j < bl; j++) {
        const cost = a[i] === b[j] ? 0 : 1;
        v1[j + 1] = Math.min(v1[j] + 1, v0[j + 1] + 1, v0[j] + cost);
      }
      for (let j = 0; j <= bl; j++) v0[j] = v1[j];
    }
    return v1[bl];
  }

  function similarityScore(a, b) {
    a = String(a || '');
    b = String(b || '');
    a = a.toLowerCase().replace(/—ë/g, '–µ').replace(/[^a-z0-9–∞-—è—ë]/gi, '');
    b = b.toLowerCase().replace(/—ë/g, '–µ').replace(/[^a-z0-9–∞-—è—ë]/gi, '');
    if (!a || !b) return 0;
    const dist = levenshtein(a, b);
    const maxLen = Math.max(a.length, b.length);
    return Math.max(0, 1 - dist / maxLen);
  }

  function findClosestMatches(query, items, limit = 6) {
    const qRaw = preprocessFinalText(query);
    if (!qRaw) return [];
    const qTokens = qRaw.split(/\s+/).filter(Boolean);

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –¥–ª—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∫ –æ—à–∏–±–∫–∞–º ASR
    function stripVowels(s) {
      return String(s || '').toLowerCase().replace(/[–∞–µ—ë–∏–æ—É—ã—ç—é—è]/g, '');
    }
    function oToA(s) {
      return String(s || '').toLowerCase().replace(/–æ/g, '–∞');
    }
    // –§–æ–Ω–µ—Ç–∏—á–µ—Å–∫–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: —Å–≤–æ–¥–∏–º —Å–æ–∑–≤—É—á–Ω—ã–µ/–æ–∑–≤–æ–Ω—á—ë–Ω–Ω—ã–µ-–ø—Ä–∏–≥–ª—É—à—ë–Ω–Ω—ã–µ –ø–∞—Ä—ã –∫ –æ–¥–Ω–æ–π —Ñ–æ—Ä–º–µ
    function phoneticNormalize(s) {
      if (!s) return s;
      let t = String(s).toLowerCase();
      // –£–±–∏—Ä–∞–µ–º –¥–∏–∞–∫—Ä–∏—Ç–∏–∫—É –∏ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã
      t = t.replace(/—ë/g, '–µ');
      // –ø–∞—Ä—ã: (–≤,—Ñ), (–±,–ø), (–≥,–∫), (–¥,—Ç), (–∑,—Å), (–∂,—à), (—á,—â)
      t = t.replace(/[—Ñ]/g, '–≤');
      t = t.replace(/[–ø]/g, '–±');
      t = t.replace(/[–∫]/g, '–≥');
      t = t.replace(/[—Ç]/g, '–¥');
      t = t.replace(/[—Å]/g, '–∑');
      t = t.replace(/[—à]/g, '–∂');
      t = t.replace(/[—â]/g, '—á');
      // –∏–Ω–æ–≥–¥–∞ –ø—É—Ç–∞—é—Ç '–≤' –∏ '—Ñ' –≤ –∫–æ–Ω—Ü–µ —Å–ª–æ–≤–∞ ‚Äî —É–∂–µ —É—á—Ç–µ–Ω–æ
      // —Å—Ö–ª–æ–ø—ã–≤–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ –Ω–µ–∞–ª—Ñ–∞–≤–∏—Ç
      t = t.replace(/[^–∞-—è0-9]/g, '');
      return t;
    }

    // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–∫–∞–ª—å–Ω–∞—è —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è –ª–∞—Ç–∏–Ω–∏—Ü—ã –≤ –∫–∏—Ä–∏–ª–ª–∏—Ü—É (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤ –∑–∞–ø—Ä–æ—Å–µ –ª–∞—Ç–∏–Ω–∏—Ü–∞)
    // –ù–ï –≤—ã–ø–æ–ª–Ω—è–µ–º –æ–±—Ä–∞—Ç–Ω—É—é —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—é (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞ -> –ª–∞—Ç–∏–Ω–∏—Ü–∞) –Ω–∏–≥–¥–µ
    function latinToCyrillicLocal(s) {
      if (!s) return s;
      let t = String(s).toLowerCase().trim();
      if (!/[a-z]/i.test(t)) return t;
      const map = [
        ['shch','—â'], ['sch','—â'], ['yo','—ë'], ['yu','—é'], ['ya','—è'],
        ['zh','–∂'], ['kh','—Ö'], ['ch','—á'], ['sh','—à'], ['ts','—Ü'],
        ['ye','–µ'], ['yi','–π'],
        ['a','–∞'], ['b','–±'], ['c','–∫'], ['d','–¥'], ['e','–µ'], ['f','—Ñ'],
        ['g','–≥'], ['h','—Ö'], ['i','–∏'], ['j','–π'], ['k','–∫'], ['l','–ª'],
        ['m','–º'], ['n','–Ω'], ['o','–æ'], ['p','–ø'], ['q','–∫'], ['r','—Ä'],
        ['s','—Å'], ['t','—Ç'], ['u','—É'], ['v','–≤'], ['w','–≤'], ['x','–∫—Å'],
        ['y','–π'], ['z','–∑']
      ];
      t = t.replace(/[^a-z0-9\s\.\-]/gi, ' ').replace(/\s+/g, ' ').trim();
      for (const [k, v] of map) {
        const re = new RegExp(k, 'gi');
        t = t.replace(re, v);
      }
      return t.replace(/\s+/g, ' ').trim();
    }

    const qLatin = /[a-z]/i.test(qRaw);
    const qCyrFromLatin = qLatin ? latinToCyrillicLocal(qRaw) : null;
    const qNoVowels = stripVowels(qRaw);
    const qOtoA = oToA(qRaw);
    const qNoVowelsCyr = qCyrFromLatin ? stripVowels(qCyrFromLatin) : null;
    const qOtoACyr = qCyrFromLatin ? oToA(qCyrFromLatin) : null;
    const qPhonetic = phoneticNormalize(qRaw);
    const qPhoneticCyr = qCyrFromLatin ? phoneticNormalize(qCyrFromLatin) : null;

    const results = (items || []).map(item => {
      const name = String(item.name || '');
      const code = String(item.code || '');
      const nameNorm = normForCompare(name);
      const codeNorm = normForCompare(code);

      const nameTokens = preprocessFinalText(name).split(/\s+/).filter(Boolean);

      // token overlap (—É—á–∏—Ç—ã–≤–∞–µ–º –∏ —Ç—Ä–∞–Ω—Å–ª–∏—Ç-–≤–µ—Ä—Å–∏—é –∑–∞–ø—Ä–æ—Å–∞)
      let tokenMatches = 0;
      qTokens.forEach(t => {
        if (nameTokens.some(nt => nt.includes(t) || t.includes(nt))) tokenMatches++;
        if (codeNorm.includes(t) || t.includes(codeNorm)) tokenMatches += 0.8;
      });
      if (qCyrFromLatin) {
        const qTokensCyr = qCyrFromLatin.split(/\s+/).filter(Boolean);
        qTokensCyr.forEach(t => {
          if (nameTokens.some(nt => nt.includes(t) || t.includes(nt))) tokenMatches += 0.9;
          if (codeNorm.includes(t) || t.includes(codeNorm)) tokenMatches += 0.6;
        });
      }
      const tokenScore = tokenMatches / Math.max(qTokens.length, 1);

      // substring bonus (–ø—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∫–æ–º–ø–∞–∫—Ç–Ω—É—é –≤–µ—Ä—Å–∏—é –∏ —Ç—Ä–∞–Ω—Å–ª–∏—Ç)
      const compactQ = qRaw.replace(/\s+/g, '');
      const compactQCyr = qCyrFromLatin ? qCyrFromLatin.replace(/\s+/g, '') : null;
      const substrBonus = (nameNorm.includes(compactQ) || codeNorm.includes(compactQ) || (compactQCyr && nameNorm.includes(compactQCyr))) ? 0.25 : 0;

      // similarity: –æ–±—ã—á–Ω–∞—è + –≤–∞—Ä–∏–∞–Ω—Ç—ã (–±–µ–∑ –≥–ª–∞—Å–Ω—ã—Ö, o->a, —Ç—Ä–∞–Ω—Å–ª–∏—Ç)
      const simCandidates = [];
      simCandidates.push(similarityScore(qRaw, name));
      if (qCyrFromLatin) simCandidates.push(similarityScore(qCyrFromLatin, name));
      simCandidates.push(similarityScore(qNoVowels, stripVowels(name)));
      if (qNoVowelsCyr) simCandidates.push(similarityScore(qNoVowelsCyr, stripVowels(name)));
      simCandidates.push(similarityScore(qOtoA, oToA(name)));
      if (qOtoACyr) simCandidates.push(similarityScore(qOtoACyr, oToA(name)));
      // –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–æ–Ω–µ—Ç–∏—á–µ—Å–∫—É—é –ø–æ—Ö–æ–∂–µ—Å—Ç—å (—Å–≤–æ–¥–∏–º —Å–æ–∑–≤—É—á–Ω—ã–µ –±—É–∫–≤—ã)
      try {
        simCandidates.push(similarityScore(qPhonetic, phoneticNormalize(name)));
        if (qPhoneticCyr) simCandidates.push(similarityScore(qPhoneticCyr, phoneticNormalize(name)));
      } catch (e) {
        // ignore
      }
      const simName = Math.max(...simCandidates, 0);

      const simCode = Math.max(similarityScore(qRaw, code), qCyrFromLatin ? similarityScore(qCyrFromLatin, code) : 0);

      // numeric bonus
      let numBonus = 0;
      const qNumMatch = (qRaw + (qCyrFromLatin || '')).match(/\b(\d+)\b/);
      if (qNumMatch) {
        const qnum = qNumMatch[1];
        if (String(item.name).includes(qnum) || String(item.code).includes(qnum)) numBonus = 0.35;
      }

      const score = Math.max(simName, simCode) * 0.55 + tokenScore * 0.30 + substrBonus + numBonus;

      return { item, score, tokenScore, simName, simCode };
    });

    const filtered = results
      .filter(r => r.score > 0.12)
      .sort((a,b) => b.score - a.score)
      .slice(0, limit)
      .map(r => ({ item: r.item, score: r.score }));

    return filtered;
  }

  // ------------------ SpeechRecognition setup ------------------
  const recognition = new SpeechRecognition();
  recognition.lang = 'ru-RU'; // –ñ—ë—Å—Ç–∫–æ —Å—Ç–∞–≤–∏–º —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
  recognition.interimResults = true;
  recognition.maxAlternatives = 1;
  recognition.continuous = false;

  let isRecording = false;

  function setRecordingState(on) {
    isRecording = !!on;
    voiceBtn.setAttribute('aria-pressed', String(isRecording));
    if (isRecording) {
      voiceBtn.classList.add('recording');
      voiceBtn.setAttribute('title', '–ì–æ–≤–æ—Ä–∏—Ç–µ, –∑–∞–ø–∏—Å—å –∏–¥—ë—Ç');
    } else {
      voiceBtn.classList.remove('recording');
      voiceBtn.setAttribute('title', '–ì–æ–ª–æ—Å–æ–≤–æ–π –ø–æ–∏—Å–∫');
    }
  }

  voiceBtn.addEventListener('click', () => {
    if (!isRecording) {
      try {
        recognition.start();
        setRecordingState(true);
      } catch (err) {
        console.error('SpeechRecognition start error', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥');
      }
    } else {
      recognition.stop();
      setRecordingState(false);
    }
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: —É–º–Ω–∞—è –∞–≤—Ç–æ–∑–∞–º–µ–Ω–∞ —Å –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–æ–π –±–∞–∑–æ–≤–æ–≥–æ –∏–º–µ–Ω–∏ (—á—Ç–æ–±—ã –Ω–µ —Å–∫—Ä—ã–≤–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã)
recognition.addEventListener('result', (ev) => {
  let interim = '';
  let final = '';
  for (let i = 0; i < ev.results.length; i++) {
    const res = ev.results[i];
    if (res.isFinal) final += res[0].transcript;
    else interim += res[0].transcript;
  }

  const displayText = (final || interim).trim();
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π/—Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  searchInput.value = displayText;
  searchInput.dispatchEvent(new Event('input', { bubbles: true }));

  if (!final || !final.trim()) return;

  const finalText = final.trim();
  const pre = preprocessFinalText(finalText);

  // 1) –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ)
  const items = Array.isArray(allItems) ? allItems : [];
  const normQuery = normForCompare(pre);
  const exactMatches = items.filter(it => normForCompare(it.name || '') === normQuery);

  if (exactMatches.length > 0) {
    // –ï—Å—Ç—å —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ ‚Äî –ù–ï –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–ª–Ω–æ–µ –∏–º—è –≤ –ø–æ–ª–µ, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ, —á—Ç–æ —Å–∫–∞–∑–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å,
    // –Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É (–µ—Å–ª–∏ –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è openItem)
    searchInput.value = finalText;
    searchInput.dispatchEvent(new Event('input', { bubbles: true }));
    try {
      if (typeof window.openItem === 'function') {
        window.openItem(exactMatches[0]);
      } else if (typeof window.openFirstItemIfNeeded === 'function') {
        window.openFirstItemIfNeeded([exactMatches[0]]);
      } else if (typeof window.renderItems === 'function') {
        window.renderItems([exactMatches[0]]);
      }
    } catch (e) {
      console.error('Error opening exact match item', e);
    }
    const box = document.getElementById('voice-suggestions');
    if (box) box.style.display = 'none';
    console.info(`Exact match for "${finalText}" ‚Üí opened "${exactMatches[0].name}"`);
    return;
  }

  // 2) –ù–µ—Ç —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è ‚Äî –∏—â–µ–º –±–ª–∏–∂–∞–π—à–∏–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
  const matches = findClosestMatches(pre, items, 8);

  if (!matches || matches.length === 0) {
    // –ù–∏—á–µ–≥–æ –ø–æ—Ö–æ–∂–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
    searchInput.value = finalText;
    searchInput.dispatchEvent(new Event('input', { bubbles: true }));
    const box = document.getElementById('voice-suggestions');
    if (box) box.style.display = 'none';
    console.info(`No fuzzy matches for "${finalText}" ‚Äî kept query.`);
    return;
  }

  // 3) –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ—Ö–æ–∂–∏–µ ‚Äî –±–µ—Ä—ë–º –ª—É—á—à–∏–π –∏ (–ù–ï –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–ª–Ω–æ–µ –∏–º—è) ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ –ª—É—á—à–µ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é
  const best = matches[0];

  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –∏–∑–≤–ª–µ—á—å –±–∞–∑–æ–≤–æ–µ –∏–º—è (—É–¥–∞–ª–∏—Ç—å —Å—É—Ñ—Ñ–∏–∫—Å—ã/–≤–∞—Ä–∏–∞–Ω—Ç—ã)
  function extractBaseName(name) {
    if (!name) return name;
    let s = String(name).trim();

    // –£–¥–∞–ª—è–µ–º —á–∞—Å—Ç–∏ –≤ —Å–∫–æ–±–∫–∞—Ö –∏ –ø–æ—Å–ª–µ —Ç–∏—Ä–µ/–¥–≤–æ–µ—Ç–æ—á–∏—è/—Å–ª–µ—à–∞
    s = s.replace(/\(.*?\)/g, ' ');
    s = s.split(/[-‚Äì‚Äî:\/]/)[0];

    // –£–¥–∞–ª—è–µ–º —Å–ª–æ–≤–∞-–º–µ—Ç–∫–∏ —Ç–∏–ø–∞ "–∫–∞—Ä—Ç–∞", "–≤–µ—Ä—Å–∏—è", "–≤—ã–ø—É—Å–∫", "—á–∞—Å—Ç—å", "‚Ññ" –∏ –≤—Å—ë –ø–æ—Å–ª–µ –Ω–∏—Ö
    s = s.replace(/\b(–∫–∞—Ä—Ç–∞|–≤–µ—Ä—Å–∏—è|–≤—ã–ø—É—Å–∫|—á–∞—Å—Ç—å|—á–∞—Å—Ç—å|–Ω–æ–º–µ—Ä|‚Ññ|—Ä–µ–¥–∞–∫—Ü–∏—è|–∏–∑–¥–∞–Ω–∏–µ|–≤–µ—Ä—Å–∏—è)\b.*$/i, '');

    // –£–¥–∞–ª—è–µ–º –∫–æ–Ω–µ—á–Ω—ã–µ —á–∏—Å–ª–∞/—Ä–æ–º–∞–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä "3", "III") –≤ –∫–æ–Ω—Ü–µ
    s = s.replace(/\b[0-9ivx]+\s*$/i, '');

    // –°—Ö–ª–æ–ø—ã–≤–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ –æ–±—Ä–µ–∑–∞–µ–º
    s = s.replace(/\s+/g, ' ').trim();

    return s;
  }

  const baseName = extractBaseName(best.item.name || best.item.title || best.item.code || finalText);

  // –ü–æ—Ä–æ–≥, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –Ω–∞–π–¥–µ–Ω–Ω—ã–π –ª—É—á—à–∏–π –º–∞—Ç—á —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω
  const AUTO_BASENAME_THRESHOLD = 0.35; // –º–æ–∂–Ω–æ –ø–æ–¥–Ω—è—Ç—å –¥–æ 0.45 –ø—Ä–∏ –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è—Ö

  if (best.score >= AUTO_BASENAME_THRESHOLD && baseName) {
    // –ù–ï –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤–æ–µ –∏–º—è –≤ –ø–æ–ª–µ ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Ä–æ–≤–Ω–æ —Ç–æ, —á—Ç–æ —Å–∫–∞–∑–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å,
    // –Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ –ª—É—á—à–µ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é
    searchInput.value = finalText;
    searchInput.dispatchEvent(new Event('input', { bubbles: true }));
    try {
      if (typeof window.openItem === 'function') {
        window.openItem(best.item);
      } else if (typeof window.openFirstItemIfNeeded === 'function') {
        window.openFirstItemIfNeeded([best.item]);
      } else if (typeof window.renderItems === 'function') {
        window.renderItems([best.item]);
      }
    } catch (e) {
      console.error('Error opening best match item', e);
    }
    const box = document.getElementById('voice-suggestions');
    if (box) box.style.display = 'none';
    console.info(`Fuzzy match for "${finalText}" ‚Üí opened "${best.item.name}" (score ${(best.score*100).toFixed(0)}%)`);
    return;
  }

  // –ï—Å–ª–∏ –ª—É—á—à–∏–π –º–∞—Ç—á —Å–ª–∏—à–∫–æ–º —Å–ª–∞–±—ã–π ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
  searchInput.value = finalText;
  searchInput.dispatchEvent(new Event('input', { bubbles: true }));
  const box = document.getElementById('voice-suggestions');
  if (box) box.style.display = 'none';
  console.info(`Fuzzy match too weak for "${finalText}" ‚Äî kept query.`);
});


  recognition.addEventListener('end', () => {
    setRecordingState(false);
  });

  recognition.addEventListener('error', (e) => {
    console.error('SpeechRecognition error', e);
    setRecordingState(false);
    if (e.error === 'not-allowed' || e.error === 'service-not-allowed') {
      alert('–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â—ë–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.');
    } else {
      alert('–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞: ' + (e.error || 'unknown'));
    }
  });

  // –ë—ã—Å—Ç—Ä—ã–π —Ö–æ—Ç–∫–µ–π: Ctrl+Shift+M
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'm') {
      voiceBtn.click();
    }
  });

})();


  // –ë—ã—Å—Ç—Ä—ã–π —Ö–æ—Ç–∫–µ–π: Ctrl+Shift+M
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'm') {
      voiceBtn.click();
    }
  });



</script>
</body>
</html>

