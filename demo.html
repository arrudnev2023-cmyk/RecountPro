<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ò–º–ø–æ—Ä—Ç —Ç–æ–≤–∞—Ä–æ–≤</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to bottom right, rgba(46, 204, 113, 0.6), rgba(52, 152, 219, 0.6));
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      width: 100%;
      max-width: 500px;
      padding: 40px 20px;
      text-align: center;
    }
    h1 {
      font-size: 36px;
      font-weight: bold;
      font-family: 'Segoe UI Rounded', sans-serif;
      color: white;
      margin-bottom: 40px;
    }
    button, .nav-button {
      display: block;
      width: 100%;
      padding: 14px;
      font-size: 20px;
      margin-bottom: 20px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }
    .upload-button {
      background: white;
      color: #27ae60;
    }
    .nav-button {
      background: white;
      color: #2980b9;
    }
    input[type="file"] {
      display: none;
    }
    #itemsContainer {
      margin-top: 30px;
    }
    .item-card {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: left;
    }
    .item-card input {
      width: 100%;
      padding: 8px;
      margin-top: 8px;
      font-size: 16px;
    }
    #summary {
      background: #ecf0f1;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìÑ –ò–º–ø–æ—Ä—Ç —Ç–æ–≤–∞—Ä–æ–≤</h1>

    <label for="pdfUpload" class="upload-button">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å PDF</label>
    <input type="file" id="pdfUpload" accept=".pdf" />
    <button class="nav-button" onclick="alert('–ó–∞–≥–ª—É—à–∫–∞: –ø–µ—Ä–µ—Ö–æ–¥ –∫ –∏—Å—Ç–æ—Ä–∏–∏')">üìÇ –†–∞–Ω–µ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ</button>

    <div id="itemsContainer"></div>
    <button class="upload-button" onclick="calculateTotal()">–ò—Ç–æ–≥</button>
    <div id="summary"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script>
    let items = [];

    document.getElementById("pdfUpload").addEventListener("change", parsePDF);

    async function parsePDF(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function () {
        const typedarray = new Uint8Array(this.result);
        const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;

        let linesByY = {};

        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();

          content.items.forEach(item => {
            const y = Math.round(item.transform[5]);
            if (!linesByY[y]) linesByY[y] = [];
            linesByY[y].push(item.str);
          });
        }

        const sortedY = Object.keys(linesByY).sort((a, b) => b - a);
        const lines = sortedY.map(y => linesByY[y].join(" "));

        extractItems(lines);
        renderItems();
      };
      reader.readAsArrayBuffer(file);
    }

    function extractItems(lines) {
      items = [];

      const ignorePatterns = [
        /–ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–ª–∞—Å—å/i,
        /–∫–æ–º–∏—Å—Å–∏–µ–π –≤ —Å–æ—Å—Ç–∞–≤–µ/i,
        /–∏—Ç–æ–≥–æ/i,
        /–¥–∞—Ç–∞/i,
        /–ø–æ–¥–ø–∏—Å—å/i,
        /–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π/i,
        /–¥–æ–∫—É–º–µ–Ω—Ç/i,
        /–æ—Å–Ω–æ–≤–∞–Ω–∏–µ/i
      ];

      lines.forEach(line => {
        if (ignorePatterns.some(p => p.test(line))) return;

        const quantityMatches = [...line.matchAll(/(\d+)\s*—à—Ç/g)];
        const lastQuantityMatch = quantityMatches.pop();
        const quantity = lastQuantityMatch ? parseInt(lastQuantityMatch[1]) : null;

        if (quantity === null) return;

        const name = line.trim(); // –≤—Å—è —Å—Ç—Ä–æ–∫–∞ –∫–∞–∫ –Ω–∞–∑–≤–∞–Ω–∏–µ

        items.push({
          name,
          docQty: quantity,
          factQty: null
        });
      });
    }

    function renderItems() {
      const container = document.getElementById("itemsContainer");
      container.innerHTML = "";
      items.forEach((item, index) => {
        container.innerHTML += `
          <div class="item-card">
            <strong>${item.name}</strong><br/>
            –ü–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º: ${item.docQty} —à—Ç<br/>
            <input type="number" placeholder="–§–∞–∫—Ç" onchange="updateFact(${index}, this.value)" />
          </div>
        `;
      });
    }

    function updateFact(index, value) {
      items[index].factQty = parseInt(value);
    }

    function calculateTotal() {
      let summary = "";
      items.forEach(item => {
        if (item.factQty !== null) {
          const diff = item.factQty - item.docQty;
          const status = diff === 0 ? "‚úÖ –°–æ–≤–ø–∞–¥–∞–µ—Ç" : diff > 0 ? `üì¶ –ò–∑–ª–∏—à–µ–∫: +${diff}` : `‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—á–∞: ${diff}`;
          summary += `<strong>${item.name}</strong>: ${status}<br/>`;
        }
      });
      document.getElementById("summary").innerHTML = summary;
    }
  </script>
</body>
</html>
